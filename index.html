<!DOCTYPE html>
<html lang="ar" dir="rtl" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>بوابة نشامى المفرق - النظام السيادي المتكامل</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Tajawal', 'sans-serif'],
                    },
                    colors: {
                        jcd: { 
                            blue: '#1e3a8a', 
                            red: '#dc2626', 
                            gold: '#fbbf24', 
                            dark: '#020617',
                            surface: '#1e293b'
                        }
                    },
                    animation: { 
                        'float': 'float 6s ease-in-out infinite',
                        'shine': 'shine 3s linear infinite',
                        'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite'
                    },
                    keyframes: {
                        float: { '0%, 100%': { transform: 'translateY(0)' }, '50%': { transform: 'translateY(-10px)' } },
                        shine: { '0%': { backgroundPosition: '200% center' }, '100%': { backgroundPosition: '-200% center' } }
                    }
                }
            }
        }
    </script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700;800&display=swap');
        body { font-family: 'Tajawal', sans-serif; }
        
        .hero-bg {
            background-color: #0f172a;
            background-image: 
                radial-gradient(at 0% 0%, hsla(253,16%,7%,1) 0, transparent 50%), 
                radial-gradient(at 50% 0%, hsla(225,39%,30%,1) 0, transparent 50%), 
                radial-gradient(at 100% 0%, hsla(339,49%,30%,1) 0, transparent 50%);
            position: relative; overflow: hidden;
        }
        
        .glass-panel {
            background: rgba(255, 255, 255, 0.03);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.2);
        }

        .input-field {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: inherit;
            transition: all 0.3s ease;
        }
        .input-field:focus {
            background: rgba(255, 255, 255, 0.08);
            border-color: #fbbf24;
            box-shadow: 0 0 0 2px rgba(251, 191, 36, 0.2);
        }

        .official-card {
            background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
            border: 1px solid rgba(251, 191, 36, 0.3);
            color: white;
        }

        .rank-border-leader { border-color: #fbbf24; box-shadow: 0 0 15px rgba(251, 191, 36, 0.3); }
        .rank-border-nashmi { border-color: #22c55e; }
        .rank-border-rescuer { border-color: #f97316; }
        .rank-border-regular { border-color: #94a3b8; }

        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #475569; border-radius: 20px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #64748b; }
        
        #map { height: 100%; width: 100%; border-radius: 1rem; z-index: 0; }
        .fade-in { animation: fadeIn 0.6s cubic-bezier(0.16, 1, 0.3, 1); }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* Connection Status Indicator */
        #connection-status {
            position: fixed;
            bottom: 10px;
            left: 10px;
            z-index: 1000;
            padding: 8px 12px;
            border-radius: 20px;
            font-size: 10px;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: all 0.3s;
            pointer-events: none;
        }
        .status-dot { width: 8px; height: 8px; border-radius: 50%; }
    </style>
</head>
<body class="flex flex-col min-h-screen text-right bg-gray-50 text-slate-800 dark:bg-[#020617] dark:text-slate-100 transition-colors duration-300 selection:bg-jcd-gold selection:text-black">

    <!-- Status Indicator -->
    <div id="connection-status" class="bg-gray-800 text-gray-400">
        <div class="status-dot bg-gray-500"></div>
        <span>جاري الاتصال...</span>
    </div>

    <!-- Navbar -->
    <nav class="sticky top-0 z-50 border-b border-white/10 bg-[#1e3a8a]/90 dark:bg-[#020617]/80 backdrop-blur-md shadow-lg transition-all duration-300">
        <div class="container mx-auto px-4 py-3 flex justify-between items-center">
            <div class="flex items-center gap-3 cursor-pointer group" onclick="app.showSection('home')">
                <div class="relative">
                    <div class="absolute inset-0 bg-white/20 rounded-full blur-md group-hover:blur-lg transition-all"></div>
                    <img id="navLogo" src="https://upload.wikimedia.org/wikipedia/commons/e/e0/Jordan_Civil_Defence_Logo.png" class="relative h-10 w-10 object-contain drop-shadow-md bg-white rounded-full p-1 border border-gray-200">
                </div>
                <div>
                    <h1 class="font-extrabold text-lg leading-tight tracking-tight text-white">بوابة نشامى المفرق</h1>
                    <p class="text-[10px] text-jcd-gold font-bold tracking-widest opacity-90 uppercase">النظام الرقمي الموحد</p>
                </div>
            </div>
            
            <div class="flex items-center gap-6">
                <div id="guestLinks" class="hidden md:flex items-center gap-1 text-sm font-bold bg-white/5 p-1 rounded-full border border-white/10">
                    <button onclick="app.showSection('home')" class="px-4 py-1.5 rounded-full hover:bg-white/10 text-gray-200 hover:text-white transition">الرئيسية</button>
                    <button onclick="app.showSection('nashama-section')" class="px-4 py-1.5 rounded-full hover:bg-white/10 text-gray-200 hover:text-white transition">بوابة النشامى</button>
                    <button onclick="app.showLogin('volunteer')" class="px-4 py-1.5 rounded-full bg-jcd-gold text-black hover:bg-yellow-400 shadow-lg hover:shadow-yellow-400/20 transition">دخول النظام</button>
                </div>
                
                <div id="userMenu" class="hidden flex items-center gap-4">
                    <div class="relative cursor-pointer group p-2 rounded-full hover:bg-white/5 transition" onclick="app.toggleNotifications()">
                        <i class="fas fa-bell text-xl text-gray-300 group-hover:text-jcd-gold transition"></i>
                        <span id="notifBadge" class="absolute top-1 right-1 bg-red-500 text-white text-[9px] font-bold h-4 w-4 flex items-center justify-center rounded-full hidden ring-2 ring-[#020617]">0</span>
                    </div>
                    <div class="text-left leading-tight hidden sm:block">
                        <span id="userNameDisplay" class="block text-xs font-bold text-white"></span>
                        <button onclick="app.logout()" class="text-[10px] text-gray-400 hover:text-red-400 transition">تسجيل خروج</button>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <!-- Ticker -->
    <div id="news-ticker-container" class="bg-gradient-to-r from-red-900 to-red-700 text-white text-xs py-2 overflow-hidden hidden relative z-40 border-b border-red-800 shadow-md">
        <div class="whitespace-nowrap animate-marquee px-4 font-bold flex items-center gap-4" id="newsTickerText"></div>
    </div>

    <main id="main-content" class="flex-grow container mx-auto px-4 py-8 relative z-0">
        
        <!-- Hero Section -->
        <section id="home" class="fade-in">
            <div class="hero-bg rounded-[2.5rem] p-8 md:p-24 text-center text-white shadow-2xl relative min-h-[75vh] flex flex-col items-center justify-center border border-white/5">
                <div class="absolute inset-0 bg-[url('https://www.transparenttextures.com/patterns/carbon-fibre.png')] opacity-10 mix-blend-overlay"></div>
                
                <div class="relative z-10 w-full max-w-5xl">
                    <div class="animate-float mb-10">
                        <div class="relative inline-block">
                            <div class="absolute inset-0 bg-blue-500 blur-[60px] opacity-20 rounded-full"></div>
                            <img id="heroLogo" src="https://upload.wikimedia.org/wikipedia/commons/e/e0/Jordan_Civil_Defence_Logo.png" class="h-40 md:h-60 mx-auto drop-shadow-2xl bg-white/5 backdrop-blur-sm rounded-full p-6 border border-white/10 relative z-10">
                        </div>
                    </div>
                    <h2 class="text-5xl md:text-8xl font-black mb-6 tracking-tighter drop-shadow-xl bg-clip-text text-transparent bg-gradient-to-b from-white via-gray-200 to-gray-400">نشامى المفرق</h2>
                    <p class="text-lg md:text-2xl text-blue-200 mb-14 max-w-3xl mx-auto font-medium leading-relaxed">"منصة التطوع الرقمية الأولى لتوثيق العطاء وتنظيم الواجب الوطني"</p>
                    
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 w-full max-w-4xl mx-auto">
                        <button onclick="app.showSection('registration')" class="glass-panel hover:bg-white/10 p-8 rounded-3xl transition-all duration-300 transform hover:-translate-y-2 hover:shadow-2xl group border-b-4 border-green-500">
                            <div class="h-16 w-16 bg-green-500/10 rounded-2xl flex items-center justify-center mx-auto mb-4 group-hover:bg-green-500/20 transition-colors">
                                <i class="fas fa-user-plus text-3xl text-green-400 group-hover:scale-110 transition"></i>
                            </div>
                            <h3 class="text-xl font-bold mb-2">انضم إلينا</h3>
                            <p class="text-sm text-gray-400">سجل كمتطوع جديد</p>
                        </button>
                        
                        <button onclick="app.showLogin('volunteer')" class="glass-panel hover:bg-white/10 p-8 rounded-3xl transition-all duration-300 transform hover:-translate-y-2 hover:shadow-2xl group border-b-4 border-jcd-gold">
                            <div class="h-16 w-16 bg-yellow-500/10 rounded-2xl flex items-center justify-center mx-auto mb-4 group-hover:bg-yellow-500/20 transition-colors">
                                <i class="fas fa-id-card-alt text-3xl text-jcd-gold group-hover:scale-110 transition"></i>
                            </div>
                            <h3 class="text-xl font-bold mb-2">دخول المتطوعين</h3>
                            <p class="text-sm text-gray-400">لوحة التحكم والخدمات</p>
                        </button>
                        
                        <button onclick="app.showLogin('admin')" class="glass-panel hover:bg-white/10 p-8 rounded-3xl transition-all duration-300 transform hover:-translate-y-2 hover:shadow-2xl group border-b-4 border-red-500">
                            <div class="h-16 w-16 bg-red-500/10 rounded-2xl flex items-center justify-center mx-auto mb-4 group-hover:bg-red-500/20 transition-colors">
                                <i class="fas fa-shield-alt text-3xl text-red-500 group-hover:scale-110 transition"></i>
                            </div>
                            <h3 class="text-xl font-bold mb-2">الإدارة</h3>
                            <p class="text-sm text-gray-400">للمسؤولين فقط</p>
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- NEW: Public Roster (Daily Approved Shifts) -->
            <div id="public-roster" class="mt-16 max-w-5xl mx-auto">
                <div class="text-center mb-8">
                    <h3 class="text-2xl font-black text-slate-800 dark:text-white mb-2 flex items-center justify-center gap-2"><i class="fas fa-calendar-check text-green-500"></i> جدول المناوبات المعتمد لليوم</h3>
                    <p class="text-sm text-gray-500 dark:text-gray-400" id="rosterDateDisplay"></p>
                </div>
                <div id="approvedRosterGrid" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
                    <!-- Cards will be injected here -->
                </div>
            </div>
        </section>

        <!-- Nashama Portal -->
        <section id="nashama-section" class="fade-in hidden py-8">
            <div class="text-center mb-12">
                <h2 class="text-4xl md:text-5xl font-black text-jcd-blue dark:text-white mb-3">بوابة النشامى</h2>
                <div class="h-1 w-24 bg-jcd-gold mx-auto rounded-full mb-4"></div>
                <p class="text-gray-500 dark:text-gray-400 font-medium text-lg">قائمة الشرف للمتطوعين المتميزين - تحديث حي</p>
            </div>
            
            <div class="max-w-2xl mx-auto mb-12 relative group">
                <div class="absolute inset-0 bg-jcd-blue/20 blur-xl rounded-full opacity-0 group-hover:opacity-100 transition duration-500"></div>
                <input type="text" oninput="app.filterNashama(this.value)" placeholder="ابحث باسم النشمي..." class="relative w-full p-5 pr-14 rounded-2xl bg-white dark:bg-[#1e293b] shadow-xl border border-gray-200 dark:border-gray-700 outline-none focus:ring-2 focus:ring-jcd-blue transition text-lg placeholder-gray-400 dark:text-white">
                <i class="fas fa-search absolute right-5 top-1/2 -translate-y-1/2 text-gray-400 text-xl"></i>
            </div>

            <div id="nashamaGrid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6"></div>
        </section>

        <!-- Login Section -->
        <section id="login" class="fade-in hidden max-w-md mx-auto py-20">
            <div class="bg-white dark:bg-[#1e293b] rounded-[2rem] shadow-2xl p-8 border border-gray-100 dark:border-gray-700 relative overflow-hidden">
                <div class="absolute top-0 left-0 w-full h-2 bg-gradient-to-r from-jcd-blue via-jcd-gold to-jcd-red"></div>
                
                <div class="flex mb-8 bg-gray-100 dark:bg-[#0f172a] rounded-xl p-1.5">
                    <button class="w-1/2 py-2.5 rounded-lg text-sm font-bold transition-all bg-white dark:bg-[#1e293b] shadow text-jcd-blue dark:text-white" id="tab-volunteer" onclick="app.switchLoginTab('volunteer')">متطوع</button>
                    <button class="w-1/2 py-2.5 rounded-lg text-sm font-bold transition-all text-gray-500 dark:text-gray-400 hover:text-jcd-blue" id="tab-admin" onclick="app.switchLoginTab('admin')">إدارة</button>
                </div>
                
                <h2 class="text-2xl font-bold text-center mb-1 text-slate-800 dark:text-white" id="loginTitle">تسجيل دخول النشامى</h2>
                <p class="text-center text-gray-400 text-sm mb-8">يرجى إدخال بياناتك للدخول للنظام</p>
                
                <form onsubmit="app.handleLogin(event)" class="space-y-5">
                    <div class="space-y-1">
                        <label class="text-xs font-bold text-gray-500 mr-2">المعرف</label>
                        <input type="text" id="username" placeholder="الرقم الوطني / ID" class="input-field w-full p-4 rounded-xl outline-none font-bold text-right bg-gray-50 dark:bg-[#0f172a] dark:text-white border border-gray-200 dark:border-gray-700 focus:border-jcd-blue focus:ring-1 focus:ring-jcd-blue" required>
                    </div>
                    <div class="space-y-1">
                        <label class="text-xs font-bold text-gray-500 mr-2">كلمة المرور</label>
                        <input type="password" id="password" placeholder="••••••••" class="input-field w-full p-4 rounded-xl outline-none font-bold text-right bg-gray-50 dark:bg-[#0f172a] dark:text-white border border-gray-200 dark:border-gray-700 focus:border-jcd-blue focus:ring-1 focus:ring-jcd-blue" required>
                    </div>
                    <button type="submit" id="loginBtn" class="w-full bg-gradient-to-l from-jcd-blue to-blue-700 hover:to-blue-800 text-white font-bold py-4 rounded-xl shadow-lg hover:shadow-xl transition transform active:scale-95 flex justify-center items-center gap-2 mt-4"><span>دخول آمن</span><i class="fas fa-arrow-left"></i></button>
                </form>
                
                <div class="text-center mt-6 pt-4 border-t dark:border-gray-700">
                    <span id="systemStatus" class="inline-flex items-center gap-2 text-[10px] font-bold text-gray-400 bg-gray-100 dark:bg-white/5 px-3 py-1 rounded-full">
                        <span class="w-1.5 h-1.5 rounded-full bg-green-500 animate-pulse"></span> النظام متصل ومحمي
                    </span>
                </div>
            </div>
        </section>

        <!-- Volunteer Dashboard -->
        <section id="volunteer-dashboard" class="fade-in hidden space-y-8">
            <!-- Header Card -->
            <div class="bg-gradient-to-br from-[#1e3a8a] to-[#0f172a] rounded-[2.5rem] p-8 text-white shadow-2xl relative overflow-hidden border border-white/5">
                <div class="absolute inset-0 bg-[url('https://www.transparenttextures.com/patterns/diagmonds-light.png')] opacity-10"></div>
                <div class="absolute top-0 right-0 w-64 h-64 bg-blue-500 blur-[100px] opacity-20 rounded-full pointer-events-none"></div>
                
                <div class="flex flex-col md:flex-row items-center gap-8 relative z-10">
                    <div class="relative group">
                        <div class="absolute -inset-1 bg-gradient-to-r from-jcd-gold to-yellow-600 rounded-full blur opacity-25 group-hover:opacity-75 transition duration-1000 group-hover:duration-200"></div>
                        <!-- Replaced Image with Dynamic Avatar -->
                        <div id="dashAvatarContainer" class="relative h-32 w-32 rounded-full border-4 border-white/10 shadow-xl bg-gray-800 flex items-center justify-center text-4xl font-black text-white object-cover overflow-hidden">
                            <img id="dashAvatar" src="" class="w-full h-full object-cover hidden">
                            <span id="dashAvatarInitial"></span>
                        </div>
                        <span id="dashRankBadge" class="absolute -bottom-3 right-1/2 translate-x-1/2 bg-jcd-gold text-black text-xs px-4 py-1.5 rounded-full font-black shadow-lg whitespace-nowrap border border-white/20">نشمي</span>
                    </div>
                    <div class="text-center md:text-right flex-grow">
                        <h2 class="text-3xl md:text-4xl font-black mb-1 tracking-tight" id="volNameDisplay"></h2>
                        <p class="text-blue-200 text-sm mb-6 flex items-center justify-center md:justify-start gap-2"><i class="fas fa-check-circle text-green-400"></i> <span id="volBioDisplay">متطوع</span></p>
                        
                        <!-- Warning Alert Box -->
                        <div id="volWarningBox" class="hidden bg-red-500/10 border border-red-500/30 p-4 rounded-xl mb-6 text-sm font-medium text-red-200 flex items-center gap-3 animate-pulse backdrop-blur-md">
                            <i class="fas fa-exclamation-triangle text-xl text-red-500"></i>
                            <span id="volWarningText">لديك إنذار نشط: يرجى مراجعة الإدارة.</span>
                        </div>
                        
                        <div class="flex flex-wrap justify-center md:justify-start gap-3">
                            <button onclick="app.openIDModal()" class="bg-white/10 hover:bg-white/20 hover:scale-105 border border-white/10 px-5 py-2.5 rounded-xl text-xs font-bold transition flex items-center gap-2 backdrop-blur-sm"><i class="fas fa-id-card"></i> هويتي</button>
                            <button onclick="app.openFullProfile()" class="bg-white/10 hover:bg-white/20 hover:scale-105 border border-white/10 px-5 py-2.5 rounded-xl text-xs font-bold transition flex items-center gap-2 backdrop-blur-sm"><i class="fas fa-user-circle"></i> ملفي</button>
                            <button onclick="app.openProfileEdit()" class="bg-white/10 hover:bg-white/20 hover:scale-105 border border-white/10 px-5 py-2.5 rounded-xl text-xs font-bold transition flex items-center gap-2 backdrop-blur-sm"><i class="fas fa-cog"></i> الإعدادات</button>
                            <button onclick="app.openSuggestionsModal()" class="bg-white/10 hover:bg-white/20 hover:scale-105 border border-white/10 px-5 py-2.5 rounded-xl text-xs font-bold transition flex items-center gap-2 backdrop-blur-sm"><i class="fas fa-box-open"></i> شكاوى</button>
                        </div>
                    </div>
                    <div id="gateContainer" class="bg-white/5 backdrop-blur-md p-6 rounded-3xl border border-white/10 text-center min-w-[200px] shadow-2xl"></div>
                </div>
            </div>

            <!-- Announcements Area -->
            <div id="volAnnouncements" class="hidden bg-gradient-to-r from-amber-50 to-orange-50 dark:from-amber-900/20 dark:to-orange-900/20 border-r-4 border-jcd-gold p-5 rounded-2xl shadow-sm fade-in">
                <h4 class="font-bold text-sm text-amber-700 dark:text-amber-400 mb-2 flex items-center"><i class="fas fa-bullhorn ml-2 animate-bounce"></i> تعاميم إدارية</h4>
                <div id="announcementText" class="text-sm text-gray-700 dark:text-gray-200 font-medium leading-relaxed"></div>
            </div>

            <!-- Stats & AI Message -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="md:col-span-2 bg-gradient-to-r from-[#ea580c] to-[#dc2626] rounded-[2rem] p-6 text-white shadow-lg relative overflow-hidden group">
                    <div class="absolute right-0 top-0 w-32 h-32 bg-white opacity-5 rounded-full blur-2xl group-hover:opacity-10 transition"></div>
                    <i class="fas fa-quote-right absolute top-6 left-6 text-4xl opacity-20"></i>
                    <h4 class="font-bold text-xs uppercase tracking-wider mb-3 opacity-80">رسالة القيادة</h4>
                    <p id="dailyMessageText" class="text-xl font-bold leading-relaxed relative z-10">جاري الاتصال بالعمليات...</p>
                </div>
                
                <div class="bg-gradient-to-br from-sky-400 to-blue-500 rounded-[2rem] p-6 text-white shadow-lg flex flex-col justify-between relative overflow-hidden">
                    <div class="absolute inset-0 bg-white/10 skew-x-12 -translate-x-full hover:translate-x-full transition duration-1000"></div>
                    <div class="flex justify-between items-start">
                        <div>
                            <h4 class="text-xs font-bold opacity-80 uppercase mb-1">الطقس (المفرق)</h4>
                            <div class="text-4xl font-black tracking-tight" id="weatherTemp">18°</div>
                        </div>
                        <i class="fas fa-sun text-4xl text-yellow-300 animate-spin-slow drop-shadow-lg"></i>
                    </div>
                    <div class="mt-4">
                        <div class="text-xs font-bold bg-white/20 backdrop-blur-md px-3 py-1.5 rounded-lg inline-block">مشمس - رؤية واضحة</div>
                    </div>
                </div>
            </div>

            <!-- AI Message -->
            <div class="bg-slate-900 rounded-[2rem] p-1 shadow-lg border border-slate-800">
                <div class="bg-slate-800/50 rounded-[1.8rem] p-6 relative overflow-hidden">
                    <div class="relative z-10">
                          <h4 class="font-bold text-sm mb-3 opacity-80 flex items-center gap-2 text-jcd-gold"><i class="fas fa-robot"></i> المستشار الذكي (AI)</h4>
                          <div id="aiResponseArea" class="text-sm font-medium leading-relaxed mb-4 min-h-[40px] text-gray-300 bg-black/20 p-4 rounded-xl border border-white/5">اسألني أي شيء عن الإسعافات الأولية أو إجراءات الدفاع المدني...</div>
                          <div class="flex gap-2">
                              <input type="text" id="aiQuickAsk" placeholder="اكتب سؤالك هنا..." class="flex-grow p-3.5 rounded-xl bg-slate-700/50 text-white placeholder-slate-400 text-xs outline-none border border-slate-600 focus:border-jcd-gold transition">
                              <button onclick="app.askAIQuick()" class="bg-jcd-gold text-black px-5 py-2 rounded-xl font-bold text-xs hover:bg-yellow-400 transition hover:shadow-lg hover:shadow-yellow-500/20"><i class="fas fa-paper-plane"></i></button>
                          </div>
                    </div>
                </div>
            </div>

            <!-- Report Generator -->
            <div class="bg-white dark:bg-[#1e293b] p-8 rounded-[2rem] shadow-lg border border-gray-100 dark:border-gray-700">
                <h4 class="font-bold text-lg mb-4 text-blue-600 dark:text-blue-400 flex items-center gap-2"><i class="fas fa-file-signature"></i> تقرير المهمة الذكي</h4>
                <textarea id="volReportText" placeholder="صف تفاصيل المهمة أو النشاط الذي قمت به..." class="input-field w-full p-4 bg-gray-50 dark:bg-[#0f172a] rounded-xl text-sm mb-4 h-28 resize-none outline-none border border-gray-200 dark:border-gray-700 dark:text-white"></textarea>
                <div class="flex justify-end">
                    <button onclick="app.generateVolReport()" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2.5 rounded-xl text-xs font-bold transition shadow-lg shadow-blue-600/20 flex items-center gap-2"><i class="fas fa-magic"></i> توليد التقرير (AI)</button>
                </div>
                <div id="aiReportOutput" class="mt-4 text-sm p-5 bg-gray-50 dark:bg-[#0f172a] rounded-2xl hidden text-gray-700 dark:text-gray-300 leading-relaxed border border-gray-200 dark:border-gray-700"></div>
            </div>
            
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- Shift Registration -->
                <div class="bg-white dark:bg-[#1e293b] p-6 rounded-[2rem] shadow-lg border-t-4 border-blue-600">
                    <h4 class="font-bold text-lg mb-6 dark:text-white flex items-center justify-between">
                        <span><i class="fas fa-calendar-alt ml-2 text-blue-500"></i> المناوبات</span>
                        <span class="text-xs bg-blue-500/10 text-blue-500 px-2 py-1 rounded-lg">متاح</span>
                    </h4>
                    <div id="volShiftList" class="space-y-3 max-h-64 overflow-y-auto custom-scrollbar pr-1"></div>
                </div>

                <!-- Training & Map -->
                <div class="bg-white dark:bg-[#1e293b] p-6 rounded-[2rem] shadow-lg border-t-4 border-purple-600">
                    <h4 class="font-bold text-lg mb-6 dark:text-white flex items-center justify-between">
                        <span><i class="fas fa-graduation-cap ml-2 text-purple-500"></i> التدريب</span>
                        <span class="text-xs bg-purple-500/10 text-purple-500 px-2 py-1 rounded-lg">دورات</span>
                    </h4>
                    <div id="volCoursesList" class="space-y-3 max-h-64 overflow-y-auto custom-scrollbar pr-1"></div>
                </div>
            </div>

            <!-- Map -->
            <div class="bg-white dark:bg-[#1e293b] p-2 rounded-[2rem] shadow-lg border border-gray-100 dark:border-gray-700 h-96 relative">
                <div class="absolute top-6 right-6 z-10 bg-white/90 dark:bg-black/80 backdrop-blur px-4 py-2 rounded-xl text-xs font-bold shadow-lg">خريطة العمليات</div>
                <div id="map" class="w-full h-full rounded-[1.5rem] z-0"></div>
            </div>

            <!-- Leaderboard -->
            <div class="bg-white dark:bg-[#1e293b] p-6 rounded-[2rem] shadow-lg border-t-4 border-jcd-gold">
                <h4 class="font-bold text-lg mb-6 dark:text-white flex items-center gap-2"><i class="fas fa-trophy text-jcd-gold"></i> لوحة الشرف</h4>
                <div id="volLeaderboard" class="space-y-4"></div>
            </div>

             <div class="bg-white dark:bg-[#1e293b] p-8 rounded-[2rem] shadow-xl border border-gray-100 dark:border-gray-700">
                 <h3 class="font-bold text-xl mb-6 text-slate-800 dark:text-white flex items-center gap-2"><i class="fas fa-history text-gray-400"></i> السجل والشهادات</h3>
                 <div class="overflow-x-auto">
                     <table class="w-full text-xs md:text-sm text-right dark:text-gray-300 border-collapse">
                         <thead class="text-gray-400 border-b border-gray-200 dark:border-gray-700">
                             <tr>
                                 <th class="pb-3 pr-2 font-medium">التاريخ</th>
                                 <th class="pb-3 text-center font-medium">النشاط</th>
                                 <th class="pb-3 text-center font-medium">الوقت</th>
                                 <th class="pb-3 text-center font-medium">النقاط</th>
                                 <th class="pb-3 text-center font-medium">الشهادة</th>
                             </tr>
                         </thead>
                         <tbody id="historyBody" class="font-bold divide-y divide-gray-100 dark:divide-gray-800"></tbody>
                     </table>
                 </div>
            </div>

        </section>

        <!-- Admin Dashboard -->
        <section id="admin-dashboard" class="fade-in hidden space-y-8">
            <div class="bg-[#0f172a] text-white rounded-[2.5rem] p-8 shadow-2xl flex flex-col md:flex-row justify-between items-center relative overflow-hidden border border-gray-800">
                <div class="absolute inset-0 bg-jcd-blue/5"></div>
                <div class="absolute right-0 top-0 w-1/3 h-full bg-gradient-to-l from-jcd-blue/10 to-transparent"></div>
                
                <div class="relative z-10 mb-4 md:mb-0 text-center md:text-right">
                    <h2 class="text-3xl font-black text-white mb-1">غرفة العمليات المركزية</h2>
                    <p class="text-gray-400 text-sm font-medium">أهلاً بك، سيادة المدير <span id="adminNameSpan" class="text-jcd-gold font-bold"></span></p>
                </div>
                <div class="flex gap-3 relative z-10">
                    <button onclick="app.generateFullSystemReport()" class="bg-blue-600 hover:bg-blue-700 text-white px-5 py-3 rounded-xl font-bold shadow-lg shadow-blue-600/20 text-xs flex items-center gap-2 transition hover:-translate-y-1"><i class="fas fa-file-pdf"></i> التقرير الشامل</button>
                    <button onclick="app.openAddNashmiModal()" class="bg-jcd-gold hover:bg-yellow-400 text-black px-5 py-3 rounded-xl font-bold shadow-lg shadow-yellow-500/20 text-xs flex items-center gap-2 transition hover:-translate-y-1"><i class="fas fa-user-plus"></i> إضافة نشمي</button>
                </div>
            </div>

             <!-- NEW: Pending Requests (Admin) -->
             <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                <!-- Check-in Requests -->
                <div class="bg-white dark:bg-[#1e293b] p-6 rounded-[2rem] shadow-lg border-l-4 border-yellow-500">
                    <h3 class="text-lg font-bold mb-4 dark:text-white flex items-center gap-2"><i class="fas fa-user-clock text-yellow-500"></i> طلبات الدوام (Check-In)</h3>
                    <div id="pendingCheckinsList" class="space-y-2 max-h-48 overflow-y-auto custom-scrollbar text-xs">
                        <p class="text-gray-400 text-center py-4 bg-gray-50 dark:bg-[#0f172a] rounded-xl">لا توجد طلبات معلقة</p>
                    </div>
                </div>

                <!-- Shift Registration Requests -->
                <div class="bg-white dark:bg-[#1e293b] p-6 rounded-[2rem] shadow-lg border-l-4 border-blue-500">
                    <h3 class="text-lg font-bold mb-4 dark:text-white flex items-center gap-2"><i class="fas fa-calendar-plus text-blue-500"></i> طلبات المناوبات</h3>
                    <div id="pendingShiftsList" class="space-y-2 max-h-48 overflow-y-auto custom-scrollbar text-xs">
                        <p class="text-gray-400 text-center py-4 bg-gray-50 dark:bg-[#0f172a] rounded-xl">لا توجد طلبات معلقة</p>
                    </div>
                </div>
             </div>

            <!-- Announcements Sender & Logo -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                <div class="bg-white dark:bg-[#1e293b] p-6 rounded-[2rem] shadow-lg">
                    <h3 class="text-lg font-bold mb-4 dark:text-white flex items-center gap-2"><i class="fas fa-bullhorn text-gray-400"></i> إرسال تعميم</h3>
                    <div class="flex gap-2">
                        <input type="text" id="adminAnnouncementText" placeholder="نص الرسالة أو التعميم..." class="flex-grow p-3 rounded-xl bg-gray-50 dark:bg-[#0f172a] dark:text-white text-xs border border-gray-200 dark:border-gray-700 outline-none focus:border-jcd-blue">
                        <button onclick="app.sendAnnouncement()" class="bg-slate-800 text-white px-6 py-2 rounded-xl text-xs font-bold hover:bg-slate-900 transition">إرسال</button>
                    </div>
                </div>

                <!-- Logo Changer -->
                <div class="bg-white dark:bg-[#1e293b] p-6 rounded-[2rem] shadow-lg">
                    <h3 class="text-lg font-bold mb-4 dark:text-white flex items-center gap-2"><i class="fas fa-image text-gray-400"></i> هوية الموقع</h3>
                    <div class="flex gap-2 items-center bg-gray-50 dark:bg-[#0f172a] p-2 rounded-xl border border-gray-200 dark:border-gray-700">
                         <input type="file" id="logoUploader" accept="image/*" class="text-xs dark:text-white w-full file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-xs file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
                         <button onclick="app.updateLogo()" class="bg-blue-600 text-white px-4 py-2 rounded-lg text-xs font-bold hover:bg-blue-700 whitespace-nowrap">حفظ</button>
                    </div>
                </div>
            </div>

            <!-- Monitors Grid -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                <!-- Login Monitor -->
                <div class="bg-white dark:bg-[#1e293b] p-6 rounded-[2rem] shadow-lg border border-gray-100 dark:border-gray-700">
                    <h3 class="text-lg font-bold mb-4 dark:text-white flex items-center gap-2"><i class="fas fa-network-wired text-indigo-500"></i> سجل الدخول الحي</h3>
                    <div id="loginLogsList" class="space-y-2 max-h-48 overflow-y-auto custom-scrollbar text-xs">
                        <p class="text-gray-400 text-center">جاري تحميل السجل...</p>
                    </div>
                </div>

                <!-- Live Attendance (Restored) -->
                <div class="bg-white dark:bg-[#1e293b] p-6 rounded-[2rem] shadow-lg border border-gray-100 dark:border-gray-700">
                    <h3 class="text-lg font-bold mb-4 dark:text-white flex items-center gap-2"><i class="fas fa-satellite-dish text-green-500"></i> المتواجدون الآن (Live)</h3>
                    <div id="liveAttendanceList" class="space-y-2 max-h-48 overflow-y-auto custom-scrollbar text-xs">
                        <p class="text-gray-400 text-center py-4 bg-gray-50 dark:bg-[#0f172a] rounded-xl">لا يوجد أحد في الميدان حالياً</p>
                    </div>
                </div>
            </div>

            <!-- NEW: Admin Daily Approved Roster Section -->
            <div class="bg-white dark:bg-[#1e293b] p-6 rounded-[2rem] shadow-lg border-t-4 border-green-500 mt-8">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="font-bold text-lg dark:text-white flex items-center gap-2">
                        <i class="fas fa-calendar-check text-green-500"></i> جدول المناوبات المعتمد
                    </h3>
                    <div class="flex gap-2">
                         <input type="date" id="adminRosterPicker" onchange="app.renderAdminRoster(this.value)" class="bg-gray-100 dark:bg-[#0f172a] dark:text-white text-xs p-2 rounded-lg border dark:border-gray-700 outline-none">
                         <button onclick="app.exportDailyRoster()" class="bg-blue-600 text-white px-3 py-1 rounded-lg text-xs font-bold hover:bg-blue-700"><i class="fas fa-download"></i> تحميل القائمة</button>
                    </div>
                </div>
                <div id="adminApprovedRosterGrid" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
                    <p class="col-span-full text-center text-gray-400 text-xs py-4">جاري تحميل الجدول...</p>
                </div>
            </div>

            <!-- Management Tools -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <!-- Exceptional Shifts -->
                <div class="bg-white dark:bg-[#1e293b] p-5 rounded-[2rem] shadow-lg">
                    <h3 class="text-sm font-bold mb-3 dark:text-white text-orange-500">الدوام الاستثنائي</h3>
                    <div class="flex gap-2 mb-3">
                        <input type="date" id="exceptionDate" class="p-2 rounded-lg bg-gray-50 dark:bg-[#0f172a] dark:text-white text-xs w-full border dark:border-gray-700">
                        <button onclick="app.addExceptionDate()" class="bg-orange-500 text-white px-3 rounded-lg text-xs font-bold"><i class="fas fa-plus"></i></button>
                    </div>
                    <div id="exceptionList" class="space-y-1 text-xs text-gray-500 dark:text-gray-400 max-h-24 overflow-y-auto"></div>
                </div>

                <!-- Vehicle Status -->
                <div class="bg-white dark:bg-[#1e293b] p-5 rounded-[2rem] shadow-lg">
                    <h3 class="text-sm font-bold mb-3 dark:text-white text-teal-500">الآليات</h3>
                    <div id="vehicleList" class="space-y-2 mb-3 max-h-24 overflow-y-auto custom-scrollbar"></div>
                    <div class="flex gap-2">
                        <input type="text" id="vehName" placeholder="الآلية" class="p-2 rounded-lg bg-gray-50 dark:bg-[#0f172a] dark:text-white text-xs w-1/3 border dark:border-gray-700">
                        <select id="vehStatus" class="p-2 rounded-lg bg-gray-50 dark:bg-[#0f172a] dark:text-white text-xs w-1/3 border dark:border-gray-700"><option value="جاهزة">جاهزة</option><option value="صيانة">صيانة</option></select>
                        <button onclick="app.addVehicleStatus()" class="bg-teal-500 text-white px-3 rounded-lg text-xs font-bold">تحديث</button>
                    </div>
                </div>
                
                <!-- Training Mgmt -->
                <div class="bg-white dark:bg-[#1e293b] p-5 rounded-[2rem] shadow-lg">
                    <h3 class="text-sm font-bold mb-3 dark:text-white text-purple-500">الدورات</h3>
                    <div class="flex gap-2 mb-3">
                        <input type="text" id="newCourseTitle" placeholder="اسم الدورة" class="flex-grow p-2 rounded-lg bg-gray-50 dark:bg-[#0f172a] dark:text-white text-xs border dark:border-gray-700">
                        <button onclick="app.addCourse()" class="bg-purple-500 text-white px-3 rounded-lg text-xs font-bold"><i class="fas fa-plus"></i></button>
                    </div>
                    <div id="adminCoursesList" class="space-y-2 text-xs"></div>
                </div>
            </div>

            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                <div class="bg-white dark:bg-[#1e293b] p-5 rounded-2xl shadow-sm border border-gray-100 dark:border-gray-700"><h4 class="text-xs text-gray-500 font-bold mb-1">الميدان</h4><div class="text-2xl font-black text-green-600" id="rosterCount">0</div></div>
                <div class="bg-white dark:bg-[#1e293b] p-5 rounded-2xl shadow-sm border border-gray-100 dark:border-gray-700"><h4 class="text-xs text-gray-500 font-bold mb-1">العدد الكلي</h4><div class="text-2xl font-black text-slate-700 dark:text-white" id="totalUsersCount">0</div></div>
                <div class="bg-white dark:bg-[#1e293b] p-5 rounded-2xl shadow-sm border border-gray-100 dark:border-gray-700"><h4 class="text-xs text-gray-500 font-bold mb-1">إنذارات</h4><div class="text-2xl font-black text-red-500" id="warningsCount">0</div></div>
                <div class="bg-white dark:bg-[#1e293b] p-5 rounded-2xl shadow-sm border border-gray-100 dark:border-gray-700 flex flex-col justify-center gap-2">
                    <button onclick="app.exportPDF('shifts')" class="bg-blue-50 dark:bg-blue-900/30 text-blue-600 dark:text-blue-400 text-[10px] font-bold py-1.5 rounded hover:bg-blue-100 dark:hover:bg-blue-900/50 transition">كشف المناوبات</button>
                    <button onclick="app.exportPDF('verified')" class="bg-green-50 dark:bg-green-900/30 text-green-600 dark:text-green-400 text-[10px] font-bold py-1.5 rounded hover:bg-green-100 dark:hover:bg-green-900/50 transition">الساعات المعتمدة</button>
                </div>
            </div>
            
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <div class="bg-white dark:bg-[#1e293b] p-6 rounded-[2rem] shadow-lg lg:col-span-1">
                    <h3 class="font-bold text-lg mb-4 dark:text-white">الاقتراحات</h3>
                    <div id="adminSuggestionsList" class="space-y-2 max-h-60 overflow-y-auto custom-scrollbar text-xs"></div>
                </div>

                <div class="bg-white dark:bg-[#1e293b] rounded-[2rem] p-6 shadow-lg lg:col-span-2">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="font-bold text-lg dark:text-white">قائمة النشامى</h3>
                        <div class="flex gap-2">
                             <button onclick="app.openBulkGrantModal()" class="bg-green-600 hover:bg-green-700 text-white px-3 py-1.5 rounded-lg text-xs font-bold transition flex items-center gap-1"><i class="fas fa-gift"></i> منح جماعي</button>
                             <input type="text" oninput="app.filterUsers(this.value)" placeholder="بحث سريع..." class="bg-gray-50 dark:bg-[#0f172a] dark:text-white text-xs p-2.5 rounded-lg outline-none w-48 border border-gray-200 dark:border-gray-700 focus:border-blue-500 transition">
                        </div>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-right text-xs dark:text-gray-300">
                            <thead class="bg-gray-50 dark:bg-[#0f172a] text-gray-500 dark:text-gray-400 font-bold uppercase tracking-wider">
                                <tr>
                                    <th class="p-3 rounded-r-lg w-10 text-center"><input type="checkbox" onclick="app.toggleSelectAll(this)" class="rounded border-gray-300 text-blue-600 focus:ring-blue-500 cursor-pointer"></th>
                                    <th class="p-3">الاسم</th>
                                    <th class="p-3">المعرف</th>
                                    <th class="p-3">الرصيد</th>
                                    <th class="p-3 rounded-l-lg">إجراء</th>
                                </tr>
                            </thead>
                            <tbody id="fullUsersTable" class="divide-y divide-gray-100 dark:divide-gray-700"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </section>

        <!-- Registration Section -->
        <section id="registration" class="fade-in hidden max-w-2xl mx-auto py-20 text-right">
            <div class="bg-white dark:bg-[#1e293b] rounded-[2.5rem] shadow-2xl p-10 border border-gray-200 dark:border-gray-700">
                <h2 class="text-3xl font-black text-center mb-2 text-slate-800 dark:text-white">انضم للفريق</h2>
                <p class="text-center text-gray-400 text-sm mb-8">كن جزءاً من نخبة نشامى الوطن</p>
                <form onsubmit="app.handleRegistration(event)" class="space-y-4">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <input type="text" id="regName" placeholder="الاسم الرباعي" class="input-field w-full p-4 rounded-xl outline-none border bg-gray-50 dark:bg-[#0f172a] dark:text-white" required>
                        <input type="text" id="regId" placeholder="الرقم الوطني" class="input-field w-full p-4 rounded-xl outline-none border bg-gray-50 dark:bg-[#0f172a] dark:text-white" required>
                    </div>
                    <input type="password" id="regPass" placeholder="كلمة المرور" class="input-field w-full p-4 rounded-xl outline-none border bg-gray-50 dark:bg-[#0f172a] dark:text-white" required>
                    <button type="submit" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-4 rounded-xl shadow-lg transition transform active:scale-95">إرسال طلب الانضمام</button>
                </form>
            </div>
        </section>

    </main>

    <!-- Chat Widget -->
    <div id="chatWidget" class="fixed bottom-6 right-6 z-50 hidden">
        <button onclick="app.toggleChat()" class="bg-jcd-blue hover:bg-blue-800 text-white w-14 h-14 rounded-full shadow-2xl flex items-center justify-center text-2xl hover:scale-110 transition relative ring-4 ring-white/10"><i class="fas fa-comments"></i></button>
        <div id="chatWindow" class="hidden absolute bottom-16 right-0 w-80 bg-white dark:bg-[#1e293b] rounded-2xl shadow-2xl border border-gray-200 dark:border-gray-700 flex flex-col h-[28rem] overflow-hidden transform origin-bottom-right transition-all">
            <div class="bg-jcd-blue p-4 text-white font-bold text-sm flex justify-between items-center">
                <div class="flex items-center gap-2"><div class="w-2 h-2 bg-green-400 rounded-full animate-pulse"></div> غرفة العمليات</div>
                <button onclick="app.toggleChat()" class="hover:bg-white/20 rounded p-1"><i class="fas fa-times"></i></button>
            </div>
            <div id="chatMessages" class="flex-grow p-4 overflow-y-auto bg-gray-50 dark:bg-[#0f172a] space-y-3 text-xs"></div>
            <div class="p-3 border-t dark:border-gray-700 bg-white dark:bg-[#1e293b] flex gap-2">
                <input type="text" id="chatInput" class="flex-grow p-3 rounded-xl bg-gray-100 dark:bg-[#0f172a] dark:text-white text-xs outline-none border border-transparent focus:border-jcd-blue transition" placeholder="اكتب رسالة...">
                <button onclick="app.sendChatMessage()" class="text-blue-600 dark:text-blue-400 hover:bg-blue-50 dark:hover:bg-blue-900/30 p-3 rounded-xl transition"><i class="fas fa-paper-plane"></i></button>
            </div>
        </div>
    </div>

    <!-- Notifications Modal -->
    <div id="notificationsModal" class="hidden fixed inset-0 z-[300] bg-black/20 backdrop-blur-sm flex items-start justify-end p-4">
        <div class="bg-white dark:bg-[#1e293b] rounded-2xl shadow-2xl w-80 p-0 mt-16 animate-float border border-gray-100 dark:border-gray-700 overflow-hidden">
            <div class="flex justify-between items-center p-4 border-b dark:border-gray-700 bg-gray-50 dark:bg-[#0f172a]">
                 <h3 class="font-bold text-sm dark:text-white">الإشعارات</h3>
                 <button onclick="document.getElementById('notificationsModal').classList.add('hidden')" class="text-gray-400 hover:text-red-500"><i class="fas fa-times"></i></button>
            </div>
            <div id="notifList" class="max-h-80 overflow-y-auto"></div>
        </div>
    </div>

    <!-- Suggestions Modal -->
    <div id="suggestionsModal" class="hidden fixed inset-0 z-[250] bg-black/80 backdrop-blur-sm flex items-center justify-center fade-in p-4">
        <div class="bg-white dark:bg-[#1e293b] rounded-[2rem] shadow-2xl w-full max-w-md p-8 relative border-t-8 border-yellow-500">
            <h3 class="text-xl font-black mb-4 dark:text-white">صندوق الاقتراحات</h3>
            <textarea id="suggestionText" class="input-field w-full p-4 bg-gray-50 dark:bg-[#0f172a] dark:text-white rounded-xl text-sm h-32 resize-none outline-none border border-gray-200 dark:border-gray-700" placeholder="اكتب مقترحك أو شكواك هنا بكل سرية..."></textarea>
            <div class="flex gap-3 mt-6">
                <button onclick="app.submitSuggestion()" class="flex-grow bg-yellow-500 hover:bg-yellow-600 text-black font-black py-3 rounded-xl text-sm transition">إرسال</button>
                <button onclick="document.getElementById('suggestionsModal').classList.add('hidden')" class="px-6 py-3 rounded-xl font-bold text-gray-500 hover:bg-gray-100 dark:hover:bg-gray-700 transition text-sm">إلغاء</button>
            </div>
        </div>
    </div>

    <!-- Add Nashmi Modal -->
    <div id="addNashmiModal" class="hidden fixed inset-0 z-[250] bg-black/80 backdrop-blur-sm flex items-center justify-center fade-in p-4">
        <div class="bg-white dark:bg-[#1e293b] rounded-[2rem] shadow-2xl w-full max-w-md p-8 relative border-t-8 border-blue-500">
            <h3 class="text-xl font-black mb-6 dark:text-white">إضافة نشمي جديد</h3>
            <div class="space-y-4">
                <input type="text" id="newVolName" placeholder="الاسم الرباعي" class="input-field w-full p-3.5 bg-gray-50 dark:bg-[#0f172a] dark:text-white rounded-xl text-sm outline-none border dark:border-gray-700">
                <input type="text" id="newVolId" placeholder="المعرف (ID)" class="input-field w-full p-3.5 bg-gray-50 dark:bg-[#0f172a] dark:text-white rounded-xl text-sm outline-none border dark:border-gray-700">
                <input type="text" id="newVolPass" placeholder="كلمة المرور" class="input-field w-full p-3.5 bg-gray-50 dark:bg-[#0f172a] dark:text-white rounded-xl text-sm outline-none border dark:border-gray-700">
                
                <!-- NEW: Role Selection -->
                <select id="newVolRole" class="input-field w-full p-3.5 bg-gray-50 dark:bg-[#0f172a] dark:text-white rounded-xl text-sm outline-none border dark:border-gray-700">
                    <option value="volunteer">متطوع</option>
                    <option value="admin">إدارة</option>
                </select>

                <div class="flex gap-3 mt-2">
                    <button onclick="app.adminAddUser()" class="flex-grow bg-blue-600 text-white font-bold py-3 rounded-xl text-sm hover:bg-blue-700">إضافة</button>
                    <button onclick="document.getElementById('addNashmiModal').classList.add('hidden')" class="w-1/3 bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-300 font-bold py-3 rounded-xl text-sm">إلغاء</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bulk Grant Modal -->
    <div id="bulkGrantModal" class="hidden fixed inset-0 z-[250] bg-black/80 backdrop-blur-sm flex items-center justify-center fade-in p-4">
        <div class="bg-white dark:bg-[#1e293b] rounded-[2rem] shadow-2xl w-full max-w-md p-8 relative border-t-8 border-green-500">
            <h3 class="text-xl font-black mb-4 dark:text-white">منح جماعي</h3>
            <p class="text-sm text-gray-500 mb-4" id="bulkSelectedCount">سيتم المنح لـ 0 شخص</p>
            <div class="space-y-3">
                 <div class="flex gap-2">
                     <input type="number" id="bulkPoints" placeholder="النقاط" class="w-1/2 p-2.5 bg-gray-50 dark:bg-[#0f172a] dark:text-white rounded-lg text-xs border dark:border-gray-700 outline-none">
                     <input type="number" id="bulkHours" placeholder="الساعات" class="w-1/2 p-2.5 bg-gray-50 dark:bg-[#0f172a] dark:text-white rounded-lg text-xs border dark:border-gray-700 outline-none">
                 </div>
                 <input type="text" id="bulkReason" placeholder="سبب المنح (مثال: نشاط ميداني)" class="w-full p-2.5 bg-gray-50 dark:bg-[#0f172a] dark:text-white rounded-lg text-xs border dark:border-gray-700 outline-none">
                 <div class="flex gap-3 mt-2">
                    <button onclick="app.submitBulkAction()" class="flex-grow bg-green-600 text-white font-bold py-3 rounded-xl text-sm hover:bg-green-700">تنفيذ</button>
                    <button onclick="document.getElementById('bulkGrantModal').classList.add('hidden')" class="w-1/3 bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-300 font-bold py-3 rounded-xl text-sm">إلغاء</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Admin Tools Modal -->
    <div id="adminToolsModal" class="hidden fixed inset-0 z-[250] bg-black/80 backdrop-blur-sm flex items-center justify-center fade-in p-4">
        <div class="bg-white dark:bg-[#1e293b] rounded-[2rem] shadow-2xl w-full max-w-md p-8 relative border-t-8 border-jcd-blue max-h-[90vh] overflow-y-auto custom-scrollbar">
            <h3 class="text-2xl font-black text-slate-800 dark:text-white mb-2">أدوات الإدارة</h3>
            <p id="toolUserName" class="text-sm text-blue-600 dark:text-blue-400 font-bold mb-6 bg-blue-50 dark:bg-blue-900/20 py-2 px-4 rounded-lg inline-block"></p>
            <input type="hidden" id="toolUserId">
            
            <!-- Edit User Details -->
            <div class="mb-6 border-b border-gray-100 dark:border-gray-700 pb-6 bg-gray-50 dark:bg-[#0f172a] p-5 rounded-2xl">
                <h4 class="font-bold text-sm mb-4 text-blue-600 dark:text-blue-300 flex items-center"><i class="fas fa-user-edit ml-2"></i> البيانات الأساسية</h4>
                <div class="space-y-3">
                    <input type="text" id="editNameAdmin" placeholder="تعديل الاسم" class="input-field w-full p-2.5 rounded-lg text-xs outline-none border dark:border-gray-700 dark:bg-[#1e293b] dark:text-white">
                    <input type="text" id="editPassAdmin" placeholder="تعديل كلمة المرور" class="input-field w-full p-2.5 rounded-lg text-xs outline-none border dark:border-gray-700 dark:bg-[#1e293b] dark:text-white">
                    <div class="relative">
                        <input type="text" id="editIdAdmin" placeholder="تعديل المعرف" class="input-field w-full p-2.5 rounded-lg text-xs outline-none border border-red-200 bg-red-50 text-red-800 dark:bg-red-900/20 dark:text-red-200 dark:border-red-900/50">
                        <i class="fas fa-exclamation-circle absolute left-3 top-3 text-red-400 text-xs"></i>
                    </div>
                    <button onclick="app.saveAdminUserEdit()" class="w-full bg-blue-600 text-white font-bold py-2.5 rounded-lg text-xs hover:bg-blue-700 shadow-lg shadow-blue-600/20 mt-2">حفظ التعديلات</button>
                </div>
            </div>

            <div class="mb-6 border-b border-gray-100 dark:border-gray-700 pb-6">
                 <h4 class="font-bold text-sm mb-3 text-green-600 flex items-center"><i class="fas fa-plus-circle ml-2"></i> الحوافز (نقاط/ساعات)</h4>
                 <div class="flex gap-2 mb-3">
                     <input type="number" id="manualPoints" placeholder="النقاط" class="w-1/2 p-2.5 bg-gray-50 dark:bg-[#0f172a] dark:text-white rounded-lg text-xs border dark:border-gray-700 outline-none focus:border-green-500">
                     <input type="number" id="manualHours" placeholder="الساعات" class="w-1/2 p-2.5 bg-gray-50 dark:bg-[#0f172a] dark:text-white rounded-lg text-xs border dark:border-gray-700 outline-none focus:border-green-500">
                 </div>
                 <button onclick="app.grantManualPointsHours()" class="w-full bg-green-600 text-white font-bold py-2.5 rounded-lg text-xs hover:bg-green-700 shadow-lg shadow-green-600/20">منح وتوثيق</button>
            </div>

            <!-- Warning Tab -->
            <div class="mb-6 border-b border-gray-100 dark:border-gray-700 pb-6">
                <h4 class="font-bold text-sm mb-3 text-red-500 flex items-center"><i class="fas fa-gavel ml-2"></i> الإجراءات التأديبية</h4>
                <input type="text" id="warningReason" placeholder="سبب الإنذار..." class="w-full p-2.5 bg-gray-50 dark:bg-[#0f172a] dark:text-white rounded-lg text-xs mb-3 outline-none border border-red-200 dark:border-red-900/30 focus:border-red-500">
                <button onclick="app.issueManualWarning()" class="w-full bg-red-50 text-red-600 border border-red-200 font-bold py-2.5 rounded-lg text-xs hover:bg-red-100 dark:bg-red-900/20 dark:text-red-300 dark:border-red-900/50 dark:hover:bg-red-900/40">إصدار إنذار</button>
            </div>

            <!-- Ban Control -->
            <div class="mb-6">
                 <h4 class="font-bold text-sm mb-3 text-slate-500 dark:text-slate-400 flex items-center"><i class="fas fa-ban ml-2"></i> حالة الحساب</h4>
                 <div class="flex gap-2">
                     <button onclick="app.adminAction(document.getElementById('toolUserId').value, 'ban')" class="flex-grow bg-slate-800 text-white font-bold py-2.5 rounded-lg text-xs hover:bg-black">تجميد الحساب</button>
                     <button onclick="app.adminAction(document.getElementById('toolUserId').value, 'unban')" class="flex-grow bg-white border border-gray-300 text-gray-700 font-bold py-2.5 rounded-lg text-xs hover:bg-gray-50 dark:bg-[#0f172a] dark:text-white dark:border-gray-600 dark:hover:bg-[#1e293b]">تنشيط</button>
                 </div>
            </div>
            
            <button onclick="document.getElementById('adminToolsModal').classList.add('hidden')" class="w-full bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-300 py-3 rounded-xl font-bold text-xs hover:bg-gray-200 dark:hover:bg-gray-600 transition">إغلاق النافذة</button>
        </div>
    </div>

    <!-- Profile Edit Modal (For Volunteer) -->
    <div id="profileEditModal" class="hidden fixed inset-0 z-[250] bg-black/80 backdrop-blur-sm flex items-center justify-center fade-in p-4">
        <div class="bg-white dark:bg-[#1e293b] rounded-[2rem] shadow-2xl w-full max-w-md p-8 relative border-t-8 border-jcd-blue">
            <h3 class="text-xl font-black mb-6 dark:text-white">تعديل بياناتي</h3>
            <div class="space-y-5">
                <div>
                    <label class="text-xs font-bold text-gray-500 mb-2 block">تغيير الصورة الشخصية</label>
                    <div class="flex items-center gap-2">
                        <input type="file" id="avatarUpload" accept="image/*" class="block w-full text-xs text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-xs file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100 bg-gray-50 dark:bg-[#0f172a] rounded-lg border dark:border-gray-700 p-1">
                    </div>
                </div>
                <div>
                    <label class="text-xs font-bold text-gray-500 mb-2 block">تغيير كلمة المرور</label>
                    <input type="password" id="newPassVol" placeholder="كلمة المرور الجديدة" class="input-field w-full p-3.5 bg-gray-50 dark:bg-[#0f172a] dark:text-white rounded-xl text-xs outline-none border dark:border-gray-700">
                </div>
                <div>
                    <label class="text-xs font-bold text-gray-500 mb-2 block">نبذة عني</label>
                    <textarea id="newBioVol" class="input-field w-full p-3.5 bg-gray-50 dark:bg-[#0f172a] dark:text-white rounded-xl text-xs h-24 resize-none outline-none border dark:border-gray-700"></textarea>
                </div>
                <div class="flex gap-3 pt-2">
                    <button onclick="app.updateProfile()" class="flex-grow bg-jcd-blue text-white py-3 rounded-xl font-bold text-xs hover:bg-blue-900 transition">حفظ التعديلات</button>
                    <button onclick="document.getElementById('profileEditModal').classList.add('hidden')" class="w-1/3 bg-gray-100 dark:bg-gray-700 text-gray-500 dark:text-gray-300 py-3 rounded-xl font-bold text-xs hover:bg-gray-200 dark:hover:bg-gray-600 transition">إلغاء</button>
                </div>
            </div>
        </div>
    </div>

    <!-- ID Card & Profile Modals -->
    <div id="idCardModal" class="hidden fixed inset-0 z-50 bg-black/90 flex items-center justify-center p-4 backdrop-blur-md">
        <div class="bg-white dark:bg-gray-800 rounded-2xl w-full max-w-sm overflow-hidden relative shadow-2xl transform scale-100 transition-all">
            <button onclick="document.getElementById('idCardModal').classList.add('hidden')" class="absolute top-3 left-3 z-20 text-white bg-black/40 hover:bg-black/60 rounded-full w-8 h-8 flex items-center justify-center transition"><i class="fas fa-times"></i></button>
            <div id="digitalIDCard" class="bg-gradient-to-b from-[#1e3a8a] to-[#0f172a] p-8 text-center text-white relative h-[480px] flex flex-col items-center border-[6px] border-white dark:border-gray-700">
                <div class="absolute top-4 right-4 w-12 h-12 bg-white/10 rounded-full blur-xl"></div>
                <img src="https://upload.wikimedia.org/wikipedia/commons/e/e0/Jordan_Civil_Defence_Logo.png" class="h-24 mb-4 drop-shadow-xl filter brightness-110">
                <h2 class="text-3xl font-black mb-1 tracking-tight">الدفاع المدني</h2>
                <p class="text-[10px] text-jcd-gold mb-8 tracking-[0.2em] uppercase font-bold">بطاقة متطوع رسمية</p>
                <div class="relative w-36 h-36 mb-6">
                    <div class="absolute inset-0 border-2 border-jcd-gold rounded-2xl transform rotate-3"></div>
                    <div id="idCardAvatar" class="w-full h-full rounded-2xl border-2 border-white bg-gray-800 relative z-10 shadow-lg flex items-center justify-center text-5xl font-black text-white"></div>
                </div>
                <h3 id="idCardName" class="text-2xl font-bold mb-1"></h3>
                <p id="idCardNum" class="font-mono text-sm opacity-60 mb-4 tracking-widest"></p>
                <p id="idCardRank" class="px-6 py-1.5 bg-white/10 backdrop-blur-sm border border-white/20 rounded-full text-xs font-bold text-jcd-gold"></p>
                <div class="mt-auto w-full pt-4 border-t border-white/10 flex justify-between items-end text-[9px] opacity-50">
                    <span>مديرية المفرق</span>
                    <span>2026</span>
                </div>
            </div>
            <div class="p-5 bg-gray-50 dark:bg-[#0f172a] flex justify-center"><button onclick="app.printID()" class="bg-blue-600 hover:bg-blue-700 text-white px-8 py-2.5 rounded-xl text-sm font-bold shadow-lg shadow-blue-600/30 transition flex items-center gap-2"><i class="fas fa-download"></i> تحميل البطاقة</button></div>
        </div>
    </div>

    <div id="fullProfileModal" class="hidden fixed inset-0 z-[200] bg-black/90 flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white dark:bg-[#1e293b] w-full max-w-4xl rounded-[2.5rem] p-8 relative max-h-[90vh] overflow-y-auto shadow-2xl border border-gray-800">
            <button onclick="document.getElementById('fullProfileModal').classList.add('hidden')" class="absolute top-6 left-6 text-gray-400 hover:text-white transition"><i class="fas fa-times text-2xl"></i></button>
            <h3 class="text-3xl font-black mb-8 dark:text-white border-b border-gray-100 dark:border-gray-700 pb-4">الملف الشخصي الشامل</h3>
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <div class="lg:col-span-1">
                    <div class="text-center mb-6">
                        <div class="relative w-32 h-32 mx-auto mb-4">
                            <div class="absolute inset-0 bg-jcd-gold rounded-full blur opacity-20"></div>
                            <div id="fpAvatar" class="w-full h-full rounded-full border-4 border-white dark:border-gray-700 shadow-xl relative z-10 bg-gray-800 flex items-center justify-center text-4xl font-black text-white"></div>
                        </div>
                        <h4 id="fpName" class="font-black text-xl dark:text-white mb-1"></h4>
                        <span id="fpRank" class="text-sm text-jcd-gold font-bold bg-yellow-500/10 px-3 py-1 rounded-full"></span>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-3 mb-6">
                        <div class="bg-blue-50 dark:bg-blue-900/20 p-4 rounded-2xl text-center border border-blue-100 dark:border-blue-900/30">
                            <span class="block text-2xl font-black text-blue-600 dark:text-blue-400" id="fpPoints">0</span>
                            <span class="text-[10px] text-gray-500 dark:text-blue-200 font-bold uppercase">نقاط</span>
                        </div>
                        <div class="bg-green-50 dark:bg-green-900/20 p-4 rounded-2xl text-center border border-green-100 dark:border-green-900/30">
                            <span class="block text-2xl font-black text-green-600 dark:text-green-400" id="fpHours">0</span>
                            <span class="text-[10px] text-gray-500 dark:text-green-200 font-bold uppercase">ساعة</span>
                        </div>
                    </div>
                    
                    <button onclick="app.printFullCertificate()" class="w-full bg-gradient-to-r from-jcd-gold to-yellow-500 text-black font-bold py-3.5 rounded-xl mb-6 shadow-lg shadow-yellow-500/20 hover:scale-105 transition flex items-center justify-center gap-2"><i class="fas fa-certificate"></i> شهادة الخبرة</button>
                    
                    <div class="bg-gray-50 dark:bg-[#0f172a] p-5 rounded-2xl border border-gray-100 dark:border-gray-700">
                        <h5 class="font-bold text-xs mb-3 dark:text-white text-gray-400 uppercase tracking-wide">الأوسمة</h5>
                        <div id="fpBadges" class="flex flex-wrap gap-2"></div>
                    </div>
                </div>
                
                <div class="lg:col-span-2 space-y-6">
                    <div class="bg-white dark:bg-[#0f172a] p-6 rounded-2xl border border-gray-100 dark:border-gray-700">
                        <h5 class="font-bold text-sm mb-4 dark:text-white flex items-center gap-2"><i class="fas fa-history text-blue-500"></i> النشاط الأخير</h5>
                        <div id="fpHistory" class="space-y-3 text-sm max-h-60 overflow-y-auto custom-scrollbar pr-2 dark:text-gray-300"></div>
                    </div>
                    
                    <div class="bg-white dark:bg-[#0f172a] p-6 rounded-2xl border border-gray-100 dark:border-gray-700">
                        <h5 class="font-bold text-sm mb-4 dark:text-white flex items-center gap-2"><i class="fas fa-graduation-cap text-purple-500"></i> الدورات المنجزة</h5>
                        <ul id="fpCourses" class="space-y-2 text-sm dark:text-gray-300"></ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Hidden Certificate Template -->
    <div id="certificateTemplate" class="hidden p-12 bg-white text-black font-serif text-center border-[20px] border-double border-[#1e3a8a] w-[800px] mx-auto relative">
        <div class="absolute inset-0 border border-jcd-gold m-4 pointer-events-none"></div>
        <div class="absolute top-0 left-0 w-32 h-32 border-t-4 border-l-4 border-jcd-gold m-8"></div>
        <div class="absolute bottom-0 right-0 w-32 h-32 border-b-4 border-r-4 border-jcd-gold m-8"></div>
        
        <img src="https://upload.wikimedia.org/wikipedia/commons/e/e0/Jordan_Civil_Defence_Logo.png" class="h-28 mx-auto mb-8 drop-shadow-lg">
        <h1 class="text-5xl font-black mb-4 text-[#1e3a8a] tracking-tight">شهادة شكر وتقدير</h1>
        <div class="w-24 h-1 bg-jcd-gold mx-auto mb-8"></div>
        
        <p class="text-xl mb-2 font-bold text-gray-600">تتشرف مديرية دفاع مدني المفرق بمنح</p>
        <h2 id="certName" class="text-4xl font-black mb-6 text-[#dc2626] py-2"></h2>
        
        <p class="text-xl mb-8 leading-loose text-gray-800 max-w-2xl mx-auto">هذه الشهادة تقديراً لجهوده المخلصة وعطائه المستمر في خدمة الوطن، <span id="certDetails" class="font-bold"></span>.</p>
        
        <p class="text-lg mb-16 text-gray-500 italic">"سائلين المولى عز وجل أن يوفقه لخدمة الأردن الغالي في ظل القيادة الهاشمية الحكيمة"</p>
        
        <div class="flex justify-between px-16 mt-auto">
            <div class="text-center">
                <p class="font-bold mb-2 text-gray-400 text-sm">التاريخ</p>
                <p id="certDate" class="font-bold text-lg"></p>
            </div>
            <div class="text-center">
                <p class="font-bold mb-4 text-[#1e3a8a]">مدير الدفاع المدني</p>
                <div class="h-16 w-32 bg-gray-100 flex items-center justify-center text-gray-300 italic font-cursive">التوقيع الرسمي</div>
            </div>
        </div>
    </div>

    <!-- Hidden System Report Template -->
    <div id="systemReportTemplate" class="hidden p-10 bg-white text-black font-sans">
        <div class="flex justify-between items-center border-b-4 border-black pb-6 mb-8">
            <img src="https://upload.wikimedia.org/wikipedia/commons/e/e0/Jordan_Civil_Defence_Logo.png" class="h-16">
            <div class="text-center">
                <h1 class="text-2xl font-bold">المملكة الأردنية الهاشمية</h1>
                <h2 class="text-xl">الدفاع المدني - مديرية المفرق</h2>
                <h3 class="text-lg font-bold mt-2">التقرير الإداري الشامل</h3>
            </div>
            <div class="text-left text-xs">
                <p>التاريخ: <span id="sysReportDate"></span></p>
                <p>رقم التقرير: #SYS-2026</p>
            </div>
        </div>

        <div class="grid grid-cols-2 gap-6 mb-8">
             <div class="border border-gray-300 p-4 rounded bg-gray-50">
                 <h3 class="font-bold border-b border-gray-300 pb-2 mb-2">ملخص الإحصائيات</h3>
                 <p id="repUserCount" class="py-1"></p>
                 <p id="repActiveCount" class="py-1"></p>
             </div>
             <div class="border border-gray-300 p-4 rounded bg-gray-50">
                 <h3 class="font-bold border-b border-gray-300 pb-2 mb-2">أبرز الملاحظات</h3>
                 <ul id="repSuggestions" class="text-sm list-disc pr-5 space-y-1"></ul>
             </div>
        </div>
        
        <h3 class="font-bold mb-3 text-lg bg-black text-white p-2">سجل حركة النظام (Login Logs)</h3>
        <table class="w-full text-sm border-collapse border border-gray-300 mb-8">
            <thead class="bg-gray-100">
                <tr>
                    <th class="p-3 border border-gray-300 text-right">اسم المستخدم</th>
                    <th class="p-3 border border-gray-300 text-right">نوع الحركة</th>
                    <th class="p-3 border border-gray-300 text-right">التوقيت</th>
                </tr>
            </thead>
            <tbody id="repLoginLogs"></tbody>
        </table>
        
        <div class="mt-12 text-center text-xs text-gray-500 border-t pt-4">
            تم استخراج هذا التقرير آلياً من نظام "نشامى المفرق" الرقمي ولا يحتاج لتوقيع.
        </div>
    </div>

    <!-- Logic Engine -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, updateDoc, onSnapshot, addDoc, deleteDoc, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // -----------------------------------------------------------------------------------------
        // --- منطقة الإعدادات ---
        // -----------------------------------------------------------------------------------------
        const YOUR_FIREBASE_CONFIG = {
            apiKey: "AIzaSyCzbJ_BCreCrOgkDq_zCdJ103FCDcguoXA",
            authDomain: "civil-defense-mafraq-b7b9d.firebaseapp.com",
            projectId: "civil-defense-mafraq-b7b9d",
            storageBucket: "civil-defense-mafraq-b7b9d.firebasestorage.app",
            messagingSenderId: "14265166108",
            appId: "1:14265166108:web:2f1ac0d4c89b2fe9cff2d9"
        };
        
        const YOUR_GEMINI_KEY = "AIzaSyBEMwEU2XqjyCfqKvlRrRRoAaqxTIXRSpQ"; 
        // -----------------------------------------------------------------------------------------

        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : YOUR_FIREBASE_CONFIG;
        const apiKey = typeof __app_id !== 'undefined' ? "" : YOUR_GEMINI_KEY; 
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'mafraq-diamond-v33-platinum-release'; 

        const fireApp = initializeApp(firebaseConfig);
        const auth = getAuth(fireApp);
        const db = getFirestore(fireApp);

        // --- FIXED STATIC USERS (Source of Truth) ---
        const STATIC_USERS = [
            { id: '101', name: 'معاذ الخوالدة', pass: '2026', role: 'admin', isOfficial: true },
            { id: '102', name: 'محمد المساعيد', pass: '2026', role: 'admin', isOfficial: true },
            { id: '1', name: 'مالك عليمات', pass: '4821', role: 'volunteer' },
            { id: '2', name: 'هدى', pass: '9253', role: 'volunteer' },
            { id: '3', name: 'معاذ الخوالدة', pass: '7741', role: 'volunteer' },
            { id: '4', name: 'حسام الحسبان', pass: '3320', role: 'volunteer' },
            { id: '5', name: 'إبراهيم سعود', pass: '5198', role: 'volunteer' },
            { id: '6', name: 'خولة نضال', pass: '6024', role: 'volunteer' },
            { id: '7', name: 'رسول الخزاعلة', pass: '8812', role: 'volunteer' },
            { id: '8', name: 'سلوى الصقور', pass: '1472', role: 'volunteer' },
            { id: '9', name: 'شرف الحراحشة', pass: '9630', role: 'volunteer' },
            { id: '10', name: 'عبد الرحمن يونس', pass: '2580', role: 'volunteer' },
            { id: '11', name: 'عمر ياسين', pass: '3691', role: 'volunteer' },
            { id: '12', name: 'امين المصري', pass: '7410', role: 'volunteer' },
            { id: '13', name: 'فرحان الخوالدة', pass: '8520', role: 'volunteer' },
            { id: '14', name: 'حور العرقان', pass: '9514', role: 'volunteer' },
            { id: '15', name: 'مدين الشرفات', pass: '7532', role: 'volunteer' },
            { id: '16', name: 'سند عليمات', pass: '1598', role: 'volunteer' },
            { id: '17', name: 'شهم الحسبان', pass: '3574', role: 'volunteer' },
            { id: '18', name: 'سجود عليمات', pass: '4568', role: 'volunteer' },
            { id: '19', name: 'يوسف دعجة', pass: '1238', role: 'volunteer' },
            { id: '20', name: 'بلقيس الكناني', pass: '9874', role: 'volunteer' },
            { id: '21', name: 'عهد الحسبان', pass: '6541', role: 'volunteer' },
            { id: '22', name: 'أرم', pass: '3214', role: 'volunteer' },
            { id: '23', name: 'اريج النعيمات', pass: '7890', role: 'volunteer' },
            { id: '24', name: 'عزيزة السقال', pass: '4125', role: 'volunteer' },
            { id: '25', name: 'باسل', pass: '6325', role: 'volunteer' },
            { id: '26', name: 'في', pass: '9654', role: 'volunteer' },
            { id: '27', name: 'حمدان عليمات', pass: '8521', role: 'volunteer' },
            { id: '28', name: 'ختام ابو قديري', pass: '7412', role: 'volunteer' },
            { id: '29', name: 'لارا العجلوني', pass: '3698', role: 'volunteer' },
            { id: '30', name: 'ميار الهواري', pass: '2587', role: 'volunteer' },
            { id: '31', name: 'ريتاج', pass: '1478', role: 'volunteer' },
            { id: '32', name: 'رويدة', pass: '9632', role: 'volunteer' },
            { id: '33', name: 'ربى', pass: '1596', role: 'volunteer' },
            { id: '34', name: 'سوار', pass: '7539', role: 'volunteer' },
            { id: '35', name: 'سندس عليمات', pass: '8523', role: 'volunteer' },
            { id: '38', name: 'رند العناسوة', pass: '3091', role: 'volunteer' }
        ];

        window.app = {
            data: { users: [], chats: [], currentUser: null, vehicles: [], courses: [], logs: [], suggestions: [], settings: { exceptions: [], announcements: [], logo: null } },
            map: null,
            selectedUsers: new Set(),

            async init() {
                if(localStorage.getItem('jcd_theme') === 'dark') document.documentElement.classList.add('dark');
                
                const statusEl = document.getElementById('connection-status');
                const dot = statusEl.querySelector('.status-dot');
                const text = statusEl.querySelector('span');

                try {
                    if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                        await signInWithCustomToken(auth, __initial_auth_token);
                    } else {
                        await signInAnonymously(auth);
                    }
                } catch (e) { 
                    console.error("Auth Error:", e);
                    dot.classList.replace('bg-gray-500', 'bg-red-500');
                    text.innerText = "خطأ في الاتصال (تأكد من تفعيل Auth)";
                }

                onAuthStateChanged(auth, (user) => { 
                    if (user) {
                        dot.classList.replace('bg-gray-500', 'bg-green-500');
                        text.innerText = "متصل بنجاح";
                        setTimeout(() => statusEl.style.opacity = '0', 3000);
                        app.setupListeners(); 
                    }
                });
            },

            setupListeners() {
                const cols = ['users', 'chats', 'vehicles', 'courses', 'logs', 'suggestions', 'settings'];
                cols.forEach(c => {
                    onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', c), (snap) => {
                        app.data[c] = [];
                        snap.forEach(d => app.data[c].push({ ...d.data(), _id: d.id }));
                        if(c === 'users') { 
                            app.syncStaticUsers(); 
                            app.checkSession(); app.renderUI(); 
                        }
                        if(c === 'settings') {
                            const mainSettings = app.data.settings.find(s => s.id === 'main');
                            if(mainSettings) {
                                if(mainSettings.exceptions) app.data.settings.exceptions = mainSettings.exceptions;
                                if(mainSettings.announcement) app.showAnnouncement(mainSettings.announcement);
                                if(mainSettings.logo) {
                                    const navLogo = document.getElementById('navLogo');
                                    const heroLogo = document.getElementById('heroLogo');
                                    if(navLogo) navLogo.src = mainSettings.logo;
                                    if(heroLogo) heroLogo.src = mainSettings.logo;
                                }
                            }
                        }
                        if(c === 'chats') app.renderChat();
                    }, (error) => console.log('Snapshot error:', error));
                });
            },

            async syncStaticUsers() {
                for (const u of STATIC_USERS) {
                    const existing = app.data.users.find(x => x.id === u.id);
                    if (!existing) {
                        try {
                            await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users', u.id), {
                                id: u.id, name: u.name, pass: u.pass,
                                role: u.role || 'volunteer', status: 'active', isOfficial: u.isOfficial || false,
                                stats: { points: 0, hours: 0 }, history: [], notifications: [], 
                                lastLogin: new Date().toISOString(), customBadges: [], warnings: [], shifts: []
                            });
                            console.log(`Synced user: ${u.name}`);
                        } catch(e) { console.error("Sync error:", e); }
                    }
                }
                await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'settings', 'main'), { exceptions: [], announcement: "", logo: null }, {merge: true});
            },

            getAvailableShiftDates() {
                const dates = [];
                const today = new Date();
                const exceptions = app.data.settings.exceptions || [];

                for(let i=1; i<=14; i++) {
                    const d = new Date(today);
                    d.setDate(today.getDate() + i);
                    const dayName = d.toLocaleDateString('en-US', {weekday: 'long'});
                    const dateStr = d.toLocaleDateString('en-CA'); 
                    
                    if (dayName === 'Monday' || dayName === 'Tuesday') {
                        dates.push({ date: dateStr, day: d.toLocaleDateString('ar-JO', {weekday:'long'}), type: 'regular' });
                    }
                }
                
                exceptions.forEach(ex => {
                      const exDate = new Date(ex);
                      if (exDate > today) {
                        dates.push({ date: ex, day: exDate.toLocaleDateString('ar-JO', {weekday:'long'}), type: 'exceptional' });
                      }
                });
                return dates.sort((a,b) => new Date(a.date) - new Date(b.date));
            },

            async registerShift(dateStr) {
                 const u = app.data.currentUser;
                 if (u.shifts && u.shifts.some(s => s.date === dateStr)) return alert("الطلب مرسل مسبقاً");
                 
                 const newShift = { date: dateStr, status: 'pending' }; 
                 await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users', u.id), { shifts: [...(u.shifts || []), newShift] });
                 alert("تم إرسال طلب حجز المناوبة للإدارة للموافقة.");
                 app.renderVolunteerUI();
            },

            async addExceptionDate() {
                const date = document.getElementById('exceptionDate').value;
                if(!date) return;
                const current = app.data.settings.exceptions || [];
                await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'settings', 'main'), { exceptions: [...current, date] }, {merge:true});
                alert("تم إضافة الموعد الاستثنائي");
                const list = document.getElementById('exceptionList');
                list.innerHTML += `<div>${date}</div>`;
            },

            // --- Bulk Actions Logic ---
            toggleSelectAll(checkbox) {
                const checkboxes = document.querySelectorAll('.user-checkbox');
                checkboxes.forEach(cb => {
                    cb.checked = checkbox.checked;
                    app.toggleSelectUser(cb.value, checkbox.checked);
                });
            },

            toggleSelectUser(id, isChecked) {
                // If called from onclick, isChecked might be undefined
                if (typeof isChecked === 'undefined') {
                     const cb = document.querySelector(`.user-checkbox[value="${id}"]`);
                     isChecked = cb.checked;
                }
                
                if (isChecked) {
                    app.selectedUsers.add(id);
                } else {
                    app.selectedUsers.delete(id);
                }
                
                // Update UI count if modal is open (optional but nice)
                const countEl = document.getElementById('bulkSelectedCount');
                if(countEl) countEl.innerText = `سيتم المنح لـ ${app.selectedUsers.size} شخص`;
            },

            openBulkGrantModal() {
                if (app.selectedUsers.size === 0) return alert("يرجى تحديد متطوعين أولاً");
                document.getElementById('bulkSelectedCount').innerText = `سيتم المنح لـ ${app.selectedUsers.size} شخص`;
                document.getElementById('bulkGrantModal').classList.remove('hidden');
            },

            async submitBulkAction() {
                const pts = parseInt(document.getElementById('bulkPoints').value) || 0;
                const hrs = parseFloat(document.getElementById('bulkHours').value) || 0;
                const reason = document.getElementById('bulkReason').value || "منح إداري جماعي";

                if (pts === 0 && hrs === 0) return alert("يرجى إدخال نقاط أو ساعات");

                const updates = [];
                app.selectedUsers.forEach(id => {
                    const u = app.data.users.find(x => x.id === id);
                    if (u) {
                        const newHistory = { 
                            date: new Date().toLocaleDateString('ar-JO'), 
                            start: reason, 
                            end: '-', 
                            hours: hrs, 
                            points: pts 
                        };
                        
                        updates.push(updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users', id), {
                            "stats.points": (u.stats?.points || 0) + pts,
                            "stats.hours": (u.stats?.hours || 0) + hrs,
                            history: [...(u.history || []), newHistory],
                            notifications: [{ text: `مكافأة جماعية: ${pts} نقاط و ${hrs} ساعة (${reason})`, read: false, time: Date.now() }, ...(u.notifications || [])]
                        }));
                    }
                });

                await Promise.all(updates);
                alert(`تم منح المكافآت لـ ${updates.length} متطوع بنجاح`);
                document.getElementById('bulkGrantModal').classList.add('hidden');
                app.selectedUsers.clear();
                app.renderAdminDashboard(); // Refresh table to clear checkboxes
            },
            
            // --- Single User Grant ---
            async grantManualPointsHours() {
                const uid = document.getElementById('toolUserId').value;
                const pts = parseInt(document.getElementById('manualPoints').value) || 0;
                const hrs = parseFloat(document.getElementById('manualHours').value) || 0;
                
                const u = app.data.users.find(x => x.id === uid);
                if(!u) return;
                await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users', uid), { 
                    "stats.points": (u.stats?.points || 0) + pts,
                    "stats.hours": (u.stats?.hours || 0) + hrs,
                    history: [...(u.history || []), { date: new Date().toLocaleDateString('ar-JO'), start: 'منح يدوي', end: '-', hours: hrs, points: pts }]
                });
                app.notifyUser(uid, `تم منحك ${pts} نقطة و ${hrs} ساعة إضافية من الإدارة`);
                alert("تم التحديث");
                app.openAdminTools(uid);
            },

            async adminAction(uid, action) {
                 if (action === 'ban') {
                     await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users', uid), { status: 'banned', banReason: 'حظر يدوي من الإدارة' });
                     alert("تم حظر المستخدم");
                 } else if (action === 'unban') {
                     await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users', uid), { status: 'active', banReason: null });
                     alert("تم رفع الحظر");
                 }
            },

            async issueManualWarning() {
                const uid = document.getElementById('toolUserId').value;
                const reason = document.getElementById('warningReason').value;
                if(!reason) return;
                const u = app.data.users.find(x => x.id === uid);
                await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users', uid), {
                    warnings: [...(u.warnings || []), {date: new Date().toLocaleDateString(), reason}]
                });
                app.notifyUser(uid, `تنبيه إداري: ${reason}`);
                alert('تم إصدار الإنذار');
            },

            openProfileEdit() {
                const u = app.data.currentUser;
                document.getElementById('newPassVol').value = u.pass;
                document.getElementById('newBioVol').value = u.bio || "";
                document.getElementById('profileEditModal').classList.remove('hidden');
            },

            // --- Updated Profile Update Logic (Using Base64 - Free & Easy) ---
            async updateProfile() {
                const u = app.data.currentUser;
                const pass = document.getElementById('newPassVol').value;
                const bio = document.getElementById('newBioVol').value;
                const fileInput = document.getElementById('avatarUpload');
                
                let avatar = u.avatar;

                // Create update object dynamically
                const updateData = { pass, bio };

                // تحويل الصورة لنص Base64 لتخزينها في الداتابيس مباشرة
                if (fileInput.files.length > 0) {
                    const file = fileInput.files[0];
                    
                    // ضغط وتصغير الصورة قبل التحويل (لتفادي حجم 1MB)
                    const resizeImage = (file) => new Promise((resolve) => {
                        const reader = new FileReader();
                        reader.readAsDataURL(file);
                        reader.onload = (event) => {
                            const img = new Image();
                            img.src = event.target.result;
                            img.onload = () => {
                                const elem = document.createElement('canvas');
                                const width = 300; // تصغير العرض إلى 300 بكسل
                                const scaleFactor = width / img.width;
                                elem.width = width;
                                elem.height = img.height * scaleFactor;
                                const ctx = elem.getContext('2d');
                                ctx.drawImage(img, 0, 0, width, img.height * scaleFactor);
                                resolve(elem.toDataURL('image/jpeg', 0.7)); // ضغط الجودة 70%
                            }
                        }
                    });

                    try {
                        alert("جاري معالجة ورفع الصورة...");
                        const base64 = await resizeImage(file);
                        updateData.avatar = base64; 
                    } catch (e) {
                        alert("خطأ في قراءة الملف");
                        return;
                    }
                }

                try {
                    await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users', u.id), updateData);
                    alert("تم تحديث الملف الشخصي");
                    document.getElementById('profileEditModal').classList.add('hidden');
                } catch (error) {
                    console.error(error);
                    alert("حدث خطأ أثناء الحفظ: " + error.message);
                }
            },

            async checkSession() {
                const uid = localStorage.getItem('jcd_uid_v33');
                if (uid) {
                    const u = app.data.users.find(x => x.id === uid);
                    if (u) { app.data.currentUser = u; app.showDashboard(u); }
                }
            },

            showLogin(type) { app.showSection('login'); app.switchLoginTab(type); },
            switchLoginTab(type) {
                const volBtn = document.getElementById('tab-volunteer');
                const adminBtn = document.getElementById('tab-admin');
                const title = document.getElementById('loginTitle');
                volBtn.className = type === 'volunteer' ? 'w-1/2 py-2.5 rounded-lg text-sm font-bold transition-all bg-white dark:bg-[#1e293b] shadow text-jcd-blue dark:text-white' : 'w-1/2 py-2.5 rounded-lg text-sm font-bold transition-all text-gray-500 dark:text-gray-400 hover:text-jcd-blue';
                adminBtn.className = type === 'admin' ? 'w-1/2 py-2.5 rounded-lg text-sm font-bold transition-all bg-white dark:bg-[#1e293b] shadow text-jcd-blue dark:text-white' : 'w-1/2 py-2.5 rounded-lg text-sm font-bold transition-all text-gray-500 dark:text-gray-400 hover:text-jcd-blue';
                title.innerText = type === 'admin' ? 'دخول قيادة العمليات' : 'تسجيل دخول النشامى';
            },

            async handleLogin(e) {
                e.preventDefault();
                const id = document.getElementById('username').value.trim();
                const pass = document.getElementById('password').value.trim();
                
                let user = app.data.users.find(u => u.id === id);
                if (!user) {
                      const staticUser = STATIC_USERS.find(u => u.id === id);
                      if (staticUser && staticUser.pass === pass) {
                          try {
                              await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users', id), {
                                  ...staticUser, role: staticUser.role || 'volunteer', status: 'active', stats: {points:0, hours:0}, lastLogin: new Date().toISOString()
                              });
                              user = staticUser; 
                          } catch(e) { alert("خطأ في الاتصال بالقاعدة"); return; }
                      }
                }
                if (!user) return alert("المستخدم غير موجود.");
                if (user.pass !== pass) return alert("كلمة المرور غير صحيحة");
                if (user.status === 'banned') return alert("الحساب محظور: " + (user.banReason || "مخالفة الأنظمة"));
                
                await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users', user.id), { lastLogin: new Date().toISOString() });
                
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'logs'), {
                    text: `${user.name} سجل دخول`,
                    type: 'login',
                    time: Date.now()
                });

                app.data.currentUser = user;
                localStorage.setItem('jcd_uid_v33', user.id);
                app.showDashboard(user);
                if(user.role === 'volunteer') app.generateDailyMessage(user.name);
            },

            logout() {
                app.data.currentUser = null;
                localStorage.removeItem('jcd_uid_v33');
                location.reload();
            },

            showDashboard(user) {
                document.getElementById('guestLinks').classList.add('hidden');
                document.getElementById('userMenu').classList.remove('hidden');
                document.getElementById('userNameDisplay').innerText = user.name;
                
                const unread = (user.notifications || []).filter(n => !n.read).length;
                const badge = document.getElementById('notifBadge');
                if (unread > 0) {
                    badge.innerText = unread;
                    badge.classList.remove('hidden');
                } else {
                    badge.classList.add('hidden');
                }

                if (user.role === 'admin') { app.showSection('admin-dashboard'); app.renderAdminDashboard(); } 
                else { app.showSection('volunteer-dashboard'); app.renderVolunteerUI(); document.getElementById('chatWidget').classList.remove('hidden'); setTimeout(() => app.initMap(), 1000); }
            },

            showSection(id) {
                ['home', 'nashama-section', 'login', 'volunteer-dashboard', 'admin-dashboard', 'registration'].forEach(s => {
                    document.getElementById(s).classList.add('hidden');
                });
                document.getElementById(id).classList.remove('hidden');
                if(id === 'nashama-section') app.renderNashamaSection();
                if(id === 'home') app.renderPublicRoster();
            },

            renderUI() {
                app.renderNashamaSection();
                app.renderPublicRoster();
                if (app.data.currentUser) {
                    const freshUser = app.data.users.find(u => u.id === app.data.currentUser.id);
                    if(freshUser) app.data.currentUser = freshUser;
                    
                    if (app.data.currentUser.role === 'admin') app.renderAdminDashboard();
                    else app.renderVolunteerUI();
                }
            },

            renderNashamaSection() {
                const grid = document.getElementById('nashamaGrid');
                if(!grid) return;
                const sorted = app.data.users.filter(u => u.role !== 'admin' && u.status === 'active')
                    .sort((a,b) => (b.isOfficial ? 1 : 0) - (a.isOfficial ? 1 : 0) || (b.stats?.points || 0) - (a.stats?.points || 0));

                grid.innerHTML = sorted.map(u => {
                    const isLeader = u.isOfficial;
                    const rank = app.getRankInfo(u.stats?.hours || 0);
                    const cardStyle = isLeader ? 'official-card transform scale-105 shadow-2xl' : 'bg-white dark:bg-[#1e293b] shadow-lg border border-gray-100 dark:border-gray-700 dark:text-white';
                    const initial = u.name ? u.name.charAt(0) : '?';
                    return `
                    <div class="${cardStyle} rounded-[2rem] p-6 text-center relative overflow-hidden group hover:-translate-y-2 transition duration-300 cursor-pointer">
                        ${isLeader ? '<div class="absolute top-0 right-0 bg-gradient-to-bl from-jcd-gold to-yellow-600 text-black text-[10px] font-black px-4 py-1.5 rounded-bl-2xl z-10 shadow-lg"><i class="fas fa-crown"></i> قيادة</div>' : ''}
                        <div class="relative w-28 h-28 mx-auto mb-5 flex items-center justify-center">
                            <div class="absolute inset-0 bg-jcd-blue/10 rounded-full blur-xl group-hover:bg-jcd-blue/20 transition"></div>
                             <div class="relative w-full h-full rounded-full border-4 ${isLeader ? 'border-jcd-gold shadow-[0_0_20px_rgba(251,191,36,0.3)]' : rank.class} bg-gray-800 flex items-center justify-center text-4xl font-black text-white overflow-hidden">
                                ${u.avatar ? `<img src="${u.avatar}" class="w-full h-full object-cover">` : initial}
                             </div>
                        </div>
                        <h3 class="font-black text-xl mb-1 truncate text-slate-800 dark:text-white">${u.name}</h3>
                        <p class="text-xs text-gray-500 dark:text-gray-400 mb-5 font-bold bg-gray-100 dark:bg-[#0f172a] py-1 px-3 rounded-full inline-block">${rank.title}</p>
                        <div class="flex justify-center gap-3 text-xs font-bold">
                            <div class="flex items-center gap-1.5 bg-yellow-50 dark:bg-yellow-500/10 text-yellow-600 dark:text-yellow-400 px-3 py-1.5 rounded-lg border border-yellow-100 dark:border-yellow-500/20">
                                <i class="fas fa-star"></i> ${u.stats?.points||0}
                            </div>
                            <div class="flex items-center gap-1.5 bg-green-50 dark:bg-green-500/10 text-green-600 dark:text-green-400 px-3 py-1.5 rounded-lg border border-green-100 dark:border-green-500/20">
                                <i class="fas fa-clock"></i> ${u.stats?.hours||0}
                            </div>
                        </div>
                    </div>`;
                }).join('');
            },

            // --- Public Roster Logic ---
            renderPublicRoster() {
                const today = new Date().toLocaleDateString('en-CA');
                const dateEl = document.getElementById('rosterDateDisplay');
                if (dateEl) {
                     dateEl.innerText = new Date().toLocaleDateString('ar-JO', {weekday: 'long', year: 'numeric', month: 'long', day: 'numeric'});
                }

                const approvedUsers = app.data.users.filter(u => 
                    u.shifts && u.shifts.some(s => s.date === today && s.status === 'approved')
                );

                const grid = document.getElementById('approvedRosterGrid');
                if(!grid) return;

                if (approvedUsers.length === 0) {
                    grid.innerHTML = `<div class="col-span-full text-center py-8 text-gray-400 bg-white/5 rounded-2xl border border-white/10">لم يتم اعتماد أي مناوبات لهذا اليوم بعد.</div>`;
                    return;
                }

                grid.innerHTML = approvedUsers.map(u => {
                    const rank = app.getRankInfo(u.stats?.hours || 0);
                    return `
                    <div class="bg-white/10 backdrop-blur-md border border-white/10 p-4 rounded-2xl flex items-center gap-4 hover:bg-white/20 transition">
                         <div class="w-12 h-12 rounded-full bg-gray-700 flex items-center justify-center text-white font-bold text-lg border-2 ${rank.class.split(' ')[1]} overflow-hidden">
                             ${u.avatar ? `<img src="${u.avatar}" class="w-full h-full object-cover">` : u.name.charAt(0)}
                         </div>
                         <div>
                             <h4 class="text-white font-bold text-sm">${u.name}</h4>
                             <p class="text-jcd-gold text-[10px] font-bold">${rank.title}</p>
                         </div>
                    </div>`;
                }).join('');
            },

            renderVolunteerUI() {
                const u = app.data.currentUser;
                document.getElementById('volNameDisplay').innerText = u.name;
                document.getElementById('volBioDisplay').innerText = u.bio || "متطوع نشيط";
                
                // Avatar Logic for Dashboard
                const dashAvatarContainer = document.getElementById('dashAvatarContainer');
                const dashAvatarImg = document.getElementById('dashAvatar');
                const dashAvatarInitial = document.getElementById('dashAvatarInitial');

                if(dashAvatarContainer) {
                    if (u.avatar) {
                        dashAvatarImg.src = u.avatar;
                        dashAvatarImg.classList.remove('hidden');
                        dashAvatarInitial.innerText = '';
                    } else {
                        dashAvatarImg.classList.add('hidden');
                        dashAvatarInitial.innerText = u.name.charAt(0);
                    }
                }
                
                if(u.warnings && u.warnings.length > 0) {
                    document.getElementById('volWarningBox').classList.remove('hidden');
                    document.getElementById('volWarningText').innerText = u.warnings[u.warnings.length-1].reason;
                } else {
                    document.getElementById('volWarningBox').classList.add('hidden');
                }

                const today = new Date().toLocaleDateString('ar-JO');
                const lastSession = u.history && u.history.length > 0 ? u.history[u.history.length - 1] : null;
                const isCheckedIn = lastSession && lastSession.date === today && lastSession.end === '-';
                const isPendingCheckin = u.pending_checkin && u.pending_checkin.date === today;
                
                let gateHTML = '';
                if (isCheckedIn) {
                    gateHTML = `<button onclick="app.checkOut()" class="w-full py-4 rounded-xl bg-red-600 hover:bg-red-700 shadow-lg shadow-red-600/30 text-white transition flex flex-col items-center justify-center gap-2 group"><i class="fas fa-sign-out-alt text-3xl mb-1 group-hover:scale-110 transition"></i><span class="font-black text-sm">تسجيل خروج</span></button>`;
                } else if (isPendingCheckin) {
                      gateHTML = `<button disabled class="w-full py-4 rounded-xl bg-amber-500/80 cursor-not-allowed text-white flex flex-col items-center justify-center gap-2 border border-amber-400/50"><i class="fas fa-clock text-3xl mb-1 animate-spin-slow"></i><span class="font-bold text-sm">بانتظار الموافقة</span></button>`;
                } else {
                    gateHTML = `<button onclick="app.requestCheckIn()" class="w-full py-4 rounded-xl bg-green-600 hover:bg-green-700 shadow-lg shadow-green-600/30 text-white transition flex flex-col items-center justify-center gap-2 group"><i class="fas fa-fingerprint text-3xl mb-1 group-hover:scale-110 transition"></i><span class="font-black text-sm">تسجيل دخول</span></button>`;
                }
                document.getElementById('gateContainer').innerHTML = gateHTML;

                const availableShifts = app.getAvailableShiftDates();
                const shiftsHTML = availableShifts.map(s => {
                    const shiftRecord = u.shifts && u.shifts.find(us => us.date === s.date);
                    const isRegistered = !!shiftRecord;
                    let btn = `<button onclick="app.registerShift('${s.date}')" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-1.5 rounded-lg text-xs font-bold transition shadow-sm">حجز</button>`;
                    
                    if (isRegistered) {
                        if (shiftRecord.status === 'approved') btn = '<span class="text-green-500 font-bold text-xs bg-green-500/10 px-3 py-1 rounded-lg"><i class="fas fa-check-circle"></i> معتمد</span>';
                        else if (shiftRecord.status === 'pending') btn = '<span class="text-yellow-500 font-bold text-xs bg-yellow-500/10 px-3 py-1 rounded-lg"><i class="fas fa-clock"></i> قيد المراجعة</span>';
                    }

                    return `
                    <div class="flex justify-between items-center p-4 bg-gray-50 dark:bg-[#0f172a] rounded-xl border border-gray-100 dark:border-gray-700 hover:border-blue-500/30 transition">
                        <div><div class="font-bold text-sm dark:text-white mb-0.5">${s.day}</div><div class="text-[10px] text-gray-500 font-mono">${s.date}</div></div>
                        ${btn}
                    </div>`;
                }).join('');
                document.getElementById('volShiftList').innerHTML = shiftsHTML || '<p class="text-center text-xs text-gray-400 py-4">لا توجد مناوبات متاحة حالياً</p>';

                const top5 = app.data.users.filter(x => x.role !== 'admin').sort((a,b) => (b.stats?.points || 0) - (a.stats?.points || 0)).slice(0, 5);
                document.getElementById('volLeaderboard').innerHTML = top5.map((x, i) => 
                    `<div class="flex items-center justify-between p-3 border-b border-gray-100 dark:border-gray-700 last:border-0 hover:bg-gray-50 dark:hover:bg-white/5 transition rounded-lg">
                        <div class="flex items-center gap-3">
                            <span class="font-black text-gray-300 w-5 text-center">${i+1}</span>
                            <div class="w-9 h-9 rounded-full bg-gray-700 flex items-center justify-center text-white text-xs font-bold overflow-hidden">
                                ${x.avatar ? `<img src="${x.avatar}" class="w-full h-full object-cover">` : x.name.charAt(0)}
                            </div>
                            <span class="text-sm font-bold dark:text-white">${x.name}</span>
                        </div>
                        <span class="text-xs font-black text-jcd-gold bg-yellow-500/10 px-2 py-1 rounded-md">${x.stats?.points || 0} pts</span>
                    </div>`
                ).join('');
                
                if(u.history) {
                    document.getElementById('historyBody').innerHTML = u.history.slice().reverse().map(h => 
                        `<tr class="border-b border-gray-100 dark:border-gray-800 last:border-0 hover:bg-gray-50 dark:hover:bg-white/5 transition">
                            <td class="py-3 pr-2 text-gray-500 font-mono">${h.date}</td>
                            <td class="py-3 text-center text-blue-600 dark:text-blue-400">${h.start}</td>
                            <td class="py-3 text-center text-gray-400">${h.end}</td>
                            <td class="py-3 text-center text-green-600 dark:text-green-400 font-bold">+${h.points||0}</td>
                            <td class="py-3 text-center"><button class="text-gray-300 hover:text-blue-500 transition"><i class="fas fa-file-download"></i></button></td>
                        </tr>`
                    ).join('');
                }
                
                const courses = app.data.courses || [];
                document.getElementById('volCoursesList').innerHTML = courses.map(c => 
                    `<div class="p-4 bg-gray-50 dark:bg-[#0f172a] rounded-xl flex justify-between items-center border border-gray-100 dark:border-gray-700 hover:border-purple-500/30 transition">
                        <div class="flex items-center gap-3">
                            <div class="w-8 h-8 rounded-lg bg-purple-500/10 flex items-center justify-center text-purple-500"><i class="fas fa-book"></i></div>
                            <span class="text-xs font-bold dark:text-white">${c.title}</span>
                        </div>
                        <button class="text-purple-600 dark:text-purple-400 text-[10px] font-bold bg-purple-100 dark:bg-purple-900/30 px-3 py-1.5 rounded-lg hover:bg-purple-200 transition">التحاق</button>
                    </div>`
                ).join('');
            },

            renderAdminDashboard() {
                const active = app.data.users.filter(u => u.status === 'active');
                document.getElementById('totalUsersCount').innerText = active.length;
                
                const today = new Date().toLocaleDateString('ar-JO');
                const checkedIn = active.filter(u => {
                    const last = u.history && u.history[u.history.length-1];
                    return last && last.date === today && last.end === '-';
                });
                document.getElementById('rosterCount').innerText = checkedIn.length;
                document.getElementById('liveAttendanceList').innerHTML = checkedIn.map(u => 
                    `<div class="flex justify-between items-center p-3 bg-green-50 dark:bg-green-900/10 border border-green-100 dark:border-green-900/30 rounded-xl mb-2">
                        <span class="text-xs font-bold dark:text-white flex items-center gap-2">
                            <span class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></span>
                            ${u.name}
                        </span>
                        <span class="text-[10px] bg-green-200 dark:bg-green-900 text-green-800 dark:text-green-200 px-2 py-0.5 rounded-md font-bold">متواجد</span>
                    </div>`
                ).join('');

                document.getElementById('loginLogsList').innerHTML = (app.data.logs || []).slice().reverse().slice(0, 10).map(l => 
                    `<div class="flex justify-between items-center text-[10px] border-b border-gray-100 dark:border-gray-700 py-2 last:border-0">
                        <span class="dark:text-gray-300 font-medium">${l.text}</span>
                        <span class="text-gray-400 font-mono bg-gray-50 dark:bg-[#0f172a] px-1.5 py-0.5 rounded">${new Date(l.time).toLocaleTimeString()}</span>
                    </div>`
                ).join('');

                const pendingCheckins = app.data.users.filter(u => u.pending_checkin);
                document.getElementById('pendingCheckinsList').innerHTML = pendingCheckins.length > 0 ? pendingCheckins.map(u => `
                    <div class="flex justify-between items-center bg-yellow-50 dark:bg-yellow-900/10 border border-yellow-100 dark:border-yellow-900/30 p-3 rounded-xl mb-2">
                        <div class="text-xs font-bold dark:text-white">${u.name} <span class="text-gray-400 block text-[9px] font-mono mt-0.5">${u.pending_checkin.time}</span></div>
                        <div class="flex gap-2">
                            <button onclick="app.approveCheckIn('${u.id}', true)" class="bg-green-500 hover:bg-green-600 text-white px-3 py-1.5 rounded-lg text-[10px] font-bold transition shadow-sm">موافقة</button>
                            <button onclick="app.approveCheckIn('${u.id}', false)" class="bg-red-500 hover:bg-red-600 text-white px-3 py-1.5 rounded-lg text-[10px] font-bold transition shadow-sm">رفض</button>
                        </div>
                    </div>
                `).join('') : '<p class="text-gray-400 text-center py-4 bg-gray-50 dark:bg-[#0f172a] rounded-xl text-xs">لا توجد طلبات معلقة</p>';

                const pendingShifts = [];
                app.data.users.forEach(u => {
                    if(u.shifts) {
                        u.shifts.forEach(s => {
                            if(s.status === 'pending') pendingShifts.push({ user: u, shift: s });
                        });
                    }
                });

                document.getElementById('pendingShiftsList').innerHTML = pendingShifts.length > 0 ? pendingShifts.map(item => `
                    <div class="flex justify-between items-center bg-blue-50 dark:bg-blue-900/10 border border-blue-100 dark:border-blue-900/30 p-3 rounded-xl mb-2">
                        <div class="text-xs font-bold dark:text-white">${item.user.name} <span class="text-blue-500 block text-[9px] font-mono mt-0.5">${item.shift.date}</span></div>
                        <div class="flex gap-2">
                            <button onclick="app.approveShift('${item.user.id}', '${item.shift.date}', true)" class="bg-green-500 hover:bg-green-600 text-white px-3 py-1.5 rounded-lg text-[10px] font-bold transition shadow-sm">موافقة</button>
                            <button onclick="app.approveShift('${item.user.id}', '${item.shift.date}', false)" class="bg-red-500 hover:bg-red-600 text-white px-3 py-1.5 rounded-lg text-[10px] font-bold transition shadow-sm">رفض</button>
                        </div>
                    </div>
                `).join('') : '<p class="text-gray-400 text-center py-4 bg-gray-50 dark:bg-[#0f172a] rounded-xl text-xs">لا توجد طلبات معلقة</p>';


                document.getElementById('fullUsersTable').innerHTML = app.data.users.map(u => 
                    `<tr class="border-b border-gray-100 dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-white/5 transition">
                        <td class="p-3 text-center"><input type="checkbox" value="${u.id}" class="user-checkbox rounded border-gray-300 text-blue-600 focus:ring-blue-500 cursor-pointer" onclick="app.toggleSelectUser('${u.id}')"></td>
                        <td class="p-3 font-bold dark:text-white">
                            <div class="flex items-center gap-2">
                                <div class="w-6 h-6 rounded-full bg-gray-200 dark:bg-gray-700 flex items-center justify-center text-[10px] text-gray-500 font-bold overflow-hidden">
                                     ${u.avatar ? `<img src="${u.avatar}" class="w-full h-full object-cover">` : u.name.charAt(0)}
                                </div>
                                <div>${u.name} <span class="text-[9px] text-gray-400 block">${u.role === 'admin' ? 'مدير' : 'متطوع'}</span></div>
                            </div>
                        </td>
                        <td class="p-3 font-mono text-[10px] text-blue-600 dark:text-blue-400">${u.id}</td>
                        <td class="p-3 text-jcd-gold font-bold text-center">${u.stats?.points||0}</td>
                        <td class="p-3 text-center"><button onclick="app.openAdminTools('${u.id}')" class="text-gray-400 hover:text-blue-600 transition bg-gray-100 dark:bg-gray-800 p-1.5 rounded-lg"><i class="fas fa-cog"></i></button></td>
                    </tr>`
                ).join('');

                document.getElementById('adminSuggestionsList').innerHTML = (app.data.suggestions || []).map(s => 
                    `<div class="p-3 bg-yellow-50 dark:bg-yellow-900/10 border border-yellow-100 dark:border-yellow-900/30 rounded-xl mb-2">
                        <p class="text-[10px] dark:text-yellow-200 font-bold mb-1 opacity-70">من: مجهول</p>
                        <p class="text-xs text-gray-700 dark:text-gray-300 leading-relaxed font-medium">${s.text}</p>
                    </div>`
                ).join('');
                
                 document.getElementById('vehicleList').innerHTML = (app.data.vehicles || []).map(v => {
                    let color = v.status === 'جاهزة' ? 'text-green-600 bg-green-100 dark:bg-green-900/20 dark:text-green-400' : (v.status === 'صيانة' ? 'text-orange-600 bg-orange-100 dark:bg-orange-900/20 dark:text-orange-400' : 'text-red-600 bg-red-100 dark:bg-red-900/20 dark:text-red-400');
                    return `<div class="flex justify-between items-center p-2.5 rounded-xl bg-gray-50 dark:bg-[#0f172a] border border-gray-100 dark:border-gray-700 mb-1">
                        <span class="text-xs font-bold dark:text-white">${v.name}</span>
                        <span class="text-[10px] px-2 py-0.5 rounded-md font-bold ${color}">${v.status}</span>
                    </div>`;
                }).join('');

                // --- Admin Daily Approved Roster ---
                // Set default date to today if picker is empty
                const picker = document.getElementById('adminRosterPicker');
                if (picker && !picker.value) {
                    picker.value = new Date().toLocaleDateString('en-CA');
                }
                
                // Trigger render for the selected date
                app.renderAdminRoster(picker ? picker.value : new Date().toLocaleDateString('en-CA'));
            },
            
            // --- New Function: Render Admin Roster Grid ---
            renderAdminRoster(dateStr) {
                if(!dateStr) return;
                
                // Update display text
                const dateObj = new Date(dateStr);
                const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
                const dateText = dateObj.toLocaleDateString('ar-JO', options);
                
                // Use optional chaining just in case
                const dateDisplay = document.getElementById('adminRosterDate');
                if(dateDisplay) dateDisplay.innerText = dateText;

                const approvedUsers = app.data.users.filter(u => 
                    u.shifts && u.shifts.some(s => s.date === dateStr && s.status === 'approved')
                );

                const rosterGrid = document.getElementById('adminApprovedRosterGrid');
                if(!rosterGrid) return;

                if (approvedUsers.length === 0) {
                    rosterGrid.innerHTML = `<div class="col-span-full text-center py-8 text-gray-400 bg-gray-50 dark:bg-[#0f172a] rounded-xl border border-dashed border-gray-200 dark:border-gray-700 text-xs">لا توجد مناوبات معتمدة لهذا اليوم.</div>`;
                    return;
                }

                rosterGrid.innerHTML = approvedUsers.map(u => {
                    const rank = app.getRankInfo(u.stats?.hours || 0);
                    return `
                    <div class="bg-gray-50 dark:bg-[#0f172a] border border-gray-100 dark:border-gray-700 p-3 rounded-xl flex items-center gap-3">
                         <div class="w-10 h-10 rounded-full bg-gray-200 dark:bg-gray-700 flex items-center justify-center text-gray-500 font-bold text-sm border-2 ${rank.class.split(' ')[1]} overflow-hidden">
                             ${u.avatar ? `<img src="${u.avatar}" class="w-full h-full object-cover">` : u.name.charAt(0)}
                         </div>
                         <div>
                             <h4 class="dark:text-white font-bold text-xs">${u.name}</h4>
                             <p class="text-jcd-gold text-[9px] font-bold opacity-80">${rank.title}</p>
                         </div>
                    </div>`;
                }).join('');
            },
            
            // --- New Function: Export Daily Roster PDF ---
            exportDailyRoster() {
                const dateStr = document.getElementById('adminRosterPicker').value;
                if(!dateStr) return alert("الرجاء اختيار تاريخ");
                
                const approvedUsers = app.data.users.filter(u => 
                    u.shifts && u.shifts.some(s => s.date === dateStr && s.status === 'approved')
                );
                
                if(approvedUsers.length === 0) return alert("لا يوجد أسماء لتصديرها لهذا اليوم");
                
                const content = `
                    <div style="text-align: right; padding: 20px; font-family: sans-serif;">
                        <div style="text-align:center; margin-bottom:20px;">
                            <img src="https://upload.wikimedia.org/wikipedia/commons/e/e0/Jordan_Civil_Defence_Logo.png" style="height:60px;">
                            <h2>مديرية دفاع مدني المفرق</h2>
                            <h3>كشف المناوبات المعتمد</h3>
                            <p>التاريخ: ${dateStr}</p>
                        </div>
                        <table style="width:100%; border-collapse: collapse; margin-top: 20px;" border="1" cellpadding="8">
                            <thead>
                                <tr style="background:#f0f0f0;">
                                    <th>#</th>
                                    <th>الاسم</th>
                                    <th>المعرف</th>
                                    <th>الرتبة</th>
                                    <th>ملاحظات</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${approvedUsers.map((u, i) => `
                                    <tr>
                                        <td>${i+1}</td>
                                        <td>${u.name}</td>
                                        <td>${u.id}</td>
                                        <td>${app.getRankInfo(u.stats?.hours).title}</td>
                                        <td></td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                        <div style="margin-top:40px; display:flex; justify-content:space-between;">
                            <div>التوقيع: .....................</div>
                            <div>الختم:</div>
                        </div>
                    </div>
                `;
                
                const element = document.createElement('div');
                element.innerHTML = content;
                html2pdf().from(element).save(`Roster_${dateStr}.pdf`);
            },

            // --- Updated Check-in Request ---
            async requestCheckIn() {
                const u = app.data.currentUser;
                const now = new Date();
                const pending = {
                    date: now.toLocaleDateString('ar-JO'),
                    time: now.toLocaleTimeString('ar-JO')
                };
                
                await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users', u.id), {
                    pending_checkin: pending
                });
                alert("تم إرسال طلب بدء المناوبة للإدارة للموافقة.");
                app.renderVolunteerUI();
            },

            async approveCheckIn(uid, approved) {
                const u = app.data.users.find(x => x.id === uid);
                if (!u) return;
                
                if (approved) {
                    const session = { 
                        date: u.pending_checkin.date, 
                        start: u.pending_checkin.time, 
                        end: '-', 
                        points: 0, hours: 0 
                    };
                    await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users', uid), {
                        history: [...(u.history || []), session],
                        pending_checkin: null
                    });
                    app.notifyUser(uid, "تمت الموافقة على بدء مناوبتك. بالتوفيق يا نشمي!");
                    await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'logs'), {
                        text: `${u.name} بدأ المناوبة (موافقة)`, type: 'checkin', time: Date.now()
                    });
                } else {
                    await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users', uid), {
                        pending_checkin: null
                    });
                    app.notifyUser(uid, "تم رفض طلب بدء المناوبة. راجع الإدارة.");
                }
            },

            async approveShift(uid, date, approved) {
                 const u = app.data.users.find(x => x.id === uid);
                 if (!u) return;

                 const updatedShifts = (u.shifts || []).map(s => {
                     if (s.date === date) {
                         return { ...s, status: approved ? 'approved' : 'rejected' };
                     }
                     return s;
                 });

                 await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users', uid), {
                     shifts: updatedShifts
                 });

                 app.notifyUser(uid, approved ? `تمت الموافقة على مناوبة ${date}` : `تم رفض طلب مناوبة ${date}`);
                 alert(approved ? "تم اعتماد المناوبة" : "تم رفض المناوبة");
                 app.renderAdminDashboard(); // Refresh UI
            },

            async checkOut() {
                const u = app.data.currentUser;
                if (!u.history || u.history.length === 0) return;
                
                const sessions = [...u.history];
                const last = sessions[sessions.length - 1];
                if (last.end !== '-') return;
                
                const now = new Date();
                last.end = now.toLocaleTimeString('ar-JO');
                
                // Calculate Duration
                last.hours = 4; // Mock 4 hours
                last.points = 10; // Mock 10 points
                
                const newStats = {
                    points: (u.stats?.points || 0) + 10,
                    hours: (u.stats?.hours || 0) + 4
                };

                await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users', u.id), {
                    history: sessions,
                    stats: newStats
                });
                
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'logs'), {
                    text: `${u.name} أنهى المناوبة`, type: 'checkout', time: Date.now()
                });
                app.notifyUser(u.id, "تم إنهاء المناوبة بنجاح ورصد النقاط.");
                app.renderVolunteerUI();
            },

            async notifyUser(uid, msg) {
                const u = app.data.users.find(x => x.id === uid);
                const newNotif = { text: msg, read: false, time: Date.now() };
                await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users', uid), {
                    notifications: [newNotif, ...(u.notifications || [])]
                });
            },

            toggleNotifications() {
                const modal = document.getElementById('notificationsModal');
                const list = document.getElementById('notifList');
                modal.classList.toggle('hidden');
                
                if (!modal.classList.contains('hidden')) {
                    const u = app.data.currentUser;
                    const notifs = u.notifications || [];
                    list.innerHTML = notifs.length > 0 ? notifs.map(n => `
                        <div class="p-3 border-b dark:border-gray-700 ${n.read ? 'opacity-60 bg-gray-50 dark:bg-[#0f172a]' : 'bg-blue-50/50 dark:bg-blue-900/10'} hover:bg-gray-100 dark:hover:bg-gray-800 transition">
                            <p class="dark:text-white font-bold text-xs mb-1">${n.text}</p>
                            <span class="text-[10px] text-gray-400 font-mono flex items-center gap-1"><i class="far fa-clock"></i> ${new Date(n.time).toLocaleString()}</span>
                        </div>
                    `).join('') : '<p class="text-center text-gray-400 py-8 text-xs">لا توجد إشعارات جديدة</p>';

                    if (notifs.some(n => !n.read)) {
                        const updated = notifs.map(n => ({ ...n, read: true }));
                        updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users', u.id), { notifications: updated });
                    }
                }
            },

            // --- Updated Logo Update Logic (Base64 + Compression + Size Limit) ---
            async updateLogo() {
                const input = document.getElementById('logoUploader');
                if (input.files.length > 0) {
                    const file = input.files[0];
                    
                    // 1. Size Check (< 700KB)
                    if (file.size > 700 * 1024) {
                         alert("حجم الصورة كبير جداً! يرجى اختيار صورة أصغر من 700 كيلوبايت.");
                         return;
                    }

                    const reader = new FileReader();
                    reader.onload = async (e) => {
                        const base64 = e.target.result;
                        try {
                            // 2. Save directly to Firestore
                            await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'settings', 'main'), { logo: base64 }, { merge: true });
                            
                            // 3. Immediate UI Update
                            const navLogo = document.getElementById('navLogo');
                            const heroLogo = document.getElementById('heroLogo');
                            if(navLogo) navLogo.src = base64;
                            if(heroLogo) heroLogo.src = base64;

                            alert("تم تحديث شعار الموقع بنجاح!");
                        } catch(err) {
                            console.error("Logo update error:", err);
                            alert("حدث خطأ أثناء حفظ الشعار. قد تكون الصورة كبيرة جداً لقاعدة البيانات.");
                        }
                    };
                    reader.readAsDataURL(file);
                }
            },
            
            async adminAddUser() {
                const name = document.getElementById('newVolName').value;
                const id = document.getElementById('newVolId').value;
                const pass = document.getElementById('newVolPass').value;
                const role = document.getElementById('newVolRole').value;
                
                if(!name || !id || !pass) return;
                
                await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users', id), {
                    id, name, pass, role, status: 'active', stats: {points:0, hours:0}, history:[], shifts:[]
                });
                alert("تم إضافة المستخدم بنجاح");
                document.getElementById('addNashmiModal').classList.add('hidden');
            },
            
            openAdminTools(uid) {
                const u = app.data.users.find(x => x.id === uid);
                document.getElementById('toolUserName').innerText = u.name;
                document.getElementById('toolUserId').value = u.id;
                
                document.getElementById('editNameAdmin').value = u.name;
                document.getElementById('editPassAdmin').value = u.pass;
                document.getElementById('editIdAdmin').value = u.id;

                document.getElementById('adminToolsModal').classList.remove('hidden');
            },

            async saveAdminUserEdit() {
                const oldId = document.getElementById('toolUserId').value;
                const newName = document.getElementById('editNameAdmin').value;
                const newPass = document.getElementById('editPassAdmin').value;
                const newId = document.getElementById('editIdAdmin').value;

                if (!newName || !newPass || !newId) return alert("البيانات ناقصة");

                const userDoc = app.data.users.find(u => u.id === oldId);

                if (newId === oldId) {
                    await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users', oldId), {
                        name: newName,
                        pass: newPass
                    });
                } else {
                    if (app.data.users.find(u => u.id === newId)) return alert("المعرف الجديد مستخدم بالفعل");
                    
                    if(confirm("تغيير المعرف سينقل البيانات للمعرف الجديد. هل أنت متأكد؟")) {
                        const newData = { ...userDoc, id: newId, name: newName, pass: newPass };
                        await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users', newId), newData);
                        await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users', oldId));
                    } else {
                        return;
                    }
                }
                alert("تم تحديث بيانات المتطوع بنجاح");
                document.getElementById('adminToolsModal').classList.add('hidden');
            },

            async sendAnnouncement() {
                const text = document.getElementById('adminAnnouncementText').value;
                if(!text) return;

                await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'settings', 'main'), { announcement: text }, { merge: true });
                
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'logs'), {
                    text: `تعميم إداري: ${text}`, type: 'announcement', time: Date.now()
                });

                alert("تم إرسال التعميم لجميع المتطوعين");
                document.getElementById('adminAnnouncementText').value = '';
            },

            showAnnouncement(text) {
                const box = document.getElementById('volAnnouncements');
                const txt = document.getElementById('announcementText');
                if (text && text.length > 0) {
                    box.classList.remove('hidden');
                    txt.innerText = text;
                } else {
                    box.classList.add('hidden');
                }
            },

            async addVehicleStatus() {
                const name = document.getElementById('vehName').value;
                const status = document.getElementById('vehStatus').value;
                if(!name) return;
                
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'vehicles'), { name, status, time: Date.now() });
            },

            async submitSuggestion() {
                const text = document.getElementById('suggestionText').value;
                if(!text) return;
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'suggestions'), { text, time: Date.now() });
                alert("تم إرسال اقتراحك بسرية تامة");
                document.getElementById('suggestionsModal').classList.add('hidden');
            },
            
            async addCourse() {
                const title = document.getElementById('newCourseTitle').value;
                if(!title) return;
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'courses'), { title, added: Date.now() });
            },

            filterNashama(q) {
                const grid = document.getElementById('nashamaGrid');
                const cards = grid.getElementsByTagName('div');
                for (let card of cards) {
                    if (card.innerText.includes(q)) card.style.display = 'block';
                    else card.style.display = 'none';
                }
            },
            
            filterUsers(q) {
                const rows = document.getElementById('fullUsersTable').getElementsByTagName('tr');
                for (let row of rows) {
                    if (row.innerText.includes(q)) row.style.display = '';
                    else row.style.display = 'none';
                }
            },

            async askAIQuick() {
                const q = document.getElementById('aiQuickAsk').value;
                if(!q) return;
                
                const responseArea = document.getElementById('aiResponseArea');
                responseArea.innerText = "جاري التفكير...";
                
                try {
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ contents: [{ parts: [{ text: "أنت مساعد ذكي للدفاع المدني الأردني. أجب باختصار واحترافية: " + q }] }] })
                    });
                    const data = await response.json();
                    responseArea.innerText = data.candidates[0].content.parts[0].text;
                } catch(e) {
                    responseArea.innerText = "عذراً، حدث خطأ في الاتصال.";
                }
            },

            async generateVolReport() {
                const text = document.getElementById('volReportText').value;
                const output = document.getElementById('aiReportOutput');
                output.classList.remove('hidden');
                output.innerText = "جاري إنشاء التقرير...";
                
                try {
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ contents: [{ parts: [{ text: "قم بصياغة تقرير رسمي عسكري لمديرية الدفاع المدني بناءً على المعلومات التالية: " + text }] }] })
                    });
                    const data = await response.json();
                    output.innerText = data.candidates[0].content.parts[0].text;
                } catch(e) {
                    output.innerText = "خطأ في التوليد";
                }
            },

            generateDailyMessage(name) {
                const msgs = [
                    `أهلاً يا ${name}، الوطن فخور بك.`,
                    "درجات الحرارة مرتفعة اليوم، احرص على شرب السوائل.",
                    "جاهزيتك هي سر قوتنا.",
                    "تفقد معداتك قبل بدء المناوبة."
                ];
                document.getElementById('dailyMessageText').innerText = msgs[Math.floor(Math.random() * msgs.length)];
            },

            initMap() {
                if (app.map) return;
                if (!document.getElementById('map')) return;
                
                app.map = L.map('map').setView([32.3424, 36.2044], 13);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '&copy; OSM'
                }).addTo(app.map);
                
                L.marker([32.3424, 36.2044]).addTo(app.map)
                    .bindPopup('مديرية دفاع مدني المفرق')
                    .openPopup();
                
                L.marker([32.35, 36.21]).addTo(app.map).bindPopup('مركز الخالدية');
            },

            toggleChat() {
                const win = document.getElementById('chatWindow');
                win.classList.toggle('hidden');
            },

            async sendChatMessage() {
                const input = document.getElementById('chatInput');
                const text = input.value;
                if(!text) return;
                
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'chats'), {
                    user: app.data.currentUser.name,
                    text: text,
                    time: Date.now()
                });
                input.value = '';
            },

            renderChat() {
                const list = document.getElementById('chatMessages');
                const msgs = (app.data.chats || []).sort((a,b) => a.time - b.time);
                list.innerHTML = msgs.map(m => 
                    `<div class="mb-1">
                        <span class="font-bold text-jcd-blue dark:text-blue-300 text-[10px]">${m.user}:</span>
                        <span class="text-gray-700 dark:text-gray-200 bg-gray-100 dark:bg-white/10 p-1 rounded px-2 inline-block">${m.text}</span>
                    </div>`
                ).join('');
                list.scrollTop = list.scrollHeight;
            },

            // --- PDF Export Stubs ---
            exportPDF(type) {
                alert(`جاري تجهيز كشف ${type === 'shifts' ? 'المناوبات' : 'الساعات المعتمدة'} للطباعة...`);
            },
            
            // --- Modals ---
            openSuggestionsModal() {
                document.getElementById('suggestionsModal').classList.remove('hidden');
            },

            openAddNashmiModal() {
                document.getElementById('addNashmiModal').classList.remove('hidden');
            },

            openIDModal() {
                const u = app.data.currentUser;
                document.getElementById('idCardName').innerText = u.name;
                document.getElementById('idCardNum').innerText = u.id;
                document.getElementById('idCardRank').innerText = app.getRankInfo(u.stats?.hours||0).title;
                
                const avatar = document.getElementById('idCardAvatar');
                if(avatar) {
                     if(u.avatar) {
                        avatar.innerHTML = `<img src="${u.avatar}" class="w-full h-full object-cover rounded-2xl">`;
                     } else {
                        avatar.innerText = u.name.charAt(0);
                     }
                }
                document.getElementById('idCardModal').classList.remove('hidden');
            },

            printID() {
                const el = document.getElementById('digitalIDCard');
                html2pdf().from(el).save('CD-ID-Card.pdf');
            },

            openFullProfile() {
                 const u = app.data.currentUser;
                 document.getElementById('fpName').innerText = u.name;
                 document.getElementById('fpRank').innerText = app.getRankInfo(u.stats?.hours).title;
                 document.getElementById('fpPoints').innerText = u.stats?.points || 0;
                 document.getElementById('fpHours').innerText = u.stats?.hours || 0;
                 
                 const avatar = document.getElementById('fpAvatar');
                 if(avatar) {
                     if(u.avatar) {
                        avatar.innerHTML = `<img src="${u.avatar}" class="w-full h-full object-cover rounded-full">`;
                     } else {
                        avatar.innerText = u.name.charAt(0);
                     }
                 }
                 
                 document.getElementById('fpHistory').innerHTML = (u.history || []).map(h => `<div class="p-2 border-b dark:border-gray-700 last:border-0 flex justify-between"><span class="text-gray-500">${h.date}</span> <span class="text-white">${h.start} - ${h.end}</span></div>`).join('');
                 document.getElementById('fullProfileModal').classList.remove('hidden');
            },

            printFullCertificate() {
                const u = app.data.currentUser;
                document.getElementById('certName').innerText = u.name;
                document.getElementById('certDetails').innerText = `بمجموع ساعات تطوعية بلغت ${u.stats?.hours || 0} ساعة ومجموع نقاط ${u.stats?.points || 0}`;
                document.getElementById('certDate').innerText = new Date().toLocaleDateString('ar-JO');
                
                const el = document.getElementById('certificateTemplate');
                el.classList.remove('hidden');
                html2pdf().from(el).save('Certificate.pdf').then(() => el.classList.add('hidden'));
            },

            generateFullSystemReport() {
                document.getElementById('sysReportDate').innerText = new Date().toLocaleString();
                document.getElementById('repUserCount').innerText = "عدد المتطوعين: " + app.data.users.length;
                document.getElementById('repActiveCount').innerText = "المتواجدون الآن: " + document.getElementById('rosterCount').innerText;
                document.getElementById('repLoginLogs').innerHTML = document.getElementById('loginLogsList').innerHTML;
                
                const el = document.getElementById('systemReportTemplate');
                el.classList.remove('hidden');
                html2pdf().from(el).save('System-Report.pdf').then(() => el.classList.add('hidden'));
            },

            getRankInfo(hours) {
                if(!hours) hours = 0;
                if(hours > 100) return { title: 'قائد فريق', class: 'border-2 border-yellow-500 shadow-[0_0_15px_rgba(234,179,8,0.5)]' };
                if(hours > 50) return { title: 'نشمي متقدم', class: 'border-2 border-green-500' };
                if(hours > 20) return { title: 'مسعف مساند', class: 'border-2 border-orange-500' };
                return { title: 'متطوع مستجد', class: 'border-2 border-gray-400' };
            }
        };

        // Start
        window.onload = app.init;
    </script>
</body>
</html>