<!DOCTYPE html>
<html lang="ar" dir="rtl" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>بوابة نشامى المفرق - النسخة الماسية</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap');
        :root {
            --jcd-blue: #1e3a8a;
            --jcd-red: #dc2626;
            --jcd-gold: #fbbf24;
            --jcd-dark: #111827;
        }
        body { font-family: 'Tajawal', sans-serif; background-color: #f3f4f6; color: #1f2937; overflow-x: hidden; }
        .bg-jcd-blue { background-color: var(--jcd-blue); }
        .bg-jcd-red { background-color: var(--jcd-red); }
        .text-jcd-blue { color: var(--jcd-blue); }
        
        .hero-pattern { 
            background-color: #1e3a8a; 
            background-image: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%232c4da7' fill-opacity='0.2'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E"); 
        }
        .fade-in { animation: fadeIn 0.4s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .login-tab.active { background-color: white; border-bottom: 4px solid var(--jcd-blue); color: var(--jcd-blue); font-weight: 800; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); }
        .ticker-wrap { width: 100%; overflow: hidden; background: var(--jcd-red); color: white; padding: 10px 0; border-bottom: 2px solid rgba(255,255,255,0.2); z-index: 100; }
        .ticker { display: inline-block; white-space: nowrap; animation: ticker 40s linear infinite; font-weight: bold; }
        @keyframes ticker { 0% { transform: translateX(100%); } 100% { transform: translateX(-100%); } }
        .admin-card { background: white; border-radius: 1.5rem; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); padding: 1.5rem; border-top: 5px solid var(--jcd-blue); transition: all 0.3s; position: relative; overflow: hidden; }
        .admin-card:hover { transform: translateY(-5px); box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1); }
        #globalLoader { position: fixed; inset: 0; background: white; z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        
        /* Roles & Badges */
        .badge-official { background: linear-gradient(45deg, #fbbf24, #f59e0b); color: #000; padding: 2px 10px; border-radius: 999px; font-size: 0.7rem; font-weight: 800; box-shadow: 0 2px 6px rgba(251, 191, 36, 0.4); border: 1px solid #fff; }
        .badge-admin { background: #1e3a8a; color: white; padding: 2px 8px; border-radius: 6px; font-size: 0.65rem; }
        .badge-volunteer { background: #4b5563; color: white; padding: 2px 8px; border-radius: 6px; font-size: 0.65rem; }
        
        .gallery-img-container { position: relative; border-radius: 1rem; overflow: hidden; aspect-ratio: 4/3; border: 2px solid white; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .gallery-img-container img { width: 100%; height: 100%; object-fit: cover; transition: transform 0.5s; }
        .gallery-img-container:hover img { transform: scale(1.1); }
    </style>
</head>
<body class="flex flex-col min-h-screen text-right font-black">

    <!-- Toast UI -->
    <div id="toastContainer" class="fixed bottom-10 left-10 z-[300] space-y-3 font-black text-xs"></div>

    <!-- Loader -->
    <div id="globalLoader">
        <div class="relative">
            <div class="animate-spin rounded-full h-28 w-28 border-t-4 border-b-4 border-jcd-blue"></div>
            <img id="loaderLogo" src="https://upload.wikimedia.org/wikipedia/commons/e/e0/Jordan_Civil_Defence_Logo.png" class="absolute inset-0 m-auto h-14 w-14">
        </div>
        <p class="text-gray-600 font-black mt-8 tracking-widest uppercase text-sm font-black">بوابة نشامى المفرق</p>
    </div>

    <!-- Ticker -->
    <div id="news-ticker-container" class="ticker-wrap hidden no-print">
        <div class="ticker" id="newsTickerText">جاري تحميل آخر الأخبار والتعميمات الرسمية...</div>
    </div>

    <!-- Navigation -->
    <nav class="bg-jcd-blue text-white shadow-2xl sticky top-0 z-50 no-print font-black">
        <div class="container mx-auto px-4 py-3 flex justify-between items-center">
            <div class="flex items-center gap-4 cursor-pointer group" onclick="app.showSection('home')">
                <div class="bg-white p-1 rounded-full h-12 w-12 flex items-center justify-center border-2 border-yellow-400 shadow-lg group-hover:rotate-12 transition-transform">
                     <img id="navLogo" src="https://upload.wikimedia.org/wikipedia/commons/e/e0/Jordan_Civil_Defence_Logo.png" class="h-10 w-10 object-contain">
                </div>
                <div>
                    <h1 class="font-black text-xl leading-tight tracking-tight">متطوعي الدفاع المدني المفرق</h1>
                    <p class="text-[9px] text-yellow-400 font-bold uppercase tracking-[0.2em] opacity-80 underline underline-offset-4">بوابة التميز الرقمية</p>
                </div>
            </div>
            
            <div class="flex items-center gap-6">
                <div id="guestLinks" class="hidden md:flex gap-8 text-sm">
                    <button onclick="app.showSection('home')" class="hover:text-yellow-400 transition underline-offset-8 hover:underline">الرئيسية</button>
                    <button onclick="app.showSection('gallery-section')" class="hover:text-yellow-400 transition underline-offset-8 hover:underline">المعرض</button>
                    <button id="loginShortcut" onclick="app.showLogin('volunteer')" class="bg-jcd-red px-6 py-2 rounded-full shadow-xl text-white hover:scale-105 transition-all font-black">دخول النظام</button>
                </div>
                
                <div id="userMenu" class="hidden flex items-center gap-6 text-sm">
                    <div class="relative cursor-pointer" onclick="app.toggleNotifications()">
                        <i class="fas fa-bell text-2xl text-gray-300 hover:text-white transition"></i>
                        <span id="notifBadge" class="absolute -top-1 -right-1 bg-red-500 text-[10px] text-white rounded-full h-5 w-5 flex items-center justify-center border-2 border-jcd-blue hidden font-black animate-bounce font-black">0</span>
                    </div>
                    <div class="flex flex-col items-end">
                        <span id="userNameDisplay" class="font-black text-yellow-400 text-xs font-black"></span>
                        <button onclick="app.logout()" class="text-[10px] text-gray-400 hover:text-white underline font-black uppercase font-black">تسجيل الخروج</button>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <main id="main-content" class="flex-grow container mx-auto px-4 py-8">
        
        <!-- Home Section -->
        <section id="home" class="fade-in">
            <div class="hero-pattern rounded-[3.5rem] p-10 md:p-28 text-center text-white shadow-2xl relative overflow-hidden min-h-[80vh] flex items-center justify-center border-b-8 border-yellow-400">
                <div class="relative z-10 w-full max-w-5xl text-center font-black">
                    <img id="heroLogo" src="https://upload.wikimedia.org/wikipedia/commons/e/e0/Jordan_Civil_Defence_Logo.png" class="h-44 mx-auto mb-10 drop-shadow-2xl animate-pulse">
                    <h2 class="text-6xl md:text-8xl font-black mb-6 tracking-tighter drop-shadow-2xl font-black uppercase">نشامى المفرق</h2>
                    <p class="text-xl md:text-3xl text-blue-100 mb-14 font-medium max-w-4xl mx-auto opacity-90 italic font-bold">"أصالة في الخدمة.. تميز في العطاء"</p>
                    
                    <!-- News Feed -->
                    <div id="news-feed-container" class="max-w-2xl mx-auto mb-10 space-y-4 font-black"></div>

                    <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
                        <button onclick="app.showSection('registration')" class="bg-green-600 text-white px-8 py-8 rounded-[2rem] font-black text-xl shadow-2xl flex flex-col items-center justify-center gap-4 border-b-8 border-green-900 group hover:scale-105 transition-all font-black">
                            <i class="fas fa-user-plus text-4xl group-hover:rotate-12 transition font-black font-black"></i>
                            <span>انضم إلينا</span>
                        </button>
                        <button onclick="app.showLogin('volunteer')" class="bg-white text-jcd-blue px-8 py-8 rounded-[2rem] font-black text-xl shadow-2xl flex flex-col items-center justify-center gap-4 border-b-8 border-gray-300 group hover:scale-105 transition-all font-black">
                            <i class="fas fa-id-badge text-4xl group-hover:scale-110 transition text-jcd-blue font-black font-black"></i>
                            <span>بوابة المتطوعين</span>
                        </button>
                        <button onclick="app.showLogin('admin')" class="bg-jcd-dark text-white px-8 py-8 rounded-[2rem] font-black text-xl shadow-2xl flex flex-col items-center justify-center gap-4 border-b-8 border-black text-yellow-500 group hover:scale-105 transition-all text-center font-black">
                            <i class="fas fa-lock-open text-4xl group-hover:scale-110 transition"></i>
                            <span>لوحة الإدارة</span>
                        </button>
                    </div>
                </div>
            </div>
        </section>

        <!-- Registration Section -->
        <section id="registration" class="fade-in hidden max-w-2xl mx-auto py-10 text-right font-black">
            <div class="bg-white rounded-[3rem] shadow-2xl p-12 border-t-8 border-green-600">
                <h2 class="text-4xl font-black text-jcd-blue mb-4 text-right">طلب انتساب جديد</h2>
                <p class="text-gray-500 mb-10 font-bold font-black">سيتم مراجعة طلبك من قبل الإدارة لتفعيل الحساب</p>
                <form onsubmit="app.handleRegistration(event)" class="grid grid-cols-1 md:grid-cols-2 gap-6 font-black text-right font-black">
                    <div class="md:col-span-2">
                        <input type="text" id="regName" placeholder="الاسم الرباعي الكامل" class="w-full p-4 bg-gray-50 rounded-2xl border-2 border-transparent focus:border-green-600 outline-none text-right shadow-inner font-black font-black" required>
                    </div>
                    <div class="text-right font-black font-black">
                        <input type="text" id="regId" placeholder="الرقم الوطني" class="w-full p-4 bg-gray-50 rounded-2xl border-2 border-transparent focus:border-green-600 outline-none text-right shadow-inner font-black" required>
                    </div>
                    <div class="text-right font-black font-black font-black">
                        <select id="regLocation" class="w-full p-4 bg-gray-50 rounded-2xl border-2 border-transparent focus:border-green-600 outline-none text-right shadow-inner font-black">
                            <option>المفرق - القصبة</option><option>بلعما</option><option>ارحاب</option><option>الخالدية</option><option>الرويشد</option>
                        </select>
                    </div>
                    <div class="md:col-span-2 font-black font-black">
                        <input type="password" id="regPass" placeholder="اختر كلمة مرور" class="w-full p-4 bg-gray-50 rounded-2xl border-2 border-transparent focus:border-green-600 outline-none text-right shadow-inner font-black" required>
                    </div>
                    <button type="submit" class="md:col-span-2 bg-green-600 text-white font-black py-5 rounded-[1.5rem] shadow-xl text-xl hover:bg-green-700 transition uppercase tracking-widest font-black font-black font-black">إرسال الطلب</button>
                    <button type="button" onclick="app.showSection('home')" class="md:col-span-2 text-sm text-gray-400 font-bold text-center uppercase tracking-widest hover:text-jcd-blue font-black font-black">إلغاء والعودة</button>
                </form>
            </div>
        </section>

        <!-- Gallery Section -->
        <section id="gallery-section" class="fade-in hidden font-black">
            <div class="bg-white rounded-[3rem] p-12 shadow-xl border border-gray-100 font-black text-right font-black font-black font-black">
                <div class="flex flex-col md:flex-row justify-between items-center mb-12 gap-6 font-black font-black font-black">
                    <div>
                        <h2 class="text-5xl font-black text-jcd-blue mb-2 font-black">معرض صور الميدان</h2>
                        <p class="text-gray-500 font-bold text-lg font-black font-black">توثيق حي لعطاء نشامى الدفاع المدني</p>
                    </div>
                    <i class="fas fa-images text-7xl text-gray-100 font-black"></i>
                </div>
                <div id="fullGalleryGrid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-8 font-black font-black font-black font-black"></div>
            </div>
        </section>

        <!-- Login Section -->
        <section id="login" class="fade-in hidden max-w-md mx-auto py-10 font-black">
            <div class="bg-white rounded-[2.5rem] shadow-2xl p-10 border-t-8 border-jcd-blue relative overflow-hidden font-black">
                <div class="flex mb-10 bg-gray-100 rounded-2xl p-1.5 shadow-inner font-black font-black">
                    <button class="w-1/2 login-tab active py-4 text-sm font-black rounded-xl transition font-black font-black font-black" id="tab-volunteer" onclick="app.switchLoginTab('volunteer')">متطوع</button>
                    <button class="w-1/2 login-tab py-4 text-sm font-black rounded-xl transition font-black font-black font-black" id="tab-admin" onclick="app.switchLoginTab('admin')">إدارة</button>
                </div>
                <h2 class="text-3xl font-black text-center mb-10 text-jcd-blue font-black" id="loginTitle">تسجيل الدخول</h2>
                <form onsubmit="app.handleLogin(event)" class="space-y-6 font-black text-right text-sm font-black">
                    <div class="relative font-black">
                        <input type="text" id="username" placeholder="المعرف / الرقم الوطني" class="w-full bg-gray-50 p-4 pr-12 rounded-2xl outline-none transition focus:ring-4 focus:ring-blue-100 border-2 border-transparent focus:border-jcd-blue text-right font-black" required>
                        <i class="fas fa-id-card absolute right-4 top-4 text-gray-400 font-black font-black"></i>
                    </div>
                    <div class="relative font-black">
                        <input type="password" id="password" placeholder="كلمة المرور" class="w-full bg-gray-50 p-4 pr-12 rounded-2xl outline-none transition focus:ring-4 focus:ring-blue-100 border-2 border-transparent focus:border-jcd-blue text-right font-black" required>
                        <i class="fas fa-lock absolute right-4 top-4 text-gray-400 font-black font-black"></i>
                    </div>
                    <button type="submit" class="w-full bg-jcd-blue text-white font-black py-5 rounded-[1.5rem] shadow-xl text-lg tracking-widest uppercase transition-all hover:bg-blue-900 font-black font-black font-black">دخول آمن</button>
                </form>
            </div>
        </section>

        <!-- Volunteer Dashboard -->
        <section id="volunteer-dashboard" class="fade-in hidden space-y-10 font-black text-right font-black font-black font-black">
            <div class="bg-jcd-blue rounded-[3rem] p-10 md:p-14 text-white shadow-2xl flex flex-col md:flex-row justify-between items-center gap-10 relative overflow-hidden text-right font-black font-black font-black font-black font-black font-black">
                <div class="absolute top-0 left-0 w-full h-full opacity-10 pointer-events-none hero-pattern scale-150 font-black font-black font-black font-black font-black font-black"></div>
                <div class="flex items-center gap-10 relative z-10 font-black">
                    <div class="relative group font-black">
                        <img id="dashAvatar" src="https://via.placeholder.com/150" class="h-44 w-44 rounded-full border-8 border-white/20 shadow-2xl object-cover cursor-pointer transition-all duration-500 hover:scale-105 font-black font-black font-black font-black" onclick="app.openProfileEdit()">
                        <div class="absolute bottom-2 right-2 bg-yellow-400 text-black h-12 w-12 rounded-full flex items-center justify-center shadow-lg cursor-pointer animate-bounce font-black" onclick="app.openProfileEdit()"><i class="fas fa-camera text-xl font-black font-black"></i></div>
                    </div>
                    <div>
                        <div class="flex flex-wrap items-center gap-4 text-right font-black">
                            <h2 class="text-4xl md:text-6xl font-black tracking-tighter font-black font-black" id="volNameDisplay"></h2>
                            <span id="dashOfficialBadge" class="hidden badge-official font-black font-black font-black font-black font-black"><i class="fas fa-crown mr-1 font-black"></i> مسؤول دفعة</span>
                        </div>
                        <p id="volBioDisplay" class="text-blue-100/70 mt-6 text-sm font-medium italic max-w-md leading-relaxed font-black font-black font-black font-black font-black"></p>
                        <div class="flex flex-wrap gap-5 mt-10 font-black">
                            <div class="bg-white/10 backdrop-blur-2xl px-10 py-5 rounded-[2rem] text-2xl flex items-center gap-5 border border-white/10 shadow-2xl font-black font-black font-black">
                                <i class="fas fa-star text-yellow-400 text-4xl animate-pulse font-black font-black font-black font-black font-black"></i> 
                                <div><span id="volPoints" class="block leading-none text-yellow-400 font-black font-black">0</span><span class="text-[10px] uppercase tracking-widest text-blue-200 block mt-2 font-black font-black">نقاط تميز</span></div>
                            </div>
                            <div class="bg-white/10 backdrop-blur-2xl px-10 py-5 rounded-[2rem] text-2xl flex items-center gap-5 border border-white/10 shadow-2xl font-black font-black font-black font-black font-black">
                                <i class="fas fa-hourglass-half text-green-400 text-4xl font-black font-black font-black font-black font-black"></i> 
                                <div><span id="volHours" class="block leading-none text-green-400 font-black font-black">0</span><span class="text-[10px] uppercase tracking-widest text-blue-200 block mt-2 font-black font-black font-black font-black">ساعة تطوع</span></div>
                            </div>
                        </div>
                    </div>
                </div>
                <div id="gateContainer" class="bg-white/10 backdrop-blur-3xl p-10 rounded-[2.5rem] border border-white/20 text-center min-w-[350px] relative z-10 shadow-inner font-black font-black font-black font-black font-black"></div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-10 font-black font-black font-black font-black">
                <div class="lg:col-span-1 space-y-10 text-right font-black font-black">
                    <div class="bg-white p-10 rounded-[3rem] shadow-xl border-b-8 border-jcd-blue font-black">
                        <h3 class="font-black text-2xl mb-8 flex items-center gap-4 text-jcd-blue font-black font-black font-black font-black font-black"><i class="fas fa-chart-line text-blue-500 font-black"></i> مؤشرات الأداء</h3>
                        <canvas id="performanceChart" height="250"></canvas>
                    </div>
                    <div class="bg-jcd-dark text-white p-10 rounded-[3rem] shadow-2xl relative overflow-hidden text-right font-black font-black font-black">
                        <div class="absolute -top-10 -right-10 h-40 w-40 bg-yellow-500/10 rounded-full blur-3xl font-black"></div>
                        <h3 class="font-black text-2xl mb-10 flex items-center gap-4 relative z-10 font-black font-black font-black font-black font-black font-black font-black"><i class="fas fa-award text-yellow-400 text-4xl ml-2 animate-bounce font-black font-black font-black font-black font-black"></i> لوحة الشرف</h3>
                        <div id="leaderboardList" class="space-y-6 relative z-10 font-black text-right font-black font-black font-black font-black font-black"></div>
                    </div>
                </div>

                <div class="lg:col-span-2 space-y-10 text-right font-black font-black font-black">
                    <div class="bg-white p-12 rounded-[3.5rem] shadow-xl border border-gray-50 text-right font-black">
                        <h3 class="font-black text-3xl text-jcd-blue flex items-center gap-5 mb-12 text-right font-black font-black font-black font-black font-black"><i class="fas fa-calendar-alt text-blue-500 ml-2 font-black font-black"></i> حجز المناوبات (آلي: إثنين وثلاثاء)</h3>
                        <div id="shiftsGrid" class="grid grid-cols-1 sm:grid-cols-2 gap-8 font-black font-black font-black font-black font-black"></div>
                    </div>

                    <div class="bg-gradient-to-br from-indigo-900 via-blue-900 to-jcd-blue rounded-[3rem] p-12 text-white shadow-2xl relative overflow-hidden font-black">
                        <h3 class="font-black text-2xl mb-10 flex items-center gap-4 text-right font-black font-black font-black font-black font-black font-black font-black font-black font-black font-black"><i class="fas fa-robot text-blue-300 ml-2 font-black font-black font-black font-black font-black"></i> المستشار الذكي (Gemini AI)</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-10 text-right font-black">
                            <div class="bg-white/10 backdrop-blur-xl p-8 rounded-[2.5rem] border border-white/10 shadow-inner font-black font-black">
                                <div id="safetyChat" class="h-64 overflow-y-auto mb-6 bg-black/20 rounded-2xl p-6 text-xs space-y-4 custom-scrollbar text-right font-black"></div>
                                <div class="flex gap-4 font-black">
                                    <input type="text" id="safetyInput" placeholder="اسأل الخبير..." class="flex-grow bg-white/10 border-none rounded-xl px-5 py-4 text-xs outline-none text-white font-black text-right shadow-inner font-black">
                                    <button onclick="app.askAI()" class="bg-blue-500 p-4 rounded-xl hover:bg-blue-400 transition shadow-xl font-black font-black"><i class="fas fa-paper-plane font-black font-black font-black"></i></button>
                                </div>
                            </div>
                            <div class="bg-white/10 backdrop-blur-xl p-8 rounded-[2.5rem] border border-white/10 flex flex-col shadow-inner font-black font-black">
                                <textarea id="reportContext" placeholder="وقائع المهمة..." class="w-full flex-grow bg-white/10 border-none rounded-2xl p-5 text-xs mb-6 outline-none resize-none font-bold text-white text-right font-black font-black font-black font-black"></textarea>
                                <button onclick="app.generateReport()" class="w-full bg-indigo-600 py-4 rounded-2xl font-black text-sm shadow-xl tracking-widest uppercase hover:bg-indigo-700 transition font-black font-black font-black">صياغة تقرير رسمي</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Section: Admin Dashboard -->
        <section id="admin-dashboard" class="fade-in hidden space-y-12 no-print text-right font-black font-black">
            <div class="bg-jcd-blue rounded-[3.5rem] p-12 text-white shadow-2xl flex flex-col md:flex-row items-center justify-between gap-10 relative overflow-hidden font-black font-black font-black font-black font-black">
                <h2 class="text-6xl font-black tracking-tighter uppercase font-black font-black">لوحة الإدارة الماسية</h2>
                <div class="bg-white/10 backdrop-blur-xl px-12 py-5 rounded-3xl border border-white/20 text-yellow-400 font-black text-2xl mt-8 inline-block shadow-2xl font-black font-black font-black transition hover:bg-white/20">سيادة المدير: <span id="adminNameSpan"></span></div>
            </div>

            <!-- Stats Widgets -->
            <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-4 gap-8 font-black font-black font-black font-black font-black font-black">
                <div class="admin-card border-t-red-600 bg-gradient-to-b from-white to-red-50/20 shadow-2xl font-black">
                    <div class="flex justify-between items-center mb-6 font-black">
                        <h3 class="font-black text-gray-400 text-[10px] uppercase tracking-widest font-black font-black font-black font-black">طلبات تغيير السر</h3>
                        <span id="passReqCount" class="bg-red-100 text-red-600 h-10 w-10 rounded-full flex items-center justify-center font-black shadow-inner font-black font-black font-black">0</span>
                    </div>
                    <div id="passReqList" class="space-y-4 max-h-64 overflow-y-auto pr-2 custom-scrollbar font-black font-black"></div>
                </div>
                <div class="admin-card border-t-green-500 shadow-2xl font-black font-black">
                    <h3 class="font-black text-gray-400 text-[10px] uppercase mb-6 text-right font-black font-black">الميدان الآن <span id="rosterCount" class="bg-green-100 text-green-600 px-2 rounded-full font-black font-black">0</span></h3>
                    <div id="liveAttendanceList" class="space-y-3 font-black font-black font-black font-black"></div>
                </div>
                <div class="admin-card border-t-indigo-600 flex flex-col justify-between shadow-2xl font-black font-black font-black">
                    <button onclick="app.exportPDF()" class="w-full bg-indigo-600 text-white py-5 rounded-2xl font-black shadow-xl text-lg font-black font-black font-black font-black">
                        <i class="fas fa-file-pdf ml-2 font-black font-black"></i> تصدير الكشف PDF
                    </button>
                </div>
                <div class="admin-card border-t-orange-500 shadow-2xl font-black font-black font-black font-black font-black font-black">
                    <h3 class="font-black text-gray-400 text-[10px] uppercase mb-6 text-right font-black font-black">انتساب جديد</h3>
                    <div id="regRequestsList" class="space-y-3 font-black font-black font-black font-black"></div>
                </div>
            </div>

            <!-- Master Management Grid -->
            <div class="grid grid-cols-1 xl:grid-cols-3 gap-10 font-black font-black">
                <div class="xl:col-span-1 space-y-10 font-black">
                    <!-- Identity Tower -->
                    <div class="admin-card border-t-gray-800 shadow-2xl font-black">
                        <h3 class="font-black text-2xl mb-10 flex items-center gap-4 font-black text-gray-800 font-black font-black"><i class="fas fa-tools text-blue-500 ml-2 font-black font-black font-black font-black"></i> إعدادات الهوية</h3>
                        <div class="space-y-8 font-black">
                            <div class="text-right">
                                <label class="block text-[10px] font-black text-gray-400 mb-3 uppercase font-black text-right font-black">تحديث الشعار (ملف)</label>
                                <input type="file" id="uploadLogo" accept="image/*" onchange="app.handleLogoUpload(event)" class="w-full bg-gray-50 p-4 rounded-2xl font-black text-xs cursor-pointer border-2 border-dashed border-gray-200">
                            </div>
                            <div class="text-right font-black font-black font-black">
                                <label class="block text-[10px] font-black text-gray-400 mb-3 uppercase font-black text-right font-black">الشريط الإخباري</label>
                                <div class="flex gap-3">
                                    <input type="text" id="adminTickerText" class="w-full bg-gray-50 p-5 rounded-2xl text-xs font-black outline-shadow-inner text-right font-black">
                                    <button onclick="app.saveTicker()" class="bg-gray-800 text-white px-8 rounded-2xl font-black text-xs hover:bg-black transition shadow-lg font-black font-black">حفظ</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Messenger -->
                    <div class="admin-card border-t-blue-400 shadow-2xl font-black">
                        <h3 class="font-black text-2xl mb-10 text-blue-800 flex items-center gap-4 font-black tracking-tighter font-black font-black"><i class="fas fa-paper-plane-alt text-blue-400 ml-2 font-black font-black"></i> المراسلة والتعميم</h3>
                        <div class="space-y-6 font-black font-black font-black font-black">
                            <select id="msgRecipient" class="w-full bg-gray-50 p-5 rounded-2xl text-sm outline-none border font-black text-right appearance-none font-black font-black"></select>
                            <textarea id="msgBody" placeholder="نص الرسالة..." class="w-full bg-gray-50 rounded-3xl p-6 text-sm h-44 outline-none resize-none border font-black text-right shadow-inner font-black"></textarea>
                            <button onclick="app.adminSendMessage()" class="w-full bg-jcd-blue text-white py-6 rounded-[1.5rem] font-black shadow-2xl btn-hover text-lg tracking-widest uppercase transition-all font-black font-black">إرسال التعميم</button>
                        </div>
                    </div>

                    <!-- News -->
                    <div class="admin-card border-t-yellow-500 shadow-2xl font-black font-black font-black">
                        <h3 class="font-black text-2xl mb-10 text-yellow-800 flex items-center gap-4 font-black font-black font-black"><i class="fas fa-newspaper text-yellow-500 ml-2 font-black font-black"></i> نشر أخبار البوابة</h3>
                        <div class="space-y-6 font-black font-black font-black">
                             <input type="text" id="newsTitle" placeholder="عنوان الخبر الرئيسي..." class="w-full p-4 bg-gray-50 rounded-2xl font-black outline-none text-right shadow-inner">
                             <textarea id="newsContent" placeholder="تفاصيل الخبر..." class="w-full p-4 bg-gray-50 rounded-2xl font-black outline-none h-32 resize-none text-right shadow-inner font-black"></textarea>
                             <button onclick="app.publishNews()" class="w-full bg-yellow-500 text-black py-4 rounded-[1.2rem] font-black shadow-lg hover:bg-yellow-600 transition font-black">نشر الخبر فوراً</button>
                        </div>
                    </div>
                </div>

                <div class="xl:col-span-2 space-y-10 font-black text-right">
                    <!-- Smart Add -->
                    <div class="admin-card border-t-green-600 shadow-2xl font-black font-black font-black">
                         <h3 class="font-black text-2xl mb-10 flex items-center gap-4 font-black font-black font-black"><i class="fas fa-magic text-green-500 ml-2 font-black font-black font-black font-black"></i> إضافة نشمي جديد (أتمتة ذكية)</h3>
                         <div class="flex gap-4 font-black font-black">
                             <input type="text" id="smartAddName" placeholder="اكتب اسم النشـمي الرباعي فقط..." class="flex-grow p-5 bg-gray-50 rounded-2xl text-sm font-black outline-none text-right shadow-inner font-black">
                             <button onclick="app.adminSmartAdd()" class="bg-green-600 text-white px-10 rounded-[1.2rem] font-black shadow-lg font-black font-black font-black">إضافة آلياً</button>
                         </div>
                    </div>

                    <!-- User Management Table -->
                    <div class="admin-card border-t-gray-700 shadow-2xl font-black font-black">
                        <div class="flex flex-col md:flex-row justify-between items-center mb-10 gap-8 font-black font-black font-black">
                            <h3 class="font-black text-3xl font-black uppercase tracking-tighter font-black font-black font-black">إدارة النشامى والمعرفات</h3>
                            <input type="text" oninput="app.filterUsers(this.value)" placeholder="بحث بالاسم أو المعرف..." class="w-full md:w-96 bg-gray-50 px-10 py-5 rounded-3xl text-sm outline-none border focus:border-jcd-blue transition font-black text-right shadow-md font-black">
                        </div>
                        <div class="overflow-x-auto text-right font-black font-black font-black font-black">
                            <table class="w-full text-right text-sm font-black font-black font-black font-black">
                                <thead class="bg-gray-100 font-black text-[10px] text-gray-400 uppercase tracking-[0.2em] text-right font-black font-black font-black font-black font-black">
                                    <tr><th class="p-6 rounded-r-3xl text-right font-black">النشـمي</th><th class="p-6 text-center font-black">المعرف</th><th class="p-6 text-center font-black text-jcd-blue font-black font-black font-black font-black font-black font-black">النقاط</th><th class="p-6 text-center font-black text-blue-600 font-black font-black font-black font-black">كلمة السر</th><th class="p-6 rounded-l-3xl text-left font-black font-black font-black">تحكم</th></tr>
                                </thead>
                                <tbody id="fullUsersTable" class="divide-y divide-gray-50 font-black text-right font-black font-black font-black font-black font-black font-black font-black font-black"></tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Shifts Hub -->
                    <div class="admin-card border-t-purple-600 bg-gradient-to-br from-white to-purple-50/30 font-black font-black font-black font-black">
                        <h3 class="font-black text-2xl mb-10 text-purple-900 flex items-center gap-4 font-black font-black font-black"><i class="fas fa-user-check text-purple-500 ml-2 font-black font-black"></i> سجل المناوبات والتحضير</h3>
                        <div class="overflow-x-auto text-right font-black font-black font-black font-black">
                            <table class="w-full text-right text-sm font-black font-black font-black font-black font-black font-black">
                                <thead class="bg-gray-50 font-black text-[10px] text-gray-400 uppercase tracking-widest text-center font-black font-black font-black font-black font-black font-black font-black">
                                    <tr><th class="p-6 rounded-r-3xl font-black font-black">اليوم والتاريخ</th><th class="p-6 rounded-l-3xl text-center font-black font-black font-black font-black">المسجلين (تحضير بنقرة)</th></tr>
                                </thead>
                                <tbody id="shiftsRegistryBody" class="divide-y divide-gray-100 text-center font-black font-black"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Hidden PDF -->
        <div id="printableRoster" class="hidden p-10 bg-white text-black font-black">
            <div class="border-[8px] border-black p-8 font-black font-black font-black font-black font-black">
                <div class="flex justify-between items-start border-b-[6px] border-black pb-10 mb-10 font-black">
                    <div class="text-right font-black text-xl space-y-2 font-black">
                        <p>المديرية العامة للدفاع المدني</p>
                        <p>مديرية المفرق</p>
                    </div>
                    <img id="printLogo" src="https://upload.wikimedia.org/wikipedia/commons/e/e0/Jordan_Civil_Defence_Logo.png" class="h-32">
                    <div class="text-left font-black text-xl space-y-2 text-left font-black">
                        <p id="printTodayDate"></p>
                        <p>سري للغاية</p>
                    </div>
                </div>
                <div class="text-center mb-12 font-black"><h2 class="text-6xl font-black underline decoration-double underline-offset-[15px] uppercase font-black font-black">كشف حضور نشامى المفرق</h2></div>
                <table class="w-full border-collapse border-[6px] border-black text-right text-2xl font-black font-black font-black font-black font-black">
                    <thead><tr class="bg-gray-100 border-[6px] border-black font-black font-black"><th class="border-4 border-black p-6 text-center w-20 font-black">م</th><th class="border-4 border-black p-6 font-black font-black">الاسم الكامل</th><th class="border-4 border-black p-6 text-center font-black">المعرف</th><th class="border-4 border-black p-6 text-center font-black font-black">التوقيع</th></tr></thead>
                    <tbody id="printBody"></tbody>
                </table>
            </div>
        </div>

        <footer class="no-print bg-white/80 backdrop-blur-md py-12 mt-12 border-t border-gray-100 text-center rounded-t-[3.5rem] shadow-inner font-black font-black font-black font-black font-black">
            <div class="container mx-auto px-4 font-black font-black font-black">
                <div class="inline-block bg-jcd-blue/5 px-10 py-4 rounded-full border-2 border-jcd-blue/10 shadow-lg transition-all hover:bg-jcd-blue/10 scale-105 font-black">
                    <p class="text-sm text-jcd-blue font-black tracking-wide font-black">
                        تم تطوير الموقع بواسطة معاذ احمد الخوالدة <span class="mx-4 text-gray-300 font-black font-black font-black">|</span> <span class="tracking-[0.1em] font-black font-black font-black">0772536229</span>
                    </p>
                </div>
            </div>
        </footer>

    </main>

    <!-- Logic Engine -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, updateDoc, onSnapshot, addDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
          apiKey: "AIzaSyCzbJ_BCreCrOgkDq_zCdJ1O3FCDcguoXA",
          authDomain: "civil-defense-mafraq-b7b9d.firebaseapp.com",
          projectId: "civil-defense-mafraq-b7b9d",
          storageBucket: "civil-defense-mafraq-b7b9d.firebasestorage.app",
          messagingSenderId: "14265166108",
          appId: "1:14265166108:web:2f1ac0d4c89b2fe9cff2d9"
        };

        const GEMINI_KEY = "AIzaSyDXfI33tFUOSj9JBEF26lg3PxvGJ4C607w";
        const fireApp = initializeApp(firebaseConfig);
        const auth = getAuth(fireApp);
        const db = getFirestore(fireApp);
        const appId = 'mafraq-diamond-elite-master-final-v21';

        window.app = {
            data: { users: [], settings: {}, suggestions: [], gallery: [], news: [], currentUser: null },
            charts: { perfChart: null },
            uploadedAvatarBase64: null,
            
            async init() {
                try { await signInAnonymously(auth); } catch (e) {}
                onAuthStateChanged(auth, (user) => { if (user) app.setupListeners(); });
            },

            setupListeners() {
                onSnapshot(doc(db, 'artifacts', appId, 'public', 'data', 'settings', 'main'), (snap) => {
                    app.data.settings = snap.exists() ? snap.data() : { ticker: "أهلاً بكم في بوابة نشامى المفرق المتطورة", logo: "" };
                    app.applySettings();
                });
                onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'users'), (snap) => {
                    const users = []; snap.forEach(d => users.push({ ...d.data(), _id: d.id }));
                    app.data.users = users;
                    app.seedData();
                    app.checkSession();
                    app.renderUI();
                });
                onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'gallery'), (snap) => {
                    const gal = []; snap.forEach(d => gal.push({ ...d.data(), _id: d.id }));
                    app.data.gallery = gal;
                    app.renderGallery();
                });
                onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'news'), (snap) => {
                    const news = []; snap.forEach(d => news.push({ ...d.data(), _id: d.id }));
                    app.data.news = news;
                    app.renderNews();
                });
                onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'suggestions'), (snap) => {
                    const suggs = []; snap.forEach(d => suggs.push({ ...d.data(), _id: d.id }));
                    app.data.suggestions = suggs;
                    app.renderUI();
                });
                document.getElementById('globalLoader').style.display = 'none';
            },

            async seedData() {
                if (app.data.users.length > 20) return;
                const adminList = [
                    { id: '100', name: 'عطوفة المدير العام', pass: '2026', role: 'admin' },
                    { id: '101', name: 'معاذ الخوالدة', pass: '2026', role: 'admin', isOfficial: true },
                    { id: '18', name: 'سجود شديفات', pass: '4568', role: 'volunteer', isOfficial: true },
                    { id: '3', name: 'معاذ الخوالدة', pass: '7741', role: 'volunteer', isOfficial: true }
                ];
                const volNames = [
                    'مالك عليمات', 'هدى', 'حسام الحسبان', 'إبراهيم سعود', 'خولة نضال', 'رسول الخزاعلة', 'سلوى الصقور',
                    'شرف الحراحشة', 'عبد الرحمن يونس', 'عمر ياسين', 'امين المصري', 'فرحان الخوالدة', 'حور العرقان',
                    'مدين الشرفات', 'سند عليمات', 'شهم الحسبان', 'يوسف دعجة', 'بلقيس الكناني', 'عهد الحسبان', 'أرم',
                    'اريج النعيمات', 'عزيزة السقال', 'باسل', 'في', 'حمدان عليمات', 'ختام ابو قديري', 'لارا العجلوني',
                    'ميار الهواري', 'ريتاج', 'رويدا', 'ربى', 'سوار', 'سندس عليمات', 'رند العناسوة'
                ];
                
                const all = [...adminList.map(a=>({...a, status:'active'}))];
                volNames.forEach((n, idx) => {
                    const id = (idx + 1).toString();
                    if (!all.some(x => x.id === id)) {
                        all.push({ id, name: n, pass: "1234", role: 'volunteer', status: 'active' });
                    }
                });

                for (const u of all) {
                    if (!app.data.users.some(e => e.id === u.id)) {
                        await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users', u.id), { ...u, stats:{points:0, hours:0}, history:[], shifts:[], notifications:[] });
                    }
                }
            },

            async checkSession() {
                const uid = localStorage.getItem('jcd_uid_master_v21');
                if (uid) {
                    const user = app.data.users.find(u => u.id === uid);
                    if (user && !app.data.currentUser) { app.data.currentUser = user; app.showDashboard(user); app.checkDailyBonus(); }
                }
            },

            async checkDailyBonus() {
                const u = app.data.currentUser;
                const today = new Date().toLocaleDateString('en-US');
                if (u && u.lastLoginBonus !== today) {
                    const newPoints = (u.stats?.points || 0) + 5;
                    await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users', u.id), { lastLoginBonus: today, "stats.points": newPoints });
                }
            },

            showSection(id) {
                document.querySelectorAll('section').forEach(s => s.classList.add('hidden'));
                const target = document.getElementById(id);
                if (target) target.classList.remove('hidden');
                window.scrollTo(0, 0);
            },

            showLogin(type) { app.showSection('login'); app.switchLoginTab(type); },
            switchLoginTab(type) {
                const elements = ['tab-volunteer', 'tab-admin', 'loginTitle'];
                const refs = {}; elements.forEach(e => refs[e] = document.getElementById(e));
                if(refs['tab-volunteer']) refs['tab-volunteer'].classList.remove('active');
                if(refs['tab-admin']) refs['tab-admin'].classList.remove('active');
                const activeTab = document.getElementById(`tab-${type}`);
                if(activeTab) activeTab.classList.add('active');
                if(refs.loginTitle) refs.loginTitle.innerText = type === 'admin' ? 'دخول لوحة الإدارة' : 'دخول النشامى';
            },

            async handleLogin(event) {
                event.preventDefault();
                const id = document.getElementById('username').value.trim();
                const pass = document.getElementById('password').value.trim();
                const user = app.data.users.find(u => u.id === id);
                if (!user || user.pass !== pass) return app.showToast("خطأ في البيانات");
                if (user.status !== 'active') return app.showToast("الحساب معلق");
                app.data.currentUser = user;
                localStorage.setItem('jcd_uid_master_v21', user.id);
                app.showDashboard(user);
            },

            logout() {
                app.data.currentUser = null;
                localStorage.removeItem('jcd_uid_master_v21');
                app.showSection('home');
                const uM = document.getElementById('userMenu'); if(uM) uM.classList.add('hidden');
                const gL = document.getElementById('guestLinks'); if(gL) gL.classList.remove('hidden');
            },

            showDashboard(user) {
                const gL = document.getElementById('guestLinks'); if(gL) gL.classList.add('hidden');
                const uM = document.getElementById('userMenu'); if(uM) uM.classList.remove('hidden');
                const uND = document.getElementById('userNameDisplay'); if(uND) uND.innerText = user.name;
                const badge = document.getElementById('userRoleBadge');
                if (badge) {
                    badge.innerText = user.role === 'admin' ? 'إدارة' : 'متطوع';
                    badge.className = user.role === 'admin' ? 'badge-admin' : 'badge-volunteer';
                }
                user.role === 'admin' ? app.showSection('admin-dashboard') : (app.showSection('volunteer-dashboard'), app.renderVolunteerUI());
            },

            renderVolunteerUI() {
                const u = app.data.currentUser; if(!u) return;
                const vND = document.getElementById('volNameDisplay'); if(vND) vND.innerText = u.name;
                const vP = document.getElementById('volPoints'); if(vP) vP.innerText = u.stats?.points || 0;
                const vH = document.getElementById('volHours'); if(vH) vH.innerText = (u.stats?.hours || 0).toFixed(1);
                const vBD = document.getElementById('volBioDisplay'); if(vBD) vBD.innerText = u.bio || "نشـمي فخور";
                const dA = document.getElementById('dashAvatar'); if(dA) dA.src = u.avatar || "https://via.placeholder.com/150";
                const offBadge = document.getElementById('dashOfficialBadge');
                if (offBadge) {
                    if (u.id === '101' || u.id === '3' || u.id === '18' || u.isOfficial) offBadge.classList.remove('hidden'); else offBadge.classList.add('hidden');
                }
                app.renderGate(); app.renderShifts(); app.renderHistory(); app.renderLeaderboard(); app.initCharts(u);
            },

            initCharts(u) {
                const canvas = document.getElementById('performanceChart');
                if (!canvas) return;
                const ctx = canvas.getContext('2d');
                if (app.charts.perfChart) app.charts.perfChart.destroy();
                const labels = (u.history || []).slice(-7).map(h => h.date.split('-')[1]?.trim() || "سابق");
                const points = (u.history || []).slice(-7).map(h => h.points);
                app.charts.perfChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels.length ? labels : ['سابق'],
                        datasets: [{ label: 'النقاط', data: points.length ? points : [0], borderColor: '#fbbf24', backgroundColor: 'rgba(251, 191, 36, 0.1)', fill: true, tension: 0.4, borderWidth: 3 }]
                    },
                    options: { responsive: true, plugins: { legend: { display: false } } }
                });
            },

            renderGate() {
                const u = app.data.currentUser;
                const container = document.getElementById('gateContainer');
                if (!container) return;
                container.innerHTML = u.currentSession ? 
                    `<button onclick="app.checkOut()" class="w-full bg-red-600 py-4 rounded-[1.2rem] font-black text-white shadow-2xl transition hover:bg-red-700">إنهاء المهمة (Check-Out)</button>` :
                    `<button onclick="app.checkIn()" class="w-full bg-green-600 py-4 rounded-[1.2rem] font-black text-white shadow-2xl transition hover:bg-green-700">دخول الميدان</button>`;
            },

            async checkIn() {
                const now = new Date();
                await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users', app.data.currentUser.id), { currentSession: { start: now.toISOString(), time: now.toLocaleTimeString('ar-JO') } });
            },

            async checkOut() {
                const u = app.data.currentUser;
                const hours = (new Date() - new Date(u.currentSession.start)) / (1000 * 60 * 60);
                const points = Math.max(5, Math.floor(hours * 15));
                const today = new Date();
                const dayName = today.toLocaleDateString('ar-JO', {weekday:'long'});
                const record = { date: `${dayName} - ${today.toLocaleDateString('ar-JO')}`, start: u.currentSession.time, end: new Date().toLocaleTimeString('ar-JO'), hours: hours.toFixed(2), points };
                await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users', u.id), { currentSession: null, history: [...(u.history || []), record], "stats.points": (u.stats.points || 0) + points, "stats.hours": (u.stats.hours || 0) + hours });
            },

            renderLeaderboard() {
                const list = document.getElementById('leaderboardList'); if(!list) return;
                const top10 = [...app.data.users].filter(u => u.role === 'volunteer' || u.isOfficial).sort((a,b) => (b.stats?.points || 0) - (a.stats?.points || 0)).slice(0, 10);
                list.innerHTML = top10.map((u, i) => `<div class="flex justify-between items-center p-4 rounded-3xl ${u.id === app.data.currentUser.id ? 'bg-yellow-400/20 border-2 border-yellow-400/40 shadow-xl' : 'bg-white/5'} font-black transition hover:scale-105">
                    <div class="flex items-center gap-4 text-right">
                        <span class="font-black text-sm ${i<3?'text-yellow-400':'text-gray-500'} font-black">#${i+1}</span>
                        <img src="${u.avatar || 'https://via.placeholder.com/150'}" class="h-10 w-10 rounded-full border shadow-sm">
                        <span class="text-xs font-black">${u.name} ${u.id === '101' || u.id === '3' || u.id === '18' ? '👑' : ''}</span>
                    </div>
                    <span class="text-[11px] font-black text-yellow-400">${u.stats?.points || 0} pt</span>
                </div>`).join('');
            },

            async renderAdminDashboard() {
                const users = app.data.users;
                const active = users.filter(u => u.currentSession);
                const passReqs = users.filter(u => u.passwordRequest?.status === 'pending');
                const regReqs = users.filter(u => u.status === 'pending');

                const refs = ['adminNameSpan', 'rosterCount', 'passReqCount', 'suggestionsCount', 'rosterCurrentDate', 'liveAttendanceList', 'passReqList', 'printTodayDate', 'regRequestsList'];
                const els = {}; refs.forEach(r => els[r] = document.getElementById(r));

                if(els.adminNameSpan) els.adminNameSpan.innerText = app.data.currentUser.name;
                if(els.rosterCount) els.rosterCount.innerText = active.length;
                if(els.passReqCount) els.passReqCount.innerText = passReqs.length;
                if(els.suggestionsCount) els.suggestionsCount.innerText = app.data.suggestions.length;
                if(els.rosterCurrentDate) els.rosterCurrentDate.innerText = new Date().toLocaleDateString('ar-JO', {weekday:'long', day:'numeric', month:'long'});
                if(els.printTodayDate) els.printTodayDate.innerText = new Date().toLocaleDateString('ar-JO');

                if(els.liveAttendanceList) els.liveAttendanceList.innerHTML = active.map(u => `<div class="bg-green-50 p-4 rounded-2xl border border-green-100 flex justify-between items-center font-black text-xs"><span>${u.name}</span><span class="text-green-600 bg-white px-2 py-1 rounded-lg border font-black">${u.currentSession.time}</span></div>`).join('') || '<p class="text-center py-4 font-black text-xs text-gray-300">No Active Heroes</p>';

                if(els.passReqList) els.passReqList.innerHTML = passReqs.map(u => `<div class="bg-red-50 p-4 rounded-2xl border border-red-100 flex flex-col gap-2 font-black text-xs"><div class="flex justify-between items-center"><span>${u.name}</span><span class="text-red-600 font-black">${u.passwordRequest.newPass}</span></div><button onclick="app.approvePass('${u.id}')" class="bg-red-600 text-white py-2 rounded-xl text-[10px] font-black uppercase">موافقة وتحديث</button></div>`).join('') || '<p class="text-center py-4 italic font-black text-xs text-gray-300">None</p>';

                if(els.regRequestsList) els.regRequestsList.innerHTML = regReqs.map(u => `<div class="bg-orange-50 p-3 rounded-2xl flex justify-between items-center border border-orange-100 text-[10px] font-black font-black"><span>${u.name}</span><button onclick="app.adminAction('${u.id}', 'approve')" class="bg-green-600 text-white px-4 py-1 rounded-xl">تفعيل</button></div>`).join('') || '<p class="text-center text-gray-300 text-[10px] py-4 italic">None</p>';

                app.renderUserTable(users);
                app.renderShiftsRegistry();
                app.renderMessenger();
            },

            renderUserTable(list) {
                const table = document.getElementById('fullUsersTable');
                if (!table) return;
                table.innerHTML = list.sort((a,b) => (a.role === 'admin' ? -1 : 1)).map(u => `
                    <tr class="hover:bg-gray-50 transition border-b border-gray-100 font-bold font-black text-right">
                        <td class="p-5 flex items-center gap-3 text-right font-black font-black"><img src="${u.avatar || 'https://via.placeholder.com/50'}" class="h-10 w-10 rounded-full border shadow-sm"> <span>${u.name} ${u.id === '101' || u.id === '3' || u.id === '18' ? '👑' : ''}</span></td>
                        <td class="p-5 text-center font-mono text-gray-400 font-black font-black">${u.id}</td>
                        <td class="p-5 text-center font-black text-jcd-blue text-lg font-black">${u.stats?.points || 0}</td>
                        <td class="p-5 text-center font-mono text-blue-600 font-black font-black font-black">${u.pass}</td>
                        <td class="p-5 text-left flex items-center justify-end h-full font-black">
                            <button onclick="app.adminAction('${u.id}', 'bonus')" class="text-purple-600 mx-2 hover:scale-125 transition font-black"><i class="fas fa-gift"></i></button>
                            <button onclick="app.adminAction('${u.id}', 'editFull')" class="text-blue-500 mx-2 hover:scale-125 transition font-black"><i class="fas fa-edit"></i></button>
                            <button onclick="app.adminAction('${u.id}', 'delete')" class="text-red-500 mx-2 hover:scale-125 transition font-black"><i class="fas fa-trash"></i></button>
                        </td>
                    </tr>
                `).join('');
            },

            filterUsers(q) {
                const filtered = app.data.users.filter(u => u.name.includes(q) || u.id.includes(q));
                app.renderUserTable(filtered);
            },

            async adminSmartAdd() {
                const name = document.getElementById('smartAddName').value.trim();
                if(!name) return alert("اكتب الاسم أولاً");
                const randomId = Math.floor(1000 + Math.random() * 9000).toString();
                await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users', randomId), { id: randomId, name, pass: "2026", role:'volunteer', status:'active', stats:{points:0, hours:0}, history:[], shifts:[], notifications:[] });
                document.getElementById('smartAddName').value = ""; app.showToast("تمت الإضافة بنجاح!");
            },

            async publishNews() {
                const title = document.getElementById('newsTitle').value.trim();
                const content = document.getElementById('newsContent').value.trim();
                if(!title || !content) return alert("املاً البيانات");
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'news'), { title, content, date: new Date().toLocaleDateString('ar-JO') });
                document.getElementById('newsTitle').value = ""; document.getElementById('newsContent').value = "";
                app.showToast("تم النشر.");
            },

            renderNews() {
                const feed = document.getElementById('news-feed-container');
                if(!feed) return;
                feed.innerHTML = app.data.news.slice().reverse().map(n => `<div class="bg-white/90 p-6 rounded-[2rem] shadow-xl text-right border-r-8 border-jcd-gold font-black">
                    <h4 class="text-xl font-black text-jcd-blue mb-2 font-black">${n.title}</h4>
                    <p class="text-sm text-gray-700 leading-relaxed font-bold font-black">${n.content}</p>
                    <span class="text-[9px] text-gray-400 block mt-4 font-black">${n.date}</span>
                </div>`).join('');
            },

            async approvePass(uid) {
                const u = app.data.users.find(x=>x.id === uid);
                await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users', uid), { pass: u.passwordRequest.newPass, passwordRequest: null });
                app.showToast("تم تحديث السر.");
            },

            async adminAction(id, action) {
                const u = app.data.users.find(x=>x.id===id);
                if(action === 'bonus') {
                    const pts = parseInt(prompt(`بونص لـ ${u.name}:`));
                    if(!isNaN(pts)) await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users', id), { "stats.points": (u.stats?.points || 0) + pts });
                } else if(action === 'editFull') {
                    const nN = prompt("الاسم الجديد:", u.name);
                    const nI = prompt("المعرف الجديد:", u.id);
                    const nP = prompt("كلمة السر الجديدة:", u.pass);
                    if(nI && nI !== u.id) {
                        const old = {...u}; delete old._id; old.id=nI; old.name=nN||u.name; old.pass=nP||u.pass;
                        await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users', nI), old);
                        await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users', u.id));
                    } else if(nN || nP) {
                        await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users', id), { name:nN||u.name, pass:nP||u.pass });
                    }
                } else if(action === 'delete') {
                    if(confirm("حذف النشـمي نهائياً؟")) await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users', id));
                } else if(action === 'approve') {
                    await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users', id), { status: 'active' });
                }
            },

            handleAvatarUpload(event) {
                const file = event.target.files[0]; if (!file) return;
                const reader = new FileReader();
                reader.onload = (e) => { app.uploadedAvatarBase64 = e.target.result; app.showToast("تم التجهيز."); };
                reader.readAsDataURL(file);
            },

            async handleLogoUpload(event) {
                const file = event.target.files[0]; if (!file) return;
                const reader = new FileReader();
                reader.onload = async (e) => {
                    await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'settings', 'main'), { logo: e.target.result }, { merge: true });
                    app.showToast("تم تحديث الشعار.");
                };
                reader.readAsDataURL(file);
            },

            async handleGalleryUpload(event) {
                const file = event.target.files[0]; if (!file) return;
                const reader = new FileReader();
                reader.onload = async (e) => {
                    await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'gallery'), { url: e.target.result, date: Date.now() });
                    app.showToast("تم الرفع للمعرض.");
                };
                reader.readAsDataURL(file);
            },

            async saveProfile() {
                const eB = document.getElementById('editBio');
                const rP = document.getElementById('reqPass');
                if(!eB || !rP) return;
                const data = { bio: eB.value };
                if(rP.value.trim()) data.passwordRequest = { newPass: rP.value.trim(), status:'pending' };
                if (app.uploadedAvatarBase64) data.avatar = app.uploadedAvatarBase64;
                await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users', app.data.currentUser.id), data);
                app.closeProfileEdit(); app.showToast("تم التحديث.");
            },

            applySettings() {
                const s = app.data.settings;
                const tTxt = document.getElementById('newsTickerText');
                const tCont = document.getElementById('news-ticker-container');
                if (tTxt && tCont && s.ticker) { tCont.classList.remove('hidden'); tTxt.innerText = s.ticker; }
                if (s.logo) { 
                    ['navLogo', 'heroLogo', 'loaderLogo', 'printLogo'].forEach(id => {
                        const el = document.getElementById(id); if(el) el.src = s.logo;
                    });
                }
            },

            showToast(msg) {
                const toast = document.createElement('div');
                toast.className = 'bg-jcd-blue text-white px-8 py-4 rounded-2xl shadow-2xl border-2 border-yellow-400 fade-in text-xs font-black font-black font-black font-black font-black';
                toast.innerText = msg;
                const tc = document.getElementById('toastContainer');
                if(tc) tc.appendChild(toast);
                setTimeout(() => toast.remove(), 4000);
            },

            renderUI() {
                app.renderGallery();
                app.renderNews();
                if (app.data.currentUser) {
                    const up = app.data.users.find(u => u.id === app.data.currentUser.id);
                    if (up) { app.data.currentUser = up; up.role === 'admin' ? app.renderAdminDashboard() : app.renderVolunteerUI(); }
                }
            },

            renderGallery() {
                const gridFull = document.getElementById('fullGalleryGrid');
                if (gridFull) gridFull.innerHTML = app.data.gallery.slice().reverse().map(img => `<div class="gallery-img-container shadow-2xl font-black font-black font-black font-black"><img src="${img.url}"></div>`).join('') || '<p class="col-span-full text-center py-20 font-black text-gray-300 font-black">المعرض خالي حالياً</p>';
                const adminPrev = document.getElementById('adminGalleryPreview');
                if (adminPrev) adminPrev.innerHTML = app.data.gallery.map(img => `<div class="relative group font-black"><img src="${img.url}" class="h-14 w-14 object-cover rounded-xl border-2 font-black font-black font-black font-black font-black"><button onclick="app.deleteGalleryImage('${img._id}')" class="absolute -top-1 -right-1 bg-red-600 text-white h-5 w-5 rounded-full text-[9px] flex items-center justify-center shadow-lg transition-all opacity-0 group-hover:opacity-100 font-black"><i class="fas fa-times"></i></button></div>`).join('');
            },

            renderShiftsRegistry() {
                const body = document.getElementById('shiftsRegistryBody'); if (!body) return;
                body.innerHTML = "";
                const weekdays = ["الأحد", "الاثنين", "الثلاثاء", "الأربعاء", "الخميس", "الجمعة", "السبت"];
                for(let i=0; i<7; i++) {
                    const d = new Date(); d.setDate(new Date().getDate() + i);
                    const rawDate = d.toISOString().split('T')[0];
                    const label = `${weekdays[d.getDay()]} - ${rawDate}`;
                    const reged = app.data.users.filter(u => u.shifts && u.shifts.some(s => s.date === rawDate));
                    body.innerHTML += `<tr class="hover:bg-indigo-50/50 transition border-b border-gray-100 font-black">
                        <td class="p-6 font-black text-xs text-gray-500 text-center border-l font-black">${label}</td>
                        <td class="p-6 flex flex-wrap gap-4 justify-center font-black">
                            ${reged.map(u => `<button onclick="app.manualCheckIn('${u.id}')" class="bg-white hover:bg-green-600 hover:text-white px-6 py-2 rounded-2xl text-[11px] font-black border-2 border-indigo-100 transition shadow-md font-black font-black">${u.name}</button>`).join('') || '<span class="text-gray-300 italic text-[11px] font-black">None</span>'}
                        </td>
                    </tr>`;
                }
            },

            async callAI(p) {
                const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${GEMINI_KEY}`, { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({contents:[{parts:[{text:p}]}]}) });
                const d = await res.json(); return d.candidates?.[0]?.content?.parts?.[0]?.text || "خطأ اتصال";
            },

            async askAI() {
                const input = document.getElementById('safetyInput'); const chat = document.getElementById('safetyChat');
                if(!input || !input.value) return;
                const q = input.value; input.value = "";
                chat.innerHTML += `<div class="bg-white/10 p-4 rounded-2xl mr-10 text-white font-bold mb-2 text-right shadow-sm font-black font-black">س: ${q}</div>`;
                const a = await app.callAI(`أجب كخبير دفاع مدني أردني باختصار ومهنية: ${q}`);
                chat.innerHTML += `<div class="bg-blue-500/40 p-4 rounded-2xl ml-10 text-blue-50 mb-4 font-bold text-right shadow-xl font-black font-black font-black font-black font-black">${marked.parse(a)}</div>`;
                chat.scrollTop = chat.scrollHeight;
            },

            async generateReport() {
                const ctx = document.getElementById('reportContext');
                if(!ctx || !ctx.value) return alert("أدخل التفاصيل");
                document.getElementById('reportModal').classList.remove('hidden');
                const out = document.getElementById('reportOutput');
                out.innerText = "جاري الصياغة الفنية للتقرير...";
                const a = await app.callAI(`اكتب تقرير مهمة رسمي بأسلوب الدفاع المدني الأردني. اسم النشـمي: ${app.data.currentUser.name}. المعرف: ${app.data.currentUser.id}. التفاصيل: ${ctx.value}. ابدأ بـ "بِسْمِ اللَّهِ الرَّحْمَنِ الرَّحِيمِ" وانتهِ بخاتمة رسمية.`);
                out.innerText = a;
            },

            renderHistory() {
                const body = document.getElementById('historyBody'); if (!body) return;
                body.innerHTML = (app.data.currentUser.history || []).slice().reverse().map(h => `<tr><td class="p-6 font-black text-xs text-right border-l font-black font-black">${h.date}</td><td class="p-6 text-green-600 font-bold text-center font-black">${h.start}</td><td class="p-6 text-red-600 font-bold text-center font-black font-black">${h.end}</td><td class="p-6 font-black text-jcd-blue text-center font-black">+${h.points}</td></tr>`).join('') || '<tr><td colspan="4" class="text-center py-20 italic text-gray-300 font-black">No Records</td></tr>';
            },

            renderShifts() {
                const grid = document.getElementById('shiftsGrid'); if (!grid) return;
                grid.innerHTML = "";
                const today = new Date();
                const autoDates = [];
                for(let i=1; i<=14; i++) {
                    const d = new Date(today); d.setDate(new Date().getDate() + i);
                    if (d.getDay() === 1 || d.getDay() === 2) autoDates.push(d); 
                }
                autoDates.forEach(d => {
                    const rawDate = d.toISOString().split('T')[0];
                    const dayName = d.toLocaleDateString('ar-JO', {weekday:'long'});
                    const shift = (app.data.currentUser.shifts || []).find(s => s.date === rawDate);
                    grid.innerHTML += `<div class="bg-gray-50 p-6 rounded-[1.5rem] border-2 border-transparent hover:border-jcd-blue transition flex justify-between items-center shadow-sm font-black">
                        <div class="flex flex-col text-right font-black"><span class="text-[10px] font-black text-gray-400 uppercase font-black">${dayName}</span><span class="text-sm font-black font-black">${rawDate}</span></div>
                        ${shift ? `<span class="text-[10px] font-black uppercase px-4 py-1 rounded-full border ${shift.status==='approved'?'bg-green-100 text-green-700 font-black':'bg-orange-100 text-orange-700 font-black'} font-black font-black font-black font-black">${shift.status}</span>` : `<button onclick="app.requestShift('${rawDate}')" class="bg-jcd-blue text-white px-6 py-2 rounded-xl text-xs font-black transition-all hover:bg-blue-900 font-black font-black font-black">حـجز</button>`}
                    </div>`;
                });
            },

            async requestShift(date) {
                await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users', app.data.currentUser.id), { shifts: [...(app.data.currentUser.shifts || []), { date, status: 'approved' }] });
            },

            exportPDF() {
                const element = document.getElementById('printableRoster'); element.classList.remove('hidden');
                const active = app.data.users.filter(u => u.currentSession);
                document.getElementById('printBody').innerHTML = active.map((u, i) => `<tr><td class="border-4 border-black p-4 text-center font-black font-black">${i+1}</td><td class="border-4 border-black p-4 font-black text-right font-black">${u.name}</td><td class="border-4 border-black p-4 text-center font-mono font-black">${u.id}</td><td class="border-4 border-black p-4 text-center font-mono font-black font-black font-black">${u.currentSession.time}</td><td class="border-4 border-black p-4 font-black"></td></tr>`).join('');
                const opt = { margin: 0.1, filename: `كشف_حضور.pdf`, image: { type: 'jpeg', quality: 1 }, html2canvas: { scale: 3 }, jsPDF: { unit: 'in', format: 'a4', orientation: 'portrait' } };
                html2pdf().set(opt).from(element).save().then(() => element.classList.add('hidden'));
            },

            async manualCheckIn(uid) {
                if(!confirm("تحضير يدوي؟")) return;
                const now = new Date();
                await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users', uid), { currentSession: { start: now.toISOString(), time: now.toLocaleTimeString('ar-JO') } });
            },

            async deleteGalleryImage(id) { if(confirm("حذف؟")) await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'gallery', id)); },

            openProfileEdit() {
                const u = app.data.currentUser;
                const eB = document.getElementById('editBio');
                const rP = document.getElementById('reqPass');
                const pM = document.getElementById('profileModal');
                const rS = document.getElementById('passReqStatus');
                if(eB) eB.value = u.bio || "";
                if(rP) rP.value = "";
                if(rS) { if (u.passwordRequest?.status === 'pending') rS.classList.remove('hidden'); else rS.classList.add('hidden'); }
                if(pM) pM.classList.remove('hidden');
            },
            closeProfileEdit() { const pM = document.getElementById('profileModal'); if(pM) pM.classList.add('hidden'); },
            toggleNotifications() { app.showSection('volunteer-dashboard'); const nL = document.getElementById('notificationsList'); if(nL) nL.scrollIntoView({ behavior:'smooth' }); },
            copyReport() { const rO = document.getElementById('reportOutput'); if(rO) { navigator.clipboard.writeText(rO.innerText); alert("تم النسخ بنجاح"); } },
            async saveTicker() { await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'settings', 'main'), { ticker: document.getElementById('adminTickerText').value }, { merge: true }); app.showToast("تم الحفظ"); },
            async adminSendMessage() {
                const recId = document.getElementById('msgRecipient').value;
                const body = document.getElementById('msgBody').value;
                if(!body) return;
                const msg = { id: Date.now(), text: body, date: new Date().toLocaleDateString('ar-JO') };
                if(recId === 'all') {
                    for(const u of app.data.users) { if(u.role !== 'admin') await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users', u.id), { notifications: [...(u.notifications || []), msg] }); }
                } else {
                    const target = app.data.users.find(x => x.id === recId);
                    await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users', recId), { notifications: [...(target.notifications || []), msg] });
                }
                document.getElementById('msgBody').value = ""; app.showToast("تم الإرسال.");
            },
            renderMessenger() {
                const rec = document.getElementById('msgRecipient'); if(!rec) return;
                const curr = rec.value;
                rec.innerHTML = '<option value="all">تعميم لكافة النشامى</option>';
                app.data.users.filter(u => u.role !== 'admin').forEach(u => rec.innerHTML += `<option value="${u.id}">${u.name} (${u.id})</option>`);
                rec.value = curr || 'all';
            },
            async deleteSuggestion(id) { if(confirm("حذف المقترح؟")) await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'suggestions', id)); },
            async handleRegistration(event) {
                event.preventDefault();
                const id = document.getElementById('regId').value.trim();
                const name = document.getElementById('regName').value.trim();
                const pass = document.getElementById('regPass').value.trim();
                const loc = document.getElementById('regLocation').value;
                if(app.data.users.some(u=>u.id===id)) return alert("المعرف مسجل");
                await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users', id), { id, name, pass, role:'volunteer', status:'pending', location: loc, stats:{points:0, hours:0}, history:[], shifts:[], notifications:[] });
                alert("تم الإرسال."); app.showSection('home');
            },
        };

        window.addEventListener('load', () => app.init());
    </script>
</body>
</html>