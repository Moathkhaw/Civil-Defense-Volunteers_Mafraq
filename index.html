<!DOCTYPE html>
<html lang="ar" dir="rtl" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>بوابة نشامى المفرق - النظام السيادي الشامل</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        jcd: { blue: '#1e3a8a', red: '#dc2626', gold: '#fbbf24', dark: '#0f172a' }
                    },
                    animation: { 
                        'float': 'float 6s ease-in-out infinite',
                        'shine': 'shine 3s linear infinite',
                        'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite'
                    },
                    keyframes: {
                        float: { '0%, 100%': { transform: 'translateY(0)' }, '50%': { transform: 'translateY(-10px)' } },
                        shine: { '0%': { backgroundPosition: '200% center' }, '100%': { backgroundPosition: '-200% center' } }
                    }
                }
            }
        }
    </script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap');
        body { font-family: 'Tajawal', sans-serif; }
        
        .hero-section {
            background: radial-gradient(circle at center, #1e3a8a 0%, #111827 100%);
            position: relative; overflow: hidden;
        }
        .hero-section::after {
            content: ''; position: absolute; inset: 0;
            background-image: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2V6h4V4H6z' fill='%23ffffff' fill-opacity='0.03'/%3E%3C/svg%3E");
        }
        
        .glass-panel {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1);
        }

        .official-card {
            background: linear-gradient(145deg, #1e3a8a, #000000);
            border: 2px solid #fbbf24;
            color: white;
        }

        .rank-border-leader { border-color: #fbbf24; box-shadow: 0 0 15px rgba(251, 191, 36, 0.5); }
        .rank-border-nashmi { border-color: #22c55e; }
        .rank-border-rescuer { border-color: #f97316; }
        .rank-border-regular { border-color: #9ca3af; }

        .custom-scrollbar::-webkit-scrollbar { width: 5px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 10px; }
        
        #map { height: 100%; width: 100%; border-radius: 1rem; z-index: 0; }
    </style>
</head>
<body class="flex flex-col min-h-screen text-right font-black bg-gray-50 text-gray-800 dark:bg-gray-950 dark:text-gray-100 transition-colors duration-300">

    <!-- Navbar -->
    <nav class="sticky top-0 z-50 glass-panel bg-jcd-blue/90 text-white shadow-lg backdrop-blur-md">
        <div class="container mx-auto px-4 py-3 flex justify-between items-center">
            <div class="flex items-center gap-3 cursor-pointer" onclick="app.showSection('home')">
                <img id="navLogo" src="https://upload.wikimedia.org/wikipedia/commons/e/e0/Jordan_Civil_Defence_Logo.png" class="h-10 w-10 object-contain drop-shadow-md">
                <div>
                    <h1 class="font-black text-lg leading-tight">بوابة نشامى المفرق</h1>
                    <p class="text-[10px] text-yellow-400 font-bold tracking-widest opacity-90">النظام الرقمي الموحد</p>
                </div>
            </div>
            
            <div class="flex items-center gap-4">
                <div id="guestLinks" class="hidden md:flex items-center gap-6 text-sm font-bold">
                    <button onclick="app.showSection('home')" class="hover:text-yellow-400 transition">الرئيسية</button>
                    <button onclick="app.showSection('nashama-section')" class="hover:text-yellow-400 transition">بوابة النشامى</button>
                    <button onclick="app.showLogin('volunteer')" class="bg-white/10 hover:bg-white/20 px-4 py-2 rounded-full border border-white/20 transition">دخول النظام</button>
                </div>
                
                <div id="userMenu" class="hidden flex items-center gap-4">
                    <div class="relative cursor-pointer group" onclick="app.toggleNotifications()">
                        <i class="fas fa-bell text-xl group-hover:text-yellow-400 transition"></i>
                        <span id="notifBadge" class="absolute -top-1 -right-1 bg-red-600 text-[10px] h-4 w-4 flex items-center justify-center rounded-full hidden animate-pulse">0</span>
                    </div>
                    <div class="text-left leading-tight">
                        <span id="userNameDisplay" class="block text-xs font-black text-yellow-400"></span>
                        <button onclick="app.logout()" class="text-[10px] text-gray-300 hover:text-white underline">خروج</button>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <!-- Ticker -->
    <div id="news-ticker-container" class="bg-jcd-red text-white text-xs py-2 overflow-hidden hidden relative z-40">
        <div class="whitespace-nowrap animate-marquee px-4 font-bold" id="newsTickerText"></div>
    </div>

    <main id="main-content" class="flex-grow container mx-auto px-4 py-6 relative z-0">
        
        <!-- Hero Section -->
        <section id="home" class="fade-in">
            <div class="hero-section rounded-[3rem] p-8 md:p-20 text-center text-white shadow-2xl relative min-h-[80vh] flex flex-col items-center justify-center border-b-8 border-yellow-500">
                <div class="relative z-10 w-full max-w-4xl">
                    <div class="animate-float mb-8">
                        <img src="https://upload.wikimedia.org/wikipedia/commons/e/e0/Jordan_Civil_Defence_Logo.png" class="h-40 md:h-56 mx-auto drop-shadow-2xl">
                    </div>
                    <h2 class="text-5xl md:text-7xl font-black mb-6 tracking-tighter drop-shadow-xl bg-clip-text text-transparent bg-gradient-to-r from-white to-gray-300" style="-webkit-text-stroke: 1px rgba(255,255,255,0.1);">نشامى المفرق</h2>
                    <p class="text-lg md:text-2xl text-blue-100 mb-12 max-w-2xl mx-auto font-medium">"منصة التطوع الرقمية الأولى لتوثيق العطاء وتنظيم الواجب"</p>
                    
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 w-full max-w-3xl mx-auto">
                        <button onclick="app.showSection('registration')" class="glass-panel hover:bg-white/10 p-6 rounded-3xl transition transform hover:scale-105 group border-b-4 border-green-500">
                            <i class="fas fa-user-plus text-4xl mb-3 text-green-400 group-hover:rotate-12 transition"></i>
                            <h3 class="text-xl font-black">انضم إلينا</h3>
                            <p class="text-xs text-gray-300 mt-1">سجل كمتطوع جديد</p>
                        </button>
                        
                        <button onclick="app.showLogin('volunteer')" class="glass-panel hover:bg-white/10 p-6 rounded-3xl transition transform hover:scale-105 group border-b-4 border-yellow-500">
                            <i class="fas fa-id-card-alt text-4xl mb-3 text-yellow-400 group-hover:scale-110 transition"></i>
                            <h3 class="text-xl font-black">دخول المتطوعين</h3>
                            <p class="text-xs text-gray-300 mt-1">لوحة التحكم والخدمات</p>
                        </button>
                        
                        <button onclick="app.showLogin('admin')" class="glass-panel hover:bg-white/10 p-6 rounded-3xl transition transform hover:scale-105 group border-b-4 border-red-500">
                            <i class="fas fa-shield-alt text-4xl mb-3 text-red-500 group-hover:scale-110 transition"></i>
                            <h3 class="text-xl font-black">الإدارة</h3>
                            <p class="text-xs text-gray-300 mt-1">للمسؤولين فقط</p>
                        </button>
                    </div>
                </div>
            </div>
        </section>

        <!-- Nashama Portal -->
        <section id="nashama-section" class="fade-in hidden">
            <div class="text-center mb-10">
                <h2 class="text-4xl font-black text-jcd-blue dark:text-white mb-2">بوابة النشامى</h2>
                <p class="text-gray-500 dark:text-gray-400 font-bold">قائمة الشرف للمتطوعين المتميزين - تحديث حي</p>
            </div>
            
            <div class="max-w-md mx-auto mb-10 relative">
                <input type="text" oninput="app.filterNashama(this.value)" placeholder="ابحث باسم النشمي..." class="w-full p-4 pr-12 rounded-2xl bg-white dark:bg-gray-800 shadow-lg border border-gray-100 dark:border-gray-700 outline-none focus:ring-2 focus:ring-jcd-blue transition">
                <i class="fas fa-search absolute right-4 top-4 text-gray-400"></i>
            </div>

            <div id="nashamaGrid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6"></div>
        </section>

        <!-- Login Section -->
        <section id="login" class="fade-in hidden max-w-md mx-auto py-10">
            <div class="bg-white dark:bg-gray-800 rounded-[2.5rem] shadow-2xl p-8 border-t-8 border-jcd-blue relative overflow-hidden">
                <div class="flex mb-8 bg-gray-100 dark:bg-gray-700 rounded-2xl p-1">
                    <button class="w-1/2 py-3 rounded-xl text-sm font-black transition-all bg-white dark:bg-gray-600 shadow-sm text-jcd-blue dark:text-white" id="tab-volunteer" onclick="app.switchLoginTab('volunteer')">متطوع</button>
                    <button class="w-1/2 py-3 rounded-xl text-sm font-black transition-all text-gray-500 dark:text-gray-400 hover:text-jcd-blue" id="tab-admin" onclick="app.switchLoginTab('admin')">إدارة</button>
                </div>
                
                <h2 class="text-2xl font-black text-center mb-6 text-jcd-blue dark:text-white" id="loginTitle">تسجيل دخول النشامى</h2>
                
                <form onsubmit="app.handleLogin(event)" class="space-y-5">
                    <input type="text" id="username" placeholder="المعرف / الرقم الوطني" class="w-full bg-gray-50 dark:bg-gray-700 dark:text-white p-4 rounded-2xl outline-none border-2 border-transparent focus:border-jcd-blue transition font-bold text-right" required>
                    <input type="password" id="password" placeholder="كلمة المرور" class="w-full bg-gray-50 dark:bg-gray-700 dark:text-white p-4 rounded-2xl outline-none border-2 border-transparent focus:border-jcd-blue transition font-bold text-right" required>
                    <button type="submit" id="loginBtn" class="w-full bg-jcd-blue hover:bg-blue-900 text-white font-black py-4 rounded-2xl shadow-xl transition transform active:scale-95 flex justify-center items-center gap-2"><span>دخول آمن</span><i class="fas fa-arrow-left"></i></button>
                </form>
            </div>
        </section>

        <!-- Volunteer Dashboard -->
        <section id="volunteer-dashboard" class="fade-in hidden space-y-8">
            <div class="bg-gradient-to-r from-jcd-blue to-blue-900 rounded-[2.5rem] p-8 text-white shadow-2xl relative overflow-hidden">
                <div class="absolute top-0 left-0 w-full h-full opacity-20 hero-pattern pointer-events-none"></div>
                <div class="flex flex-col md:flex-row items-center gap-8 relative z-10">
                    <div class="relative">
                        <img id="dashAvatar" src="https://via.placeholder.com/150" class="h-32 w-32 rounded-full border-4 border-yellow-400 shadow-xl object-cover bg-gray-200">
                        <span id="dashRankBadge" class="absolute -bottom-3 right-1/2 translate-x-1/2 bg-yellow-400 text-black text-xs px-3 py-1 rounded-full font-black shadow-lg whitespace-nowrap">نشمي</span>
                    </div>
                    <div class="text-center md:text-right flex-grow">
                        <h2 class="text-3xl font-black mb-1" id="volNameDisplay"></h2>
                        <p class="text-blue-200 text-sm mb-4" id="volBioDisplay">متطوع</p>
                        <div class="flex flex-wrap justify-center md:justify-start gap-3">
                            <button onclick="app.openIDModal()" class="bg-white/20 hover:bg-white/30 px-4 py-2 rounded-xl text-xs font-bold transition flex items-center gap-2"><i class="fas fa-id-card"></i> هويتي</button>
                            <button onclick="app.openFullProfile()" class="bg-white/20 hover:bg-white/30 px-4 py-2 rounded-xl text-xs font-bold transition flex items-center gap-2"><i class="fas fa-user-circle"></i> ملفي الشامل</button>
                        </div>
                    </div>
                    <div id="gateContainer" class="bg-white/10 backdrop-blur-md p-6 rounded-2xl border border-white/20 text-center min-w-[200px]"></div>
                </div>
            </div>

            <!-- Stats & AI Message -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="md:col-span-2 bg-gradient-to-r from-orange-500 to-red-600 rounded-[2rem] p-6 text-white shadow-lg relative overflow-hidden">
                    <i class="fas fa-quote-right absolute top-4 left-4 text-4xl opacity-20"></i>
                    <h4 class="font-black text-sm mb-2 opacity-80">رسالة اليوم من القيادة</h4>
                    <p id="dailyMessageText" class="text-lg font-bold leading-relaxed relative z-10">جاري الاتصال بالعمليات...</p>
                </div>
                <div class="bg-gradient-to-br from-blue-400 to-cyan-500 rounded-[2rem] p-6 text-white shadow-lg flex items-center justify-between">
                    <div>
                        <h4 class="text-sm font-bold opacity-80">الطقس (المفرق)</h4>
                        <div class="text-3xl font-black mt-1" id="weatherTemp">--°</div>
                        <div class="text-xs bg-white/20 px-2 py-1 rounded inline-block mt-1">مشمس</div>
                    </div>
                    <i class="fas fa-sun text-5xl text-yellow-300 animate-spin-slow"></i>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div class="bg-white dark:bg-gray-800 p-6 rounded-[2rem] shadow-lg border-b-4 border-purple-500">
                    <h4 class="font-black text-lg mb-4 text-purple-600 dark:text-purple-400 flex items-center gap-2"><i class="fas fa-graduation-cap"></i> الدورات المتاحة</h4>
                    <div id="volCoursesList" class="space-y-3 max-h-48 overflow-y-auto custom-scrollbar"><p class="text-xs text-gray-400 text-center py-4">لا توجد دورات حالياً</p></div>
                </div>
                <div class="bg-white dark:bg-gray-800 p-6 rounded-[2rem] shadow-lg border-b-4 border-red-500 relative h-64">
                    <h4 class="font-black text-lg mb-4 text-red-500 flex items-center gap-2"><i class="fas fa-map-marked-alt"></i> خريطة العمليات</h4>
                    <div id="map" class="w-full h-[calc(100%-2rem)] rounded-xl bg-gray-200 dark:bg-gray-700"></div>
                </div>
            </div>
        </section>

        <!-- Admin Dashboard -->
        <section id="admin-dashboard" class="fade-in hidden space-y-8">
            <div class="bg-gray-900 text-white rounded-[2.5rem] p-8 shadow-2xl flex justify-between items-center relative overflow-hidden">
                <div class="relative z-10">
                    <h2 class="text-3xl font-black text-yellow-400 mb-1">غرفة العمليات المركزية</h2>
                    <p class="text-gray-400 text-sm">أهلاً بك، سيادة المدير <span id="adminNameSpan" class="text-white font-bold"></span></p>
                </div>
                <button onclick="app.openAdminScanner()" class="bg-green-600 hover:bg-green-700 text-white px-6 py-3 rounded-xl font-bold shadow-lg flex items-center gap-2 transition relative z-10"><i class="fas fa-qrcode"></i> فحص هوية</button>
                <div class="absolute inset-0 bg-jcd-blue/10"></div>
            </div>

            <!-- Management Tools -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                <div class="bg-white dark:bg-gray-800 p-6 rounded-[2rem] shadow-lg border-l-8 border-orange-500">
                    <h3 class="text-xl font-black mb-4 dark:text-white flex items-center"><i class="fas fa-truck ml-2 text-orange-500"></i> جاهزية الآليات</h3>
                    <div id="vehicleList" class="space-y-3 mb-4 max-h-40 overflow-y-auto custom-scrollbar"></div>
                    <div class="flex gap-2">
                        <input type="text" id="vehName" placeholder="رقم الآلية" class="p-2 rounded bg-gray-100 dark:bg-gray-700 text-xs w-1/3">
                        <select id="vehStatus" class="p-2 rounded bg-gray-100 dark:bg-gray-700 text-xs w-1/3"><option value="جاهزة">جاهزة</option><option value="صيانة">صيانة</option><option value="معطلة">معطلة</option></select>
                        <button onclick="app.addVehicleStatus()" class="bg-orange-500 text-white px-4 rounded text-xs font-bold">تحديث</button>
                    </div>
                </div>
                
                <div class="bg-white dark:bg-gray-800 p-6 rounded-[2rem] shadow-lg border-l-8 border-purple-500">
                    <h3 class="text-xl font-black mb-4 dark:text-white flex items-center"><i class="fas fa-chalkboard-teacher ml-2 text-purple-500"></i> إدارة الدورات</h3>
                    <div class="flex gap-2 mb-4">
                        <input type="text" id="newCourseTitle" placeholder="اسم الدورة" class="flex-grow p-2 rounded bg-gray-100 dark:bg-gray-700 text-xs">
                        <button onclick="app.addCourse()" class="bg-purple-500 text-white px-4 rounded text-xs font-bold">طرح</button>
                    </div>
                    <div id="adminCoursesList" class="space-y-2 text-xs"></div>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                <div class="bg-white dark:bg-gray-800 p-5 rounded-2xl shadow-md border-r-4 border-green-500"><h4 class="text-xs text-gray-500 font-bold mb-1">الميدان الآن</h4><div class="text-2xl font-black text-green-600" id="rosterCount">0</div></div>
                <div class="bg-white dark:bg-gray-800 p-5 rounded-2xl shadow-md border-r-4 border-red-500"><h4 class="text-xs text-gray-500 font-bold mb-1">طلبات السر</h4><div class="text-2xl font-black text-red-600" id="passReqCount">0</div></div>
                <div class="bg-white dark:bg-gray-800 p-5 rounded-2xl shadow-md border-r-4 border-yellow-500"><h4 class="text-xs text-gray-500 font-bold mb-1">إنذارات نشطة</h4><div class="text-2xl font-black text-yellow-600" id="warningsCount">0</div></div>
                <div class="bg-white dark:bg-gray-800 p-5 rounded-2xl shadow-md border-r-4 border-blue-500 flex flex-col justify-center gap-2">
                    <button onclick="app.exportPDF('shifts')" class="bg-blue-50 text-blue-600 text-xs font-bold py-2 rounded hover:bg-blue-100">كشف المناوبات</button>
                    <button onclick="app.exportPDF('verified')" class="bg-green-50 text-green-600 text-xs font-bold py-2 rounded hover:bg-green-100">ساعات العمل</button>
                </div>
            </div>

            <div class="bg-white dark:bg-gray-800 rounded-[2rem] p-6 shadow-lg">
                <h3 class="font-black text-lg mb-4 dark:text-white border-b pb-2 dark:border-gray-700">سجل الدخول والمناوبات (Live)</h3>
                <div id="liveAttendanceList" class="space-y-2 max-h-60 overflow-y-auto custom-scrollbar"></div>
            </div>

            <div class="bg-white dark:bg-gray-800 rounded-[2rem] p-6 shadow-lg">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="font-black text-lg dark:text-white">إدارة النشامى</h3>
                    <input type="text" oninput="app.filterUsers(this.value)" placeholder="بحث..." class="bg-gray-100 dark:bg-gray-700 text-xs p-2 rounded-lg outline-none w-40">
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-right text-xs dark:text-gray-300">
                        <thead class="bg-gray-50 dark:bg-gray-700 text-gray-500 dark:text-gray-400 font-bold">
                            <tr><th class="p-3 rounded-r-lg">الاسم</th><th class="p-3">المعرف</th><th class="p-3">الرصيد</th><th class="p-3 rounded-l-lg">إجراء</th></tr>
                        </thead>
                        <tbody id="fullUsersTable"></tbody>
                    </table>
                </div>
            </div>
        </section>

        <!-- Registration Section -->
        <section id="registration" class="fade-in hidden max-w-2xl mx-auto py-10 text-right">
            <div class="bg-white dark:bg-gray-800 rounded-[2.5rem] shadow-2xl p-10 border-t-8 border-green-500">
                <h2 class="text-3xl font-black text-center mb-8 text-green-600 dark:text-green-400">طلب انضمام للفريق</h2>
                <form onsubmit="app.handleRegistration(event)" class="space-y-4">
                    <input type="text" id="regName" placeholder="الاسم الرباعي" class="w-full p-4 bg-gray-50 dark:bg-gray-700 dark:text-white rounded-xl outline-none border focus:border-green-500 transition" required>
                    <input type="text" id="regId" placeholder="الرقم الوطني" class="w-full p-4 bg-gray-50 dark:bg-gray-700 dark:text-white rounded-xl outline-none border focus:border-green-500 transition" required>
                    <input type="password" id="regPass" placeholder="كلمة المرور" class="w-full p-4 bg-gray-50 dark:bg-gray-700 dark:text-white rounded-xl outline-none border focus:border-green-500 transition" required>
                    <button type="submit" class="w-full bg-green-600 hover:bg-green-700 text-white font-black py-4 rounded-xl shadow-lg transition">إرسال الطلب</button>
                </form>
            </div>
        </section>

    </main>

    <!-- Chat Widget -->
    <div id="chatWidget" class="fixed bottom-6 right-6 z-50 hidden">
        <button onclick="app.toggleChat()" class="bg-jcd-blue text-white w-14 h-14 rounded-full shadow-2xl flex items-center justify-center text-2xl hover:scale-110 transition relative"><i class="fas fa-comments"></i></button>
        <div id="chatWindow" class="hidden absolute bottom-16 right-0 w-80 bg-white dark:bg-gray-800 rounded-2xl shadow-2xl border border-gray-200 dark:border-gray-700 flex flex-col h-96 overflow-hidden">
            <div class="bg-jcd-blue p-3 text-white font-bold text-sm flex justify-between"><span>غرفة العمليات</span><button onclick="app.toggleChat()"><i class="fas fa-times"></i></button></div>
            <div id="chatMessages" class="flex-grow p-3 overflow-y-auto bg-gray-50 dark:bg-gray-900 space-y-2 text-xs"></div>
            <div class="p-2 border-t dark:border-gray-700 flex gap-2"><input type="text" id="chatInput" class="flex-grow p-2 rounded bg-gray-100 dark:bg-gray-700 text-xs outline-none" placeholder="رسالة..."><button onclick="app.sendChatMessage()" class="text-blue-600"><i class="fas fa-paper-plane"></i></button></div>
        </div>
    </div>

    <!-- Admin Tools Modal -->
    <div id="adminToolsModal" class="hidden fixed inset-0 z-[250] bg-black/80 backdrop-blur-sm flex items-center justify-center fade-in p-4">
        <div class="bg-white dark:bg-gray-800 rounded-[2rem] shadow-2xl w-full max-w-md p-8 relative border-t-8 border-jcd-blue max-h-[90vh] overflow-y-auto custom-scrollbar">
            <h3 class="text-2xl font-black text-jcd-dark dark:text-white mb-2">أدوات الإدارة المتقدمة</h3>
            <p id="toolUserName" class="text-sm text-jcd-blue dark:text-blue-300 font-bold mb-6"></p>
            <input type="hidden" id="toolUserId">
            
            <div class="mb-6 border-b pb-6 dark:border-gray-700">
                <h4 class="font-black text-sm mb-2 dark:text-white">منح وسام</h4>
                <div id="manualBadgesList" class="flex flex-wrap gap-2 mb-2"></div>
                <input type="text" id="badgeTitle" placeholder="اسم الوسام" class="w-full p-2 bg-gray-50 dark:bg-gray-700 rounded-lg text-xs mb-2">
                <button onclick="app.grantManualBadge()" class="w-full bg-purple-600 text-white font-bold py-2 rounded-lg text-xs">منح</button>
            </div>
            <div class="mb-6 border-b pb-6 dark:border-gray-700">
                <h4 class="font-black text-sm mb-2 dark:text-white">تقييم الأداء</h4>
                <div class="flex justify-center gap-2 mb-2 text-xl text-gray-300" id="starRating">
                    <i class="fas fa-star cursor-pointer hover:text-yellow-400" onclick="app.setRating(1)"></i>
                    <i class="fas fa-star cursor-pointer hover:text-yellow-400" onclick="app.setRating(2)"></i>
                    <i class="fas fa-star cursor-pointer hover:text-yellow-400" onclick="app.setRating(3)"></i>
                    <i class="fas fa-star cursor-pointer hover:text-yellow-400" onclick="app.setRating(4)"></i>
                    <i class="fas fa-star cursor-pointer hover:text-yellow-400" onclick="app.setRating(5)"></i>
                </div>
                <input type="hidden" id="selectedRating" value="0">
                <input type="text" id="evalNote" placeholder="ملاحظة" class="w-full p-2 bg-gray-50 dark:bg-gray-700 rounded-lg text-xs mb-2">
                <button onclick="app.submitEvaluation()" class="w-full bg-yellow-500 text-black font-bold py-2 rounded-lg text-xs">حفظ</button>
            </div>
            <div class="mb-6">
                <h4 class="font-black text-sm mb-2 dark:text-white">إدارة العهدة</h4>
                <div id="userInventoryList" class="space-y-1 mb-2 text-xs"></div>
                <div class="flex gap-2">
                    <input type="text" id="invItemName" placeholder="العهدة" class="flex-grow p-2 bg-gray-50 dark:bg-gray-700 rounded-lg text-xs">
                    <button onclick="app.assignInventory()" class="bg-blue-600 text-white px-3 py-1 rounded-lg text-xs">تسليم</button>
                </div>
            </div>
            <button onclick="document.getElementById('adminToolsModal').classList.add('hidden')" class="w-full bg-gray-200 dark:bg-gray-700 text-gray-600 dark:text-gray-300 py-2 rounded-lg font-bold text-xs">إغلاق</button>
        </div>
    </div>

    <!-- Admin Edit User Modal -->
    <div id="adminEditUserModal" class="hidden fixed inset-0 z-[250] bg-black/80 backdrop-blur-sm flex items-center justify-center fade-in p-4">
        <div class="bg-white dark:bg-gray-800 rounded-[2rem] shadow-2xl w-full max-w-md p-8 relative border-t-8 border-jcd-dark">
            <h3 class="text-xl font-black mb-4 dark:text-white">تعديل الحساب</h3>
            <input type="hidden" id="editUserId">
            <input type="text" id="adminEditPass" placeholder="كلمة المرور الجديدة" class="w-full p-3 mb-3 bg-gray-50 dark:bg-gray-700 rounded-xl text-xs">
            <div class="flex gap-2 mb-3">
                <input type="number" id="adminEditPoints" placeholder="النقاط" class="w-full p-3 bg-gray-50 dark:bg-gray-700 rounded-xl text-xs">
                <select id="adminPointAction" class="p-3 bg-gray-50 dark:bg-gray-700 rounded-xl text-xs"><option value="add">إضافة</option><option value="deduct">خصم</option></select>
            </div>
            <input type="text" id="adminEditReason" placeholder="السبب" class="w-full p-3 mb-4 bg-gray-50 dark:bg-gray-700 rounded-xl text-xs">
            <button onclick="app.saveAdminUserEdit()" class="w-full bg-jcd-dark text-white py-3 rounded-xl font-bold text-xs">حفظ</button>
            <button onclick="document.getElementById('adminEditUserModal').classList.add('hidden')" class="w-full mt-2 text-gray-500 text-xs">إلغاء</button>
        </div>
    </div>

    <!-- ID Card & Profile Modals -->
    <div id="idCardModal" class="hidden fixed inset-0 z-50 bg-black/90 flex items-center justify-center p-4">
        <div class="bg-white dark:bg-gray-800 rounded-2xl w-full max-w-sm overflow-hidden relative">
            <button onclick="document.getElementById('idCardModal').classList.add('hidden')" class="absolute top-2 left-2 z-20 text-white bg-black/50 rounded-full w-8 h-8"><i class="fas fa-times"></i></button>
            <div id="digitalIDCard" class="bg-gradient-to-b from-jcd-blue to-black p-6 text-center text-white relative h-[450px] flex flex-col items-center">
                <img src="https://upload.wikimedia.org/wikipedia/commons/e/e0/Jordan_Civil_Defence_Logo.png" class="h-20 mb-4 drop-shadow-md">
                <h2 class="text-2xl font-black mb-1">الدفاع المدني</h2>
                <p class="text-xs text-yellow-400 mb-6 tracking-widest uppercase">بطاقة متطوع رسمية</p>
                <div class="relative w-32 h-32 mb-4">
                    <img id="idCardAvatar" src="" class="w-full h-full rounded-xl object-cover border-2 border-yellow-400 bg-gray-800">
                </div>
                <h3 id="idCardName" class="text-xl font-bold"></h3>
                <p id="idCardNum" class="font-mono text-sm opacity-70 mt-1"></p>
                <p id="idCardRank" class="mt-4 px-4 py-1 bg-white/20 rounded-full text-xs font-bold"></p>
                <div class="mt-auto text-[10px] opacity-50 w-full border-t border-white/10 pt-2">مديرية المفرق - 2026</div>
            </div>
            <div class="p-4 flex justify-center"><button onclick="app.printID()" class="bg-blue-600 text-white px-6 py-2 rounded-lg text-sm font-bold">تحميل البطاقة</button></div>
        </div>
    </div>

    <div id="fullProfileModal" class="hidden fixed inset-0 z-[200] bg-black/90 flex items-center justify-center p-4">
        <div class="bg-white dark:bg-gray-800 w-full max-w-3xl rounded-3xl p-6 relative max-h-[90vh] overflow-y-auto">
            <button onclick="document.getElementById('fullProfileModal').classList.add('hidden')" class="absolute top-4 left-4 text-gray-400"><i class="fas fa-times text-xl"></i></button>
            <h3 class="text-2xl font-black mb-6 dark:text-white">الملف الشخصي</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <div class="flex items-center gap-4 mb-4">
                        <img id="fpAvatar" class="w-20 h-20 rounded-full border-2 border-jcd-blue object-cover">
                        <div>
                            <h4 id="fpName" class="font-bold text-lg dark:text-white"></h4>
                            <span id="fpRank" class="text-sm text-gray-500"></span>
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-2 mb-4">
                        <div class="bg-blue-50 dark:bg-gray-700 p-3 rounded-xl text-center"><span class="block font-black text-blue-600" id="fpPoints">0</span><span class="text-xs">نقطة</span></div>
                        <div class="bg-green-50 dark:bg-gray-700 p-3 rounded-xl text-center"><span class="block font-black text-green-600" id="fpHours">0</span><span class="text-xs">ساعة</span></div>
                    </div>
                    <div class="bg-gray-50 dark:bg-gray-700 p-3 rounded-xl">
                        <h5 class="font-bold text-xs mb-2 dark:text-white">الأوسمة</h5>
                        <div id="fpBadges" class="flex flex-wrap gap-2"></div>
                    </div>
                </div>
                <div class="space-y-4">
                    <div class="bg-gray-50 dark:bg-gray-700 p-3 rounded-xl">
                        <h5 class="font-bold text-xs mb-2 dark:text-white">الدورات</h5>
                        <ul id="fpCourses" class="text-xs space-y-1 dark:text-gray-300"></ul>
                    </div>
                    <div class="bg-gray-50 dark:bg-gray-700 p-3 rounded-xl">
                        <h5 class="font-bold text-xs mb-2 dark:text-white">النشاط الأخير</h5>
                        <div id="fpHistory" class="text-xs space-y-1 max-h-32 overflow-y-auto dark:text-gray-300"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Hidden Admin Scanner -->
    <div id="adminScannerModal" class="hidden fixed inset-0 z-[250] bg-black/90 flex items-center justify-center p-4">
        <div class="bg-white dark:bg-gray-800 rounded-2xl w-full max-w-md p-6 text-center relative">
            <button onclick="document.getElementById('adminScannerModal').classList.add('hidden')" class="absolute top-2 left-2 text-gray-400"><i class="fas fa-times"></i></button>
            <h3 class="font-black text-xl mb-4 dark:text-white">التحقق من الهوية</h3>
            <input type="text" id="scannerInput" placeholder="رقم المعرف" class="w-full p-3 bg-gray-100 dark:bg-gray-700 rounded-xl mb-4 text-center">
            <button onclick="app.verifyVolunteer()" class="w-full bg-green-600 text-white py-3 rounded-xl font-bold">تحقق</button>
            <div id="scanResult" class="hidden mt-4 p-4 bg-gray-50 dark:bg-gray-700 rounded-xl border border-dashed">
                <img id="scanAvatar" src="" class="w-16 h-16 rounded-full mx-auto mb-2">
                <h4 id="scanName" class="font-bold dark:text-white"></h4>
                <p id="scanRank" class="text-xs text-blue-500"></p>
                <div id="scanStatus" class="mt-2 text-xs font-bold"></div>
            </div>
        </div>
    </div>

    <!-- Logic Engine -->
    <script type="module">
        // -----------------------------------------------------------
        // CONFIGURATION SECTION (For GitHub Deployment)
        // -----------------------------------------------------------
        // If deploying to GitHub, replace the 'undefined' checks with your actual keys.
        // Keep the empty string for apiKey if using the Gemini environment injection.
        
        const GITHUB_FIREBASE_CONFIG = {
            apiKey: "YOUR_API_KEY",
            authDomain: "YOUR_PROJECT.firebaseapp.com",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_PROJECT.firebasestorage.app",
            messagingSenderId: "SENDER_ID",
            appId: "APP_ID"
        };
        const GITHUB_GEMINI_KEY = "YOUR_GEMINI_KEY"; // Required for AI features on GitHub
        // -----------------------------------------------------------

        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, updateDoc, onSnapshot, addDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Config Selection Logic
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : GITHUB_FIREBASE_CONFIG;
        const apiKey = typeof __app_id !== 'undefined' ? "" : GITHUB_GEMINI_KEY; 
        const appId = 'mafraq-diamond-v24-final'; // New version to reset bad data

        const fireApp = initializeApp(firebaseConfig);
        const auth = getAuth(fireApp);
        const db = getFirestore(fireApp);

        window.app = {
            data: { users: [], chats: [], currentUser: null, vehicles: [], courses: [] },
            map: null,

            async init() {
                if(localStorage.getItem('jcd_theme') === 'dark') document.documentElement.classList.add('dark');
                
                try {
                    if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                        await signInWithCustomToken(auth, __initial_auth_token);
                    } else {
                        await signInAnonymously(auth);
                    }
                } catch (e) { console.error("Auth:", e); }

                onAuthStateChanged(auth, (user) => { 
                    if (user) app.setupListeners(); 
                });
            },

            setupListeners() {
                const cols = ['users', 'chats', 'vehicles', 'courses'];
                cols.forEach(c => {
                    onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', c), (snap) => {
                        app.data[c] = [];
                        snap.forEach(d => app.data[c].push({ ...d.data(), _id: d.id }));
                        if(c === 'users') { app.seedData(); app.checkSession(); app.renderUI(); }
                        if(c === 'chats') app.renderChat();
                    }, (error) => console.log('Snapshot error:', error));
                });
                
                const loader = document.getElementById('globalLoader');
                if(loader) loader.style.display = 'none';
            },

            async seedData() {
                if (app.data.users.length > 0) return;
                
                const officials = [
                    { id: '101', name: 'معاذ الخوالدة', pass: '2026', role: 'admin', isOfficial: true, bio: 'مسؤول الدفعة' },
                    { id: '18', name: 'سجود شديفات', pass: '4568', role: 'volunteer', isOfficial: true, bio: 'مسؤولة المتطوعات' },
                    { id: '3', name: 'معاذ الخوالدة', pass: '7741', role: 'volunteer', isOfficial: true, bio: 'حساب متطوع' },
                    { id: '100', name: 'عطوفة المدير العام', pass: '2026', role: 'admin', isOfficial: true }
                ];

                const volNames = [
                    'مالك عليمات', 'هدى', 'حسام الحسبان', 'إبراهيم سعود', 'خولة نضال', 'رسول الخزاعلة', 'سلوى الصقور',
                    'شرف الحراحشة', 'عبد الرحمن يونس', 'عمر ياسين', 'امين المصري', 'فرحان الخوالدة', 'حور العرقان',
                    'مدين الشرفات', 'سند عليمات', 'شهم الحسبان', 'يوسف دعجة', 'بلقيس الكناني', 'عهد الحسبان', 'أرم',
                    'اريج النعيمات', 'عزيزة السقال', 'باسل', 'في', 'حمدان عليمات', 'ختام ابو قديري', 'لارا العجلوني',
                    'ميار الهواري', 'ريتاج', 'رويدا', 'ربى', 'سوار', 'سندس عليمات', 'رند العناسوة'
                ];

                // Seed Officials
                for (const u of officials) {
                    await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users', u.id), { ...u, status: 'active', stats: {points: 500, hours: 100}, history: [], notifications: [] });
                }

                // Seed Volunteers
                for (let i = 0; i < volNames.length; i++) {
                    const id = (i + 1).toString();
                    // Skip if ID conflicts with officials
                    if (officials.some(o => o.id === id)) continue;
                    
                    await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users', id), {
                        id, name: volNames[i], pass: "1234", role: 'volunteer', status: 'active',
                        stats: {points: 0, hours: 0}, history: [], notifications: []
                    });
                }
            },

            async checkSession() {
                const uid = localStorage.getItem('jcd_uid_v24');
                if (uid) {
                    const u = app.data.users.find(x => x.id === uid);
                    if (u) { app.data.currentUser = u; app.showDashboard(u); }
                }
            },

            showSection(id) {
                document.querySelectorAll('section').forEach(s => s.classList.add('hidden'));
                const target = document.getElementById(id);
                if (target) target.classList.remove('hidden');
                if (id === 'nashama-section') app.renderNashamaSection();
                window.scrollTo(0,0);
            },

            showLogin(type) {
                app.showSection('login');
                app.switchLoginTab(type);
            },

            switchLoginTab(type) {
                const volBtn = document.getElementById('tab-volunteer');
                const adminBtn = document.getElementById('tab-admin');
                const title = document.getElementById('loginTitle');
                
                volBtn.className = type === 'volunteer' ? 'w-1/2 py-3 rounded-xl text-sm font-black transition-all bg-white dark:bg-gray-600 shadow-sm text-jcd-blue dark:text-white' : 'w-1/2 py-3 rounded-xl text-sm font-black transition-all text-gray-500 hover:text-jcd-blue';
                adminBtn.className = type === 'admin' ? 'w-1/2 py-3 rounded-xl text-sm font-black transition-all bg-white dark:bg-gray-600 shadow-sm text-jcd-blue dark:text-white' : 'w-1/2 py-3 rounded-xl text-sm font-black transition-all text-gray-500 hover:text-jcd-blue';
                title.innerText = type === 'admin' ? 'دخول قيادة العمليات' : 'تسجيل دخول النشامى';
            },

            async handleLogin(e) {
                e.preventDefault();
                const id = document.getElementById('username').value.trim();
                const pass = document.getElementById('password').value.trim();
                
                if (app.data.users.length === 0) return alert("جاري تحميل البيانات.. حاول بعد ثواني");
                
                const user = app.data.users.find(u => u.id === id);
                if (!user || user.pass !== pass) return alert("بيانات غير صحيحة");
                if (user.status === 'banned') return alert("الحساب محظور. راجع الإدارة.");
                if (user.status === 'pending') return alert("الحساب قيد التفعيل.");

                app.data.currentUser = user;
                localStorage.setItem('jcd_uid_v24', user.id);
                app.showDashboard(user);
                
                if(user.role === 'volunteer') app.generateDailyMessage(user.name);
            },

            logout() {
                app.data.currentUser = null;
                localStorage.removeItem('jcd_uid_v24');
                location.reload();
            },

            showDashboard(user) {
                document.getElementById('guestLinks').classList.add('hidden');
                document.getElementById('userMenu').classList.remove('hidden');
                document.getElementById('userNameDisplay').innerText = user.name;
                
                if (user.role === 'admin') {
                    app.showSection('admin-dashboard');
                    app.renderAdminDashboard();
                } else {
                    app.showSection('volunteer-dashboard');
                    app.renderVolunteerUI();
                    document.getElementById('chatWidget').classList.remove('hidden');
                    setTimeout(() => app.initMap(), 1000);
                }
            },

            renderUI() {
                app.renderNashamaSection();
                if (app.data.currentUser) {
                    const freshUser = app.data.users.find(u => u.id === app.data.currentUser.id);
                    if(freshUser) app.data.currentUser = freshUser;
                    
                    if (app.data.currentUser.role === 'admin') app.renderAdminDashboard();
                    else app.renderVolunteerUI();
                }
            },

            renderNashamaSection() {
                const grid = document.getElementById('nashamaGrid');
                if(!grid) return;
                
                const sorted = app.data.users.filter(u => u.role !== 'admin' && u.status === 'active')
                    .sort((a,b) => (b.isOfficial ? 1 : 0) - (a.isOfficial ? 1 : 0) || (b.stats?.points || 0) - (a.stats?.points || 0));

                grid.innerHTML = sorted.map(u => {
                    const isLeader = u.isOfficial || u.name.includes('معاذ') || u.name.includes('سجود');
                    const rank = app.getRankInfo(u.stats?.hours);
                    const cardStyle = isLeader ? 'official-card transform scale-105 shadow-2xl' : 'bg-white dark:bg-gray-800 shadow-lg border border-gray-100 dark:border-gray-700';
                    
                    return `
                    <div class="${cardStyle} rounded-3xl p-6 text-center relative overflow-hidden group hover:-translate-y-2 transition duration-300">
                        ${isLeader ? '<div class="absolute top-0 right-0 bg-yellow-400 text-black text-[10px] font-black px-3 py-1 rounded-bl-xl z-10"><i class="fas fa-crown"></i> قيادة</div>' : ''}
                        <div class="relative w-24 h-24 mx-auto mb-4">
                            <img src="${u.avatar || 'https://via.placeholder.com/150'}" class="w-full h-full rounded-full object-cover border-4 ${isLeader ? 'border-yellow-400 shadow-[0_0_15px_rgba(251,191,36,0.6)]' : rank.class}">
                        </div>
                        <h3 class="font-black text-lg mb-1 truncate">${u.name}</h3>
                        <p class="text-xs opacity-70 mb-4 font-bold">${rank.title}</p>
                        <div class="flex justify-center gap-4 text-xs font-bold bg-black/10 dark:bg-white/5 py-2 rounded-xl">
                            <span class="flex items-center gap-1"><i class="fas fa-star text-yellow-400"></i> ${u.stats?.points||0}</span>
                            <span class="flex items-center gap-1"><i class="fas fa-clock text-green-400"></i> ${u.stats?.hours||0}</span>
                        </div>
                    </div>`;
                }).join('');
            },

            renderVolunteerUI() {
                const u = app.data.currentUser;
                document.getElementById('volNameDisplay').innerText = u.name;
                document.getElementById('volBioDisplay').innerText = u.bio || "متطوع نشيط";
                document.getElementById('dashAvatar').src = u.avatar || "https://via.placeholder.com/150";
                
                const rank = app.getRankInfo(u.stats?.hours);
                document.getElementById('dashRankBadge').innerText = rank.title;
                document.getElementById('dashRankBadge').className = `absolute -bottom-3 right-1/2 translate-x-1/2 px-3 py-1 rounded-full font-black shadow-lg whitespace-nowrap text-xs ${rank.badgeColor}`;

                const gate = document.getElementById('gateContainer');
                if(!u.currentSession) {
                    gate.innerHTML = `<button onclick="app.checkIn()" class="w-full bg-green-500 hover:bg-green-600 text-white py-3 rounded-xl font-black shadow-lg transition">دخول الميدان</button>`;
                } else if (u.currentSession.status === 'pending') {
                    gate.innerHTML = `<div class="bg-yellow-500/20 text-yellow-300 p-3 rounded-xl border border-yellow-500 font-bold text-sm animate-pulse">بانتظار الموافقة...</div>`;
                } else {
                    gate.innerHTML = `<div class="text-white mb-2 font-bold text-sm">دخلت: ${u.currentSession.time}</div><button onclick="app.checkOut()" class="w-full bg-red-600 hover:bg-red-700 text-white py-3 rounded-xl font-black shadow-lg transition">إنهاء (Check-Out)</button>`;
                }
            },

            async renderAdminDashboard() {
                const users = app.data.users;
                const pending = users.filter(u => u.currentSession?.status === 'pending');
                const active = users.filter(u => u.currentSession?.status === 'active');
                
                document.getElementById('adminNameSpan').innerText = app.data.currentUser.name;
                document.getElementById('rosterCount').innerText = active.length;
                
                let liveHTML = '';
                if(pending.length > 0) {
                    liveHTML += `<div class="mb-2"><h5 class="text-xs font-bold text-yellow-500 mb-2">طلبات معلقة (${pending.length})</h5>`;
                    liveHTML += pending.map(u => `
                        <div class="bg-yellow-50 dark:bg-yellow-900/20 p-2 rounded-lg flex justify-between items-center text-xs mb-1 dark:text-white border border-yellow-200 dark:border-yellow-700">
                            <span>${u.name}</span>
                            <div class="flex gap-1">
                                <button onclick="app.adminApprove('${u.id}')" class="bg-green-500 text-white px-2 py-1 rounded hover:bg-green-600">✓</button>
                                <button onclick="app.adminReject('${u.id}')" class="bg-red-500 text-white px-2 py-1 rounded hover:bg-red-600">✗</button>
                            </div>
                        </div>`).join('');
                    liveHTML += `</div>`;
                }
                
                liveHTML += active.map(u => `
                    <div class="bg-green-50 dark:bg-green-900/20 p-2 rounded-lg flex justify-between items-center text-xs mb-1 dark:text-white border border-green-200 dark:border-green-700">
                        <span>${u.name}</span>
                        <span class="text-green-600 dark:text-green-400 font-mono">${u.currentSession.time}</span>
                    </div>`).join('');
                
                document.getElementById('liveAttendanceList').innerHTML = liveHTML || '<p class="text-center text-xs text-gray-400 py-4">الميدان هادئ حالياً</p>';
                
                app.renderUserTable(users);
                app.renderVehicles();
            },

            renderUserTable(list) {
                const table = document.getElementById('fullUsersTable');
                if(!table) return;
                table.innerHTML = list.sort((a,b) => (a.role === 'admin' ? -1 : 1)).map(u => `
                    <tr class="border-b border-gray-100 dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-700/50 transition">
                        <td class="p-3 flex items-center gap-2">
                            <img src="${u.avatar || 'https://via.placeholder.com/150'}" class="w-8 h-8 rounded-full">
                            <span>${u.name} ${u.isOfficial ? '👑' : ''}</span>
                        </td>
                        <td class="p-3 font-mono text-gray-400">${u.id}</td>
                        <td class="p-3 text-jcd-blue dark:text-blue-400 font-bold">${u.stats?.points || 0}</td>
                        <td class="p-3">
                            <button onclick="app.openAdminTools('${u.id}')" class="text-jcd-gold mx-1"><i class="fas fa-tools"></i></button>
                            <button onclick="app.openAdminEditUser('${u.id}')" class="text-blue-500 mx-1"><i class="fas fa-edit"></i></button>
                        </td>
                    </tr>
                `).join('');
            },

            async checkIn() {
                const now = new Date();
                await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users', app.data.currentUser.id), {
                    currentSession: { start: now.toISOString(), time: now.toLocaleTimeString('ar-JO'), status: 'pending' }
                });
            },
            async checkOut() {
                const u = app.data.currentUser;
                const hours = (new Date() - new Date(u.currentSession.start)) / (1000 * 60 * 60);
                const points = Math.floor(hours * 5) + 5;
                const rec = { date: new Date().toLocaleDateString('ar-JO'), hours: hours.toFixed(2), points };
                await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users', u.id), {
                    currentSession: null,
                    history: [...(u.history||[]), rec],
                    "stats.points": (u.stats.points||0) + points,
                    "stats.hours": (u.stats.hours||0) + hours
                });
            },
            async adminApprove(uid) { await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users', uid), { "currentSession.status": 'active' }); },
            async adminReject(uid) { await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users', uid), { currentSession: null }); },

            async generateDailyMessage(name) {
                const today = new Date().toDateString();
                if(localStorage.getItem('ai_msg_date') === today) {
                    document.getElementById('dailyMessageText').innerText = localStorage.getItem('ai_msg_content');
                    return;
                }
                try {
                    const prompt = `وجه رسالة تحفيزية قصيرة جداً (سطر واحد) باللهجة الأردنية للمتطوع ${name} في الدفاع المدني.`;
                    const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                        method: 'POST', headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                    });
                    const d = await res.json();
                    const msg = d.candidates?.[0]?.content?.parts?.[0]?.text || "همتكم عالية يا نشامى!";
                    document.getElementById('dailyMessageText').innerText = msg;
                    localStorage.setItem('ai_msg_date', today);
                    localStorage.setItem('ai_msg_content', msg);
                } catch(e) { document.getElementById('dailyMessageText').innerText = "يا نشمي، الوطن بيكبر بعطائك. الله يقويك!"; }
            },

            getRankInfo(hours = 0) {
                if (hours >= 300) return { title: 'قائد ميداني', class: 'rank-border-leader', badgeColor: 'bg-yellow-400 text-black' };
                if (hours >= 100) return { title: 'منقذ', class: 'rank-border-rescuer', badgeColor: 'bg-orange-500 text-white' };
                if (hours >= 50) return { title: 'نشمي', class: 'rank-border-nashmi', badgeColor: 'bg-green-500 text-white' };
                return { title: 'مبتدئ', class: 'rank-border-beginner', badgeColor: 'bg-gray-500 text-white' };
            },

            initMap() {
                if(app.map) return;
                app.map = L.map('map').setView([32.3424, 36.2043], 13);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '&copy; OpenStreetMap' }).addTo(app.map);
            },

            toggleChat() {
                const w = document.getElementById('chatWindow');
                w.classList.toggle('hidden');
                if(!w.classList.contains('hidden')) app.renderChat();
            },
            async sendChatMessage() {
                const inp = document.getElementById('chatInput');
                if(!inp.value.trim()) return;
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'chats'), { text: inp.value, sender: app.data.currentUser.name, time: Date.now() });
                inp.value = '';
            },
            renderChat() {
                const box = document.getElementById('chatMessages');
                box.innerHTML = app.data.chats.sort((a,b)=>a.time-b.time).map(m => `<div class="mb-2 ${m.sender===app.data.currentUser.name ? 'text-left' : 'text-right'}"><span class="text-[10px] opacity-50 block">${m.sender}</span><span class="inline-block px-3 py-2 rounded-lg text-xs ${m.sender===app.data.currentUser.name ? 'bg-blue-100 text-blue-900' : 'bg-gray-100 text-gray-900'}">${m.text}</span></div>`).join('');
                box.scrollTop = box.scrollHeight;
            },
            
            toggleDarkMode() { document.documentElement.classList.toggle('dark'); },
            filterNashama(q) {
                const grid = document.getElementById('nashamaGrid');
                const users = app.data.users.filter(u => u.name.includes(q) && u.role !== 'admin');
                grid.innerHTML = users.map(u => `<div class="bg-white dark:bg-gray-800 p-4 rounded-xl shadow text-center"><img src="${u.avatar || 'https://via.placeholder.com/150'}" class="w-16 h-16 rounded-full mx-auto mb-2 object-cover"><h4 class="font-bold text-sm dark:text-white">${u.name}</h4><span class="text-xs text-gray-500">${app.getRankInfo(u.stats?.hours).title}</span></div>`).join('');
            },
            filterUsers(q) {
                const filtered = app.data.users.filter(u => u.name.includes(q) || u.id.includes(q));
                app.renderUserTable(filtered);
            },
            
            // Admin Tools Handlers
            openAdminTools(uid) {
                const u = app.data.users.find(x => x.id === uid);
                document.getElementById('toolUserId').value = uid;
                document.getElementById('toolUserName').innerText = `المتطوع: ${u.name}`;
                document.getElementById('adminToolsModal').classList.remove('hidden');
                
                // Inventory & Badges lists rendering (simplified)
                const badgesList = document.getElementById('manualBadgesList');
                badgesList.innerHTML = (u.customBadges || []).map(b => `<span class="${b.color} px-2 py-1 rounded text-xs flex items-center gap-1"><i class="fas fa-${b.icon}"></i> ${b.title}</span>`).join('') || '<span class="text-gray-400 text-xs">لا يوجد أوسمة</span>';
                
                const list = document.getElementById('userInventoryList');
                list.innerHTML = (u.inventory || []).map(item => `<div class="flex justify-between bg-gray-50 p-2 rounded"><span>${item.name}</span><button onclick="app.returnInventory('${uid}', '${item.id}')" class="text-red-500 text-[10px]">إرجاع</button></div>`).join('') || '<p class="text-gray-400">لا توجد عهدة</p>';
            },
            async grantManualBadge() {
                const uid = document.getElementById('toolUserId').value;
                const title = document.getElementById('badgeTitle').value;
                if (!title) return;
                const u = app.data.users.find(x => x.id === uid);
                const newBadge = { id: Date.now(), title, icon: 'medal', color: 'text-yellow-500 bg-yellow-100', date: new Date().toLocaleDateString('ar-JO') };
                await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users', uid), { customBadges: [...(u.customBadges || []), newBadge] });
                app.openAdminTools(uid);
            },
            async assignInventory() {
                const uid = document.getElementById('toolUserId').value;
                const name = document.getElementById('invItemName').value;
                if(!name) return;
                const u = app.data.users.find(x => x.id === uid);
                const newItem = { id: Date.now().toString(), name, date: new Date().toLocaleDateString('ar-JO') };
                await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users', uid), { inventory: [...(u.inventory || []), newItem] });
                app.openAdminTools(uid);
            },
            async returnInventory(uid, itemId) {
                const u = app.data.users.find(x => x.id === uid);
                const newInv = u.inventory.filter(i => i.id !== itemId);
                await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users', uid), { inventory: newInv });
                app.openAdminTools(uid);
            },
            
            // Vehicles
            async addVehicleStatus() {
                const name = document.getElementById('vehName').value;
                const status = document.getElementById('vehStatus').value;
                if(!name) return;
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'vehicles'), { name, status, date: new Date().toLocaleDateString('ar-JO') });
            },
            renderVehicles() {
                const list = document.getElementById('vehicleList');
                if(!list) return;
                list.innerHTML = app.data.vehicles.map(v => `<div class="flex justify-between items-center bg-white/10 p-2 rounded text-xs"><span>${v.name}</span><span class="${v.status === 'جاهزة' ? 'text-green-400' : 'text-red-400'} font-bold">${v.status}</span></div>`).join('');
            },
            
            // Registration
            async handleRegistration(event) {
                event.preventDefault();
                const id = document.getElementById('regId').value.trim();
                const name = document.getElementById('regName').value.trim();
                const pass = document.getElementById('regPass').value.trim();
                if(app.data.users.some(u=>u.id===id)) return alert("المعرف مسجل");
                await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users', id), { id, name, pass, role:'volunteer', status:'pending', stats:{points:0, hours:0} });
                alert("تم الإرسال."); app.showSection('home');
            },
            
            // Modals
            openIDModal() {
                const u = app.data.currentUser;
                document.getElementById('idCardName').innerText = u.name;
                document.getElementById('idCardNum').innerText = `ID: ${u.id}`;
                document.getElementById('idCardRank').innerText = app.getRankInfo(u.stats?.hours).title;
                document.getElementById('idCardAvatar').src = u.avatar || "https://via.placeholder.com/150";
                document.getElementById('idCardModal').classList.remove('hidden');
            },
            printID() {
                const element = document.getElementById('digitalIDCard');
                const opt = { margin: 0, filename: `ID_${app.data.currentUser.id}.png`, image: { type: 'png', quality: 1 }, html2canvas: { scale: 3 } };
                html2pdf().set(opt).from(element).save();
            },
            openFullProfile() {
                const u = app.data.currentUser;
                document.getElementById('fpName').innerText = u.name;
                document.getElementById('fpRank').innerText = app.getRankInfo(u.stats?.hours).title;
                document.getElementById('fpAvatar').src = u.avatar || "https://via.placeholder.com/150";
                document.getElementById('fpPoints').innerText = u.stats?.points || 0;
                document.getElementById('fpHours').innerText = (u.stats?.hours || 0).toFixed(1);
                
                const badgesDiv = document.getElementById('fpBadges');
                let badgesHTML = '';
                if(u.isOfficial) badgesHTML += '<span class="bg-blue-100 text-blue-700 px-2 py-1 rounded text-xs">👑 قيادة</span>';
                if(u.customBadges) badgesHTML += u.customBadges.map(b => `<span class="${b.color} px-2 py-1 rounded text-xs"><i class="fas fa-${b.icon}"></i> ${b.title}</span>`).join('');
                badgesDiv.innerHTML = badgesHTML || '<span class="text-xs text-gray-400">لا توجد أوسمة بعد</span>';
                
                document.getElementById('fullProfileModal').classList.remove('hidden');
            }
        };

        window.addEventListener('load', () => app.init());
    </script>
</body>
</html>