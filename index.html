<!DOCTYPE html>
<html lang="ar" dir="rtl" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>بوابة نشامى المفرق - النظام السيادي المتكامل</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        jcd: { blue: '#1e3a8a', red: '#dc2626', gold: '#fbbf24', dark: '#0f172a' }
                    },
                    animation: { 
                        'float': 'float 6s ease-in-out infinite',
                        'shine': 'shine 3s linear infinite',
                        'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite'
                    },
                    keyframes: {
                        float: { '0%, 100%': { transform: 'translateY(0)' }, '50%': { transform: 'translateY(-10px)' } },
                        shine: { '0%': { backgroundPosition: '200% center' }, '100%': { backgroundPosition: '-200% center' } }
                    }
                }
            }
        }
    </script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap');
        body { font-family: 'Tajawal', sans-serif; }
        
        .hero-section {
            background: radial-gradient(circle at center, #1e3a8a 0%, #111827 100%);
            position: relative; overflow: hidden;
        }
        .hero-section::after {
            content: ''; position: absolute; inset: 0;
            background-image: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2V6h4V4H6z' fill='%23ffffff' fill-opacity='0.03'/%3E%3C/svg%3E");
        }
        
        .glass-panel {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1);
        }

        .official-card {
            background: linear-gradient(145deg, #1e3a8a, #000000);
            border: 2px solid #fbbf24;
            color: white;
        }

        .rank-border-leader { border-color: #fbbf24; box-shadow: 0 0 15px rgba(251, 191, 36, 0.5); }
        .rank-border-nashmi { border-color: #22c55e; }
        .rank-border-rescuer { border-color: #f97316; }
        .rank-border-regular { border-color: #9ca3af; }

        .custom-scrollbar::-webkit-scrollbar { width: 5px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 10px; }
        
        #map { height: 100%; width: 100%; border-radius: 1rem; z-index: 0; }
        .fade-in { animation: fadeIn 0.5s ease-in; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body class="flex flex-col min-h-screen text-right font-black bg-gray-50 text-gray-800 dark:bg-gray-950 dark:text-gray-100 transition-colors duration-300">

    <!-- Navbar -->
    <nav class="sticky top-0 z-50 glass-panel bg-jcd-blue/90 text-white shadow-lg backdrop-blur-md">
        <div class="container mx-auto px-4 py-3 flex justify-between items-center">
            <div class="flex items-center gap-3 cursor-pointer" onclick="app.showSection('home')">
                <img id="navLogo" src="https://upload.wikimedia.org/wikipedia/commons/e/e0/Jordan_Civil_Defence_Logo.png" class="h-10 w-10 object-contain drop-shadow-md bg-white rounded-full p-1">
                <div>
                    <h1 class="font-black text-lg leading-tight">بوابة نشامى المفرق</h1>
                    <p class="text-[10px] text-yellow-400 font-bold tracking-widest opacity-90">النظام الرقمي الموحد</p>
                </div>
            </div>
            
            <div class="flex items-center gap-4">
                <div id="guestLinks" class="hidden md:flex items-center gap-6 text-sm font-bold">
                    <button onclick="app.showSection('home')" class="hover:text-yellow-400 transition">الرئيسية</button>
                    <button onclick="app.showSection('nashama-section')" class="hover:text-yellow-400 transition">بوابة النشامى</button>
                    <button onclick="app.showLogin('volunteer')" class="bg-white/10 hover:bg-white/20 px-4 py-2 rounded-full border border-white/20 transition">دخول النظام</button>
                </div>
                
                <div id="userMenu" class="hidden flex items-center gap-4">
                    <div class="relative cursor-pointer group" onclick="app.toggleNotifications()">
                        <i class="fas fa-bell text-xl group-hover:text-yellow-400 transition"></i>
                        <span id="notifBadge" class="absolute -top-1 -right-1 bg-red-600 text-[10px] h-4 w-4 flex items-center justify-center rounded-full hidden animate-pulse">0</span>
                    </div>
                    <div class="text-left leading-tight">
                        <span id="userNameDisplay" class="block text-xs font-black text-yellow-400"></span>
                        <button onclick="app.logout()" class="text-[10px] text-gray-300 hover:text-white underline">خروج</button>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <!-- Ticker -->
    <div id="news-ticker-container" class="bg-jcd-red text-white text-xs py-2 overflow-hidden hidden relative z-40">
        <div class="whitespace-nowrap animate-marquee px-4 font-bold" id="newsTickerText"></div>
    </div>

    <main id="main-content" class="flex-grow container mx-auto px-4 py-6 relative z-0">
        
        <!-- Hero Section -->
        <section id="home" class="fade-in">
            <div class="hero-section rounded-[3rem] p-8 md:p-20 text-center text-white shadow-2xl relative min-h-[80vh] flex flex-col items-center justify-center border-b-8 border-yellow-500">
                <div class="relative z-10 w-full max-w-4xl">
                    <div class="animate-float mb-8">
                        <img id="heroLogo" src="https://upload.wikimedia.org/wikipedia/commons/e/e0/Jordan_Civil_Defence_Logo.png" class="h-40 md:h-56 mx-auto drop-shadow-2xl bg-white/10 rounded-full p-4">
                    </div>
                    <h2 class="text-5xl md:text-7xl font-black mb-6 tracking-tighter drop-shadow-xl bg-clip-text text-transparent bg-gradient-to-r from-white to-gray-300" style="-webkit-text-stroke: 1px rgba(255,255,255,0.1);">نشامى المفرق</h2>
                    <p class="text-lg md:text-2xl text-blue-100 mb-12 max-w-2xl mx-auto font-medium">"منصة التطوع الرقمية الأولى لتوثيق العطاء وتنظيم الواجب"</p>
                    
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 w-full max-w-3xl mx-auto">
                        <button onclick="app.showSection('registration')" class="glass-panel hover:bg-white/10 p-6 rounded-3xl transition transform hover:scale-105 group border-b-4 border-green-500">
                            <i class="fas fa-user-plus text-4xl mb-3 text-green-400 group-hover:rotate-12 transition"></i>
                            <h3 class="text-xl font-black">انضم إلينا</h3>
                            <p class="text-xs text-gray-300 mt-1">سجل كمتطوع جديد</p>
                        </button>
                        
                        <button onclick="app.showLogin('volunteer')" class="glass-panel hover:bg-white/10 p-6 rounded-3xl transition transform hover:scale-105 group border-b-4 border-yellow-500">
                            <i class="fas fa-id-card-alt text-4xl mb-3 text-yellow-400 group-hover:scale-110 transition"></i>
                            <h3 class="text-xl font-black">دخول المتطوعين</h3>
                            <p class="text-xs text-gray-300 mt-1">لوحة التحكم والخدمات</p>
                        </button>
                        
                        <button onclick="app.showLogin('admin')" class="glass-panel hover:bg-white/10 p-6 rounded-3xl transition transform hover:scale-105 group border-b-4 border-red-500">
                            <i class="fas fa-shield-alt text-4xl mb-3 text-red-500 group-hover:scale-110 transition"></i>
                            <h3 class="text-xl font-black">الإدارة</h3>
                            <p class="text-xs text-gray-300 mt-1">للمسؤولين فقط</p>
                        </button>
                    </div>
                </div>
            </div>
        </section>

        <!-- Nashama Portal -->
        <section id="nashama-section" class="fade-in hidden">
            <div class="text-center mb-10">
                <h2 class="text-4xl font-black text-jcd-blue dark:text-white mb-2">بوابة النشامى</h2>
                <p class="text-gray-500 dark:text-gray-400 font-bold">قائمة الشرف للمتطوعين المتميزين - تحديث حي</p>
            </div>
            
            <div class="max-w-md mx-auto mb-10 relative">
                <input type="text" oninput="app.filterNashama(this.value)" placeholder="ابحث باسم النشمي..." class="w-full p-4 pr-12 rounded-2xl bg-white dark:bg-gray-800 shadow-lg border border-gray-100 dark:border-gray-700 outline-none focus:ring-2 focus:ring-jcd-blue transition">
                <i class="fas fa-search absolute right-4 top-4 text-gray-400"></i>
            </div>

            <div id="nashamaGrid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6"></div>
        </section>

        <!-- Login Section -->
        <section id="login" class="fade-in hidden max-w-md mx-auto py-10">
            <div class="bg-white dark:bg-gray-800 rounded-[2.5rem] shadow-2xl p-8 border-t-8 border-jcd-blue relative overflow-hidden">
                <div class="flex mb-8 bg-gray-100 dark:bg-gray-700 rounded-2xl p-1">
                    <button class="w-1/2 py-3 rounded-xl text-sm font-black transition-all bg-white dark:bg-gray-600 shadow-sm text-jcd-blue dark:text-white" id="tab-volunteer" onclick="app.switchLoginTab('volunteer')">متطوع</button>
                    <button class="w-1/2 py-3 rounded-xl text-sm font-black transition-all text-gray-500 dark:text-gray-400 hover:text-jcd-blue" id="tab-admin" onclick="app.switchLoginTab('admin')">إدارة</button>
                </div>
                
                <h2 class="text-2xl font-black text-center mb-6 text-jcd-blue dark:text-white" id="loginTitle">تسجيل دخول النشامى</h2>
                
                <form onsubmit="app.handleLogin(event)" class="space-y-5">
                    <input type="text" id="username" placeholder="المعرف / الرقم الوطني" class="w-full bg-gray-50 dark:bg-gray-700 dark:text-white p-4 rounded-2xl outline-none border-2 border-transparent focus:border-jcd-blue transition font-bold text-right" required>
                    <input type="password" id="password" placeholder="كلمة المرور" class="w-full bg-gray-50 dark:bg-gray-700 dark:text-white p-4 rounded-2xl outline-none border-2 border-transparent focus:border-jcd-blue transition font-bold text-right" required>
                    <button type="submit" id="loginBtn" class="w-full bg-jcd-blue hover:bg-blue-900 text-white font-black py-4 rounded-2xl shadow-xl transition transform active:scale-95 flex justify-center items-center gap-2"><span>دخول آمن</span><i class="fas fa-arrow-left"></i></button>
                </form>
                <div class="text-center mt-4">
                    <span id="systemStatus" class="inline-flex items-center gap-2 text-xs font-bold text-gray-400">
                        <span class="w-2 h-2 rounded-full bg-gray-400 animate-pulse"></span> جاري تهيئة النظام...
                    </span>
                </div>
            </div>
        </section>

        <!-- Volunteer Dashboard -->
        <section id="volunteer-dashboard" class="fade-in hidden space-y-8">
            <div class="bg-gradient-to-r from-jcd-blue to-blue-900 rounded-[2.5rem] p-8 text-white shadow-2xl relative overflow-hidden">
                <div class="absolute top-0 left-0 w-full h-full opacity-20 pointer-events-none" style="background-image: url('https://www.transparenttextures.com/patterns/cubes.png');"></div>
                <div class="flex flex-col md:flex-row items-center gap-8 relative z-10">
                    <div class="relative">
                        <img id="dashAvatar" src="https://via.placeholder.com/150" class="h-32 w-32 rounded-full border-4 border-yellow-400 shadow-xl object-cover bg-gray-200">
                        <span id="dashRankBadge" class="absolute -bottom-3 right-1/2 translate-x-1/2 bg-yellow-400 text-black text-xs px-3 py-1 rounded-full font-black shadow-lg whitespace-nowrap">نشمي</span>
                    </div>
                    <div class="text-center md:text-right flex-grow">
                        <h2 class="text-3xl font-black mb-1" id="volNameDisplay"></h2>
                        <p class="text-blue-200 text-sm mb-4" id="volBioDisplay">متطوع</p>
                        <!-- Warning Alert Box -->
                        <div id="volWarningBox" class="hidden bg-red-600/20 border border-red-500 p-3 rounded-xl mb-4 text-xs font-bold text-white flex items-center gap-2 animate-pulse">
                            <i class="fas fa-exclamation-triangle text-xl"></i>
                            <span id="volWarningText">لديك إنذار نشط: يرجى مراجعة الإدارة أو الالتزام بالدوام.</span>
                        </div>
                        <div class="flex flex-wrap justify-center md:justify-start gap-3">
                            <button onclick="app.openIDModal()" class="bg-white/20 hover:bg-white/30 px-4 py-2 rounded-xl text-xs font-bold transition flex items-center gap-2"><i class="fas fa-id-card"></i> هويتي</button>
                            <button onclick="app.openFullProfile()" class="bg-white/20 hover:bg-white/30 px-4 py-2 rounded-xl text-xs font-bold transition flex items-center gap-2"><i class="fas fa-user-circle"></i> ملفي الشامل</button>
                            <button onclick="app.openProfileEdit()" class="bg-white/20 hover:bg-white/30 px-4 py-2 rounded-xl text-xs font-bold transition flex items-center gap-2"><i class="fas fa-cog"></i> الإعدادات</button>
                            <button onclick="app.openSuggestionsModal()" class="bg-white/20 hover:bg-white/30 px-4 py-2 rounded-xl text-xs font-bold transition flex items-center gap-2"><i class="fas fa-box-open"></i> اقتراحات وشكاوى</button>
                        </div>
                    </div>
                    <div id="gateContainer" class="bg-white/10 backdrop-blur-md p-6 rounded-2xl border border-white/20 text-center min-w-[200px]"></div>
                </div>
            </div>

            <!-- Announcements Area for Volunteer -->
            <div id="volAnnouncements" class="hidden bg-yellow-50 dark:bg-yellow-900/20 border-r-4 border-yellow-500 p-4 rounded-xl shadow-md fade-in">
                <h4 class="font-black text-sm text-yellow-600 dark:text-yellow-400 mb-2"><i class="fas fa-bullhorn ml-2"></i> تعاميم إدارية</h4>
                <div id="announcementText" class="text-xs text-gray-700 dark:text-gray-300 font-bold leading-relaxed"></div>
            </div>

            <!-- Stats & AI Message -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="md:col-span-2 bg-gradient-to-r from-orange-500 to-red-600 rounded-[2rem] p-6 text-white shadow-lg relative overflow-hidden">
                    <i class="fas fa-quote-right absolute top-4 left-4 text-4xl opacity-20"></i>
                    <h4 class="font-black text-sm mb-2 opacity-80">رسالة اليوم من القيادة</h4>
                    <p id="dailyMessageText" class="text-lg font-bold leading-relaxed relative z-10">جاري الاتصال بالعمليات...</p>
                </div>
                <div class="bg-gradient-to-br from-blue-400 to-cyan-500 rounded-[2rem] p-6 text-white shadow-lg flex items-center justify-between">
                    <div>
                        <h4 class="text-sm font-bold opacity-80">الطقس (المفرق)</h4>
                        <div class="text-3xl font-black mt-1" id="weatherTemp">18°</div>
                        <div class="text-xs bg-white/20 px-2 py-1 rounded inline-block mt-1">مشمس</div>
                    </div>
                    <i class="fas fa-sun text-5xl text-yellow-300 animate-spin-slow"></i>
                </div>
            </div>

            <!-- AI Message -->
            <div class="bg-gradient-to-r from-gray-800 to-black rounded-[2rem] p-6 text-white shadow-lg relative overflow-hidden flex flex-col md:flex-row items-center justify-between gap-6 border border-gray-700">
                <div class="relative z-10 w-full">
                     <h4 class="font-black text-sm mb-2 opacity-80 flex items-center gap-2 text-yellow-400"><i class="fas fa-robot"></i> المستشار الذكي (AI)</h4>
                     <div id="aiResponseArea" class="text-sm font-bold leading-relaxed mb-4 min-h-[40px] text-gray-300">اسألني أي شيء عن الإسعافات الأولية أو إجراءات الدفاع المدني...</div>
                     <div class="flex gap-2">
                         <input type="text" id="aiQuickAsk" placeholder="اكتب سؤالك هنا..." class="flex-grow p-3 rounded-xl bg-white/10 text-white placeholder-white/40 text-xs outline-none border border-white/20 focus:border-yellow-400 transition">
                         <button onclick="app.askAIQuick()" class="bg-yellow-500 text-black px-4 py-2 rounded-xl font-bold text-xs hover:bg-yellow-400 transition"><i class="fas fa-paper-plane"></i></button>
                     </div>
                </div>
            </div>

            <!-- Report Generator -->
            <div class="bg-white dark:bg-gray-800 p-6 rounded-[2rem] shadow-lg border-l-4 border-blue-500">
                <h4 class="font-black text-lg mb-2 text-blue-600 dark:text-blue-400"><i class="fas fa-file-alt ml-2"></i> إنشاء تقرير مهمة</h4>
                <textarea id="volReportText" placeholder="صف تفاصيل المهمة أو النشاط الذي قمت به..." class="w-full p-3 bg-gray-50 dark:bg-gray-700 rounded-xl text-xs mb-3 h-24 resize-none outline-none border focus:border-blue-500 dark:text-white"></textarea>
                <button onclick="app.generateVolReport()" class="bg-blue-600 text-white px-6 py-2 rounded-xl text-xs font-bold hover:bg-blue-700">توليد تقرير (AI)</button>
                <div id="aiReportOutput" class="mt-4 text-xs p-4 bg-gray-50 dark:bg-gray-700 rounded-xl hidden text-gray-700 dark:text-gray-300 leading-relaxed"></div>
            </div>
            
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- Shift Registration -->
                <div class="bg-white dark:bg-gray-800 p-6 rounded-[2rem] shadow-lg border-b-4 border-blue-500">
                    <h4 class="font-black text-lg mb-4 text-blue-600 dark:text-blue-400 flex items-center gap-2"><i class="fas fa-calendar-alt"></i> التسجيل للمناوبات</h4>
                    <div id="volShiftList" class="space-y-3 max-h-48 overflow-y-auto custom-scrollbar"></div>
                </div>

                <!-- Training & Map -->
                <div class="bg-white dark:bg-gray-800 p-6 rounded-[2rem] shadow-lg border-b-4 border-purple-500">
                    <h4 class="font-black text-lg mb-4 text-purple-600 dark:text-purple-400 flex items-center gap-2"><i class="fas fa-graduation-cap"></i> الدورات المتاحة</h4>
                    <div id="volCoursesList" class="space-y-3 max-h-48 overflow-y-auto custom-scrollbar"></div>
                </div>
            </div>

            <!-- Map -->
            <div class="bg-white dark:bg-gray-800 p-6 rounded-[2rem] shadow-lg border-b-4 border-red-500 h-96">
                <h4 class="font-black text-lg mb-4 text-red-500 flex items-center gap-2"><i class="fas fa-map-marked-alt"></i> خريطة العمليات</h4>
                <div id="map" class="w-full h-[calc(100%-2rem)] rounded-xl bg-gray-200 dark:bg-gray-700 z-0 relative"></div>
            </div>

            <!-- Leaderboard -->
            <div class="bg-white dark:bg-gray-800 p-6 rounded-[2rem] shadow-lg border-b-4 border-yellow-500">
                <h4 class="font-black text-lg mb-4 text-yellow-600 dark:text-yellow-400 flex items-center gap-2"><i class="fas fa-award"></i> لوحة الشرف</h4>
                <div id="volLeaderboard" class="space-y-3 max-h-48 overflow-y-auto custom-scrollbar"></div>
            </div>

             <div class="bg-white dark:bg-gray-800 p-10 rounded-[3rem] shadow-xl text-right">
                 <h3 class="font-black text-2xl mb-6 text-gray-700 dark:text-gray-200">سجل النشاط والشهادات</h3>
                 <div class="overflow-x-auto">
                     <table class="w-full text-xs dark:text-gray-300">
                         <thead class="text-gray-400 border-b dark:border-gray-700"><tr><th class="pb-2">التاريخ</th><th class="pb-2 text-center">النشاط</th><th class="pb-2 text-center">التفاصيل</th><th class="pb-2 text-center">نقط</th><th class="pb-2 text-center">شهادة</th></tr></thead>
                         <tbody id="historyBody" class="font-black"></tbody>
                     </table>
                 </div>
            </div>

        </section>

        <!-- Admin Dashboard -->
        <section id="admin-dashboard" class="fade-in hidden space-y-8">
            <div class="bg-gray-900 text-white rounded-[2.5rem] p-8 shadow-2xl flex justify-between items-center relative overflow-hidden">
                <div class="relative z-10">
                    <h2 class="text-3xl font-black text-yellow-400 mb-1">غرفة العمليات المركزية</h2>
                    <p class="text-gray-400 text-sm">أهلاً بك، سيادة المدير <span id="adminNameSpan" class="text-white font-bold"></span></p>
                </div>
                <div class="flex gap-2 relative z-10">
                    <button onclick="app.generateFullSystemReport()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-3 rounded-xl font-bold shadow-lg text-xs flex items-center gap-2"><i class="fas fa-file-pdf"></i> تقرير النظام الشامل</button>
                    <button onclick="app.openAddNashmiModal()" class="bg-yellow-500 hover:bg-yellow-600 text-black px-4 py-3 rounded-xl font-bold shadow-lg text-xs flex items-center gap-2"><i class="fas fa-user-plus"></i> إضافة نشمي</button>
                </div>
                <div class="absolute inset-0 bg-jcd-blue/10"></div>
            </div>

             <!-- NEW: Pending Requests (Admin) -->
             <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                <!-- Check-in Requests -->
                <div class="bg-white dark:bg-gray-800 p-6 rounded-[2rem] shadow-lg border-l-8 border-yellow-500">
                    <h3 class="text-xl font-black mb-4 dark:text-white flex items-center"><i class="fas fa-user-clock ml-2 text-yellow-500"></i> طلبات بدء الدوام (Check-In)</h3>
                    <div id="pendingCheckinsList" class="space-y-2 max-h-48 overflow-y-auto custom-scrollbar text-xs">
                        <p class="text-gray-400 text-center">لا توجد طلبات معلقة</p>
                    </div>
                </div>

                <!-- Shift Registration Requests -->
                <div class="bg-white dark:bg-gray-800 p-6 rounded-[2rem] shadow-lg border-l-8 border-blue-500">
                    <h3 class="text-xl font-black mb-4 dark:text-white flex items-center"><i class="fas fa-calendar-plus ml-2 text-blue-500"></i> طلبات حجز المناوبات</h3>
                    <div id="pendingShiftsList" class="space-y-2 max-h-48 overflow-y-auto custom-scrollbar text-xs">
                        <p class="text-gray-400 text-center">لا توجد طلبات معلقة</p>
                    </div>
                </div>
             </div>

            <!-- Announcements Sender & Logo -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                <div class="bg-white dark:bg-gray-800 p-6 rounded-[2rem] shadow-lg border-l-8 border-yellow-500">
                    <h3 class="text-xl font-black mb-4 dark:text-white flex items-center"><i class="fas fa-bullhorn ml-2 text-yellow-500"></i> إرسال تعميم / رسالة آلية</h3>
                    <div class="flex gap-2">
                        <input type="text" id="adminAnnouncementText" placeholder="نص الرسالة أو التعميم..." class="flex-grow p-3 rounded-xl bg-gray-100 dark:bg-gray-700 dark:text-white text-xs">
                        <button onclick="app.sendAnnouncement()" class="bg-yellow-500 text-black px-6 py-2 rounded-xl text-xs font-bold hover:bg-yellow-600">إرسال للجميع</button>
                    </div>
                </div>

                <!-- Logo Changer -->
                <div class="bg-white dark:bg-gray-800 p-6 rounded-[2rem] shadow-lg border-l-8 border-purple-500">
                    <h3 class="text-xl font-black mb-4 dark:text-white flex items-center"><i class="fas fa-image ml-2 text-purple-500"></i> تغيير شعار الموقع</h3>
                    <div class="flex gap-2 items-center">
                         <input type="file" id="logoUploader" accept="image/*" class="text-xs dark:text-white w-2/3">
                         <button onclick="app.updateLogo()" class="bg-purple-600 text-white px-4 py-2 rounded-xl text-xs font-bold hover:bg-purple-700 w-1/3">تحديث الشعار</button>
                    </div>
                    <p class="text-[10px] text-gray-400 mt-2">سيتم تحديث الشعار لجميع المستخدمين فوراً.</p>
                </div>
            </div>

            <!-- Login Monitor -->
            <div class="bg-white dark:bg-gray-800 p-6 rounded-[2rem] shadow-lg border-l-8 border-indigo-500">
                <h3 class="text-xl font-black mb-4 dark:text-white flex items-center"><i class="fas fa-history ml-2 text-indigo-500"></i> سجل الدخول الحي</h3>
                <div id="loginLogsList" class="space-y-2 max-h-40 overflow-y-auto custom-scrollbar text-xs">
                    <p class="text-gray-400 text-center">جاري تحميل السجل...</p>
                </div>
            </div>

            <!-- Management Tools -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                <!-- Exceptional Shifts -->
                <div class="bg-white dark:bg-gray-800 p-6 rounded-[2rem] shadow-lg border-l-8 border-orange-500">
                    <h3 class="text-xl font-black mb-4 dark:text-white flex items-center"><i class="fas fa-calendar-check ml-2 text-orange-500"></i> إدارة الدوام الاستثنائي</h3>
                    <div class="flex gap-2">
                        <input type="date" id="exceptionDate" class="p-2 rounded bg-gray-100 dark:bg-gray-700 dark:text-white text-xs w-2/3">
                        <button onclick="app.addExceptionDate()" class="bg-orange-500 text-white px-4 rounded text-xs font-bold w-1/3">إضافة</button>
                    </div>
                    <div id="exceptionList" class="mt-3 space-y-1 text-xs text-gray-500 dark:text-gray-400 max-h-24 overflow-y-auto"></div>
                </div>

                <!-- Vehicle Status -->
                <div class="bg-white dark:bg-gray-800 p-6 rounded-[2rem] shadow-lg border-l-8 border-teal-500">
                    <h3 class="text-xl font-black mb-4 dark:text-white flex items-center"><i class="fas fa-truck ml-2 text-teal-500"></i> جاهزية الآليات</h3>
                    <div id="vehicleList" class="space-y-3 mb-4 max-h-40 overflow-y-auto custom-scrollbar"></div>
                    <div class="flex gap-2">
                        <input type="text" id="vehName" placeholder="رقم الآلية" class="p-2 rounded bg-gray-100 dark:bg-gray-700 dark:text-white text-xs w-1/3">
                        <select id="vehStatus" class="p-2 rounded bg-gray-100 dark:bg-gray-700 dark:text-white text-xs w-1/3"><option value="جاهزة">جاهزة</option><option value="صيانة">صيانة</option><option value="معطلة">معطلة</option></select>
                        <button onclick="app.addVehicleStatus()" class="bg-teal-500 text-white px-4 rounded text-xs font-bold">تحديث</button>
                    </div>
                </div>
                
                <!-- Training Mgmt -->
                <div class="bg-white dark:bg-gray-800 p-6 rounded-[2rem] shadow-lg border-l-8 border-purple-500">
                    <h3 class="text-xl font-black mb-4 dark:text-white flex items-center"><i class="fas fa-chalkboard-teacher ml-2 text-purple-500"></i> إدارة الدورات</h3>
                    <div class="flex gap-2 mb-4">
                        <input type="text" id="newCourseTitle" placeholder="اسم الدورة" class="flex-grow p-2 rounded bg-gray-100 dark:bg-gray-700 dark:text-white text-xs">
                        <button onclick="app.addCourse()" class="bg-purple-500 text-white px-4 rounded text-xs font-bold">طرح</button>
                    </div>
                    <div id="adminCoursesList" class="space-y-2 text-xs"></div>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                <div class="bg-white dark:bg-gray-800 p-5 rounded-2xl shadow-md border-r-4 border-green-500"><h4 class="text-xs text-gray-500 font-bold mb-1">الميدان الآن</h4><div class="text-2xl font-black text-green-600" id="rosterCount">0</div></div>
                <div class="bg-white dark:bg-gray-800 p-5 rounded-2xl shadow-md border-r-4 border-red-500"><h4 class="text-xs text-gray-500 font-bold mb-1">المتطوعين</h4><div class="text-2xl font-black text-red-600" id="totalUsersCount">0</div></div>
                <div class="bg-white dark:bg-gray-800 p-5 rounded-2xl shadow-md border-r-4 border-yellow-500"><h4 class="text-xs text-gray-500 font-bold mb-1">إنذارات نشطة</h4><div class="text-2xl font-black text-yellow-600" id="warningsCount">0</div></div>
                <div class="bg-white dark:bg-gray-800 p-5 rounded-2xl shadow-md border-r-4 border-blue-500 flex flex-col justify-center gap-2">
                    <button onclick="app.exportPDF('shifts')" class="bg-blue-50 text-blue-600 text-xs font-bold py-2 rounded hover:bg-blue-100">كشف المناوبات</button>
                    <button onclick="app.exportPDF('verified')" class="bg-green-50 text-green-600 text-xs font-bold py-2 rounded hover:bg-green-100">ساعات العمل</button>
                </div>
            </div>
            
            <div class="bg-white dark:bg-gray-800 p-6 rounded-[2rem] shadow-lg">
                <h3 class="font-black text-lg mb-4 dark:text-white">الاقتراحات والشكاوى الواردة</h3>
                <div id="adminSuggestionsList" class="space-y-2 max-h-60 overflow-y-auto custom-scrollbar text-xs"></div>
            </div>

            <div class="bg-white dark:bg-gray-800 rounded-[2rem] p-6 shadow-lg">
                <h3 class="font-black text-lg mb-4 dark:text-white border-b pb-2 dark:border-gray-700">سجل الدخول والمناوبات (Live)</h3>
                <div id="liveAttendanceList" class="space-y-2 max-h-60 overflow-y-auto custom-scrollbar"></div>
            </div>

            <div class="bg-white dark:bg-gray-800 rounded-[2rem] p-6 shadow-lg">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="font-black text-lg dark:text-white">إدارة النشامى</h3>
                    <input type="text" oninput="app.filterUsers(this.value)" placeholder="بحث..." class="bg-gray-100 dark:bg-gray-700 dark:text-white text-xs p-2 rounded-lg outline-none w-40">
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-right text-xs dark:text-gray-300">
                        <thead class="bg-gray-50 dark:bg-gray-700 text-gray-500 dark:text-gray-400 font-bold">
                            <tr><th class="p-3 rounded-r-lg">الاسم</th><th class="p-3">المعرف</th><th class="p-3">الرصيد</th><th class="p-3 rounded-l-lg">إجراء</th></tr>
                        </thead>
                        <tbody id="fullUsersTable"></tbody>
                    </table>
                </div>
            </div>
        </section>

        <!-- Registration Section -->
        <section id="registration" class="fade-in hidden max-w-2xl mx-auto py-10 text-right">
            <div class="bg-white dark:bg-gray-800 rounded-[2.5rem] shadow-2xl p-10 border-t-8 border-green-500">
                <h2 class="text-3xl font-black text-center mb-8 text-green-600 dark:text-green-400">طلب انضمام للفريق</h2>
                <form onsubmit="app.handleRegistration(event)" class="space-y-4">
                    <input type="text" id="regName" placeholder="الاسم الرباعي" class="w-full p-4 bg-gray-50 dark:bg-gray-700 dark:text-white rounded-xl outline-none border focus:border-green-500 transition" required>
                    <input type="text" id="regId" placeholder="الرقم الوطني" class="w-full p-4 bg-gray-50 dark:bg-gray-700 dark:text-white rounded-xl outline-none border focus:border-green-500 transition" required>
                    <input type="password" id="regPass" placeholder="كلمة المرور" class="w-full p-4 bg-gray-50 dark:bg-gray-700 dark:text-white rounded-xl outline-none border focus:border-green-500 transition" required>
                    <button type="submit" class="w-full bg-green-600 hover:bg-green-700 text-white font-black py-4 rounded-xl shadow-lg transition">إرسال الطلب</button>
                </form>
            </div>
        </section>

    </main>

    <!-- Chat Widget -->
    <div id="chatWidget" class="fixed bottom-6 right-6 z-50 hidden">
        <button onclick="app.toggleChat()" class="bg-jcd-blue text-white w-14 h-14 rounded-full shadow-2xl flex items-center justify-center text-2xl hover:scale-110 transition relative"><i class="fas fa-comments"></i></button>
        <div id="chatWindow" class="hidden absolute bottom-16 right-0 w-80 bg-white dark:bg-gray-800 rounded-2xl shadow-2xl border border-gray-200 dark:border-gray-700 flex flex-col h-96 overflow-hidden">
            <div class="bg-jcd-blue p-3 text-white font-bold text-sm flex justify-between"><span>غرفة العمليات</span><button onclick="app.toggleChat()"><i class="fas fa-times"></i></button></div>
            <div id="chatMessages" class="flex-grow p-3 overflow-y-auto bg-gray-50 dark:bg-gray-900 space-y-2 text-xs"></div>
            <div class="p-2 border-t dark:border-gray-700 flex gap-2"><input type="text" id="chatInput" class="flex-grow p-2 rounded bg-gray-100 dark:bg-gray-700 dark:text-white text-xs outline-none" placeholder="رسالة..."><button onclick="app.sendChatMessage()" class="text-blue-600"><i class="fas fa-paper-plane"></i></button></div>
        </div>
    </div>

    <!-- Notifications Modal -->
    <div id="notificationsModal" class="hidden fixed inset-0 z-[300] bg-black/50 backdrop-blur-sm flex items-start justify-end p-4">
        <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-2xl w-80 p-4 mt-16 animate-float">
            <div class="flex justify-between items-center mb-4 border-b pb-2 dark:border-gray-700">
                 <h3 class="font-black text-sm dark:text-white">الإشعارات</h3>
                 <button onclick="document.getElementById('notificationsModal').classList.add('hidden')" class="text-gray-400 hover:text-red-500"><i class="fas fa-times"></i></button>
            </div>
            <div id="notifList" class="space-y-2 max-h-60 overflow-y-auto text-xs"></div>
        </div>
    </div>

    <!-- Suggestions Modal -->
    <div id="suggestionsModal" class="hidden fixed inset-0 z-[250] bg-black/80 backdrop-blur-sm flex items-center justify-center fade-in p-4">
        <div class="bg-white dark:bg-gray-800 rounded-[2rem] shadow-2xl w-full max-w-md p-8 relative border-t-8 border-yellow-500">
            <h3 class="text-xl font-black mb-4 dark:text-white">صندوق الاقتراحات والشكاوى</h3>
            <textarea id="suggestionText" class="w-full p-4 bg-gray-50 dark:bg-gray-700 dark:text-white rounded-xl text-sm h-32 resize-none outline-none border focus:border-yellow-500" placeholder="اكتب مقترحك أو شكواك هنا بكل سرية..."></textarea>
            <div class="flex gap-2 mt-4">
                <button onclick="app.submitSuggestion()" class="flex-grow bg-yellow-500 hover:bg-yellow-600 text-black font-black py-3 rounded-xl text-sm transition">إرسال</button>
                <button onclick="document.getElementById('suggestionsModal').classList.add('hidden')" class="px-6 py-3 rounded-xl font-bold text-gray-500 hover:bg-gray-100 dark:hover:bg-gray-700 transition text-sm">إلغاء</button>
            </div>
        </div>
    </div>

    <!-- Add Nashmi Modal -->
    <div id="addNashmiModal" class="hidden fixed inset-0 z-[250] bg-black/80 backdrop-blur-sm flex items-center justify-center fade-in p-4">
        <div class="bg-white dark:bg-gray-800 rounded-[2rem] shadow-2xl w-full max-w-md p-8 relative border-t-8 border-blue-500">
            <h3 class="text-xl font-black mb-4 dark:text-white">إضافة نشمي جديد</h3>
            <div class="space-y-3">
                <input type="text" id="newVolName" placeholder="الاسم الرباعي" class="w-full p-3 bg-gray-50 dark:bg-gray-700 dark:text-white rounded-xl text-sm outline-none">
                <input type="text" id="newVolId" placeholder="المعرف (ID)" class="w-full p-3 bg-gray-50 dark:bg-gray-700 dark:text-white rounded-xl text-sm outline-none">
                <input type="text" id="newVolPass" placeholder="كلمة المرور" class="w-full p-3 bg-gray-50 dark:bg-gray-700 dark:text-white rounded-xl text-sm outline-none">
                <button onclick="app.adminAddUser()" class="w-full bg-blue-600 text-white font-black py-3 rounded-xl text-sm hover:bg-blue-700">إضافة</button>
                <button onclick="document.getElementById('addNashmiModal').classList.add('hidden')" class="w-full text-gray-500 text-xs mt-2">إلغاء</button>
            </div>
        </div>
    </div>

    <!-- Admin Tools Modal -->
    <div id="adminToolsModal" class="hidden fixed inset-0 z-[250] bg-black/80 backdrop-blur-sm flex items-center justify-center fade-in p-4">
        <div class="bg-white dark:bg-gray-800 rounded-[2rem] shadow-2xl w-full max-w-md p-8 relative border-t-8 border-jcd-blue max-h-[90vh] overflow-y-auto custom-scrollbar">
            <h3 class="text-2xl font-black text-jcd-dark dark:text-white mb-2">أدوات الإدارة المتقدمة</h3>
            <p id="toolUserName" class="text-sm text-jcd-blue dark:text-blue-300 font-bold mb-6"></p>
            <input type="hidden" id="toolUserId">
            
            <!-- Edit User Details -->
            <div class="mb-6 border-b pb-6 dark:border-gray-700 bg-gray-50 dark:bg-gray-700 p-4 rounded-xl">
                <h4 class="font-black text-sm mb-4 text-blue-600 dark:text-blue-300 flex items-center"><i class="fas fa-user-edit ml-2"></i> تعديل بيانات المتطوع</h4>
                <div class="space-y-3">
                    <input type="text" id="editNameAdmin" placeholder="تعديل الاسم" class="w-full p-2 rounded-lg text-xs outline-none border">
                    <input type="text" id="editPassAdmin" placeholder="تعديل كلمة المرور" class="w-full p-2 rounded-lg text-xs outline-none border">
                    <input type="text" id="editIdAdmin" placeholder="تعديل المعرف (ID)" class="w-full p-2 rounded-lg text-xs outline-none border bg-red-50 text-red-800 border-red-200">
                    <p class="text-[10px] text-red-500 font-bold">تنبيه: تغيير المعرف سينقل كافة البيانات للمعرف الجديد.</p>
                    <button onclick="app.saveAdminUserEdit()" class="w-full bg-blue-600 text-white font-bold py-2 rounded-lg text-xs hover:bg-blue-700">حفظ التعديلات</button>
                </div>
            </div>

            <div class="mb-6 border-b pb-6 dark:border-gray-700">
                 <h4 class="font-black text-sm mb-2 text-green-600 flex items-center"><i class="fas fa-plus-circle ml-2"></i> منح نقاط/ساعات (يدوي)</h4>
                 <div class="flex gap-2">
                     <input type="number" id="manualPoints" placeholder="النقاط" class="w-1/2 p-2 bg-gray-50 dark:bg-gray-700 dark:text-white rounded-lg text-xs">
                     <input type="number" id="manualHours" placeholder="الساعات" class="w-1/2 p-2 bg-gray-50 dark:bg-gray-700 dark:text-white rounded-lg text-xs">
                 </div>
                 <button onclick="app.grantManualPointsHours()" class="w-full bg-green-600 text-white font-bold py-2 rounded-lg text-xs mt-2 hover:bg-green-700">منح وتوثيق</button>
            </div>

            <!-- Warning Tab -->
            <div class="mb-6 border-b pb-6 dark:border-gray-700">
                <h4 class="font-black text-sm mb-2 text-red-600 flex items-center"><i class="fas fa-exclamation-triangle ml-2"></i> إصدار إنذار</h4>
                <input type="text" id="warningReason" placeholder="سبب الإنذار (غياب، تقصير..)" class="w-full p-2 bg-gray-50 dark:bg-gray-700 dark:text-white rounded-lg text-xs mb-2 outline-none">
                <button onclick="app.issueManualWarning()" class="w-full bg-red-600 text-white font-bold py-2 rounded-lg text-xs hover:bg-red-700">إصدار إنذار</button>
            </div>

            <!-- Ban Control -->
            <div class="mb-6 border-b pb-6 dark:border-gray-700">
                 <h4 class="font-black text-sm mb-2 text-red-800 flex items-center"><i class="fas fa-ban ml-2"></i> التحكم بالحظر</h4>
                 <div class="flex gap-2">
                     <button onclick="app.adminAction(document.getElementById('toolUserId').value, 'ban')" class="flex-grow bg-red-800 text-white font-bold py-2 rounded-lg text-xs">حظر</button>
                     <button onclick="app.adminAction(document.getElementById('toolUserId').value, 'unban')" class="flex-grow bg-gray-500 text-white font-bold py-2 rounded-lg text-xs">رفع الحظر</button>
                 </div>
            </div>
            
            <button onclick="document.getElementById('adminToolsModal').classList.add('hidden')" class="w-full bg-gray-200 dark:bg-gray-700 text-gray-600 dark:text-gray-300 py-2 rounded-lg font-bold text-xs">إغلاق</button>
        </div>
    </div>

    <!-- Profile Edit Modal (For Volunteer) -->
    <div id="profileEditModal" class="hidden fixed inset-0 z-[250] bg-black/80 backdrop-blur-sm flex items-center justify-center fade-in p-4">
        <div class="bg-white dark:bg-gray-800 rounded-[2rem] shadow-2xl w-full max-w-md p-8 relative border-t-8 border-jcd-blue">
            <h3 class="text-xl font-black mb-4 dark:text-white">تعديل بياناتي</h3>
            <div class="space-y-4">
                <div>
                    <label class="text-xs font-bold text-gray-500 block mb-1">تغيير الصورة الشخصية</label>
                    <input type="file" id="avatarUpload" accept="image/*" class="w-full text-xs p-2 bg-gray-100 dark:bg-gray-700 rounded-lg">
                </div>
                <div>
                    <label class="text-xs font-bold text-gray-500 block mb-1">تغيير كلمة المرور</label>
                    <input type="password" id="newPassVol" placeholder="كلمة المرور الجديدة" class="w-full p-3 bg-gray-50 dark:bg-gray-700 dark:text-white rounded-xl text-xs">
                </div>
                <div>
                    <label class="text-xs font-bold text-gray-500 block mb-1">نبذة عني</label>
                    <textarea id="newBioVol" class="w-full p-3 bg-gray-50 dark:bg-gray-700 dark:text-white rounded-xl text-xs h-20 resize-none"></textarea>
                </div>
                <button onclick="app.updateProfile()" class="w-full bg-jcd-blue text-white py-3 rounded-xl font-bold text-xs">حفظ التعديلات</button>
                <button onclick="document.getElementById('profileEditModal').classList.add('hidden')" class="w-full text-gray-400 text-xs mt-2">إلغاء</button>
            </div>
        </div>
    </div>

    <!-- ID Card & Profile Modals -->
    <div id="idCardModal" class="hidden fixed inset-0 z-50 bg-black/90 flex items-center justify-center p-4">
        <div class="bg-white dark:bg-gray-800 rounded-2xl w-full max-w-sm overflow-hidden relative">
            <button onclick="document.getElementById('idCardModal').classList.add('hidden')" class="absolute top-2 left-2 z-20 text-white bg-black/50 rounded-full w-8 h-8"><i class="fas fa-times"></i></button>
            <div id="digitalIDCard" class="bg-gradient-to-b from-jcd-blue to-black p-6 text-center text-white relative h-[450px] flex flex-col items-center">
                <img src="https://upload.wikimedia.org/wikipedia/commons/e/e0/Jordan_Civil_Defence_Logo.png" class="h-20 mb-4 drop-shadow-md">
                <h2 class="text-2xl font-black mb-1">الدفاع المدني</h2>
                <p class="text-xs text-yellow-400 mb-6 tracking-widest uppercase">بطاقة متطوع رسمية</p>
                <div class="relative w-32 h-32 mb-4">
                    <img id="idCardAvatar" src="" class="w-full h-full rounded-xl object-cover border-2 border-yellow-400 bg-gray-800">
                </div>
                <h3 id="idCardName" class="text-xl font-bold"></h3>
                <p id="idCardNum" class="font-mono text-sm opacity-70 mt-1"></p>
                <p id="idCardRank" class="mt-4 px-4 py-1 bg-white/20 rounded-full text-xs font-bold"></p>
                <div class="mt-auto text-[10px] opacity-50 w-full border-t border-white/10 pt-2">مديرية المفرق - 2026</div>
            </div>
            <div class="p-4 flex justify-center"><button onclick="app.printID()" class="bg-blue-600 text-white px-6 py-2 rounded-lg text-sm font-bold">تحميل البطاقة</button></div>
        </div>
    </div>

    <div id="fullProfileModal" class="hidden fixed inset-0 z-[200] bg-black/90 flex items-center justify-center p-4">
        <div class="bg-white dark:bg-gray-800 w-full max-w-3xl rounded-3xl p-6 relative max-h-[90vh] overflow-y-auto">
            <button onclick="document.getElementById('fullProfileModal').classList.add('hidden')" class="absolute top-4 left-4 text-gray-400"><i class="fas fa-times text-xl"></i></button>
            <h3 class="text-2xl font-black mb-6 dark:text-white">الملف الشخصي</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <div class="flex items-center gap-4 mb-4">
                        <img id="fpAvatar" class="w-20 h-20 rounded-full border-2 border-jcd-blue object-cover">
                        <div>
                            <h4 id="fpName" class="font-bold text-lg dark:text-white"></h4>
                            <span id="fpRank" class="text-sm text-gray-500"></span>
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-2 mb-4">
                        <div class="bg-blue-50 dark:bg-gray-700 p-3 rounded-xl text-center"><span class="block font-black text-blue-600 dark:text-blue-400" id="fpPoints">0</span><span class="text-xs dark:text-white">نقطة</span></div>
                        <div class="bg-green-50 dark:bg-gray-700 p-3 rounded-xl text-center"><span class="block font-black text-green-600 dark:text-green-400" id="fpHours">0</span><span class="text-xs dark:text-white">ساعة</span></div>
                    </div>
                    <button onclick="app.printFullCertificate()" class="w-full bg-jcd-gold text-black font-bold py-3 rounded-xl mb-4 shadow-lg hover:scale-105 transition"><i class="fas fa-certificate ml-2"></i> تحميل شهادة الخبرة الشاملة</button>
                    <div class="bg-gray-50 dark:bg-gray-700 p-3 rounded-xl">
                        <h5 class="font-bold text-xs mb-2 dark:text-white">الأوسمة</h5>
                        <div id="fpBadges" class="flex flex-wrap gap-2"></div>
                    </div>
                </div>
                <div class="space-y-4">
                    <div class="bg-gray-50 dark:bg-gray-700 p-3 rounded-xl">
                        <h5 class="font-bold text-xs mb-2 dark:text-white">الدورات</h5>
                        <ul id="fpCourses" class="text-xs space-y-1 dark:text-gray-300"></ul>
                    </div>
                    <div class="bg-gray-50 dark:bg-gray-700 p-3 rounded-xl">
                        <h5 class="font-bold text-xs mb-2 dark:text-white">النشاط الأخير</h5>
                        <div id="fpHistory" class="text-xs space-y-1 max-h-32 overflow-y-auto dark:text-gray-300"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Hidden Certificate Template -->
    <div id="certificateTemplate" class="hidden p-10 bg-white text-black font-serif text-center border-[20px] border-double border-jcd-blue w-[800px] mx-auto">
        <img src="https://upload.wikimedia.org/wikipedia/commons/e/e0/Jordan_Civil_Defence_Logo.png" class="h-32 mx-auto mb-6">
        <h1 class="text-4xl font-black mb-2 text-jcd-blue">شهادة شكر وتقدير</h1>
        <p class="text-xl mb-8">مديرية دفاع مدني المفرق</p>
        <p class="text-lg mb-4">يسرنا أن نشهد بأن المتطوع/ـة</p>
        <h2 id="certName" class="text-3xl font-black mb-6 text-jcd-red underline underline-offset-8"></h2>
        <p class="text-lg mb-6 leading-loose">قد أتم/ت واجبه/ـا الوطني بكل تفانٍ وإخلاص، <span id="certDetails"></span>.</p>
        <p class="text-lg mb-12">سائلين المولى عز وجل أن يوفقه/ـا لخدمة الوطن في ظل القيادة الهاشمية الحكيمة.</p>
        <div class="flex justify-between px-20 mt-12">
            <div class="text-center"><p class="font-bold mb-4">التاريخ</p><p id="certDate"></p></div>
            <div class="text-center"><p class="font-bold mb-4">مدير الدفاع المدني</p><img src="https://via.placeholder.com/100x50?text=Signature" class="h-12 opacity-50"></div>
        </div>
    </div>

    <!-- Hidden System Report Template -->
    <div id="systemReportTemplate" class="hidden p-8 bg-white text-black font-sans">
        <h1 class="text-2xl font-bold mb-4 text-center">تقرير النظام الشامل - بوابة نشامى المفرق</h1>
        <p class="text-center mb-6 text-sm" id="sysReportDate"></p>
        <div class="grid grid-cols-2 gap-4 mb-8">
             <div class="border p-4"><h3>إحصائيات</h3><p id="repUserCount"></p><p id="repActiveCount"></p></div>
             <div class="border p-4"><h3>الملاحظات</h3><ul id="repSuggestions" class="text-xs list-disc pr-4"></ul></div>
        </div>
        <h3 class="font-bold mb-2">سجل الدخول الأخير</h3>
        <table class="w-full text-xs border mb-8">
            <thead class="bg-gray-100"><tr><th class="p-2 border">الاسم</th><th class="p-2 border">التوقيت</th></tr></thead>
            <tbody id="repLoginLogs"></tbody>
        </table>
    </div>

    <!-- Logic Engine -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, updateDoc, onSnapshot, addDoc, deleteDoc, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // -----------------------------------------------------------------------------------------
        // --- منطقة الإعدادات (تم التحديث بناءً على الصورة المرفقة) ---
        // -----------------------------------------------------------------------------------------
        const YOUR_FIREBASE_CONFIG = {
            apiKey: "AIzaSyCzbJ_BCreCrOgkDq_zCdJ103FCDcguoXA",
            authDomain: "civil-defense-mafraq-b7b9d.firebaseapp.com",
            projectId: "civil-defense-mafraq-b7b9d",
            storageBucket: "civil-defense-mafraq-b7b9d.firebasestorage.app",
            messagingSenderId: "14265166108",
            appId: "1:14265166108:web:2f1ac0d4c89b2fe9cff2d9"
        };
        
        const YOUR_GEMINI_KEY = "AIzaSyBEMwEU2XqjyCfqKvlRrRRoAaqxTIXRSpQ"; // (اختياري) ضع مفتاح Gemini API هنا إذا أردت تفعيل الذكاء الاصطناعي
        // -----------------------------------------------------------------------------------------

        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : YOUR_FIREBASE_CONFIG;
        const apiKey = typeof __app_id !== 'undefined' ? "" : YOUR_GEMINI_KEY; 
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'mafraq-diamond-v33-platinum-release'; 

        const fireApp = initializeApp(firebaseConfig);
        const auth = getAuth(fireApp);
        const db = getFirestore(fireApp);

        // --- FIXED STATIC USERS (Source of Truth) ---
        const STATIC_USERS = [
            { id: '101', name: 'معاذ الخوالدة', pass: '2026', role: 'admin', isOfficial: true },
            { id: '102', name: 'محمد المساعيد', pass: '2026', role: 'admin', isOfficial: true },
            { id: '1', name: 'مالك عليمات', pass: '4821', role: 'volunteer' },
            { id: '2', name: 'هدى', pass: '9253', role: 'volunteer' },
            { id: '3', name: 'معاذ الخوالدة', pass: '7741', role: 'volunteer' },
            { id: '4', name: 'حسام الحسبان', pass: '3320', role: 'volunteer' },
            { id: '5', name: 'إبراهيم سعود', pass: '5198', role: 'volunteer' },
            { id: '6', name: 'خولة نضال', pass: '6024', role: 'volunteer' },
            { id: '7', name: 'رسول الخزاعلة', pass: '8812', role: 'volunteer' },
            { id: '8', name: 'سلوى الصقور', pass: '1472', role: 'volunteer' },
            { id: '9', name: 'شرف الحراحشة', pass: '9630', role: 'volunteer' },
            { id: '10', name: 'عبد الرحمن يونس', pass: '2580', role: 'volunteer' },
            { id: '11', name: 'عمر ياسين', pass: '3691', role: 'volunteer' },
            { id: '12', name: 'امين المصري', pass: '7410', role: 'volunteer' },
            { id: '13', name: 'فرحان الخوالدة', pass: '8520', role: 'volunteer' },
            { id: '14', name: 'حور العرقان', pass: '9514', role: 'volunteer' },
            { id: '15', name: 'مدين الشرفات', pass: '7532', role: 'volunteer' },
            { id: '16', name: 'سند عليمات', pass: '1598', role: 'volunteer' },
            { id: '17', name: 'شهم الحسبان', pass: '3574', role: 'volunteer' },
            { id: '18', name: 'سجود عليمات', pass: '4568', role: 'volunteer' },
            { id: '19', name: 'يوسف دعجة', pass: '1238', role: 'volunteer' },
            { id: '20', name: 'بلقيس الكناني', pass: '9874', role: 'volunteer' },
            { id: '21', name: 'عهد الحسبان', pass: '6541', role: 'volunteer' },
            { id: '22', name: 'أرم', pass: '3214', role: 'volunteer' },
            { id: '23', name: 'اريج النعيمات', pass: '7890', role: 'volunteer' },
            { id: '24', name: 'عزيزة السقال', pass: '4125', role: 'volunteer' },
            { id: '25', name: 'باسل', pass: '6325', role: 'volunteer' },
            { id: '26', name: 'في', pass: '9654', role: 'volunteer' },
            { id: '27', name: 'حمدان عليمات', pass: '8521', role: 'volunteer' },
            { id: '28', name: 'ختام ابو قديري', pass: '7412', role: 'volunteer' },
            { id: '29', name: 'لارا العجلوني', pass: '3698', role: 'volunteer' },
            { id: '30', name: 'ميار الهواري', pass: '2587', role: 'volunteer' },
            { id: '31', name: 'ريتاج', pass: '1478', role: 'volunteer' },
            { id: '32', name: 'رويدة', pass: '9632', role: 'volunteer' },
            { id: '33', name: 'ربى', pass: '1596', role: 'volunteer' },
            { id: '34', name: 'سوار', pass: '7539', role: 'volunteer' },
            { id: '35', name: 'سندس عليمات', pass: '8523', role: 'volunteer' },
            { id: '38', name: 'رند العناسوة', pass: '3091', role: 'volunteer' }
        ];

        window.app = {
            data: { users: [], chats: [], currentUser: null, vehicles: [], courses: [], logs: [], suggestions: [], settings: { exceptions: [], announcements: [], logo: null } },
            map: null,

            async init() {
                if(localStorage.getItem('jcd_theme') === 'dark') document.documentElement.classList.add('dark');
                try {
                    if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                        await signInWithCustomToken(auth, __initial_auth_token);
                    } else {
                        await signInAnonymously(auth);
                    }
                } catch (e) { console.error("Auth:", e); }

                onAuthStateChanged(auth, (user) => { if (user) app.setupListeners(); });
            },

            setupListeners() {
                const cols = ['users', 'chats', 'vehicles', 'courses', 'logs', 'suggestions', 'settings'];
                cols.forEach(c => {
                    onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', c), (snap) => {
                        app.data[c] = [];
                        snap.forEach(d => app.data[c].push({ ...d.data(), _id: d.id }));
                        if(c === 'users') { 
                            app.syncStaticUsers(); // Check and install static users if missing
                            app.checkSession(); app.renderUI(); 
                        }
                        if(c === 'settings') {
                            const mainSettings = app.data.settings.find(s => s.id === 'main');
                            if(mainSettings) {
                                if(mainSettings.exceptions) app.data.settings.exceptions = mainSettings.exceptions;
                                if(mainSettings.announcement) app.showAnnouncement(mainSettings.announcement);
                                if(mainSettings.logo) {
                                    document.getElementById('navLogo').src = mainSettings.logo;
                                    document.getElementById('heroLogo').src = mainSettings.logo;
                                }
                            }
                        }
                        if(c === 'chats') app.renderChat();
                    }, (error) => console.log('Snapshot error:', error));
                });
            },

            // Updated Sync Function
            async syncStaticUsers() {
                for (const u of STATIC_USERS) {
                    const existing = app.data.users.find(x => x.id === u.id);
                    if (!existing) {
                        // Create missing user
                        try {
                            await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users', u.id), {
                                id: u.id, name: u.name, pass: u.pass,
                                role: u.role || 'volunteer', status: 'active', isOfficial: u.isOfficial || false,
                                stats: { points: 0, hours: 0 }, history: [], notifications: [], 
                                lastLogin: new Date().toISOString(), customBadges: [], warnings: [], shifts: []
                            });
                            console.log(`Synced user: ${u.name}`);
                        } catch(e) { console.error("Sync error:", e); }
                    }
                }
                // Ensure Settings Doc Exists
                await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'settings', 'main'), { exceptions: [], announcement: "", logo: null }, {merge: true});
            },

            getAvailableShiftDates() {
                const dates = [];
                const today = new Date();
                const exceptions = app.data.settings.exceptions || [];

                for(let i=1; i<=14; i++) {
                    const d = new Date(today);
                    d.setDate(today.getDate() + i);
                    const dayName = d.toLocaleDateString('en-US', {weekday: 'long'});
                    const dateStr = d.toLocaleDateString('en-CA'); 
                    
                    if (dayName === 'Monday' || dayName === 'Tuesday') {
                        dates.push({ date: dateStr, day: d.toLocaleDateString('ar-JO', {weekday:'long'}), type: 'regular' });
                    }
                }
                
                exceptions.forEach(ex => {
                      const exDate = new Date(ex);
                      if (exDate > today) {
                        dates.push({ date: ex, day: exDate.toLocaleDateString('ar-JO', {weekday:'long'}), type: 'exceptional' });
                      }
                });
                return dates.sort((a,b) => new Date(a.date) - new Date(b.date));
            },

            // --- Updated Shift Registration Flow (Approval Required) ---
            async registerShift(dateStr) {
                 const u = app.data.currentUser;
                 if (u.shifts && u.shifts.some(s => s.date === dateStr)) return alert("الطلب مرسل مسبقاً");
                 
                 // Changed status to 'pending'
                 const newShift = { date: dateStr, status: 'pending' }; 
                 await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users', u.id), { shifts: [...(u.shifts || []), newShift] });
                 alert("تم إرسال طلب حجز المناوبة للإدارة للموافقة.");
                 app.renderVolunteerUI();
            },

            async addExceptionDate() {
                const date = document.getElementById('exceptionDate').value;
                if(!date) return;
                const current = app.data.settings.exceptions || [];
                await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'settings', 'main'), { exceptions: [...current, date] }, {merge:true});
                alert("تم إضافة الموعد الاستثنائي");
                const list = document.getElementById('exceptionList');
                list.innerHTML += `<div>${date}</div>`;
            },

            async grantManualPointsHours() {
                const uid = document.getElementById('toolUserId').value;
                const pts = parseInt(document.getElementById('manualPoints').value) || 0;
                const hrs = parseFloat(document.getElementById('manualHours').value) || 0;
                
                const u = app.data.users.find(x => x.id === uid);
                if(!u) return;
                await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users', uid), { 
                    "stats.points": (u.stats?.points || 0) + pts,
                    "stats.hours": (u.stats?.hours || 0) + hrs,
                    history: [...(u.history || []), { date: new Date().toLocaleDateString('ar-JO'), start: 'منح يدوي', end: '-', hours: hrs, points: pts }]
                });
                app.notifyUser(uid, `تم منحك ${pts} نقطة و ${hrs} ساعة إضافية من الإدارة`);
                alert("تم التحديث");
                app.openAdminTools(uid);
            },

            async adminAction(uid, action) {
                 if (action === 'ban') {
                     await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users', uid), { status: 'banned', banReason: 'حظر يدوي من الإدارة' });
                     alert("تم حظر المستخدم");
                 } else if (action === 'unban') {
                     await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users', uid), { status: 'active', banReason: null });
                     alert("تم رفع الحظر");
                 }
            },

            async issueManualWarning() {
                const uid = document.getElementById('toolUserId').value;
                const reason = document.getElementById('warningReason').value;
                if(!reason) return;
                const u = app.data.users.find(x => x.id === uid);
                await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users', uid), {
                    warnings: [...(u.warnings || []), {date: new Date().toLocaleDateString(), reason}]
                });
                app.notifyUser(uid, `تنبيه إداري: ${reason}`);
                alert('تم إصدار الإنذار');
            },

            openProfileEdit() {
                const u = app.data.currentUser;
                document.getElementById('newPassVol').value = u.pass;
                document.getElementById('newBioVol').value = u.bio || "";
                document.getElementById('profileEditModal').classList.remove('hidden');
            },

            async updateProfile() {
                const u = app.data.currentUser;
                const pass = document.getElementById('newPassVol').value;
                const bio = document.getElementById('newBioVol').value;
                const fileInput = document.getElementById('avatarUpload');
                
                let avatar = u.avatar;
                if (fileInput.files.length > 0) {
                    const file = fileInput.files[0];
                    avatar = await new Promise(resolve => {
                        const reader = new FileReader();
                        reader.onload = (e) => resolve(e.target.result);
                        reader.readAsDataURL(file);
                    });
                }

                await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users', u.id), { pass, bio, avatar });
                alert("تم تحديث الملف الشخصي");
                document.getElementById('profileEditModal').classList.add('hidden');
            },

            async checkSession() {
                const uid = localStorage.getItem('jcd_uid_v33');
                if (uid) {
                    const u = app.data.users.find(x => x.id === uid);
                    if (u) { app.data.currentUser = u; app.showDashboard(u); }
                }
            },

            showLogin(type) { app.showSection('login'); app.switchLoginTab(type); },
            switchLoginTab(type) {
                const volBtn = document.getElementById('tab-volunteer');
                const adminBtn = document.getElementById('tab-admin');
                const title = document.getElementById('loginTitle');
                volBtn.className = type === 'volunteer' ? 'w-1/2 py-3 rounded-xl text-sm font-black transition-all bg-white dark:bg-gray-600 shadow-sm text-jcd-blue dark:text-white' : 'w-1/2 py-3 rounded-xl text-sm font-black transition-all text-gray-500 hover:text-jcd-blue';
                adminBtn.className = type === 'admin' ? 'w-1/2 py-3 rounded-xl text-sm font-black transition-all bg-white dark:bg-gray-600 shadow-sm text-jcd-blue dark:text-white' : 'w-1/2 py-3 rounded-xl text-sm font-black transition-all text-gray-500 hover:text-jcd-blue';
                title.innerText = type === 'admin' ? 'دخول قيادة العمليات' : 'تسجيل دخول النشامى';
            },

            async handleLogin(e) {
                e.preventDefault();
                const id = document.getElementById('username').value.trim();
                const pass = document.getElementById('password').value.trim();
                
                // Fallback check against static users if not yet synced
                let user = app.data.users.find(u => u.id === id);
                if (!user) {
                      const staticUser = STATIC_USERS.find(u => u.id === id);
                      if (staticUser && staticUser.pass === pass) {
                          try {
                              await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users', id), {
                                 ...staticUser, role: staticUser.role || 'volunteer', status: 'active', stats: {points:0, hours:0}, lastLogin: new Date().toISOString()
                              });
                              user = staticUser; 
                          } catch(e) { alert("خطأ في الاتصال بالقاعدة"); return; }
                      }
                }
                if (!user) return alert("المستخدم غير موجود.");
                if (user.pass !== pass) return alert("كلمة المرور غير صحيحة");
                if (user.status === 'banned') return alert("الحساب محظور: " + (user.banReason || "مخالفة الأنظمة"));
                
                await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users', user.id), { lastLogin: new Date().toISOString() });
                
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'logs'), {
                    text: `${user.name} سجل دخول`,
                    type: 'login',
                    time: Date.now()
                });

                app.data.currentUser = user;
                localStorage.setItem('jcd_uid_v33', user.id);
                app.showDashboard(user);
                if(user.role === 'volunteer') app.generateDailyMessage(user.name);
            },

            logout() {
                app.data.currentUser = null;
                localStorage.removeItem('jcd_uid_v33');
                location.reload();
            },

            showDashboard(user) {
                document.getElementById('guestLinks').classList.add('hidden');
                document.getElementById('userMenu').classList.remove('hidden');
                document.getElementById('userNameDisplay').innerText = user.name;
                
                // Notifications Check
                const unread = (user.notifications || []).filter(n => !n.read).length;
                const badge = document.getElementById('notifBadge');
                if (unread > 0) {
                    badge.innerText = unread;
                    badge.classList.remove('hidden');
                } else {
                    badge.classList.add('hidden');
                }

                if (user.role === 'admin') { app.showSection('admin-dashboard'); app.renderAdminDashboard(); } 
                else { app.showSection('volunteer-dashboard'); app.renderVolunteerUI(); document.getElementById('chatWidget').classList.remove('hidden'); setTimeout(() => app.initMap(), 1000); }
            },

            showSection(id) {
                ['home', 'nashama-section', 'login', 'volunteer-dashboard', 'admin-dashboard', 'registration'].forEach(s => {
                    document.getElementById(s).classList.add('hidden');
                });
                document.getElementById(id).classList.remove('hidden');
                if(id === 'nashama-section') app.renderNashamaSection();
            },

            renderUI() {
                app.renderNashamaSection();
                if (app.data.currentUser) {
                    const freshUser = app.data.users.find(u => u.id === app.data.currentUser.id);
                    if(freshUser) app.data.currentUser = freshUser;
                    
                    if (app.data.currentUser.role === 'admin') app.renderAdminDashboard();
                    else app.renderVolunteerUI();
                }
            },

            renderNashamaSection() {
                const grid = document.getElementById('nashamaGrid');
                if(!grid) return;
                const sorted = app.data.users.filter(u => u.role !== 'admin' && u.status === 'active')
                    .sort((a,b) => (b.isOfficial ? 1 : 0) - (a.isOfficial ? 1 : 0) || (b.stats?.points || 0) - (a.stats?.points || 0));

                grid.innerHTML = sorted.map(u => {
                    const isLeader = u.isOfficial;
                    const rank = app.getRankInfo(u.stats?.hours || 0);
                    const cardStyle = isLeader ? 'official-card transform scale-105 shadow-2xl' : 'bg-white dark:bg-gray-800 shadow-lg border border-gray-100 dark:border-gray-700 dark:text-white';
                    return `
                    <div class="${cardStyle} rounded-3xl p-6 text-center relative overflow-hidden group hover:-translate-y-2 transition duration-300 cursor-pointer">
                        ${isLeader ? '<div class="absolute top-0 right-0 bg-yellow-400 text-black text-[10px] font-black px-3 py-1 rounded-bl-xl z-10"><i class="fas fa-crown"></i> قيادة</div>' : ''}
                        <div class="relative w-24 h-24 mx-auto mb-4"><img src="${u.avatar || 'https://via.placeholder.com/150'}" class="w-full h-full rounded-full object-cover border-4 ${isLeader ? 'border-yellow-400 shadow-[0_0_15px_rgba(251,191,36,0.6)]' : rank.class}"></div>
                        <h3 class="font-black text-lg mb-1 truncate">${u.name}</h3>
                        <p class="text-xs opacity-70 mb-4 font-bold">${rank.title}</p>
                        <div class="flex justify-center gap-4 text-xs font-bold bg-black/10 dark:bg-white/5 py-2 rounded-xl">
                            <span class="flex items-center gap-1"><i class="fas fa-star text-yellow-400"></i> ${u.stats?.points||0}</span>
                            <span class="flex items-center gap-1"><i class="fas fa-clock text-green-400"></i> ${u.stats?.hours||0}</span>
                        </div>
                    </div>`;
                }).join('');
            },

            renderVolunteerUI() {
                const u = app.data.currentUser;
                document.getElementById('volNameDisplay').innerText = u.name;
                document.getElementById('volBioDisplay').innerText = u.bio || "متطوع نشيط";
                if(u.avatar) document.getElementById('dashAvatar').src = u.avatar;
                
                // Warnings
                if(u.warnings && u.warnings.length > 0) {
                    document.getElementById('volWarningBox').classList.remove('hidden');
                    document.getElementById('volWarningText').innerText = u.warnings[u.warnings.length-1].reason;
                } else {
                    document.getElementById('volWarningBox').classList.add('hidden');
                }

                // Gate Button with Approval Logic
                const today = new Date().toLocaleDateString('ar-JO');
                const lastSession = u.history && u.history.length > 0 ? u.history[u.history.length - 1] : null;
                const isCheckedIn = lastSession && lastSession.date === today && lastSession.end === '-';
                const isPendingCheckin = u.pending_checkin && u.pending_checkin.date === today;
                
                let gateHTML = '';
                if (isCheckedIn) {
                    gateHTML = `<button onclick="app.checkOut()" class="w-32 h-32 rounded-full bg-red-600 border-4 border-red-400 shadow-[0_0_20px_rgba(220,38,38,0.6)] animate-pulse flex flex-col items-center justify-center text-white"><i class="fas fa-sign-out-alt text-4xl mb-2"></i><span class="font-black">خروج</span></button>`;
                } else if (isPendingCheckin) {
                     gateHTML = `<button disabled class="w-32 h-32 rounded-full bg-yellow-500 border-4 border-yellow-300 opacity-90 cursor-not-allowed flex flex-col items-center justify-center text-black"><i class="fas fa-clock text-4xl mb-2 animate-spin-slow"></i><span class="font-black text-xs">بانتظار الموافقة</span></button>`;
                } else {
                    gateHTML = `<button onclick="app.requestCheckIn()" class="w-32 h-32 rounded-full bg-green-600 border-4 border-green-400 shadow-[0_0_20px_rgba(34,197,94,0.6)] flex flex-col items-center justify-center text-white hover:scale-110 transition"><i class="fas fa-fingerprint text-4xl mb-2"></i><span class="font-black">دخول</span></button>`;
                }
                document.getElementById('gateContainer').innerHTML = gateHTML;

                // Shifts
                const availableShifts = app.getAvailableShiftDates();
                const shiftsHTML = availableShifts.map(s => {
                    const shiftRecord = u.shifts && u.shifts.find(us => us.date === s.date);
                    const isRegistered = !!shiftRecord;
                    let btn = `<button onclick="app.registerShift('${s.date}')" class="bg-blue-600 text-white px-3 py-1 rounded-lg text-xs font-bold">تسجيل</button>`;
                    
                    if (isRegistered) {
                        if (shiftRecord.status === 'approved') btn = '<span class="text-green-500 font-bold text-xs"><i class="fas fa-check-circle"></i> معتمد</span>';
                        else if (shiftRecord.status === 'pending') btn = '<span class="text-yellow-500 font-bold text-xs"><i class="fas fa-clock"></i> قيد المراجعة</span>';
                    }

                    return `
                    <div class="flex justify-between items-center p-3 bg-gray-50 dark:bg-gray-700 rounded-xl">
                        <div><div class="font-bold text-sm dark:text-white">${s.day}</div><div class="text-xs text-gray-500">${s.date}</div></div>
                        ${btn}
                    </div>`;
                }).join('');
                document.getElementById('volShiftList').innerHTML = shiftsHTML || '<p class="text-center text-xs text-gray-400">لا توجد مناوبات متاحة حالياً</p>';

                // Leaderboard (Top 5)
                const top5 = app.data.users.filter(x => x.role !== 'admin').sort((a,b) => (b.stats?.points || 0) - (a.stats?.points || 0)).slice(0, 5);
                document.getElementById('volLeaderboard').innerHTML = top5.map((x, i) => 
                    `<div class="flex items-center justify-between p-2 border-b dark:border-gray-700 last:border-0">
                        <div class="flex items-center gap-2">
                            <span class="font-black text-gray-400 w-4">${i+1}</span>
                            <img src="${x.avatar || 'https://via.placeholder.com/30'}" class="w-8 h-8 rounded-full">
                            <span class="text-sm font-bold dark:text-white">${x.name}</span>
                        </div>
                        <span class="text-xs font-black text-yellow-500">${x.stats?.points || 0} pts</span>
                    </div>`
                ).join('');
                
                // History
                if(u.history) {
                    document.getElementById('historyBody').innerHTML = u.history.slice().reverse().map(h => 
                        `<tr class="border-b dark:border-gray-700 last:border-0">
                            <td class="py-2 text-gray-500 text-center">${h.date}</td>
                            <td class="py-2 text-center text-blue-600">${h.start}</td>
                            <td class="py-2 text-center text-red-500">${h.end}</td>
                            <td class="py-2 text-center text-green-600">+${h.points||0}</td>
                            <td class="py-2 text-center"><button class="text-gray-400 hover:text-blue-500"><i class="fas fa-download"></i></button></td>
                        </tr>`
                    ).join('');
                }
                
                // Courses
                const courses = app.data.courses || [];
                document.getElementById('volCoursesList').innerHTML = courses.map(c => 
                    `<div class="p-3 bg-purple-50 dark:bg-gray-700 rounded-xl flex justify-between items-center">
                        <span class="text-xs font-bold dark:text-white">${c.title}</span>
                        <button class="text-purple-600 text-xs font-bold hover:underline">التحاق</button>
                    </div>`
                ).join('');
            },

            renderAdminDashboard() {
                const active = app.data.users.filter(u => u.status === 'active');
                document.getElementById('totalUsersCount').innerText = active.length;
                
                // Live Roster
                const today = new Date().toLocaleDateString('ar-JO');
                const checkedIn = active.filter(u => {
                    const last = u.history && u.history[u.history.length-1];
                    return last && last.date === today && last.end === '-';
                });
                document.getElementById('rosterCount').innerText = checkedIn.length;
                document.getElementById('liveAttendanceList').innerHTML = checkedIn.map(u => 
                    `<div class="flex justify-between items-center p-2 bg-green-50 dark:bg-gray-700 rounded-lg">
                        <span class="text-xs font-bold dark:text-white">${u.name}</span>
                        <span class="text-[10px] bg-green-200 text-green-800 px-2 rounded-full">متواجد</span>
                    </div>`
                ).join('');

                // Logs
                document.getElementById('loginLogsList').innerHTML = (app.data.logs || []).slice().reverse().slice(0, 10).map(l => 
                    `<div class="flex justify-between text-[10px] border-b dark:border-gray-700 pb-1"><span>${l.text}</span><span class="text-gray-400">${new Date(l.time).toLocaleTimeString()}</span></div>`
                ).join('');

                // Pending Checkins (Start Shift Requests)
                const pendingCheckins = app.data.users.filter(u => u.pending_checkin);
                document.getElementById('pendingCheckinsList').innerHTML = pendingCheckins.length > 0 ? pendingCheckins.map(u => `
                    <div class="flex justify-between items-center bg-gray-50 dark:bg-gray-700 p-2 rounded-lg">
                        <div class="text-xs font-bold dark:text-white">${u.name} <span class="text-gray-400">(${u.pending_checkin.time})</span></div>
                        <div class="flex gap-1">
                            <button onclick="app.approveCheckIn('${u.id}', true)" class="bg-green-500 text-white px-2 py-1 rounded text-[10px]">موافقة</button>
                            <button onclick="app.approveCheckIn('${u.id}', false)" class="bg-red-500 text-white px-2 py-1 rounded text-[10px]">رفض</button>
                        </div>
                    </div>
                `).join('') : '<p class="text-gray-400 text-center">لا توجد طلبات معلقة</p>';

                // Pending Shifts (Registration Requests)
                const pendingShifts = [];
                app.data.users.forEach(u => {
                    if(u.shifts) {
                        u.shifts.forEach(s => {
                            if(s.status === 'pending') pendingShifts.push({ user: u, shift: s });
                        });
                    }
                });

                document.getElementById('pendingShiftsList').innerHTML = pendingShifts.length > 0 ? pendingShifts.map(item => `
                    <div class="flex justify-between items-center bg-gray-50 dark:bg-gray-700 p-2 rounded-lg">
                        <div class="text-xs font-bold dark:text-white">${item.user.name} <span class="text-blue-400">${item.shift.date}</span></div>
                        <div class="flex gap-1">
                            <button onclick="app.approveShift('${item.user.id}', '${item.shift.date}', true)" class="bg-green-500 text-white px-2 py-1 rounded text-[10px]">موافقة</button>
                            <button onclick="app.approveShift('${item.user.id}', '${item.shift.date}', false)" class="bg-red-500 text-white px-2 py-1 rounded text-[10px]">رفض</button>
                        </div>
                    </div>
                `).join('') : '<p class="text-gray-400 text-center">لا توجد طلبات معلقة</p>';


                // User Table
                document.getElementById('fullUsersTable').innerHTML = app.data.users.map(u => 
                    `<tr class="border-b dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-700">
                        <td class="p-3 font-bold dark:text-white">${u.name} <span class="text-[10px] text-gray-400 block">${u.role}</span></td>
                        <td class="p-3 font-mono text-blue-600">${u.id}</td>
                        <td class="p-3 text-yellow-500 font-bold">${u.stats?.points||0}</td>
                        <td class="p-3"><button onclick="app.openAdminTools('${u.id}')" class="text-gray-500 hover:text-blue-600"><i class="fas fa-cog"></i></button></td>
                    </tr>`
                ).join('');

                // Suggestions
                document.getElementById('adminSuggestionsList').innerHTML = (app.data.suggestions || []).map(s => 
                    `<div class="p-3 bg-yellow-50 dark:bg-gray-700 rounded-xl mb-2">
                        <p class="text-xs dark:text-white font-bold mb-1">من: غير معرف</p>
                        <p class="text-xs text-gray-600 dark:text-gray-300">${s.text}</p>
                    </div>`
                ).join('');
                
                // Vehicles
                 document.getElementById('vehicleList').innerHTML = (app.data.vehicles || []).map(v => {
                    let color = v.status === 'جاهزة' ? 'text-green-600 bg-green-100' : (v.status === 'صيانة' ? 'text-orange-600 bg-orange-100' : 'text-red-600 bg-red-100');
                    return `<div class="flex justify-between items-center p-2 rounded-lg bg-gray-50 dark:bg-gray-700">
                        <span class="text-xs font-bold dark:text-white">${v.name}</span>
                        <span class="text-[10px] px-2 py-1 rounded-full font-bold ${color}">${v.status}</span>
                    </div>`;
                }).join('');
            },

            // --- Logic Actions ---
            // Updated Check-in Request
            async requestCheckIn() {
                const u = app.data.currentUser;
                const now = new Date();
                const pending = {
                    date: now.toLocaleDateString('ar-JO'),
                    time: now.toLocaleTimeString('ar-JO')
                };
                
                await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users', u.id), {
                    pending_checkin: pending
                });
                alert("تم إرسال طلب بدء المناوبة للإدارة للموافقة.");
                app.renderVolunteerUI();
            },

            // Admin Approve Check-in
            async approveCheckIn(uid, approved) {
                const u = app.data.users.find(x => x.id === uid);
                if (!u) return;
                
                if (approved) {
                    const session = { 
                        date: u.pending_checkin.date, 
                        start: u.pending_checkin.time, 
                        end: '-', 
                        points: 0, hours: 0 
                    };
                    await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users', uid), {
                        history: [...(u.history || []), session],
                        pending_checkin: null
                    });
                    app.notifyUser(uid, "تمت الموافقة على بدء مناوبتك. بالتوفيق يا نشمي!");
                    await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'logs'), {
                        text: `${u.name} بدأ المناوبة (موافقة)`, type: 'checkin', time: Date.now()
                    });
                } else {
                    await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users', uid), {
                        pending_checkin: null
                    });
                    app.notifyUser(uid, "تم رفض طلب بدء المناوبة. راجع الإدارة.");
                }
            },

            // Admin Approve Shift Registration
            async approveShift(uid, date, approved) {
                 const u = app.data.users.find(x => x.id === uid);
                 if (!u) return;

                 const updatedShifts = (u.shifts || []).map(s => {
                     if (s.date === date) {
                         return { ...s, status: approved ? 'approved' : 'rejected' };
                     }
                     return s;
                 });
                 // Filter out rejected if you want them gone, or keep status. Keeping status rejected so they know.
                 // Actually, let's remove rejected ones so they can re-apply if needed, or keep for record.
                 // Let's keep status 'rejected' for UX feedback.

                 await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users', uid), {
                     shifts: updatedShifts
                 });

                 app.notifyUser(uid, approved ? `تمت الموافقة على مناوبة ${date}` : `تم رفض طلب مناوبة ${date}`);
            },

            async checkOut() {
                const u = app.data.currentUser;
                if (!u.history || u.history.length === 0) return;
                
                const sessions = [...u.history];
                const last = sessions[sessions.length - 1];
                if (last.end !== '-') return;
                
                const now = new Date();
                last.end = now.toLocaleTimeString('ar-JO');
                
                // Calculate Duration
                last.hours = 4; // Mock 4 hours
                last.points = 10; // Mock 10 points
                
                const newStats = {
                    points: (u.stats?.points || 0) + 10,
                    hours: (u.stats?.hours || 0) + 4
                };

                await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users', u.id), {
                    history: sessions,
                    stats: newStats
                });
                
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'logs'), {
                    text: `${u.name} أنهى المناوبة`, type: 'checkout', time: Date.now()
                });
                app.notifyUser(u.id, "تم إنهاء المناوبة بنجاح ورصد النقاط.");
                app.renderVolunteerUI();
            },

            // New: Notification System
            async notifyUser(uid, msg) {
                const u = app.data.users.find(x => x.id === uid);
                const newNotif = { text: msg, read: false, time: Date.now() };
                await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users', uid), {
                    notifications: [newNotif, ...(u.notifications || [])]
                });
            },

            toggleNotifications() {
                const modal = document.getElementById('notificationsModal');
                const list = document.getElementById('notifList');
                modal.classList.toggle('hidden');
                
                if (!modal.classList.contains('hidden')) {
                    const u = app.data.currentUser;
                    const notifs = u.notifications || [];
                    list.innerHTML = notifs.length > 0 ? notifs.map(n => `
                        <div class="p-2 border-b dark:border-gray-700 ${n.read ? 'opacity-50' : 'bg-blue-50 dark:bg-gray-700'}">
                            <p class="dark:text-white font-bold">${n.text}</p>
                            <span class="text-[10px] text-gray-400">${new Date(n.time).toLocaleString()}</span>
                        </div>
                    `).join('') : '<p class="text-center text-gray-400">لا توجد إشعارات</p>';

                    // Mark as read
                    if (notifs.some(n => !n.read)) {
                        const updated = notifs.map(n => ({ ...n, read: true }));
                        updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users', u.id), { notifications: updated });
                    }
                }
            },

            // New: Update Logo
            async updateLogo() {
                const input = document.getElementById('logoUploader');
                if (input.files.length > 0) {
                    const file = input.files[0];
                    const reader = new FileReader();
                    reader.onload = async (e) => {
                         const base64 = e.target.result;
                         await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'settings', 'main'), { logo: base64 }, { merge: true });
                         alert("تم تحديث شعار الموقع بنجاح");
                    };
                    reader.readAsDataURL(file);
                }
            },
            
            async adminAddUser() {
                const name = document.getElementById('newVolName').value;
                const id = document.getElementById('newVolId').value;
                const pass = document.getElementById('newVolPass').value;
                
                if(!name || !id || !pass) return;
                
                await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users', id), {
                    id, name, pass, role: 'volunteer', status: 'active', stats: {points:0, hours:0}, history:[], shifts:[]
                });
                alert("تم إضافة النشمي");
                document.getElementById('addNashmiModal').classList.add('hidden');
            },
            
            openAdminTools(uid) {
                const u = app.data.users.find(x => x.id === uid);
                document.getElementById('toolUserName').innerText = u.name;
                document.getElementById('toolUserId').value = u.id;
                
                // Pre-fill edit fields
                document.getElementById('editNameAdmin').value = u.name;
                document.getElementById('editPassAdmin').value = u.pass;
                document.getElementById('editIdAdmin').value = u.id;

                document.getElementById('adminToolsModal').classList.remove('hidden');
            },

            async saveAdminUserEdit() {
                const oldId = document.getElementById('toolUserId').value;
                const newName = document.getElementById('editNameAdmin').value;
                const newPass = document.getElementById('editPassAdmin').value;
                const newId = document.getElementById('editIdAdmin').value;

                if (!newName || !newPass || !newId) return alert("البيانات ناقصة");

                const userDoc = app.data.users.find(u => u.id === oldId);

                if (newId === oldId) {
                    // Simple update
                    await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users', oldId), {
                        name: newName,
                        pass: newPass
                    });
                } else {
                    // ID Change (Complex: Clone & Delete)
                    if (app.data.users.find(u => u.id === newId)) return alert("المعرف الجديد مستخدم بالفعل");
                    
                    if(confirm("تغيير المعرف سينقل البيانات للمعرف الجديد. هل أنت متأكد؟")) {
                        const newData = { ...userDoc, id: newId, name: newName, pass: newPass };
                        // Create new
                        await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users', newId), newData);
                        // Delete old
                        await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users', oldId));
                    } else {
                        return;
                    }
                }
                alert("تم تحديث بيانات المتطوع بنجاح");
                document.getElementById('adminToolsModal').classList.add('hidden');
            },

            async sendAnnouncement() {
                const text = document.getElementById('adminAnnouncementText').value;
                if(!text) return;

                // Save to settings/main doc to display globally
                await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'settings', 'main'), { announcement: text }, { merge: true });
                
                // Also log it
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'logs'), {
                    text: `تعميم إداري: ${text}`, type: 'announcement', time: Date.now()
                });

                alert("تم إرسال التعميم لجميع المتطوعين");
                document.getElementById('adminAnnouncementText').value = '';
            },

            showAnnouncement(text) {
                const box = document.getElementById('volAnnouncements');
                const txt = document.getElementById('announcementText');
                if (text && text.length > 0) {
                    box.classList.remove('hidden');
                    txt.innerText = text;
                } else {
                    box.classList.add('hidden');
                }
            },

            async addVehicleStatus() {
                const name = document.getElementById('vehName').value;
                const status = document.getElementById('vehStatus').value;
                if(!name) return;
                
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'vehicles'), { name, status, time: Date.now() });
            },

            async submitSuggestion() {
                const text = document.getElementById('suggestionText').value;
                if(!text) return;
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'suggestions'), { text, time: Date.now() });
                alert("تم إرسال اقتراحك بسرية تامة");
                document.getElementById('suggestionsModal').classList.add('hidden');
            },
            
            async addCourse() {
                const title = document.getElementById('newCourseTitle').value;
                if(!title) return;
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'courses'), { title, added: Date.now() });
            },

            filterNashama(q) {
                const grid = document.getElementById('nashamaGrid');
                const cards = grid.getElementsByTagName('div');
                for (let card of cards) {
                    if (card.innerText.includes(q)) card.style.display = 'block';
                    else card.style.display = 'none';
                }
            },
            
            filterUsers(q) {
                const rows = document.getElementById('fullUsersTable').getElementsByTagName('tr');
                for (let row of rows) {
                    if (row.innerText.includes(q)) row.style.display = '';
                    else row.style.display = 'none';
                }
            },

            // --- AI & Reports ---
            async askAIQuick() {
                const q = document.getElementById('aiQuickAsk').value;
                if(!q) return;
                
                const responseArea = document.getElementById('aiResponseArea');
                responseArea.innerText = "جاري التفكير...";
                
                try {
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ contents: [{ parts: [{ text: "أنت مساعد ذكي للدفاع المدني الأردني. أجب باختصار واحترافية: " + q }] }] })
                    });
                    const data = await response.json();
                    responseArea.innerText = data.candidates[0].content.parts[0].text;
                } catch(e) {
                    responseArea.innerText = "عذراً، حدث خطأ في الاتصال.";
                }
            },

            async generateVolReport() {
                const text = document.getElementById('volReportText').value;
                const output = document.getElementById('aiReportOutput');
                output.classList.remove('hidden');
                output.innerText = "جاري إنشاء التقرير...";
                
                try {
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ contents: [{ parts: [{ text: "قم بصياغة تقرير رسمي عسكري لمديرية الدفاع المدني بناءً على المعلومات التالية: " + text }] }] })
                    });
                    const data = await response.json();
                    output.innerText = data.candidates[0].content.parts[0].text;
                } catch(e) {
                    output.innerText = "خطأ في التوليد";
                }
            },

            generateDailyMessage(name) {
                // Mock message
                const msgs = [
                    `أهلاً يا ${name}، الوطن فخور بك.`,
                    "درجات الحرارة مرتفعة اليوم، احرص على شرب السوائل.",
                    "جاهزيتك هي سر قوتنا.",
                    "تفقد معداتك قبل بدء المناوبة."
                ];
                document.getElementById('dailyMessageText').innerText = msgs[Math.floor(Math.random() * msgs.length)];
            },

            // --- Map ---
            initMap() {
                if (app.map) return;
                if (!document.getElementById('map')) return;
                
                app.map = L.map('map').setView([32.3424, 36.2044], 13); // Mafraq Coordinates
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '&copy; OSM'
                }).addTo(app.map);
                
                L.marker([32.3424, 36.2044]).addTo(app.map)
                    .bindPopup('مديرية دفاع مدني المفرق')
                    .openPopup();
                
                L.marker([32.35, 36.21]).addTo(app.map).bindPopup('مركز الخالدية');
            },

            // --- PDF & Print ---
            openIDModal() {
                const u = app.data.currentUser;
                document.getElementById('idCardName').innerText = u.name;
                document.getElementById('idCardNum').innerText = u.id;
                document.getElementById('idCardRank').innerText = app.getRankInfo(u.stats?.hours||0).title;
                document.getElementById('idCardAvatar').src = u.avatar || 'https://via.placeholder.com/150';
                document.getElementById('idCardModal').classList.remove('hidden');
            },

            printID() {
                const el = document.getElementById('digitalIDCard');
                html2pdf().from(el).save('CD-ID-Card.pdf');
            },

            openFullProfile() {
                 const u = app.data.currentUser;
                 document.getElementById('fpName').innerText = u.name;
                 document.getElementById('fpRank').innerText = app.getRankInfo(u.stats?.hours).title;
                 document.getElementById('fpPoints').innerText = u.stats?.points || 0;
                 document.getElementById('fpHours').innerText = u.stats?.hours || 0;
                 document.getElementById('fpAvatar').src = u.avatar || 'https://via.placeholder.com/150';
                 document.getElementById('fpHistory').innerHTML = (u.history || []).map(h => `<div>${h.date}: ${h.start} - ${h.end}</div>`).join('');
                 document.getElementById('fullProfileModal').classList.remove('hidden');
            },

            printFullCertificate() {
                const u = app.data.currentUser;
                document.getElementById('certName').innerText = u.name;
                document.getElementById('certDetails').innerText = `بمجموع ساعات تطوعية بلغت ${u.stats?.hours || 0} ساعة ومجموع نقاط ${u.stats?.points || 0}`;
                document.getElementById('certDate').innerText = new Date().toLocaleDateString('ar-JO');
                
                const el = document.getElementById('certificateTemplate');
                el.classList.remove('hidden');
                html2pdf().from(el).save('Certificate.pdf').then(() => el.classList.add('hidden'));
            },

            generateFullSystemReport() {
                document.getElementById('sysReportDate').innerText = new Date().toLocaleString();
                document.getElementById('repUserCount').innerText = "عدد المتطوعين: " + app.data.users.length;
                document.getElementById('repActiveCount').innerText = "المتواجدون الآن: " + document.getElementById('rosterCount').innerText;
                document.getElementById('repLoginLogs').innerHTML = document.getElementById('loginLogsList').innerHTML;
                
                const el = document.getElementById('systemReportTemplate');
                el.classList.remove('hidden');
                html2pdf().from(el).save('System-Report.pdf').then(() => el.classList.add('hidden'));
            },

            getRankInfo(hours) {
                if(!hours) hours = 0;
                if(hours > 100) return { title: 'قائد فريق', class: 'rank-border-leader' };
                if(hours > 50) return { title: 'نشمي متقدم', class: 'rank-border-nashmi' };
                if(hours > 20) return { title: 'مسعف مساند', class: 'rank-border-rescuer' };
                return { title: 'متطوع مستجد', class: 'rank-border-regular' };
            },

            // --- Chat ---
            toggleChat() {
                const win = document.getElementById('chatWindow');
                win.classList.toggle('hidden');
            },

            async sendChatMessage() {
                const input = document.getElementById('chatInput');
                const text = input.value;
                if(!text) return;
                
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'chats'), {
                    user: app.data.currentUser.name,
                    text: text,
                    time: Date.now()
                });
                input.value = '';
            },

            renderChat() {
                const list = document.getElementById('chatMessages');
                const msgs = (app.data.chats || []).sort((a,b) => a.time - b.time);
                list.innerHTML = msgs.map(m => 
                    `<div class="mb-1">
                        <span class="font-bold text-jcd-blue dark:text-blue-300 text-[10px]">${m.user}:</span>
                        <span class="text-gray-700 dark:text-gray-300 bg-white dark:bg-gray-700 p-1 rounded px-2 inline-block">${m.text}</span>
                    </div>`
                ).join('');
                list.scrollTop = list.scrollHeight;
            },

            toggleNotifications() {
                alert("لا توجد إشعارات جديدة"); // Simplified
            }
        };

        // Start
        window.onload = app.init;
    </script>
</body>
</html>