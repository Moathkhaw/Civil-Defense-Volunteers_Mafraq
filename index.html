<!DOCTYPE html>
<html lang="ar" dir="rtl" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø¨ÙˆØ§Ø¨Ø© Ù…ØªØ·ÙˆØ¹ÙŠ Ø§Ù„Ø¯ÙØ§Ø¹ Ø§Ù„Ù…Ø¯Ù†ÙŠ - Ø§Ù„Ù…ÙØ±Ù‚ (Ø³Ø­Ø§Ø¨ÙŠ)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <!-- Markdown Parser -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    
    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, addDoc, updateDoc, deleteDoc, onSnapshot, query, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global Variable to access Firebase functions outside module
        window.firebaseApp = {
            auth: null,
            db: null,
            appId: null,
            methods: {
                signInAnonymously,
                signInWithCustomToken,
                onAuthStateChanged,
                collection, doc, setDoc, addDoc, updateDoc, deleteDoc, onSnapshot, query, getDocs
            }
        };

        // Initialize Firebase
        const firebaseConfig = JSON.parse(window.__firebase_config || '{}');
        const app = initializeApp(firebaseConfig);
        window.firebaseApp.auth = getAuth(app);
        window.firebaseApp.db = getFirestore(app);
        window.firebaseApp.appId = window.__app_id || 'default-app-id';

        // Signal that Firebase is loaded
        window.dispatchEvent(new Event('firebase-loaded'));
    </script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap');
        
        body { font-family: 'Tajawal', sans-serif; background-color: #f3f4f6; }
        .bg-jcd-blue { background-color: #1e3a8a; } 
        .bg-jcd-red { background-color: #dc2626; }  
        .text-jcd-blue { color: #1e3a8a; }
        .hero-pattern {
            background-color: #1e3a8a;
            background-image: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%232c4da7' fill-opacity='0.2'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
        }
        .fade-in { animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .login-tab { cursor: pointer; padding-bottom: 0.5rem; border-bottom: 2px solid transparent; color: #6b7280; transition: all 0.3s; }
        .login-tab.active { border-bottom-color: #1e3a8a; color: #1e3a8a; font-weight: bold; }
        .ticker-wrap { width: 100%; overflow: hidden; background-color: #dc2626; color: white; white-space: nowrap; }
        .ticker { display: inline-block; padding-top: 5px; padding-bottom: 5px; animation: ticker 30s linear infinite; }
        @keyframes ticker { 0% { transform: translateX(100%); } 100% { transform: translateX(-100%); } }
        .chat-bubble { max-width: 80%; padding: 10px 15px; border-radius: 15px; margin-bottom: 10px; font-size: 0.95rem; line-height: 1.5; }
        .chat-user { background-color: #1e3a8a; color: white; align-self: flex-start; border-bottom-right-radius: 2px; }
        .chat-ai { background-color: #f3f4f6; color: #1f2937; align-self: flex-end; border-bottom-left-radius: 2px; border: 1px solid #e5e7eb; }
        
        /* Loading Overlay */
        #globalLoader { position: fixed; inset: 0; background: rgba(255,255,255,0.9); z-index: 9999; display: flex; flex-col; align-items: center; justify-content: center; transition: opacity 0.3s; }
        
        @media print {
            nav, footer, .no-print, button, .ticker-wrap, #globalLoader { display: none !important; }
            body { background: white; }
            #admin-dashboard { display: block !important; }
            #dailyReportContent { border: 1px solid #000; padding: 20px; font-size: 14pt; }
        }
    </style>
</head>
<body class="flex flex-col min-h-screen">

    <!-- Global Loader -->
    <div id="globalLoader">
        <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-jcd-blue mb-4"></div>
        <p class="text-gray-600 font-bold">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...</p>
    </div>

    <!-- News Ticker -->
    <div id="news-ticker-container" class="ticker-wrap hidden no-print">
        <div class="ticker text-sm font-bold" id="newsTickerText"></div>
    </div>

    <!-- Navbar -->
    <nav class="bg-jcd-blue text-white shadow-lg sticky top-0 z-50 no-print">
        <div class="container mx-auto px-4 py-3 flex justify-between items-center">
            <div class="flex items-center space-x-3 space-x-reverse cursor-pointer" onclick="app.showSection('home')">
                <div class="bg-white p-1 rounded-full h-12 w-12 flex items-center justify-center overflow-hidden shadow-inner border-2 border-gray-100">
                     <img id="navLogo" src="https://upload.wikimedia.org/wikipedia/commons/e/e0/Jordan_Civil_Defence_Logo.png" alt="Ø´Ø¹Ø§Ø± Ø§Ù„Ø¯ÙØ§Ø¹ Ø§Ù„Ù…Ø¯Ù†ÙŠ" class="h-full w-full object-contain">
                </div>
                <div>
                    <h1 class="font-bold text-lg leading-tight">Ù…ØªØ·ÙˆØ¹ÙŠ Ø§Ù„Ø¯ÙØ§Ø¹ Ø§Ù„Ù…Ø¯Ù†ÙŠ Ø§Ù„Ù…ÙØ±Ù‚</h1>
                    <p class="text-xs text-gray-300">Ø¨ÙˆØ§Ø¨Ø© Ø§Ù„Ù…ØªØ·ÙˆØ¹ÙŠÙ† (Ù…ØªØµÙ„ <i class="fas fa-circle text-green-400 text-[8px]"></i>)</p>
                </div>
            </div>
            
            <div id="nav-links" class="hidden md:flex space-x-6 space-x-reverse text-sm font-medium">
                <button onclick="app.showSection('home')" class="hover:text-yellow-400 transition">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</button>
                <button onclick="app.showSection('gallery')" class="hover:text-yellow-400 transition">Ù…Ø¹Ø±Ø¶ Ø§Ù„ØµÙˆØ±</button>
            </div>

            <div>
                <button id="loginBtnNav" onclick="app.showLogin('volunteer')" class="bg-jcd-red hover:bg-red-700 text-white px-4 py-2 rounded-md text-sm font-bold transition shadow-md">
                    <i class="fas fa-sign-in-alt ml-2"></i> Ø¯Ø®ÙˆÙ„
                </button>
                <div id="userMenu" class="hidden flex items-center space-x-3 space-x-reverse">
                    <div class="relative">
                        <span id="notifBadge" class="hidden absolute -top-1 -right-1 bg-red-500 rounded-full h-3 w-3 animate-pulse"></span>
                        <i class="fas fa-bell text-gray-300 hover:text-white cursor-pointer ml-3" onclick="app.toggleNotifications()"></i>
                    </div>
                    <span id="userNameDisplay" class="font-medium text-yellow-400"></span>
                    <button onclick="app.logout()" class="bg-gray-700 hover:bg-gray-600 text-white px-3 py-1 rounded text-sm transition">
                        Ø®Ø±ÙˆØ¬
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content Area -->
    <main id="main-content" class="flex-grow container mx-auto px-4 py-6">
        
        <!-- SECTION: Home -->
        <section id="home" class="fade-in space-y-8">
            <div class="hero-pattern rounded-2xl p-8 md:p-12 text-center text-white shadow-xl relative overflow-hidden">
                <div class="relative z-10 flex flex-col items-center">
                    <div class="bg-white p-2 rounded-full h-24 w-24 mb-6 shadow-lg flex items-center justify-center border-4 border-blue-200">
                        <img id="heroLogo" src="https://upload.wikimedia.org/wikipedia/commons/e/e0/Jordan_Civil_Defence_Logo.png" alt="Ø´Ø¹Ø§Ø± Ù…ØªØ·ÙˆØ¹ÙŠ Ø§Ù„Ø¯ÙØ§Ø¹ Ø§Ù„Ù…Ø¯Ù†ÙŠ" class="h-full w-full object-contain">
                    </div>
                    <h2 class="text-3xl md:text-5xl font-bold mb-4">Ù†Ø´Ø§Ù…Ù‰ Ø§Ù„Ù…ÙØ±Ù‚</h2>
                    <p class="text-lg md:text-xl text-gray-200 mb-8 max-w-2xl mx-auto">
                        Ù…Ù†ØµØ© Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠØ© Ù…ÙˆØ­Ø¯Ø© ÙˆØ°ÙƒÙŠØ© Ù„Ø®Ø¯Ù…Ø© Ù…ØªØ·ÙˆØ¹ÙŠ Ø§Ù„Ø¯ÙØ§Ø¹ Ø§Ù„Ù…Ø¯Ù†ÙŠ.
                    </p>
                    
                    <div class="flex flex-col md:flex-row justify-center gap-6 mt-6 w-full max-w-2xl">
                        <div onclick="app.showLogin('volunteer')" class="bg-white/10 backdrop-blur-md border border-white/30 p-6 rounded-xl hover:bg-white/20 transition cursor-pointer flex flex-col items-center w-full group">
                            <div class="bg-white text-jcd-blue h-16 w-16 rounded-full flex items-center justify-center text-3xl mb-3 shadow-lg group-hover:scale-110 transition">
                                <i class="fas fa-user-hard-hat"></i>
                            </div>
                            <h3 class="text-xl font-bold">Ø¨ÙˆØ§Ø¨Ø© Ø§Ù„Ù…ØªØ·ÙˆØ¹ÙŠÙ†</h3>
                            <p class="text-sm text-gray-200 mt-2">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ØŒ Ø§Ù„Ù…Ù†Ø§ÙˆØ¨Ø§ØªØŒ Ø§Ù„Ø­Ø¶ÙˆØ±</p>
                        </div>
                        <div onclick="app.showLogin('admin')" class="bg-gray-900/40 backdrop-blur-md border border-gray-500/30 p-6 rounded-xl hover:bg-gray-900/60 transition cursor-pointer flex flex-col items-center w-full group">
                            <div class="bg-gray-800 text-white h-16 w-16 rounded-full flex items-center justify-center text-3xl mb-3 shadow-lg group-hover:scale-110 transition">
                                <i class="fas fa-user-shield"></i>
                            </div>
                            <h3 class="text-xl font-bold">Ø¨ÙˆØ§Ø¨Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</h3>
                            <p class="text-sm text-gray-300 mt-2">Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ø­ÙŠØ© ÙˆØ§Ù„ØªÙ‚Ø§Ø±ÙŠØ±</p>
                        </div>
                    </div>
                    
                    <div class="mt-8">
                         <button onclick="app.showRegistration()" class="bg-yellow-400 text-jcd-blue px-6 py-2 rounded-lg font-bold hover:bg-yellow-300 transition shadow-lg flex items-center justify-center mx-auto text-sm">
                            <i class="fas fa-user-plus ml-2"></i> Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ Ø­Ø³Ø§Ø¨ØŸ Ø³Ø¬Ù„ Ø§Ù„Ø¢Ù†
                        </button>
                    </div>
                </div>
            </div>
        </section>

        <!-- SECTION: Gallery -->
        <section id="gallery" class="fade-in hidden">
             <h2 class="text-2xl font-bold text-jcd-blue mb-6 border-b-2 border-yellow-400 pb-2 inline-block">Ù…Ø¹Ø±Ø¶ Ø§Ù„ØµÙˆØ±</h2>
             <div id="galleryGrid" class="grid grid-cols-1 md:grid-cols-3 gap-4"></div>
        </section>

        <!-- SECTION: Registration -->
        <section id="registration" class="fade-in hidden max-w-md mx-auto mt-10">
            <div class="bg-white rounded-xl shadow-lg p-8">
                <div class="text-center mb-6">
                    <h2 class="text-2xl font-bold text-gray-800">Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ù…ØªØ·ÙˆØ¹</h2>
                    <p class="text-gray-500 text-sm">Ø³ÙŠØªÙ… ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø­Ø³Ø§Ø¨ Ø¨Ø¹Ø¯ Ù…ÙˆØ§ÙÙ‚Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</p>
                </div>
                <form onsubmit="event.preventDefault(); app.registerUser();">
                    <div class="mb-4">
                        <label class="block text-gray-700 text-sm font-bold mb-2">Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø±Ø¨Ø§Ø¹ÙŠ</label>
                        <input type="text" id="regName" class="w-full p-2 border rounded-lg" required>
                    </div>
                    <div class="mb-4">
                        <label class="block text-gray-700 text-sm font-bold mb-2">Ø§Ù„Ø±Ù‚Ù… Ø§Ù„ÙˆØ·Ù†ÙŠ / Ø§Ù„Ù…Ø¹Ø±Ù</label>
                        <input type="text" id="regId" class="w-full p-2 border rounded-lg" required>
                    </div>
                    <div class="mb-4">
                        <label class="block text-gray-700 text-sm font-bold mb-2">Ø§Ù„Ù…Ù†Ø·Ù‚Ø©</label>
                        <select id="regLocation" class="w-full p-2 border rounded-lg bg-white">
                            <option>Ø§Ù„Ù…ÙØ±Ù‚ - Ø§Ù„Ù‚ØµØ¨Ø©</option>
                            <option>Ø¨Ù„Ø¹Ù…Ø§</option>
                            <option>Ø§Ø±Ø­Ø§Ø¨</option>
                            <option>Ø§Ù„Ø®Ø§Ù„Ø¯ÙŠØ©</option>
                            <option>Ø§Ù„Ø±ÙˆÙŠØ´Ø¯</option>
                        </select>
                    </div>
                    <div class="mb-6">
                        <label class="block text-gray-700 text-sm font-bold mb-2">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label>
                        <input type="password" id="regPass" class="w-full p-2 border rounded-lg" required>
                    </div>
                    <button type="submit" class="w-full bg-green-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-700 transition">
                        ØªØ³Ø¬ÙŠÙ„ Ø·Ù„Ø¨
                    </button>
                    <button type="button" onclick="app.showLogin('volunteer')" class="w-full mt-2 text-blue-600 text-sm hover:underline">
                        Ù„Ø¯ÙŠÙƒ Ø­Ø³Ø§Ø¨ Ø¨Ø§Ù„ÙØ¹Ù„ØŸ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
                    </button>
                </form>
            </div>
        </section>

        <!-- SECTION: Login -->
        <section id="login" class="fade-in hidden max-w-md mx-auto mt-10">
            <div class="bg-white rounded-xl shadow-lg p-8 border-t-4 border-jcd-blue">
                <div class="flex mb-6 border-b text-center">
                    <div class="w-1/2 login-tab active" id="tab-volunteer" onclick="app.switchLoginTab('volunteer')">
                        <i class="fas fa-user-hard-hat ml-1"></i> Ø¨ÙˆØ§Ø¨Ø© Ø§Ù„Ù…ØªØ·ÙˆØ¹
                    </div>
                    <div class="w-1/2 login-tab" id="tab-admin" onclick="app.switchLoginTab('admin')">
                        <i class="fas fa-user-shield ml-1"></i> Ø¨ÙˆØ§Ø¨Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©
                    </div>
                </div>
                <div class="text-center mb-6">
                    <h2 class="text-2xl font-bold text-gray-800" id="loginTitle">ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„</h2>
                    <p class="text-gray-500 text-sm" id="loginSubtitle">Ø£Ø¯Ø®Ù„ Ø¨ÙŠØ§Ù†Ø§ØªÙƒ</p>
                </div>
                <form onsubmit="event.preventDefault(); app.login();">
                    <div class="mb-4">
                        <label class="block text-gray-700 text-sm font-bold mb-2">Ø§Ù„Ù…Ø¹Ø±Ù</label>
                        <input type="text" id="username" class="w-full p-2 border rounded-lg" required>
                    </div>
                    <div class="mb-6">
                        <label class="block text-gray-700 text-sm font-bold mb-2">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label>
                        <input type="password" id="password" class="w-full p-2 border rounded-lg" required>
                    </div>
                    <button type="submit" class="w-full bg-jcd-blue text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-800 transition shadow-md">
                        Ø¯Ø®ÙˆÙ„ Ù„Ù„Ù†Ø¸Ø§Ù…
                    </button>
                    <p id="loginError" class="text-red-500 text-xs mt-3 text-center hidden"></p>
                    <div id="registerLink" class="mt-4 text-center text-sm">
                        <a href="#" onclick="app.showRegistration()" class="text-blue-600 hover:underline">ØªØ³Ø¬ÙŠÙ„ Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯</a>
                    </div>
                </form>
            </div>
        </section>

        <!-- SECTION: Admin Dashboard -->
        <section id="admin-dashboard" class="fade-in hidden space-y-6">
            
            <div class="bg-jcd-blue rounded-2xl p-8 text-white shadow-xl flex flex-col md:flex-row justify-between items-center mb-6 border-2 border-blue-400 no-print">
                <div>
                    <h2 class="text-3xl font-extrabold mb-2">Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„Ù…Ø±ÙƒØ²ÙŠØ©</h2>
                    <div class="text-lg md:text-xl bg-white/10 px-6 py-2 rounded-lg inline-block border border-white/20">
                        Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ ÙŠØ§ <span id="adminNameSpan" class="font-bold text-yellow-400"></span>
                    </div>
                </div>
                <div class="bg-white/10 p-4 rounded-full mt-4 md:mt-0">
                    <i class="fas fa-user-shield text-4xl"></i>
                </div>
            </div>

            <!-- DAILY REPORT & SUGGESTIONS -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- Daily Auto Report -->
                <div class="bg-white p-6 rounded-xl shadow-md border-t-4 border-indigo-600">
                    <h3 class="text-lg font-bold mb-4 flex items-center justify-between text-indigo-800">
                        <span><i class="fas fa-file-alt ml-2"></i> ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø¯ÙˆØ§Ù… Ø§Ù„ÙŠÙˆÙ…ÙŠ (Ø§Ù„Ø¢Ù„ÙŠ)</span>
                        <span id="reportDate" class="text-xs text-gray-500"></span>
                    </h3>
                    <div id="dailyReportContent" class="bg-gray-50 p-4 rounded text-sm min-h-[150px]">
                        <p class="text-center text-gray-400 py-4">Ø¬Ø§Ø±ÙŠ ØªÙˆÙ„ÙŠØ¯ Ø§Ù„ØªÙ‚Ø±ÙŠØ±...</p>
                    </div>
                    <button onclick="app.printDailyReport()" class="mt-3 w-full bg-indigo-600 text-white py-2 rounded hover:bg-indigo-700 transition no-print">
                        <i class="fas fa-print ml-2"></i> Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ØªÙ‚Ø±ÙŠØ±
                    </button>
                </div>

                <!-- Suggestions Inbox -->
                <div class="bg-white p-6 rounded-xl shadow-md border-t-4 border-pink-500 no-print">
                    <h3 class="text-lg font-bold mb-4 flex items-center justify-between text-pink-800">
                        <span><i class="fas fa-lightbulb ml-2"></i> ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„Ù…Ù‚ØªØ±Ø­Ø§Øª</span>
                        <span id="suggestionsCount" class="bg-pink-100 text-pink-800 text-xs px-2 py-1 rounded">0</span>
                    </h3>
                    <div id="suggestionsList" class="overflow-y-auto max-h-[300px] space-y-2">
                        <p class="text-center text-gray-400 py-4 text-sm">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</p>
                    </div>
                </div>
            </div>

            <!-- Site Settings & SHIFT MANAGEMENT -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 no-print">
                <div class="bg-white p-6 rounded-xl shadow-md">
                    <h3 class="text-lg font-bold mb-4 border-b pb-2">Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…ÙˆÙ‚Ø¹</h3>
                    <div class="mb-3">
                        <label class="block text-sm font-bold mb-1">Ù†Øµ Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø¥Ø®Ø¨Ø§Ø±ÙŠ</label>
                        <input type="text" id="adminTickerText" class="w-full p-2 border rounded text-sm mb-2" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„Ù†Øµ Ù‡Ù†Ø§...">
                        <button onclick="app.saveSettings()" class="bg-jcd-blue text-white px-4 py-1 rounded text-sm w-full">Ø­ÙØ¸ Ø§Ù„Ù†Øµ</button>
                    </div>
                    <div class="mb-3">
                        <label class="block text-sm font-bold mb-1">Ø´Ø¹Ø§Ø± Ø§Ù„Ù…ÙˆÙ‚Ø¹</label>
                        <div class="flex gap-2 mb-2">
                             <input type="text" id="adminLogoUrl" class="w-full p-2 border rounded text-sm" placeholder="Ø±Ø§Ø¨Ø· Ø§Ù„ØµÙˆØ±Ø© (URL)">
                             <button onclick="app.saveSettings()" class="bg-blue-600 text-white px-3 rounded text-sm whitespace-nowrap">ØªØ­Ø¯ÙŠØ«</button>
                        </div>
                    </div>
                </div>

                <div class="bg-white p-6 rounded-xl shadow-md border-t-4 border-blue-600">
                    <h3 class="text-lg font-bold mb-4 flex items-center justify-between text-blue-800">
                        <span><i class="fas fa-calendar-plus ml-2"></i> Ø£ÙŠØ§Ù… Ø¯ÙˆØ§Ù… Ø§Ø³ØªØ«Ù†Ø§Ø¦ÙŠØ©</span>
                    </h3>
                    <div class="flex gap-2 mb-4">
                        <input type="date" id="newShiftDate" class="w-full p-2 border rounded text-sm">
                        <button onclick="app.addCustomShift()" class="bg-blue-600 text-white px-4 py-1 rounded text-sm font-bold whitespace-nowrap hover:bg-blue-700">
                            <i class="fas fa-plus"></i> Ø¥Ø¶Ø§ÙØ©
                        </button>
                    </div>
                    <div id="customShiftsList" class="space-y-1 max-h-[150px] overflow-y-auto"></div>
                </div>
            </div>

            <!-- Shift Roster -->
            <div class="bg-white p-6 rounded-xl shadow-md border-t-4 border-indigo-500 no-print">
                <h3 class="text-lg font-bold mb-4 flex items-center justify-between text-indigo-800">
                    <span><i class="fas fa-clipboard-list ml-2"></i> Ø³Ø¬Ù„ Ø§Ù„Ù…Ù†Ø§ÙˆØ¨Ø§Øª ÙˆØ§Ù„Ù…Ø³Ø¬Ù„ÙŠÙ†</span>
                </h3>
                <div class="overflow-x-auto max-h-96">
                    <table class="w-full text-sm text-right border-collapse">
                        <thead class="bg-gray-50 text-gray-700 sticky top-0">
                            <tr>
                                <th class="p-3 border-b text-center">Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                                <th class="p-3 border-b text-center">Ø§Ù„ÙŠÙˆÙ…</th>
                                <th class="p-3 border-b">Ø§Ù„Ù…ØªØ·ÙˆØ¹ÙŠÙ† (Ø§Ø¶ØºØ· Ù„Ù„ØªØ­Ø¶ÙŠØ±)</th>
                            </tr>
                        </thead>
                        <tbody id="adminShiftRosterBody"></tbody>
                    </table>
                </div>
            </div>

            <!-- Volunteers Management -->
            <div class="bg-white p-6 rounded-xl shadow-md border-t-4 border-gray-800 no-print">
                <h3 class="text-lg font-bold mb-4 flex items-center justify-between">
                    <span><i class="fas fa-users-cog ml-2 text-gray-700"></i> Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ØªØ·ÙˆØ¹ÙŠÙ†</span>
                    <input type="text" onkeyup="app.filterVolunteers(this.value)" placeholder="Ø¨Ø­Ø«..." class="border rounded p-1 text-sm font-normal w-1/3">
                </h3>
                <div class="overflow-x-auto max-h-96">
                    <table class="w-full text-sm text-right">
                        <thead class="bg-gray-50 sticky top-0">
                            <tr><th>Ø§Ù„Ø§Ø³Ù…</th><th>Ø§Ù„Ù…Ø¹Ø±Ù</th><th>ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±</th><th>Ø§Ù„Ø­Ø§Ù„Ø©</th><th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th></tr>
                        </thead>
                        <tbody id="allVolunteersBody"></tbody>
                    </table>
                </div>
            </div>

            <!-- Live Monitor -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 no-print">
                <div class="bg-white p-6 rounded-xl shadow-md border-t-4 border-yellow-500">
                    <h3 class="text-lg font-bold mb-4 flex items-center justify-between">
                        <span><i class="fas fa-key ml-2 text-yellow-600"></i> Ø·Ù„Ø¨Ø§Øª ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</span>
                        <span id="pendingPassCount" class="bg-yellow-100 text-yellow-800 text-xs px-2 py-1 rounded">0</span>
                    </h3>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm text-right">
                            <thead class="bg-gray-50"><tr><th>Ø§Ù„Ù…ØªØ·ÙˆØ¹</th><th>Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©</th><th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡</th></tr></thead>
                            <tbody id="passwordRequestsBody"></tbody>
                        </table>
                    </div>
                </div>

                <div class="bg-white p-6 rounded-xl shadow-md border-t-4 border-green-500">
                    <h3 class="text-lg font-bold mb-4 flex items-center justify-between">
                        <span><i class="fas fa-satellite-dish ml-2 text-green-600"></i> Ù…Ø±Ø§Ù‚Ø¨ Ø§Ù„Ø¯ÙˆØ§Ù… Ø§Ù„Ø­ÙŠ</span>
                        <span id="activeVolunteersCount" class="bg-green-100 text-green-800 text-xs px-2 py-1 rounded">0</span>
                    </h3>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm text-right">
                            <thead class="bg-gray-50"><tr><th>Ø§Ù„Ù…ØªØ·ÙˆØ¹</th><th>ÙˆÙ‚Øª Ø§Ù„Ø¯Ø®ÙˆÙ„</th><th>Ø§Ù„Ù…Ù†Ø·Ù‚Ø©</th></tr></thead>
                            <tbody id="liveAttendanceBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Approvals -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 no-print">
                <div class="bg-white p-6 rounded-xl shadow-md">
                    <h3 class="text-lg font-bold mb-4 border-b pb-2 flex justify-between">
                        <span>Ø·Ù„Ø¨Ø§Øª Ø§Ù„ØªØ³Ø¬ÙŠÙ„</span>
                        <span id="pendingCount" class="bg-yellow-100 text-yellow-800 text-xs px-2 py-1 rounded">0</span>
                    </h3>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm text-right">
                            <tbody id="pendingTableBody"></tbody>
                        </table>
                    </div>
                </div>

                <div class="bg-white p-6 rounded-xl shadow-md">
                    <h3 class="text-lg font-bold mb-4 border-b pb-2 flex justify-between">
                        <span>Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…Ù†Ø§ÙˆØ¨Ø§Øª</span>
                        <span id="pendingShiftsCount" class="bg-orange-100 text-orange-800 text-xs px-2 py-1 rounded">0</span>
                    </h3>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm text-right">
                            <tbody id="shiftRequestsTableBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Messaging -->
            <div class="bg-white p-6 rounded-xl shadow-md no-print">
                <h3 class="text-lg font-bold mb-4 border-b pb-2">Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø±</h3>
                <div class="mb-3">
                    <select id="msgRecipient" class="w-full p-2 border rounded text-sm mb-2 bg-gray-50">
                        <option value="all">Ø§Ù„Ø¬Ù…ÙŠØ¹</option>
                    </select>
                </div>
                <div class="mb-3">
                    <textarea id="msgBody" class="w-full p-2 border rounded text-sm h-20" placeholder="Ù†Øµ Ø§Ù„Ø±Ø³Ø§Ù„Ø©..."></textarea>
                </div>
                <button onclick="app.adminSendMessage()" class="bg-green-600 text-white px-4 py-2 rounded text-sm w-full font-bold">Ø¥Ø±Ø³Ø§Ù„</button>
            </div>
        </section>

        <!-- SECTION: Volunteer Dashboard -->
        <section id="volunteer-dashboard" class="fade-in hidden space-y-6">
            <div class="flex flex-col md:flex-row gap-6">
                <div class="w-full md:w-1/3 bg-white p-4 rounded-xl shadow-md h-fit order-2 md:order-1">
                    <h3 class="font-bold text-lg mb-3 flex items-center text-gray-700 border-b pb-2">
                        <i class="fas fa-bell ml-2 text-yellow-500"></i> Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª
                    </h3>
                    <div id="notificationsList" class="space-y-3 max-h-96 overflow-y-auto"></div>
                </div>

                <div class="w-full md:w-2/3 order-1 md:order-2 space-y-6">
                    <div class="bg-jcd-blue rounded-2xl p-8 text-white shadow-xl flex flex-col md:flex-row justify-between items-center mb-2 border-2 border-blue-400">
                        <div>
                            <h2 class="text-3xl font-extrabold mb-2">Ù„ÙˆØ­Ø© Ø§Ù„Ø®Ø¯Ù…Ø§Øª</h2>
                            <div class="text-lg md:text-xl bg-white/10 px-6 py-2 rounded-lg inline-block border border-white/20">
                                Ù…Ø±Ø­Ø¨Ø§Ù‹ <span id="volNameSpan" class="font-bold text-yellow-400"></span>
                            </div>
                        </div>
                        <div class="bg-white/10 p-4 rounded-full mt-4 md:mt-0">
                            <i class="fas fa-user-hard-hat text-4xl"></i>
                        </div>
                    </div>

                    <!-- Gemini AI -->
                    <div class="bg-gradient-to-br from-indigo-50 to-white p-6 rounded-xl shadow-md border-t-8 border-indigo-500">
                        <h3 class="font-bold text-lg mb-4 flex items-center text-indigo-900">
                            <i class="fas fa-robot ml-2 text-indigo-600 text-xl"></i> Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ âœ¨
                        </h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="bg-white border border-indigo-100 p-4 rounded-lg shadow-sm">
                                <h4 class="font-bold text-indigo-700 mb-2">â›‘ï¸ Ø§Ù„Ù…Ø³ØªØ´Ø§Ø± Ø§Ù„Ù…ÙŠØ¯Ø§Ù†ÙŠ</h4>
                                <div id="safetyChatOutput" class="h-40 overflow-y-auto bg-gray-50 rounded p-2 mb-2 text-xs border flex flex-col">
                                    <div class="text-center text-gray-400 mt-10">ØªÙØ¶Ù„ Ø¨Ø§Ù„Ø³Ø¤Ø§Ù„...</div>
                                </div>
                                <div class="flex gap-2">
                                    <input type="text" id="safetyQuery" class="w-full p-2 border rounded text-xs" placeholder="Ù…Ø«Ø§Ù„: ÙƒÙŠÙ Ø£ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø§Ù„Ø­Ø±ÙˆÙ‚ØŸ">
                                    <button onclick="app.askSafetyAdvisor()" class="bg-indigo-600 text-white px-3 py-1 rounded text-xs"><i class="fas fa-paper-plane"></i></button>
                                </div>
                            </div>
                            <div class="bg-white border border-indigo-100 p-4 rounded-lg shadow-sm">
                                <h4 class="font-bold text-indigo-700 mb-2">ğŸ“ ØµØ§Ù†Ø¹ Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±</h4>
                                <textarea id="reportNotes" class="w-full p-2 border rounded text-xs h-24 mb-2 bg-gray-50" placeholder="Ø§ÙƒØªØ¨ Ø±Ø¤ÙˆØ³ Ø£Ù‚Ù„Ø§Ù… Ù„Ù„ØªÙ‚Ø±ÙŠØ±"></textarea>
                                <button onclick="app.generateReport()" class="bg-indigo-600 text-white w-full py-1 rounded text-xs font-bold">ØµÙŠØ§ØºØ© Ø§Ù„ØªÙ‚Ø±ÙŠØ±</button>
                            </div>
                        </div>
                        
                        <!-- Modal Report -->
                        <div id="reportModal" class="hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
                            <div class="bg-white rounded-lg w-full max-w-lg p-6 shadow-2xl relative">
                                <button onclick="document.getElementById('reportModal').classList.add('hidden')" class="absolute top-2 left-2 text-gray-500 hover:text-red-500"><i class="fas fa-times text-xl"></i></button>
                                <div id="reportResult" class="bg-gray-50 p-4 rounded text-sm whitespace-pre-wrap h-64 overflow-y-auto mt-6"></div>
                                <button onclick="app.copyReport()" class="bg-green-600 text-white w-full mt-4 py-2 rounded font-bold">Ù†Ø³Ø® Ø§Ù„Ù†Øµ</button>
                            </div>
                        </div>
                    </div>

                    <div id="electronicGate" class="bg-white p-6 rounded-xl shadow-md border-t-8 border-gray-300"></div>

                    <div class="bg-white p-6 rounded-xl shadow-md border-r-4 border-blue-500">
                        <h3 class="font-bold text-lg mb-4 flex items-center"><i class="fas fa-calendar-alt ml-2 text-blue-600"></i> Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ù†Ø§ÙˆØ¨Ø§Øª</h3>
                        <div id="shiftsContainer" class="space-y-3"></div>
                    </div>

                    <div class="bg-white p-6 rounded-xl shadow-md border-r-4 border-pink-500">
                        <h3 class="font-bold text-lg mb-2 text-gray-700">ØªÙ‚Ø¯ÙŠÙ… Ù…Ù‚ØªØ±Ø­</h3>
                        <textarea id="suggestionText" class="w-full p-2 border rounded text-sm h-20 mb-2" placeholder="Ø§ÙƒØªØ¨ Ù…Ù‚ØªØ±Ø­Ùƒ..."></textarea>
                        <button onclick="app.submitSuggestion()" class="bg-pink-600 text-white px-4 py-2 rounded text-sm font-bold w-full mb-4">Ø¥Ø±Ø³Ø§Ù„</button>
                        <h4 class="font-bold text-sm text-gray-700 border-b pb-1 mb-2">Ø§Ù„Ø±Ø¯ÙˆØ¯</h4>
                        <div id="mySuggestionsList" class="space-y-2 max-h-40 overflow-y-auto"></div>
                    </div>

                    <div class="bg-white p-6 rounded-xl shadow-md">
                        <h3 class="font-bold text-lg mb-4 text-gray-700">ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</h3>
                        <div class="flex gap-2">
                            <input type="number" id="newVolunteerPass" class="w-full p-2 border rounded" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©">
                            <button onclick="app.requestPasswordChange()" class="bg-gray-800 text-white px-4 py-2 rounded whitespace-nowrap">Ø·Ù„Ø¨</button>
                        </div>
                        <p id="passRequestStatus" class="text-sm text-orange-600 mt-2 hidden">Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©...</p>
                    </div>
                </div>
            </div>
        </section>

    </main>

    <footer class="bg-gray-800 text-white py-8 mt-10 text-center no-print">
        <div class="container mx-auto">
            <p class="mb-4 font-bold text-lg">Ù…ØªØ·ÙˆØ¹ÙŠ Ø§Ù„Ø¯ÙØ§Ø¹ Ø§Ù„Ù…Ø¯Ù†ÙŠ Ø§Ù„Ù…ÙØ±Ù‚ &copy; 2026</p>
        </div>
    </footer>

    <!-- Logic -->
    <script>
        const apiKey = ""; // API Key injected automatically

        const app = {
            data: {
                users: [],
                settings: {},
                suggestions: [],
                currentUser: null,
                currentLoginContext: 'volunteer'
            },

            init: async function() {
                // Initialize Auth First (Fix for permission denied)
                const auth = window.firebaseApp.auth;
                
                // Wait for any existing auth state to resolve
                await new Promise(resolve => {
                    const unsubscribe = window.firebaseApp.methods.onAuthStateChanged(auth, (user) => {
                        unsubscribe();
                        resolve(user);
                    });
                });

                // If not signed in, sign in now
                if (!auth.currentUser) {
                    try {
                        if (window.__initial_auth_token) {
                            await window.firebaseApp.methods.signInWithCustomToken(auth, window.__initial_auth_token);
                        } else {
                            await window.firebaseApp.methods.signInAnonymously(auth);
                        }
                    } catch (error) {
                        console.error("Auth Error:", error);
                        // Fallback
                         await window.firebaseApp.methods.signInAnonymously(auth);
                    }
                }

                const appId = window.firebaseApp.appId;
                const db = window.firebaseApp.db;
                const { collection, doc, onSnapshot } = window.firebaseApp.methods;

                // 1. Setup Listeners with Error Handling
                // Users
                const usersCol = collection(db, 'artifacts', appId, 'public', 'data', 'users');
                onSnapshot(usersCol, (snapshot) => {
                    const users = [];
                    snapshot.forEach(doc => users.push({ ...doc.data(), _id: doc.id }));
                    
                    if(users.length === 0) {
                        this.seedDatabase(); 
                    } else {
                        this.data.users = users;
                        this.refreshUI();
                    }
                }, (error) => {
                    console.log("Users Listener Error (Ignore if just initializing):", error.code);
                });

                // Settings
                const settingsDoc = doc(db, 'artifacts', appId, 'public', 'data', 'settings', 'main');
                onSnapshot(settingsDoc, (docSnap) => {
                    if(docSnap.exists()) {
                        this.data.settings = docSnap.data();
                    } else {
                        this.data.settings = { tickerText: "Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨ÙƒÙ…", logoUrl: "https://upload.wikimedia.org/wikipedia/commons/e/e0/Jordan_Civil_Defence_Logo.png", gallery: [], customShifts: [] };
                    }
                    this.applySettings();
                }, (error) => console.log("Settings Listener Error:", error.code));

                // Suggestions
                const suggCol = collection(db, 'artifacts', appId, 'public', 'data', 'suggestions');
                onSnapshot(suggCol, (snapshot) => {
                    const suggs = [];
                    snapshot.forEach(doc => suggs.push({ ...doc.data(), _id: doc.id }));
                    this.data.suggestions = suggs.sort((a,b) => b.id - a.id);
                    if(this.data.currentUser) this.refreshUI();
                }, (error) => console.log("Suggestions Listener Error:", error.code));

                document.getElementById('globalLoader').classList.add('opacity-0');
                setTimeout(() => document.getElementById('globalLoader').style.display = 'none', 300);

                this.showSection('home');
            },

            seedDatabase: async function() {
                const { addDoc, collection, setDoc, doc } = window.firebaseApp.methods;
                const db = window.firebaseApp.db;
                const appId = window.firebaseApp.appId;
                
                // Initial Data
                const defaultUsers = [
                    { id: '101', pass: '2026', name: 'Ù…Ø¹Ø§Ø° Ø§Ù„Ø®ÙˆØ§Ù„Ø¯Ø©', role: 'admin', location: 'Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©', status: 'active', notifications: [] },
                    { id: '1', pass: '4821', name: 'Ù…Ø§Ù„Ùƒ Ø¹Ù„ÙŠÙ…Ø§Øª', role: 'volunteer', location: 'Ø§Ù„Ù…ÙØ±Ù‚', status: 'active', notifications: [] },
                    { id: '2', pass: '1234', name: 'Ù‡Ø¯Ù‰', role: 'volunteer', location: 'Ø§Ù„Ù…ÙØ±Ù‚', status: 'active', notifications: [] }
                ];

                for(const u of defaultUsers) {
                    await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'users'), u);
                }
                
                await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'settings', 'main'), {
                    tickerText: "Ø£Ù‡Ù„Ø§Ù‹ Ø¨ÙƒÙ… ÙÙŠ Ø¨ÙˆØ§Ø¨Ø© Ù…ØªØ·ÙˆØ¹ÙŠ Ø§Ù„Ø¯ÙØ§Ø¹ Ø§Ù„Ù…Ø¯Ù†ÙŠ - Ø§Ù„Ù…ÙØ±Ù‚",
                    logoUrl: "https://upload.wikimedia.org/wikipedia/commons/e/e0/Jordan_Civil_Defence_Logo.png",
                    gallery: [],
                    customShifts: []
                });
            },

            // --- Database Helpers ---
            updateUser: async function(userId, data) {
                // We need the Firestore Document ID (_id), not the user's ID string
                const user = this.data.users.find(u => u.id === userId);
                if(user && user._id) {
                    const { updateDoc, doc } = window.firebaseApp.methods;
                    const db = window.firebaseApp.db;
                    const appId = window.firebaseApp.appId;
                    await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users', user._id), data);
                }
            },

            refreshUI: function() {
                // If user is logged in, reload their view to show latest data
                if(this.data.currentUser) {
                    // Update local user object from the synced list
                    const updatedUser = this.data.users.find(u => u.id === this.data.currentUser.id);
                    if(updatedUser) {
                        this.data.currentUser = updatedUser;
                        // Refresh specific sections based on role
                        if(updatedUser.role === 'admin') this.loadAdminData();
                        else this.loadVolunteerData();
                    } else {
                        // User deleted?
                        this.logout();
                    }
                }
                this.renderGallery();
            },

            // --- Navigation ---
            showSection: function(id) {
                document.querySelectorAll('section').forEach(el => el.classList.add('hidden'));
                const sec = document.getElementById(id);
                sec.classList.remove('hidden');
                sec.classList.add('fade-in');
                this.updateNav();
                window.scrollTo(0,0);
            },

            updateNav: function() {
                const loginBtn = document.getElementById('loginBtnNav');
                const userMenu = document.getElementById('userMenu');
                if (this.data.currentUser) {
                    loginBtn.classList.add('hidden');
                    userMenu.classList.remove('hidden');
                    document.getElementById('userNameDisplay').innerText = this.data.currentUser.name;
                } else {
                    loginBtn.classList.remove('hidden');
                    userMenu.classList.add('hidden');
                }
            },

            // --- Login/Reg ---
            showLogin: function(type) {
                this.showSection('login');
                this.switchLoginTab(type);
                document.getElementById('loginError').classList.add('hidden');
            },

            switchLoginTab: function(type) {
                this.data.currentLoginContext = type;
                const tabVol = document.getElementById('tab-volunteer');
                const tabAdmin = document.getElementById('tab-admin');
                const regLink = document.getElementById('registerLink');
                
                if (type === 'admin') {
                    tabVol.classList.remove('active'); tabAdmin.classList.add('active');
                    document.getElementById('loginTitle').innerText = 'Ø¨ÙˆØ§Ø¨Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©';
                    regLink.classList.add('hidden');
                } else {
                    tabAdmin.classList.remove('active'); tabVol.classList.add('active');
                    document.getElementById('loginTitle').innerText = 'Ø¨ÙˆØ§Ø¨Ø© Ø§Ù„Ù…ØªØ·ÙˆØ¹ÙŠÙ†';
                    regLink.classList.remove('hidden');
                }
            },

            login: function() {
                const id = document.getElementById('username').value;
                const pass = document.getElementById('password').value;
                const user = this.data.users.find(u => u.id === id && u.pass === pass);
                const errorMsg = document.getElementById('loginError');

                if (!user) { errorMsg.innerText = 'Ø¨ÙŠØ§Ù†Ø§Øª Ø®Ø§Ø·Ø¦Ø©'; errorMsg.classList.remove('hidden'); return; }
                if (user.role !== 'admin' && this.data.currentLoginContext === 'admin') { errorMsg.innerText = 'ØºÙŠØ± Ù…ØµØ±Ø­'; errorMsg.classList.remove('hidden'); return; }
                if (user.status === 'blocked' || user.status === 'pending') { errorMsg.innerText = 'Ø§Ù„Ø­Ø³Ø§Ø¨ ØºÙŠØ± Ù†Ø´Ø·'; errorMsg.classList.remove('hidden'); return; }

                this.data.currentUser = user;
                if (user.role === 'admin') { this.showSection('admin-dashboard'); this.loadAdminData(); }
                else { this.showSection('volunteer-dashboard'); this.loadVolunteerData(); }
            },

            registerUser: async function() {
                const id = document.getElementById('regId').value;
                if(this.data.users.find(u => u.id === id)) return alert('Ø§Ù„Ù…Ø¹Ø±Ù Ù…Ø³Ø¬Ù„ Ù…Ø³Ø¨Ù‚Ø§Ù‹');
                
                const newUser = {
                    id: id, 
                    pass: document.getElementById('regPass').value, 
                    name: document.getElementById('regName').value, 
                    location: document.getElementById('regLocation').value,
                    role: 'volunteer', status: 'pending', shifts: [], notifications: [], currentSession: null
                };

                const { addDoc, collection } = window.firebaseApp.methods;
                const db = window.firebaseApp.db;
                const appId = window.firebaseApp.appId;
                
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'users'), newUser);
                alert('ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨ØŒ Ø³ÙŠØµÙ„Ùƒ Ø¥Ø´Ø¹Ø§Ø± Ø¹Ù†Ø¯ Ø§Ù„Ù‚Ø¨ÙˆÙ„.');
                this.showLogin('volunteer');
            },

            logout: function() { this.data.currentUser = null; this.showSection('home'); },

            // --- Admin Logic ---
            loadAdminData: function() {
                document.getElementById('adminNameSpan').innerText = this.data.currentUser.name;
                this.renderPendingTable();
                this.renderShiftRequestsTable();
                this.renderLiveAttendance();
                this.renderPasswordRequests();
                this.renderAllVolunteersTable();
                this.renderDailyReport();
                this.renderSuggestions();
                this.renderCustomShiftsList();
                this.checkAbsence();
                this.renderShiftRosterAdmin();
                
                const select = document.getElementById('msgRecipient');
                select.innerHTML = '<option value="all">Ø§Ù„Ø¬Ù…ÙŠØ¹</option>';
                this.data.users.filter(u => u.role === 'volunteer').forEach(u => select.innerHTML += `<option value="${u.id}">${u.name}</option>`);
                
                document.getElementById('adminTickerText').value = this.data.settings.tickerText || '';
                document.getElementById('adminLogoUrl').value = '';
            },

            // --- Admin Actions (Now Async with DB) ---
            approveUser: async function(id) {
                await this.updateUser(id, { status: 'active' });
                this.addNotification(id, 'ØªÙ… ØªÙØ¹ÙŠÙ„ Ø­Ø³Ø§Ø¨Ùƒ Ø¨Ù†Ø¬Ø§Ø­!', 'success');
            },

            decideShift: async function(uid, date, decision) {
                const user = this.data.users.find(u => u.id === uid);
                const shifts = user.shifts.map(s => s.date === date ? { ...s, status: decision } : s);
                await this.updateUser(uid, { shifts: shifts });
                this.addNotification(uid, `Ø·Ù„Ø¨ Ø§Ù„Ø¯ÙˆØ§Ù… Ù„ÙŠÙˆÙ… ${date} ØªÙ… ${decision==='approved'?'Ù‚Ø¨ÙˆÙ„Ù‡':'Ø±ÙØ¶Ù‡'}`, decision==='approved'?'success':'error');
            },

            toggleAttendance: async function(userId, date) {
                const u = this.data.users.find(u => u.id === userId);
                const shifts = u.shifts.map(s => s.date === date ? { ...s, attended: !s.attended } : s);
                await this.updateUser(userId, { shifts: shifts });
            },

            approvePassChange: async function(id) {
                const u = this.data.users.find(u => u.id === id);
                await this.updateUser(id, { pass: u.passwordRequest.newPass, passwordRequest: null });
                this.addNotification(id, 'ØªÙ… ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø¨Ù†Ø¬Ø§Ø­.', 'success');
            },

            addCustomShift: async function() {
                const date = document.getElementById('newShiftDate').value;
                if(!date) return;
                const shifts = [...(this.data.settings.customShifts || [])];
                if(!shifts.includes(date)) {
                    shifts.push(date);
                    const { setDoc, doc } = window.firebaseApp.methods;
                    const db = window.firebaseApp.db;
                    const appId = window.firebaseApp.appId;
                    await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'settings', 'main'), { ...this.data.settings, customShifts: shifts });
                }
            },

            saveSettings: async function() {
                const text = document.getElementById('adminTickerText').value;
                const logo = document.getElementById('adminLogoUrl').value;
                const newData = { ...this.data.settings };
                if(text) newData.tickerText = text;
                if(logo) newData.logoUrl = logo;
                
                const { setDoc, doc } = window.firebaseApp.methods;
                const db = window.firebaseApp.db;
                const appId = window.firebaseApp.appId;
                await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'settings', 'main'), newData);
                alert('ØªÙ… Ø§Ù„Ø­ÙØ¸');
            },

            adminSendMessage: function() {
                const rec = document.getElementById('msgRecipient').value;
                const body = document.getElementById('msgBody').value;
                if(!body) return;
                if(rec === 'all') {
                    this.data.users.forEach(u => { if(u.role === 'volunteer') this.addNotification(u.id, body) });
                } else {
                    this.addNotification(rec, body);
                }
                document.getElementById('msgBody').value = '';
                alert('ØªÙ… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„');
            },
            
            replyToSuggestion: async function(index) {
                const replyText = document.getElementById(`replyInput-${index}`).value;
                if(!replyText) return;
                const sugg = this.data.suggestions[index];
                
                // Update Suggestion Doc
                const { updateDoc, doc } = window.firebaseApp.methods;
                const db = window.firebaseApp.db;
                const appId = window.firebaseApp.appId;
                await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'suggestions', sugg._id), { reply: replyText });
                
                if(sugg.authorId) this.addNotification(sugg.authorId, `Ø±Ø¯ Ø¹Ù„Ù‰ Ù…Ù‚ØªØ±Ø­Ùƒ: ${replyText}`, 'info');
            },

            // --- Volunteer Logic ---
            loadVolunteerData: function() {
                document.getElementById('volNameSpan').innerText = this.data.currentUser.name;
                this.renderNotifications();
                this.generateShifts();
                this.renderElectronicGate();
                this.checkPassRequestStatus();
                this.renderVolunteerSuggestions();
            },

            requestShift: async function(date) {
                const shifts = this.data.currentUser.shifts ? [...this.data.currentUser.shifts] : [];
                shifts.push({ date, status: 'pending' });
                await this.updateUser(this.data.currentUser.id, { shifts: shifts });
                this.generateShifts();
            },

            submitSuggestion: async function() {
                const t = document.getElementById('suggestionText').value;
                if(!t) return;
                
                const { addDoc, collection } = window.firebaseApp.methods;
                const db = window.firebaseApp.db;
                const appId = window.firebaseApp.appId;
                
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'suggestions'), {
                    text: t,
                    author: this.data.currentUser.name,
                    authorId: this.data.currentUser.id,
                    date: new Date().toLocaleDateString('ar-JO'),
                    id: Date.now(),
                    reply: null
                });
                
                document.getElementById('suggestionText').value = '';
                alert('ØªÙ… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„');
            },

            requestPasswordChange: async function() {
                const p = document.getElementById('newVolunteerPass').value;
                if(!p) return;
                await this.updateUser(this.data.currentUser.id, { passwordRequest: { newPass: p, status: 'pending' } });
                alert('ØªÙ… Ø§Ù„Ø·Ù„Ø¨');
            },

            checkIn: async function() {
                const today = new Date().toISOString().split('T')[0];
                const session = { status: 'active', checkInTime: new Date().toLocaleTimeString('ar-JO'), date: today };
                
                // Update Session + Mark Shift Attended locally first to find correct shift
                const shifts = [...this.data.currentUser.shifts];
                const shiftIndex = shifts.findIndex(s => s.date === today);
                if(shiftIndex >= 0) shifts[shiftIndex].attended = true;

                await this.updateUser(this.data.currentUser.id, { currentSession: session, shifts: shifts });
            },

            checkOut: async function() {
                 await this.updateUser(this.data.currentUser.id, { "currentSession.status": 'completed' });
            },

            // --- Shared Logic (Notifications) ---
            addNotification: async function(userId, text, type='info') {
                const user = this.data.users.find(u => u.id === userId);
                if(user) {
                    const notifs = user.notifications ? [...user.notifications] : [];
                    notifs.unshift({ id: Date.now(), text, type, date: new Date().toLocaleDateString('ar-JO'), read: false });
                    await this.updateUser(userId, { notifications: notifs });
                }
            },

            // --- AI Integration ---
            async callGemini(prompt) {
                const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
                try {
                    const response = await fetch(url, { 
                        method: 'POST', 
                        headers: { 'Content-Type': 'application/json' }, 
                        body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] }) 
                    });
                    const data = await response.json();
                    return data.candidates[0].content.parts[0].text;
                } catch (error) { return "Ø¹Ø°Ø±Ø§Ù‹ØŒ Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ."; }
            },

            // --- Rendering Functions (Similar to before but safe) ---
            applySettings: function() {
                if(this.data.settings.tickerText) {
                    document.getElementById('news-ticker-container').classList.remove('hidden');
                    document.getElementById('newsTickerText').innerText = this.data.settings.tickerText;
                }
                if(this.data.settings.logoUrl) document.getElementById('navLogo').src = this.data.settings.logoUrl;
            },

            renderGallery: function() {
                const grid = document.getElementById('galleryGrid');
                if(!this.data.settings.gallery || this.data.settings.gallery.length === 0) {
                     grid.innerHTML = '<p class="col-span-3 text-center text-gray-500">Ù„Ø§ ØªÙˆØ¬Ø¯ ØµÙˆØ±</p>'; return; 
                }
                grid.innerHTML = this.data.settings.gallery.map(url => `<div class="bg-white p-2 rounded shadow h-48 overflow-hidden"><img src="${url}" class="w-full h-full object-cover rounded hover:scale-105 transition duration-300"></div>`).join('');
            },

            renderNotifications: function() {
                const list = document.getElementById('notificationsList');
                const badge = document.getElementById('notifBadge');
                const notifs = this.data.currentUser.notifications || [];
                
                if(notifs.length === 0) { list.innerHTML = '<p class="text-center text-gray-400">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¥Ø´Ø¹Ø§Ø±Ø§Øª</p>'; badge.classList.add('hidden'); return; }
                
                const unread = notifs.filter(n => !n.read).length;
                if(unread) { badge.classList.remove('hidden'); this.markNotifsRead(); } else badge.classList.add('hidden');
                
                list.innerHTML = notifs.map(n => `<div class="bg-gray-50 p-3 rounded border-r-4 ${n.type==='error'?'border-red-500':'border-blue-500'} text-sm"><p class="font-bold">${n.text}</p><span class="text-xs text-gray-500">${n.date}</span></div>`).join('');
            },

            markNotifsRead: async function() {
                // We update this silently
                const notifs = this.data.currentUser.notifications.map(n => ({...n, read: true}));
                // Avoid infinite loop by checking first, but simpliest is just updating local state for badge
                // In real app, we update DB
                // await this.updateUser(this.data.currentUser.id, { notifications: notifs });
            },

            // ... (Rest of rendering logic for tables, mostly identical to original but utilizing fresh data)
            renderPendingTable: function() {
                const p = this.data.users.filter(u => u.status === 'pending');
                document.getElementById('pendingCount').innerText = p.length;
                document.getElementById('pendingTableBody').innerHTML = p.map(u => `<tr><td>${u.name}</td><td>${u.location}</td><td><button onclick="app.approveUser('${u.id}')" class="bg-green-100 text-green-700 px-2 py-1 rounded text-xs font-bold">Ù‚Ø¨ÙˆÙ„</button></td></tr>`).join('');
            },
            
            renderShiftRequestsTable: function() {
                const tbody = document.getElementById('shiftRequestsTableBody');
                let html = ''; let count = 0;
                this.data.users.forEach(u => { if(u.shifts) u.shifts.forEach(s => { if(s.status === 'pending') {
                    count++; html += `<tr><td>${u.name}</td><td>${s.date}</td><td><button onclick="app.decideShift('${u.id}','${s.date}','approved')" class="text-green-600">âœ”</button> <button onclick="app.decideShift('${u.id}','${s.date}','rejected')" class="text-red-600">âœ–</button></td></tr>`;
                }})});
                document.getElementById('pendingShiftsCount').innerText = count; tbody.innerHTML = html || '<tr><td class="text-center text-gray-400">Ù„Ø§ ÙŠÙˆØ¬Ø¯</td></tr>';
            },

            renderAllVolunteersTable: function(filter='') {
                const tbody = document.getElementById('allVolunteersBody');
                let users = this.data.users.filter(u => u.role === 'volunteer');
                if(filter) users = users.filter(u => u.name.includes(filter) || u.id.includes(filter));
                tbody.innerHTML = users.map(u => `<tr><td class="p-2 font-bold">${u.name}</td><td class="p-2">${u.id}</td><td class="p-2 text-blue-600">${u.pass}</td><td class="p-2"><span class="${u.status==='active'?'text-green-600':'text-red-600'}">${u.status}</span></td><td class="p-2"><button onclick="app.updateUser('${u.id}', {status: '${u.status==='active'?'blocked':'active'}'})" class="text-xs border px-1">${u.status==='active'?'Ø­Ø¸Ø±':'ØªÙØ¹ÙŠÙ„'}</button></td></tr>`).join('');
            },

            renderSuggestions: function() {
                document.getElementById('suggestionsCount').innerText = this.data.suggestions.length;
                document.getElementById('suggestionsList').innerHTML = this.data.suggestions.map((s, idx) => `
                    <div class="border p-2 rounded text-sm bg-gray-50 mb-2">
                        <div class="flex justify-between font-bold"><span>${s.author}</span><span class="text-xs font-normal">${s.date}</span></div>
                        <p class="mt-1 mb-2">${s.text}</p>
                        ${s.reply ? `<div class="bg-green-50 p-2 text-green-800 text-xs"><strong>Ø§Ù„Ø±Ø¯:</strong> ${s.reply}</div>` : 
                        `<div class="flex gap-2"><input id="replyInput-${idx}" class="border rounded px-2 flex-grow text-xs" placeholder="Ø±Ø¯..."><button onclick="app.replyToSuggestion(${idx})" class="bg-blue-600 text-white px-2 text-xs rounded">Ø¥Ø±Ø³Ø§Ù„</button></div>`}
                    </div>`).join('');
            },

            renderVolunteerSuggestions: function() {
                const my = this.data.suggestions.filter(s => s.authorId === this.data.currentUser.id);
                document.getElementById('mySuggestionsList').innerHTML = my.length ? my.map(s => `<div class="bg-gray-50 p-2 text-xs border mb-1"><div class="flex justify-between"><span>${s.date}</span><span class="${s.reply?'text-green-600':'text-yellow-600'}">${s.reply?'ØªÙ…':'Ø§Ù†ØªØ¸Ø§Ø±'}</span></div><p>${s.text}</p>${s.reply?`<p class="text-green-700 mt-1 border-t">Ø§Ù„Ø±Ø¯: ${s.reply}</p>`:''}</div>`).join('') : '<p class="text-center text-gray-400 text-xs">Ù„Ø§ ÙŠÙˆØ¬Ø¯</p>';
            },
            
            checkPassRequestStatus: function() {
                const s = this.data.currentUser.passwordRequest?.status;
                if(s === 'pending') document.getElementById('passRequestStatus').classList.remove('hidden');
                else document.getElementById('passRequestStatus').classList.add('hidden');
            },
            
            renderPasswordRequests: function() {
                const reqs = this.data.users.filter(u => u.passwordRequest?.status === 'pending');
                document.getElementById('pendingPassCount').innerText = reqs.length;
                document.getElementById('passwordRequestsBody').innerHTML = reqs.map(u => `<tr><td>${u.name}</td><td>${u.passwordRequest.newPass}</td><td><button onclick="app.approvePassChange('${u.id}')" class="bg-green-100 text-green-700 px-2 rounded text-xs">Ù…ÙˆØ§ÙÙ‚Ø©</button></td></tr>`).join('');
            },

            renderLiveAttendance: function() {
                const active = this.data.users.filter(u => u.currentSession?.status === 'active');
                document.getElementById('activeVolunteersCount').innerText = active.length;
                document.getElementById('liveAttendanceBody').innerHTML = active.map(u => `<tr><td>${u.name}</td><td>${u.currentSession.checkInTime}</td><td>${u.location}</td></tr>`).join('');
            },

            renderDailyReport: function() {
                const today = new Date().toISOString().split('T')[0];
                document.getElementById('reportDate').innerText = today;
                const present = this.data.users.filter(u => u.currentSession?.date === today && (u.currentSession.status === 'active' || u.currentSession.status === 'completed'));
                document.getElementById('dailyReportContent').innerHTML = `<p class="font-bold mb-2">Ø§Ù„Ø­Ø¶ÙˆØ±: ${present.length}</p><ul class="list-disc pr-4">${present.map(u => `<li>${u.name} (${u.location}) - ${u.currentSession.status==='active'?'Ù…ØªÙˆØ§Ø¬Ø¯':'ØºØ§Ø¯Ø±'}</li>`).join('')}</ul>`;
            },
            
            printDailyReport: function() { window.print(); },
            
            renderCustomShiftsList: function() {
                 const list = document.getElementById('customShiftsList');
                 if(!this.data.settings.customShifts || !this.data.settings.customShifts.length) { list.innerHTML = '<p class="text-center text-gray-400 text-xs">Ù„Ø§ ÙŠÙˆØ¬Ø¯</p>'; return; }
                 list.innerHTML = this.data.settings.customShifts.map(d => `<div class="bg-gray-50 p-1 text-xs border flex justify-between"><span>${d}</span></div>`).join('');
            },
            
            renderShiftRosterAdmin: function() {
                // Simplified roster logic for brevity in this robust version
                const tbody = document.getElementById('adminShiftRosterBody');
                let today = new Date();
                let dates = [];
                for(let i=0; i<7; i++) { 
                    let d = new Date(today); d.setDate(today.getDate() + i); 
                    dates.push(d.toISOString().split('T')[0]); 
                }
                
                tbody.innerHTML = dates.map(date => {
                    const usersOnShift = this.data.users.filter(u => u.shifts?.some(s => s.date === date && s.status === 'approved'));
                    const userHtml = usersOnShift.map(u => {
                         const s = u.shifts.find(s => s.date === date);
                         return `<button onclick="app.toggleAttendance('${u.id}', '${date}')" class="${s.attended?'bg-green-200':'bg-gray-200'} px-2 rounded text-xs ml-1">${u.name}</button>`
                    }).join('');
                    return `<tr><td class="p-2 text-center border-b">${date}</td><td class="p-2 text-center border-b">${new Date(date).toLocaleDateString('ar-JO', {weekday:'long'})}</td><td class="p-2 border-b">${userHtml}</td></tr>`;
                }).join('');
            },
            
            checkAbsence: function() { /* Logic exists in render loops indirectly */ },
            
            generateShifts: function() {
                const container = document.getElementById('shiftsContainer'); container.innerHTML = '';
                let dates = []; let today = new Date();
                
                // Add next 14 days
                for(let i=1; i<14; i++) {
                    let d = new Date(today); d.setDate(today.getDate() + i);
                    if(d.getDay() === 1 || d.getDay() === 2) dates.push(d.toISOString().split('T')[0]); // Mon/Tue
                }
                if(this.data.settings.customShifts) dates = [...new Set([...dates, ...this.data.settings.customShifts])].sort();

                dates.forEach(date => {
                    const shift = this.data.currentUser.shifts?.find(s => s.date === date);
                    let btn = `<button onclick="app.requestShift('${date}')" class="bg-blue-600 text-white px-3 py-1 rounded text-sm">ØªØ³Ø¬ÙŠÙ„</button>`;
                    if(shift) {
                        if(shift.status === 'pending') btn = '<span class="text-yellow-600 bg-yellow-100 px-2 text-xs rounded">Ø§Ù†ØªØ¸Ø§Ø±</span>';
                        else if(shift.status === 'approved') btn = '<span class="text-green-600 bg-green-100 px-2 text-xs rounded">Ù…Ù‚Ø¨ÙˆÙ„</span>';
                        else btn = '<span class="text-red-600 bg-red-100 px-2 text-xs rounded">Ù…Ø±ÙÙˆØ¶</span>';
                    }
                    container.innerHTML += `<div class="flex justify-between items-center bg-gray-50 p-3 rounded border mb-2"><span class="font-bold text-gray-700">${date}</span>${btn}</div>`;
                });
            },
            
            renderElectronicGate: function() {
                const gate = document.getElementById('electronicGate'); 
                const today = new Date().toISOString().split('T')[0];
                const shift = this.data.currentUser.shifts?.find(s => s.date === today && s.status === 'approved');
                
                if(!shift) { gate.innerHTML = '<div class="text-center py-4"><i class="fas fa-lock text-4xl text-gray-300 mb-2"></i><p class="text-gray-500 font-bold">Ø§Ù„Ø¨ÙˆØ§Ø¨Ø© Ù…ØºÙ„Ù‚Ø©</p></div>'; return; }
                
                if(this.data.currentUser.currentSession?.status === 'active') {
                    gate.innerHTML = `<div class="text-center"><p class="text-green-600 font-bold text-lg">Ø£Ù†Øª Ø¹Ù„Ù‰ Ø±Ø£Ø³ Ø¹Ù…Ù„Ùƒ</p><button onclick="app.checkOut()" class="bg-red-500 text-white px-6 py-2 rounded-lg font-bold mt-2">Ø®Ø±ÙˆØ¬</button></div>`;
                } else if(this.data.currentUser.currentSession?.status === 'completed') {
                    gate.innerHTML = `<div class="text-center"><i class="fas fa-check-circle text-4xl text-green-500 mb-2"></i><p>ØªÙ… Ø§Ù„Ø¥Ù†Ù‡Ø§Ø¡</p></div>`;
                } else {
                    gate.innerHTML = `<div class="text-center"><p class="text-blue-600 font-bold text-lg">Ø§Ù„Ø¨ÙˆØ§Ø¨Ø© Ù…ÙØªÙˆØ­Ø©</p><button onclick="app.checkIn()" class="bg-green-600 text-white px-6 py-2 rounded-lg font-bold mt-2">Ø¯Ø®ÙˆÙ„</button></div>`;
                }
            },
            
            // AI Wrappers
            askSafetyAdvisor: async function() {
                const q = document.getElementById('safetyQuery').value;
                if(!q) return;
                const out = document.getElementById('safetyChatOutput');
                out.innerHTML += `<div class="chat-bubble chat-user">${q}</div>`;
                const ans = await this.callGemini('Ø¨ØµÙØªÙƒ Ø®Ø¨ÙŠØ± Ø¯ÙØ§Ø¹ Ù…Ø¯Ù†ÙŠØŒ Ø£Ø¬Ø¨ Ø¨Ø§Ø®ØªØµØ§Ø±: ' + q);
                out.innerHTML += `<div class="chat-bubble chat-ai">${marked.parse(ans)}</div>`;
                document.getElementById('safetyQuery').value='';
                out.scrollTop = out.scrollHeight;
            },
            
            generateReport: async function() {
                const n = document.getElementById('reportNotes').value;
                if(!n) return;
                document.getElementById('reportModal').classList.remove('hidden');
                document.getElementById('reportResult').innerText = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„ÙƒØªØ§Ø¨Ø©...';
                const ans = await this.callGemini(`Ø§ÙƒØªØ¨ ØªÙ‚Ø±ÙŠØ± Ø±Ø³Ù…ÙŠ Ù„Ù…ØªØ·ÙˆØ¹ Ø¯ÙØ§Ø¹ Ù…Ø¯Ù†ÙŠ Ø§Ø³Ù…Ù‡ ${this.data.currentUser.name} Ø¨Ù†Ø§Ø¡ Ø¹Ù„Ù‰: ${n}`);
                document.getElementById('reportResult').innerText = ans;
            },
            
            copyReport: function() {
                 navigator.clipboard.writeText(document.getElementById('reportResult').innerText);
                 alert('ØªÙ… Ø§Ù„Ù†Ø³Ø®');
            }
        };

        window.addEventListener('DOMContentLoaded', () => app.init());
    </script>
</body>
</html>